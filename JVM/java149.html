<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"RM
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>Pro doplnìní informací, které jsme si doposud v seriálu o virtuálním stroji jazyka Java (JVM) uvedli si v nìkolika navazujících èláncích popí¹eme velmi zajímavý projekt LuaJIT. Ji¾ z názvu tohoto projektu je zøejmé, ¾e se jedná o &bdquo;konkurenèní &ldquo;Just in Time pøekladaè, který je mo¾né pou¾ít spoleènì s programovacím jazykem Lua.</p>



<h2>Obsah</h2>


<p><a href="#k01">1. LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua</a></p>
<p><a href="#k02">2. Formát instrukèních slov pou¾ívaný v&nbsp;IR LuaJITu</a></p>
<p><a href="#k03">3. Instrukce pro práci s&nbsp;konstantami a pro pøesun hodnot mezi registry v&nbsp;IR LuaJITu</a></p>
<p><a href="#k04">4. Základní instrukce pro volání funkcí a návrat z&nbsp;funkcí v&nbsp;IR LuaJITu</a></p>
<p><a href="#k05">5. Demonstraèní pøíklad èíslo 1: zdrojový kód obsahující pouze pøíkaz <strong>return</strong></a></p>
<p><a href="#k06">6. Demonstraèní pøíklad èíslo 2: automatické pøiøazení hodnoty <strong>nil</strong> k&nbsp;nìkolika promìnným</a></p>
<p><a href="#k07">7. Demonstraèní pøíklad èíslo 3: explicitní pøiøazení hodnot k&nbsp;nìkolika promìnným</a></p>
<p><a href="#k08">8. Demonstraèní pøíklad èíslo 4: volání (builtin) funkce</a></p>
<p><a href="#k09">9. Demonstraèní pøíklad èíslo 5: volání funkce s&nbsp;pøedáním parametru</a></p>
<p><a href="#k10">10. Obsah následující èásti seriálu</a></p>
<p><a href="#k11">11. Repositáø se zdrojovými kódy dne¹ních pìti demonstraèních pøíkladù</a></p>
<p><a href="#k12">12. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua</h2>

<p>Vìt¹ina dosavadního obsahu <a
href="http://www.root.cz/serialy/programovaci-jazyk-java-a-jvm/">seriálu o
programovacím jazyku Java i o JVM</a> byla skuteènì vìnována relativnì
podrobnému popisu vlastností virtuálního stroje Javy vèetnì jeho bajtkódu a
takté¾ principu èinnosti Just in Time pøekladaèe (<i>JIT Compiler</i>). JITu
JVM se je¹tì budeme vìnovat podrobnìji v&nbsp;budoucnosti, ov¹em nebude na
¹kodu se mezitím podívat na princip práce &bdquo;konkurenèního&ldquo; JITu.
Konkrétnì se jedná o projekt <i>LuaJIT</i>. LuaJIT byl vybrán pøedev¹ím
s&nbsp;ohledem na jeho relativní jednoduchost (zejména v&nbsp;porovnání
s&nbsp;monstrózním JVM JITem) a takté¾ proto, ¾e pou¾ívá snadno pochopitelný <a
href="http://cs.wikipedia.org/wiki/Mezijazyk">mezijazyk</a> (anglicky <i>IR
&ndash; Intermediate Representation</i>), který je následnì
&bdquo;JITován&ldquo;. Tento IR je odli¹ný od bajtkódu jazyka Lua, s&nbsp;ním¾
jsme se ji¾ v&nbsp;tomto seriálu takté¾ seznámili. Zatímco pùvodní bajtkód
jazyka Lua byl orientován pøedev¹ím s&nbsp;ohledem na mo¾nosti interpretru, je
IR v&nbsp;LuaJITu navr¾en takovým zpùsobem, aby byl jeho následný pøeklad do
nativního kódu pomìrnì snadný a rychlý, bez ohledu na architekturu pou¾itého
mikroprocesoru.</p>

<p><i>LuaJIT</i> je z&nbsp;velké èásti dílem jediného programátora, který se
jmenuje <i>Mike Pall</i>. To je velmi zajímavá skuteènost, zvlá¹tì kdy¾ si
uvìdomíme, ¾e <i>LuaJIT</i> je v&nbsp;souèasné verzi velmi kvalitní produkt
podporující vìt¹í mno¾ství procesorových architektur (na tomto místì je pro
porovnání dùle¾ité se zmínit o tom, jak dlouho trvalo, ne¾ byl JVM JIT
adaptován napøíklad pro procesory ARM èi ARM64; u dal¹ích architektur jsme
stále odkázáni na <a
href="http://icedtea.classpath.org/wiki/+#What_is_Zero.3F">Zero</a> a <a
href="http://icedtea.classpath.org/wiki/ZeroSharkFaq#What_is_Shark.3F">Shark</a>).
Jeden z&nbsp;problémù, kterým alespoò doposud <i>LuaJIT</i> trpí, je stále
je¹tì nedokonèená dokumentace, proto¾e sám Mike pí¹e: &bdquo;I have little use
for academic merits myself -- I'm more interested in coding than writing
papers&ldquo;. Mo¾ná se nám v&nbsp;tomto seriálu podaøí tuto mezeru
v&nbsp;dokumentaci alespoò nepatrnì zaplnit :-)</p>



<p><a name="k02"></a></p>
<h2 id="k02">2. Formát instrukèních slov pou¾ívaný v&nbsp;IR LuaJITu</h2>

<p>Celý projekt <i>LuaJIT</i> se skládá z&nbsp;nìkolika modulù, které pøi
spu¹tìní aplikace vytvoøené v&nbsp;programovacím jazyku Lua musí vzájemnì
spolupracovat. Prvním modulem je pøekladaè slou¾ící pro kompilaci zdrojového
kódu napsaného v&nbsp;Lue do mezijazyka, který budeme v&nbsp;dal¹ím textu
zkrácenì oznaèovat <strong>IR</strong> &ndash; <i>Intermediate
Representation</i>. IR je navr¾en takovým zpùsobem, aby mohl být buï
interpretován (jde o ty èásti kódu, které nejsou spou¹tìny pøíli¹ èasto) nebo
pøekládán do nativního strojového kódu s&nbsp;vyu¾itím JITu (vìt¹inou se jedná
o opìtovnì spou¹tìné èásti kódu). Dnes se budeme zabývat pøedev¹ím základními
vlastnostmi IR, proto¾e vlastní IR je dosti odli¹ný napøíklad od bajtkódu JVM,
nehledì na to, ¾e pøeklad do IR se provádí v&nbsp;pøípadì <i>LuaJITu</i> zcela
automaticky. IR pou¾ívá takzvaný tøíadresový kód a instrukce o pevné ¹íøce
tøiceti dvou bitù. Pøístup k&nbsp;instrukcím je tedy obecnì mnohem rychlej¹í,
ne¾ pøi pou¾ití instrukcí promìnné délky, tak jako je tomu v&nbsp;JVM.</p>

<p>Existují dva formáty instrukcí, pøesnìji øeèeno dva zpùsoby rozdìlení
32bitového slova na jednotlivá bitová pole. V&nbsp;obou formátech má operaèní
kód instrukce ¹íøku osmi bitù, obsazení dal¹ích 24 bitù je v¹ak odli¹né.</p>

<p>První formát se pou¾ívá u instrukcí s&nbsp;trojicí operandù. Typické pou¾ití
tohoto formátu je u aritmetických instrukcí:</p>

<table>
<tr><th>Oznaèení</th><th>©íøka (bitù)</th><th>Popis</th></tr>
<tr><td>B</td><td>8</td><td>první vstupní operand (zdrojová promìnná)</td></tr>
<tr><td>C</td><td>8</td><td>druhý vstupní operand (zdrojová promìnná, numerická konstanta atd.)</td></tr>
<tr><td>A</td><td>8</td><td>výsledek operace (promìnná pro ulo¾ení výsledku)</td></tr>
<tr><td>OP</td><td>8</td><td>operaèní kód instrukce</td></tr>
<tr><td>Celkem</td><td>32</td><td>&nbsp;</td></tr>
</table>

<p>Druhý formát doká¾e adresovat pouze dva operandy, ov¹em operand oznaèený
písmenem <strong>D</strong> má ¹íøku ¹estnáct bitù a lze ho v&nbsp;nìkterých
instrukcích pou¾ít napøíklad k&nbsp;pøímému ulo¾ení ¹estnáctibitové celoèíselné
konstanty se znaménkem (srov.&nbsp;s&nbsp;pomìrnì velkým mno¾stvím instrukcí
v&nbsp;bajtkódu JVM, které se pokou¹í o toté¾, ale mnohem komplikovanìj¹ím
zpùsobem):</p>

<table>
<tr><th>Oznaèení</th><th>©íøka (bitù)</th><th>Popis</th></tr>
<tr><td>D</td><td>16</td><td>vstupní operand (zdrojová promìnná)</td></tr>
<tr><td>A</td><td>8</td><td>první operand nebo promìnná pro ulo¾ení výsledku</td></tr>
<tr><td>OP</td><td>8</td><td>operaèní kód instrukce</td></tr>
<tr><td>Celkem</td><td>32</td><td>&nbsp;</td></tr>
</table>



<p><a name="k03"></a></p>
<h2 id="k03">3. Instrukce pro práci s&nbsp;konstantami a pro pøesun hodnot mezi registry v&nbsp;IR LuaJITu</h2>

<p>Demonstraèní pøíklady popsané v&nbsp;navazujících kapitolách obsahují pøi
pøekladu do IR pouze velmi malé mno¾ství instrukcí. Mezi zcela základní
instrukce patøí operace pou¾ívané pro naètení promìnné do zvoleného slotu (nyní
pro jednoduchost pøedpokládejme, ¾e slotem je my¹lena globální èi lokální
promìnná). V&nbsp;IR se pro naètení konstanty do zvoleného slotu mù¾e pou¾ít
jedna ze ètyø instrukcí vypsaných v&nbsp;tabulce pod tímto odstavcem.
Pov¹imnìte si, ¾e i kdy¾ by teoreticky bylo mo¾né pou¾ít pouze jedinou
instrukci, je z&nbsp;dùvodu optimalizací a zmen¹ení celkové velikosti IR
k&nbsp;dispozici i instrukce <strong>KNIL</strong> (mnoho promìnných je
v&nbsp;reálných programech implicitnì inicializováno na hodnotu
<strong>nil</strong>) a takté¾ instrukce <strong>KSHORT</strong> (pou¾ití
malých celoèíselných konstant 0, 1 atd. je takté¾ velmi èasté):</p>

<table>
<tr><th>Instrukce</th><th>Operand A</th><th>Operand D</th><th>Popis</th></tr>
<tr><td>KNIL     </td><td>base</td><td>base  </td><td>nastaví sloty èíslo A a¾ D na hodnotu <strong>nil</strong></td></tr>
<tr><td>KPRI     </td><td>dest</td><td>pri   </td><td>nastaví <i>dest</i> na hodnotu specifikovanou v D</td></tr>
<tr><td>KSHORT   </td><td>dest</td><td>const </td><td>pøenese do <i>dest</i> ¹estnáctibitovou celoèíselnou konstantu</td></tr>
<tr><td>KNUM     </td><td>dest</td><td>number</td><td>pøenese do <i>dest</i> zvolenou numerickou konstantu</td></tr>
</table>

<p>V&nbsp;pøedchozí tabulce jsou pro oznaèení typu/významu operandu pou¾ity
následující termíny:</p>

<table>
<tr><td>base  </td><td>èíslo, hodnota pouze pro ètení</td></tr>
<tr><td>dest  </td><td>èíslo slotu, pou¾ito pro specifikaci cíle</td></tr>
<tr><td>number</td><td>index do tabulky konstant (lze pova¾ovat za zjednodu¹enou obdobu <i>constant poolu</i>)</td></tr>
</table>



<p><a name="k04"></a></p>
<h2 id="k04">4. Základní instrukce pro volání funkcí a návrat z&nbsp;funkcí v&nbsp;IR LuaJITu</h2>

<p>V&nbsp;IR vygenerovaných pøi pøekladu dále popsaných demonstraèních pøíkladù
se pou¾ívají i dal¹í typy instrukcí. Pøedev¹ím se jedná o instrukci
<strong>MOV</strong> slou¾ící pro jednoduchý pøenos hodnoty z&nbsp;jednoho
slotu do slotu jiného:</p>

<table>
<tr><th>Instrukce</th><th>Operand A</th><th>Operand D</th><th>Popis</th></tr>
<tr><td>MOV</td><td>dest</td><td>var</td><td>kopie dat z D do A</td></tr>
</table>

<p>Mnohem komplikovanìj¹í jsou instrukce nazvané <strong>RET0</strong> a
<strong>CALL</strong>. První z&nbsp;tìchto instrukcí slou¾í k&nbsp;návratu
z&nbsp;aktuálnì provádìné funkce, druhá instrukce pak k&nbsp;volání funkce a
k&nbsp;pøedání parametrù do volané funkce. Reference na volanou funkci je
ulo¾ena ve slotu specifikovaném v&nbsp;operandu A, parametry funkce pak
v&nbsp;následujících slotech. Návratové hodnoty jsou ulo¾eny do slotù
s&nbsp;indexy A a¾ A+B-2. Konstanty ulo¾ené v&nbsp;operandech B a C tedy urèují
poèet návratových hodnot resp. poèet pøedávaných parametrù:</p>

<table>
<tr><th>Instrukce</th><th>Operand A</th><th>Operand B</th><th>Operandy C/D</th><th>Popis</th></tr>
<tr><td>RET0</td><td>rbase</td><td>lit</td><td>&nbsp;</td><td>návrat z funkce</td></tr>
<tr><td>CALL</td><td>base </td><td>lit</td><td>lit</td><td>volání funkce<br />
reference na funkci je v A<br />
parametry A+1, A+2, ... A+C-1<br />
návratové hodnoty A, A+1, ... A+B-2</td></tr>
</table>

<p>Poslední instrukcí IR, s&nbsp;ní¾ se v&nbsp;dále uvedených a pøelo¾ených
demonstraèních pøíkladech setkáme, je instrukce <strong>GGET</strong>, která
slou¾í k&nbsp;pøístupu do globální tabulky <strong>_G</strong> (tato tabulka
obsahuje v¹echny globální symboly). Tato instrukce bude vyu¾ita k&nbsp;získání
reference na volané funkce:</p>

<table>
<tr><th>Instrukce</th><th>Operand A</th><th>Operand B</th><th>Operandy C/D</th><th>Popis</th></tr>
<tr><td>GGET</td><td>var</td><td>&times;</td><td>str</td><td>tzv. &bdquo;global get&ldquo;, A=_G[D]</td></tr>
</table>



<p><a name="k05"></a></p>
<h2 id="k05">5. Demonstraèní pøíklad èíslo 1: zdrojový kód obsahující pouze pøíkaz <strong>return</strong></h2>

<p>Dne¹ní první demonstraèní pøíklad je velmi jednoduchý &ndash; jedná se ve
skuteènosti o nejjednodu¹¹í mo¾ný program naprogramovaný v&nbsp;jazyku Lua
vùbec :-) Tento pøíklad obsahuje jen pøíkaz <strong>return</strong>, která
zpùsobí ukonèení programu. Interpret jazyka Lua sám otestuje, zda se za tímto
pøíkazem nenachází dal¹í pøíkazy:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 1</i>
<i>--</i>
<i>-- Tento pøíklad obsahuje pouze jediný pøíkaz return.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>-- jediny prikaz</i>
<strong>return</strong>
&nbsp;
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>

<p>Podívejme se na pøeklad tohoto demonstraèního pøíkladu do IR LuaJITu. Podle
oèekávání bude IR velmi jednoduchý, konkrétnì bude obsahovat pouze jedinou
instrukci <strong>RET0</strong>, kterou jsme si popsali <a href="#k04">ve
ètvrté kapitole</a>:</p>

<pre>
<i>-- BYTECODE -- test01.lua:0-11</i>
0001    <strong>RET0</strong>     0   1   <i>; návrat z programu</i>
</pre>

<p></p>



<p><a name="k06"></a></p>
<h2 id="k06">6. Demonstraèní pøíklad èíslo 2: automatické pøiøazení hodnoty <strong>nil</strong> k&nbsp;nìkolika promìnným</h2>

<p>Druhý demonstraèní pøíklad je takté¾ velmi jednoduchý, proto¾e obsahuje
pouze definici ètyø promìnných nazvaných <strong>a</strong>,
<strong>b</strong>, <strong>c</strong> a <strong>d</strong>. Tyto promìnné jsou
lokální v&nbsp;rámci aktuálnì zpracovávaného modulu. Lokální promìnné, kterým
není explicitnì pøiøazena jiná hodnota, jsou implicitnì inicializovány na
hodnotu <strong>nil</strong>:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 2</i>
<i>--</i>
<i>-- Automatické pøiøazení hodnoty nil k nìkolika promìnným.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>-- ètyøi automaticky inicializované promìnné</i>
<strong>local</strong> a
<strong>local</strong> b
<strong>local</strong> c
<strong>local</strong> d
&nbsp;
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>

<p>Pøeklad tohoto demonstraèního pøíkladu do IR mù¾e být ponìkud pøekvapivý,
proto¾e zde je inicializace v¹ech ètyø promìnných zaji¹tìna jedinou instrukcí
<strong>KNIL</strong>. Pøekladaè zde vyu¾il faktu, ¾e se v¹echny promìnné
nachází ve zdrojovém kódu za sebou a pøiøadil jim po sobì jdoucí sloty 0 a¾
3:</p>

<pre>
<i>-- BYTECODE -- test02.lua:0-14</i>
0001    <strong>KNIL</strong>     0   3   <i>; ulo¾it hodnotu <strong>nil</strong> do slotù 0 a¾ 3 (vèetnì)</i>
0002    <strong>RET0</strong>     0   1   <i>; návrat z programu</i>
</pre>



<p><a name="k07"></a></p>
<h2 id="k07">7. Demonstraèní pøíklad èíslo 3: explicitní pøiøazení hodnot k&nbsp;nìkolika promìnným</h2>

<p>Dne¹ní tøetí demonstraèní pøíklad se do znaèné míry podobá pøíkladu druhému,
ov¹em s&nbsp;tím rozdílem, ¾e zde je deklarováno ¹est promìnných a ka¾dé
promìnné je pøiøazena explicitní hodnota:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 3</i>
<i>--</i>
<i>-- Explicitní pøiøazení hodnot k nìkolika promìnným.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>-- ¹est explicitnì inicializovaných promìnných</i>
<strong>local</strong> a = nil
<strong>local</strong> b = 0
<strong>local</strong> c = 42
<strong>local</strong> d = 42*42
<strong>local</strong> e = 42*42*42
<strong>local</strong> f = 42*42*42*42
&nbsp;
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>

<p>Pøeklad tøetího demonstraèního pøíkladu do IR je opìt ponìkud zvlá¹tní.
Pøedev¹ím pøekvapí absence instrukce <strong>KNIL</strong>, která byla pou¾ita
v&nbsp;pøíkladu druhém. Ve skuteènosti se v&nbsp;LuaJITu pou¾ije instrukce
<strong>KNIL</strong> pouze v&nbsp;pøípadì, ¾e je nutné inicializovat na
hodnotu <strong>nil</strong> vìt¹í poèet promìnných, nejenom promìnnou jedinou.
Namísto <strong>KNIL</strong> je zde pou¾ita instrukce <strong>KPRI</strong>.
Pro pøiøazení hodnot 0, 42 a 1764 je v&nbsp;IR vyu¾ita instrukce
<strong>KSHORT</strong>, která obsahuje pøíslu¹nou celoèíselnou konstantu pøímo
ve svém instrukèním slovu, co¾ je zajisté výhodné z&nbsp;hlediska délky IR i
pøípadných optimalizací. Ov¹em ji¾ hodnota 74088 je tak velká, ¾e se namísto
instrukce <strong>KSHORT</strong> pou¾ívá instrukce <strong>KNUM</strong>,
která se odkazuje do tabulky konstant:</p>

<pre>
<i>-- BYTECODE -- test03.lua:0-16</i>
0001    <strong>KPRI</strong>     0   0   <i>; do slotu èíslo 0 ulo¾it hodnotu <strong>nil</strong></i>
0002    <strong>KSHORT</strong>   1   0   <i>; do slotu èíslo 1 ulo¾it hodnotu 0</i>
0003    <strong>KSHORT</strong>   2  42   <i>; do slotu èíslo 2 ulo¾it hodnotu 0</i>
0004    <strong>KSHORT</strong>   3 1764  <i>; do slotu èíslo 3 ulo¾it hodnotu 42&times;42=1764</i>
0005    <strong>KNUM</strong>     4   0   <i>; do slotu èíslo 4 ulo¾it hodnotu 42&times;42&times;42=74088 z&nbsp;tabulky konstant</i>
0006    <strong>KNUM</strong>     5   1   <i>; do slotu èíslo 4 ulo¾it hodnotu 42&times;42&times;42&times;42=3111696 z&nbsp;tabulky konstant</i>
0007    <strong>RET0</strong>     0   1   <i>; návrat z programu</i>
</pre>



<p><a name="k08"></a></p>
<h2 id="k08">8. Demonstraèní pøíklad èíslo 4: volání (builtin) funkce</h2>

<p>Ve ètvrtém pøíkladu je ukázán zpùsob volání funkce, a to konkrétnì funkce
<strong>print()</strong> bez parametrù. Samotný zdrojový kód tohoto
demonstraèního pøíkladu je primitivní:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 4</i>
<i>--</i>
<i>-- Volání funkce.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>-- volání funkce</i>
print()
&nbsp;
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>

<p>V&nbsp;IR ètvrtého demonstraèního pøíkladu mù¾eme vidìt dvì instrukce, o
nich¾ jsme se zmínili <a href="#k04">ve ètvrté kapitole</a>. Jedná se o
instrukci <strong>GGET</strong>, která pøeète z&nbsp;globální tabulky
<strong>_G[]</strong> referenci na funkci <strong>print()</strong> a ulo¾í ji
do zvoleného slotu (zde slotu èíslo 0). Následnì je pou¾ita instrukce
<strong>CALL</strong>, která zavolá funkci, její¾ reference je ulo¾ena do slotu
èíslo 0. Operand B má hodnotu 1 a operand C má takté¾ hodnotu 1. Tyto hodnoty
znamenají: poèet parametrù volané funkce = (C-A)-1 = 0, poèet návratových
hodnot volané funkce = (B-A)-1 = 0:</p>

<pre>
<i>-- BYTECODE -- test04.lua:0-11</i>
0001    <strong>GGET</strong>     0   0      <i>; získání reference na funkci se jménem  "print"</i>
0002    <strong>CALL</strong>     0   1   1  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0003    <strong>RET0</strong>     0   1      <i>; návrat z programu</i>
</pre>



<p><a name="k09"></a></p>
<h2 id="k09">9. Demonstraèní pøíklad èíslo 5: volání funkce s&nbsp;pøedáním parametru</h2>

<p>Syntézou pøedchozích dvou demonstraèních pøíkladù vznikl poslední dnes
uvádìný demonstraèní pøíklad, v&nbsp;nìm¾ je nejprve inicializováno ¹est
promìnných a následnì jsou tyto promìnné pøedány do volané funkce
<strong>print()</strong>:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 5</i>
<i>--</i>
<i>-- Volání funkce s pøedáním parametru.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>-- inicializace promìnných</i>
<strong>local</strong> a = nil
<strong>local</strong> b = 0
<strong>local</strong> c = 42
<strong>local</strong> d = 42*42
<strong>local</strong> e = 42*42*42
<strong>local</strong> f = 42*42*42*42
&nbsp;
<i>-- volání funkci s pou¾itím rùzných parametru</i>
print(a)
print(b)
print(c)
print(d)
print(e)
print(f,a)
&nbsp;
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>

<p>Pøekladem pátého demonstraèního pøíkladu do IR se opìt dozvíme novou
informaci o vlastnostech LuaJITu. Tentokrát se setkáme s&nbsp;instrukcí
<strong>MOV</strong>, která zde poslou¾í k&nbsp;pøípravì parametrù volané
funkce <strong>print()</strong>, proto¾e parametry musí být umístìny do
slotu/slotù umístìných ihned za slotem obsahujícím referenci volané funkce:</p>

<pre>
<i>-- BYTECODE -- test05.lua:0-23</i>
0001    <strong>KPRI</strong>     0   0   <i>; do slotu èíslo 0 ulo¾it hodnotu <strong>nil</strong></i>
0002    <strong>KSHORT</strong>   1   0   <i>; do slotu èíslo 1 ulo¾it hodnotu 0</i>
0003    <strong>KSHORT</strong>   2  42   <i>; do slotu èíslo 2 ulo¾it hodnotu 0</i>
0004    <strong>KSHORT</strong>   3 1764  <i>; do slotu èíslo 3 ulo¾it hodnotu 42&times;42=1764</i>
0005    <strong>KNUM</strong>     4   0   <i>; do slotu èíslo 4 ulo¾it hodnotu 42&times;42&times;42=74088 z&nbsp;tabulky konstant</i>
0006    <strong>KNUM</strong>     5   1   <i>; do slotu èíslo 4 ulo¾it hodnotu 42&times;42&times;42&times;42=3111696 z&nbsp;tabulky konstant</i>
&nbsp;
0007    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0008    <strong>MOV</strong>      7   0      <i>; jediným parametrem funkce je hodnota promìnné "a" (slot 0)</i>
0009    <strong>CALL</strong>     6   1   2  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0010    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0011    <strong>MOV</strong>      7   1      <i>; jediným parametrem funkce je hodnota promìnné "b" (slot 1)</i>
0012    <strong>CALL</strong>     6   1   2  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0013    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0014    <strong>MOV</strong>      7   2      <i>; jediným parametrem funkce je hodnota promìnné "c" (slot 2)</i>
0015    <strong>CALL</strong>     6   1   2  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0016    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0017    <strong>MOV</strong>      7   3      <i>; jediným parametrem funkce je hodnota promìnné "d" (slot 3)</i>
0018    <strong>CALL</strong>     6   1   2  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0019    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0020    <strong>MOV</strong>      7   4      <i>; jediným parametrem funkce je hodnota promìnné "e" (slot 4)</i>
0021    <strong>CALL</strong>     6   1   2  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0022    <strong>GGET</strong>     6   0      <i>; získání reference na funkci se jménem  "print", ulo¾ení do slotu 6</i>
0023    <strong>MOV</strong>      7   5      <i>; prvním parametrem funkce je hodnota promìnné "f" (slot 5)</i>
0024    <strong>MOV</strong>      8   0      <i>; druhým parametrem funkce je hodnota promìnné "a" (slot 0)</i>
0025    <strong>CALL</strong>     6   1   3  <i>; volání funkce <strong>print()</strong></i>
&nbsp;
0026    <strong>RET0</strong>     0   1      <i>; návrat z programu</i>
</pre>



<p><a name="k10"></a></p>
<h2 id="k10">10. Obsah následující èásti seriálu</h2>

<p>V&nbsp;následující èásti <a
href="http://www.root.cz/serialy/programovaci-jazyk-java-a-jvm/">tohoto
seriálu</a> si popí¹eme zpùsob pøekladu aritmetických a logických výrazù do
mezijazyka LuaJITu. Kromì toho se takté¾ budeme zabývat instrukcemi IR, které
slou¾í pro implementaci podmínek a skokù. Tyto instrukce jsou pou¾ity jak pøi
vìtvení (programové konstrukce typu <i>if-then</i>, <i>if-then-else</i> atd.),
tak i pøi pøekladu programových smyèek (<i>for</i>, <i>while</i> a relativnì
málo pou¾ívané smyèky typu <i>repeat-until</i>).</p>



<p><a name="k11"></a></p>
<h2 id="k11">11. Repositáø se zdrojovými kódy dne¹ních pìti demonstraèních pøíkladù</h2>

<p>V¹ech pìt dnes popsaných a takté¾ &bdquo;disasemblovaných&ldquo;
demonstraèních pøíkladù bylo ulo¾eno do Git repositáøe umístìného na adrese <a
href="https://github.com/tisnik/luajit-examples">https://github.com/tisnik/luajit-examples</a>.
Odkazy na prozatím poslední verze tìchto pìti pøíkladù naleznete v&nbsp;tabulce
umístìné pod tímto odstavcem:</p>

<table>
<tr><th> #</th><th>Zdrojový kód</th><th>Umístìní</th></tr>
<tr><td> 1</td><td>test01.lua</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test01.lua">https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test01.lua</a></td></tr>
<tr><td> 2</td><td>test02.lua</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test02.lua">https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test02.lua</a></td></tr>
<tr><td> 3</td><td>test03.lua</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test03.lua">https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test03.lua</a></td></tr>
<tr><td> 4</td><td>test04.lua</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test04.lua">https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test04.lua</a></td></tr>
<tr><td> 5</td><td>test05.lua</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test05.lua">https://raw.githubusercontent.com/tisnik/luajit-examples/master/src/test05.lua</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 6</td><td>test01.asm</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test01.asm">https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test01.asm</a></td></tr>
<tr><td> 7</td><td>test02.asm</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test02.asm">https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test02.asm</a></td></tr>
<tr><td> 8</td><td>test03.asm</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test03.asm">https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test03.asm</a></td></tr>
<tr><td> 9</td><td>test04.asm</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test04.asm">https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test04.asm</a></td></tr>
<tr><td>10</td><td>test05.asm</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test05.asm">https://raw.githubusercontent.com/tisnik/luajit-examples/master/asm/test05.asm</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>11</td><td>Makefile</td><td><a href="https://raw.githubusercontent.com/tisnik/luajit-examples/master/Makefile">https://raw.githubusercontent.com/tisnik/luajit-examples/master/Makefile</a></td></tr>
</table>



<p><a name="k12"></a></p>
<h2 id="k12">12. Odkazy na Internetu</h2>

<ol>

<li>Wikipedia: Mezijazyk<br />
<a href="http://cs.wikipedia.org/wiki/Mezijazyk">http://cs.wikipedia.org/wiki/Mezijazyk</a>
</li>

<li>The LuaJIT Project<br />
<a href="http://luajit.org/index.html">http://luajit.org/index.html</a>
</li>

<li>LuaJIT FAQ<br />
<a href="http://luajit.org/faq.html">http://luajit.org/faq.html</a>
</li>

<li>LuaJIT Performance Comparison<br />
<a href="http://luajit.org/performance.html">http://luajit.org/performance.html</a>
</li>

<li><li>LuaJIT 2.0 intellectual property disclosure and research opportunities<br />
<a href="http://article.gmane.org/gmane.comp.lang.lua.general/58908">http://article.gmane.org/gmane.comp.lang.lua.general/58908</a>
</li>

<li>LuaJIT Wiki<br />
<a href="http://wiki.luajit.org/Home">http://wiki.luajit.org/Home</a>
</li>

<li>LuaJIT 2.0 Bytecode Instructions<br />
<a href="http://wiki.luajit.org/Bytecode-2.0">http://wiki.luajit.org/Bytecode-2.0</a>
</li>

<li>Programming in Lua 9.1 &ndash; Coroutine Basics,<br />
<a href="http://www.lua.org/pil/9.1.html">http://www.lua.org/pil/9.1.html</a>
</li>

<li>Programming in Lua (first edition)<br />
<a href="http://www.lua.org/pil/contents.html">http://www.lua.org/pil/contents.html</a>
</li>

<li>Programming in Lua: 6 - More about Functions<br />
<a href="http://www.lua.org/pil/6.html">http://www.lua.org/pil/6.html</a>
</li>

<li>Lua Lanes,<br />
<a href="http://kotisivu.dnainternet.net/askok/bin/lanes/">http://kotisivu.dnainternet.net/askok/bin/lanes/</a>
</li>

<li>Programming in Lua: 6.1 - Closures<br />
<a href="http://www.lua.org/pil/6.1.html">http://www.lua.org/pil/6.1.html</a>
</li>

<li>Programming in Lua: 9.1 - Coroutine Basics<br />
<a href="http://www.lua.org/pil/9.1.html">http://www.lua.org/pil/9.1.html</a>
</li>

<li>Programming in Lua: Numeric for<br />
<a href="http://www.lua.org/pil/4.3.4.html">http://www.lua.org/pil/4.3.4.html</a>
</li>

<li>Programming in Lua: break and return<br />
<a href="http://www.lua.org/pil/4.4.html">http://www.lua.org/pil/4.4.html</a>
</li>

<li>Programming in Lua: Tables<br />
<a href="http://www.lua.org/pil/2.5.html">http://www.lua.org/pil/2.5.html</a>
</li>

<li>Programming in Lua: Table Constructors<br />
<a href="http://www.lua.org/pil/3.6.html">http://www.lua.org/pil/3.6.html</a>
</li>

<li>Programovací jazyk Lua<br />
<a href="http://palmknihy.cz/web/kniha/programovaci-jazyk-lua-12651.htm">http://palmknihy.cz/web/kniha/programovaci-jazyk-lua-12651.htm</a>
</li>

<li>Lua: Tables Tutorial<br />
<a href="http://lua-users.org/wiki/TablesTutorial">http://lua-users.org/wiki/TablesTutorial</a>
</li>

<li>Lua: Control Structure Tutorial<br />
<a href="http://lua-users.org/wiki/ControlStructureTutorial">http://lua-users.org/wiki/ControlStructureTutorial</a>
</li>

<li>Lua Types Tutorial<br />
<a href="http://lua-users.org/wiki/LuaTypesTutorial">http://lua-users.org/wiki/LuaTypesTutorial</a>
</li>

<li>Goto Statement in Lua<br />
<a href="http://lua-users.org/wiki/GotoStatement">http://lua-users.org/wiki/GotoStatement</a>
</li>

<li>Lua 5.2 sources<br />
<a href="http://www.lua.org/source/5.2/">http://www.lua.org/source/5.2/</a>
</li>

<li>Lua 5.2 sources - lopcodes.h<br />
<a href="http://www.lua.org/source/5.2/lopcodes.h.html">http://www.lua.org/source/5.2/lopcodes.h.html</a>
</li>

<li>Lua 5.2 sources - lopcodes.c<br />
<a href="http://www.lua.org/source/5.2/lopcodes.c.html">http://www.lua.org/source/5.2/lopcodes.c.html</a>
</li>

<li>Lambda the Ultimate: Coroutines in Lua,<br />
<a href="http://lambda-the-ultimate.org/node/438">http://lambda-the-ultimate.org/node/438</a>
</li>

<li>Coroutines Tutorial,<br />
<a href="http://lua-users.org/wiki/CoroutinesTutorial">http://lua-users.org/wiki/CoroutinesTutorial</a>
</li>

<li>Lua Coroutines Versus Python Generators,<br />
<a href="http://lua-users.org/wiki/LuaCoroutinesVersusPythonGenerators">http://lua-users.org/wiki/LuaCoroutinesVersusPythonGenerators</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2014</small></p>
</body>
</html>

