<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua (4)</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua (4)</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>Ètvrtá èást èlánku o Just in Time pøekladaèi nazvaném LuaJIT bude vìnována problematice volání funkcí, pøedávání parametrù do funkcí a takté¾ zpùsobu vracení hodnoty èi vìt¹ího mno¾ství hodnot z volaných funkcí. Seznámíme se i s dal¹ími instrukcemi mezijazyka vyu¾ívaného LuaJITem.</p>



<h2>Obsah</h2>

<p><a href="#k01">1. LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua (4)</a></p>
<p><a href="#k02">2. Volání funkci, pøedávání parametrù a vracení hodnot z volaných funkcí v IR LuaJITu</a></p>
<p><a href="#k03">3. Demonstraèní pøíklad <strong>test19.lua</strong>: volání funkce print() s pøedáním rùzného poètu parametrù</a></p>
<p><a href="#k031">&nbsp;&nbsp;3.1 Zdrojový kód pøíkladu <strong>test19.lua</strong></a></p>
<p><a href="#k032">&nbsp;&nbsp;3.2 Pøeklad pøíkladu <strong>test19.lua</strong> do mezijazyka LuaJITu</a></p>
<p><a href="#k04">4. Demonstraèní pøíklad <strong>test20.lua</strong>: pøeklad a volání u¾ivatelských funkcí</a></p>
<p><a href="#k041">&nbsp;&nbsp;4.1 Zdrojový kód pøíkladu <strong>test20.lua</strong></a></p>
<p><a href="#k042">&nbsp;&nbsp;4.2 Pøeklad pøíkladu <strong>test20.lua</strong> do mezijazyka LuaJITu</a></p>
<p><a href="#k05">5. Demonstraèní pøíklad <strong>test21.lua</strong>: volání &bdquo;statických metod&ldquo;</a></p>
<p><a href="#k051">&nbsp;&nbsp;5.1 Zdrojový kód pøíkladu <strong>test21.lua</strong></a></p>
<p><a href="#k052">&nbsp;&nbsp;5.2 Pøeklad pøíkladu <strong>test21.lua</strong> do mezijazyka LuaJITu</a></p>
<p><a href="#k06">6. Demonstraèní pøíklad <strong>test22.lua</strong>: volání &bdquo;metod&ldquo;</a></p>
<p><a href="#k061">&nbsp;&nbsp;6.1 Zdrojový kód pøíkladu <strong>test22.lua</strong></a></p>
<p><a href="#k062">&nbsp;&nbsp;6.2 Pøeklad pøíkladu <strong>test22.lua</strong> do mezijazyka LuaJITu</a></p>
<p><a href="#k07">7. Demonstraèní pøíklad <strong>test23.lua</strong>: zpùsob vracení parametrù z&nbsp;volaných funkcí</a></p>
<p><a href="#k071">&nbsp;&nbsp;7.1 Zdrojový kód pøíkladu <strong>test23.lua</strong></a></p>
<p><a href="#k072">&nbsp;&nbsp;7.2 Pøeklad pøíkladu <strong>test23.lua</strong> do mezijazyka LuaJITu</a></p>
<p><a href="#k08">8. Repositáø se zdrojovými kódy v¹ech pìti dne¹ních demonstraèních pøíkladù</a></p>
<p><a href="#k09">9. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. LuaJIT - Just in Time pøekladaè pro programovací jazyk Lua (4)</h2>

<p>Ve ètvrté èásti èlánku o velmi zajímavém a pøitom pomìrnì jednoduchém Just
in Time pøekladaèi nazvaném <i>LuaJIT</i> se budeme zabývat problematikou
volání funkcí v&nbsp;programovacím jazyku Lua, pøesnìji øeèeno zpùsobem
pøekladu volání funkcí do mezijazyka (<i>IR</i>) vyu¾ívaného LuaJITem. Takté¾
si øekneme a na demonstraèních pøíkladech i prakticky uká¾eme, jakým zpùsobem
se do volaných funkcí pøedávají parametry a jak se naopak z&nbsp;volaných
funkcí vrací hodnota èi hodnoty do té èásti programu, z&nbsp;nìho¾ je daná
funkce volána. Voláním funkcí jsme se pomìrnì podrobnì zabývali ji¾ pøi
vzájemném porovnávání bajtkódù JVM, Lua VM a Python VM, tak¾e si jen struènì
pøipomeòme, ¾e Lua, jako¾to dynamicky typovaný programovací jazyk vyhodnocuje
typy pøedávaných hodnot a¾ v&nbsp;dobì bìhu aplikace (tj.&nbsp;pøi volání
konkrétní funkce èi metody).</p>

<p>Navíc se v&nbsp;programovacím jazyku Lua nemusí pøi volání funkcí dodr¾et
pøesný poèet parametrù &ndash; nadbyteèné parametry nejsou vyu¾ity a naopak,
pokud se pøi volání uvede men¹í poèet parametrù, ne¾ by odpovídalo poètu
argumentù volané funkce (uvedené v&nbsp;její hlavièce), jsou tyto argumenty
automaticky nastaveny na hodnotu <strong>nil</strong>. Aby byla situace je¹tì
ponìkud komplikovanìj¹í, je v&nbsp;Lua mo¾né, aby funkce vracely více ne¾ jednu
hodnotu a z&nbsp;funkcí lze i s&nbsp;(na)vázanými promìnnými vytvoøit <i>uzávìr
(closure)</i>.</p>



<p><a name="k02"></a></p>
<h2 id="k02">2. Volání funkci, pøedávání parametrù a vracení hodnot z volaných funkcí v IR LuaJITu</h2>

<p>V&nbsp;demonstraèních pøíkladech, které budou popsány v&nbsp;navazujících
kapitolách, se pøi jejich pøekladu do mezijazyka LuaJITu vyskytuje vìt¹í
mno¾ství nových èi novì pou¾itých instrukcí. Tyto instrukce jsou struènì
popsány v&nbsp;tabulce pod tímto odstavcem:</p>

<table>
<tr><th>#</th><th>Instrukce</th><th>Operandy</th><th>Popis</th></tr>
<tr><td> 1</td><td>GSET </td><td>var, str      </td><td>ulo¾ení nové polo¾ky do globální tabulky _G, pou¾ito pøi deklaraci funkcí</td></tr>
<tr><td> 2</td><td>GGET </td><td>dst, str      </td><td>pøeètení polo¾ky z globální tabulky _G, pou¾ito pøed voláním funkcí</td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 3</td><td>FNEW </td><td>dst, func     </td><td>vytvoøení uzávìru (closure) z prototypu funkce</td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 4</td><td>CALL </td><td>base, lit, lit</td><td>volání funkce s pøedáním parametrù (standardní forma volání)</td></tr>
<tr><td> 5</td><td>CALLM</td><td>base, lit, lit</td><td>volání funkce s pøedáním parametrù (speciální forma volání)</td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 5</td><td>RET0 </td><td>A, D          </td><td>návrat z funkce bez pøedání návratového hodnoty (A a D se ignorují)</td></tr>
<tr><td> 6</td><td>RET1 </td><td>A, D          </td><td>návrat z funkce s pøedáním jedné návratové hodnoty A (D se ignoruje)</td></tr>
<tr><td> 7</td><td>RET  </td><td>A, D          </td><td>návrat z funkce s pøedáním jedné návratových hodnot A, A+1, ... A+D-2</td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 8</td><td>TNEW </td><td>A, D          </td><td>vytvoøení nové tabulky o velikosti zapsané v D</td></tr>
<tr><td> 9</td><td>TSETS</td><td>var, var, str </td><td>ulo¾ení prvku do tabulky (klíèem je øetìzec)</td></tr>
<tr><td>10</td><td>TGETS</td><td>dst, var, str </td><td>pøeètení prvku z tabulky (klíèem je øetìzec)</td></tr>
</table>



<p><a name="k03"></a></p>
<h2 id="k03">3. Demonstraèní pøíklad <strong>test19.lua</strong>: volání funkce print() s pøedáním rùzného poètu parametrù</h2>

<p>V&nbsp;dne¹ním prvním demonstraèním pøíkladu si uká¾eme, jakým zpùsobem je
mo¾né volat funkci <strong>print()</strong>, která je souèástí standardní
knihovny programovacího jazyka Lua. Tuto funkci lze volat bez parametrù &ndash;
v&nbsp;tom pøípadì se na standardní výstup jednodu¹e zapí¹e nový øádek (provede
se odøádkování). Pokud se tato funkce zavolá s&nbsp;jedním parametrem, je na
standardní výstup poslána textová reprezentace hodnoty parametru,
v&nbsp;pøípadì vìt¹ího poètu parametrù jsou tyto parametry takté¾ zkonvertovány
na text a vypsány na stejný øádek standardního výstupu. Díky tomuto chování
funkce <strong>print()</strong> si mù¾eme ukázat, jak lze volat funkci
akceptující promìnný poèet parametrù. V&nbsp;tomto pøíkladu je takté¾ vytvoøena
u¾ivatelská funkce <strong>main()</strong>, která musí být v&nbsp;dobì bìhu
programu vytvoøena z&nbsp;prototypu, následnì ulo¾ena do globální tabulky _G a
posléze zavolána.</p>



<p><a name="k031"></a></p>
<h3 id="k031">3.1 Zdrojový kód pøíkladu <strong>test19.lua</strong></h3>

<p>Zdrojový kód prvního demonstraèního pøíkladu je velmi jednoduchý:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 19</i>
<i>--</i>
<i>-- Volání funkci v programovacím jazyce Lua.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Spu¹tìní testu.</i>
<i>--</i>
<strong>function</strong> main()
    print()
    print(nil)
    print(42)
    print(1, 2)
    print("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
main()
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>



<p><a name="k032"></a></p>
<h3 id="k032">3.2 Pøeklad pøíkladu <strong>test19.lua</strong> do mezijazyka LuaJITu</h3>

<p>V&nbsp;sekvenci instrukcí vzniklých pøelo¾ením pøíkladu
<strong>test19.lua</strong> do mezijazyka LuaJITu mù¾eme najít volání funkce
<strong>print()</strong> realizované instrukcemi <strong>GGET</strong> a
<strong>CALL</strong>. První z&nbsp;tìchto instrukcí naète reference na funkci
z&nbsp;globální tabulky _G, druhá instrukce obstará volání:</p>

<pre>
<i>; Pøeklad demonstraèního pøíkladu test19.lua</i>
<i>; do IR vyu¾ívaného virtuálním strojem a JIT</i>
<i>; pøekladaèem LuaJIT.</i>
&nbsp;
-- BYTECODE -- test19.lua:12-18
<i>; function main()</i>
&nbsp;
<i>; print()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "print"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce print()</i>
&nbsp;
<i>; print(nil)</i>
0003    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "print"</i>
0004    <strong>KPRI</strong>     1   0        <i>; ulo¾ení primitivní hodnoty nil do slotu èíslo 1</i>
0005    <strong>CALL</strong>     0   1   2    <i>; volání funkce print()</i>
&nbsp;
<i>; print(42)</i>
0006    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "print"</i>
0007    <strong>KSHORT</strong>   1  42        <i>; ulo¾ení numerické hodnoty 42 do slotu èíslo 1</i>
0008    <strong>CALL</strong>     0   1   2    <i>; volání funkce print()</i>
&nbsp;
<i>; print(1,2)</i>
0009    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "print"</i>
0010    <strong>KSHORT</strong>   1   1        <i>; ulo¾ení numerické hodnoty 1 do slotu èíslo 1</i>
0011    <strong>KSHORT</strong>   2   2        <i>; ulo¾ení numerické hodnoty 2 do slotu èíslo 2</i>
0012    <strong>CALL</strong>     0   1   3    <i>; volání funkce print()</i>
&nbsp;
<i>; print("xyzzy")</i>
0013    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "print"</i>
0014    <strong>KSTR</strong>     1   1        <i>; ulo¾ení reference na øetìzec "xyzzy" do slotu èíslo 1</i>
0015    <strong>CALL</strong>     0   1   2    <i>; volání funkce print()</i>
&nbsp;
0016    <strong>RET0</strong>     0   1        <i>; návrat z funkce main</i>
</pre>

<p>Dùle¾itá je i sekvence instrukcí pou¾itá pro vytvoøení a registraci funkce
<strong>main()</strong>. Najdeme zde pøedev¹ím dvì instrukce
<strong>FNEW</strong> a <strong>GSET</strong>, kde první instrukce vytvoøí
uzávìr z&nbsp;prototypu funkce a druhá instrukce ulo¾í tento uzávìr do globální
tabulky _G:</p>

<pre>
-- BYTECODE -- test19.lua:0-27
&nbsp;
<i>; main()</i>
<i>; vytvoøení, "registrace" a následné volání funkce main()</i>
0001    <strong>FNEW</strong>     0   0        <i>; vytvoøení uzávìru tvoøeného funkcí "main" s ulo¾ením do slotu èíslo 0</i>
0002    <strong>GSET</strong>     0   1        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "main"</i>
0003    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "main"</i>
0004    <strong>CALL</strong>     0   1   1    <i>; zavolání funkce main()</i>
0005    <strong>RET0</strong>     0   1        <i>; návrat z programu</i>
&nbsp;
<i>; konec</i>
</pre>



<p><a name="k04"></a></p>
<h2 id="k04">4. Demonstraèní pøíklad <strong>test20.lua</strong>: pøeklad a volání u¾ivatelských funkcí</h2>

<p>Dne¹ní druhý demonstraèní pøíklad, který je nazvaný
<strong>test20.lua</strong>, je, podobnì jako pøíklad pøedchozí, stále velmi
jednoduchý. Jsou v&nbsp;nìm implementovány funkce se jmény
<strong>function1()</strong>, <strong>function2()</strong> a
<strong>function3()</strong>, pøièem¾ první funkce pojmenovaná
<strong>function1()</strong> neoèekává ¾ádné argumenty, funkce se jménem
<strong>function2()</strong> oèekává jeden argument a koneènì funkce
<strong>function3()</strong> oèekává dva argumenty, které jsou seèteny
(v&nbsp;pøípadì, ¾e argumenty nejsou typu celé èi reálné èíslo, vznikne pøi
bìhu programu chyba, to v¹ak pøi pøekladu do IR neuvidíme). V¹echny tøi zmínìné
funkce jsou volány z&nbsp;kódu, který je implementován v&nbsp;dal¹í trojici
funkcí nazvaných <strong>callFunction1()</strong>,
<strong>callFunction2()</strong> a <strong>callFunction3()</strong>. Pov¹imnìte
si, ¾e se nikde nekontroluje ani poèet ani typ skuteènì pøedávaných parametrù,
co¾ je pro jazyk Lua a souèasnì i pro nìkolik dal¹ích dynamicky typovaných
programovacích jazykù typická vlastnost:</p>



<p><a name="k041"></a></p>
<h3 id="k041">4.1 Zdrojový kód pøíkladu <strong>test20.lua</strong></h3>

<p>Podívejme se na zdrojový kód demonstraèního pøíkladu
<strong>test20.lua</strong>:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 20</i>
<i>--</i>
<i>-- Volání funkci v programovacím jazyce Lua.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce bez parametrù.</i>
<i>--</i>
<strong>function</strong> function1()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce s jedním parametrem.</i>
<i>--</i>
<strong>function</strong> function2(x)
    <strong>return</strong> x
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce se dvìma parametry.</i>
<i>--</i>
<strong>function</strong> function3(x, y)
    <strong>if</strong> x <strong>and</strong> y <strong>then</strong>
        <strong>return</strong> x+y
    <strong>else</strong>
        <strong>return</strong> nil
    <strong>end</strong>
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function1().</i>
<i>--</i>
<strong>function</strong> callFunction1()
    function1()
    function1(nil)
    function1(42)
    function3(1, 2)
    function1("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function2().</i>
<i>--</i>
<strong>function</strong> callFunction2()
    function2()
    function2(nil)
    function2(42)
    function3(1, 2)
    function2("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function3().</i>
<i>--</i>
<strong>function</strong> callFunction3()
    function3()
    function3(nil)
    function3(42)
    function3(1, 2)
    function3("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Spu¹tìní testu.</i>
<i>--</i>
<strong>function</strong> main()
    callFunction1()
    callFunction2()
    callFunction3()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
main()
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>



<p><a name="k042"></a></p>
<h3 id="k042">4.2 Pøeklad pøíkladu <strong>test20.lua</strong> do mezijazyka LuaJITu</h3>

<p>V&nbsp;pøelo¾eném pøíkladu <strong>test20.lua</strong> stojí za pov¹imnutí
nìkolik zajímavostí. Pøedev¹ím se zde nepou¾ívá jediná instrukce
<strong>RET</strong>, ale dvì rùzné instrukce <strong>RET0</strong> a
<strong>RET1</strong>. Instrukce <strong>RET0</strong> zaji¹»uje návrat
z&nbsp;volané funkce do funkce volající, ov¹em bez pøedání návratové hodnoty.
Naproti tomu instrukce <strong>RET1</strong> doká¾e do volající funkce pøedat
jednu hodnotu, konkrétnì hodnotu ulo¾enou ve slotu, jeho¾ index je ulo¾en pøímo
v&nbsp;instrukèním slovu:</p>

<pre>
<i>; Pøeklad demonstraèního pøíkladu test20.lua</i>
<i>; do IR vyu¾ívaného virtuálním strojem a JIT</i>
<i>; pøekladaèem LuaJIT.</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:12-13
<i>; function function1()</i>
&nbsp;
<i>; end</i>
0001    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
-- BYTECODE -- test20.lua:20-22
<i>; function function2(x)</i>
&nbsp;
<i>; return x</i>
0001    <strong>RET1</strong>     0   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:29-35
<i>; function function3(x, y)</i>
&nbsp;
<i>; if x and y then</i>
0001    <strong>ISF</strong>          0        <i>; test, zda není první parametr funkce false èi nil</i>
0002    <strong>JMP</strong>      2 =&gt; 0008    <i>; + podmínìný skok</i>
0003    <strong>ISF</strong>          1        <i>; test, zda není druhý parametr funkce false èi nil</i>
0004    <strong>JMP</strong>      2 =&gt; 0008    <i>; + podmínìný skok</i>
&nbsp;
<i>; return x+y</i>
0005    <strong>ADDVV</strong>    2   0   1    <i>; výpoèet návratové hodnoty</i>
0006    <strong>RET1</strong>     2   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
<i>; else</i>
0007    <strong>JMP</strong>      2 =&gt; 0010    <i>; nepodmínìný skok</i>
&nbsp;
<i>; return nil</i>
0008 =&gt; <strong>KPRI</strong>     2   0        <i>; návratová hodnota</i>
0009    <strong>RET1</strong>     2   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
0010 =&gt; <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:42-48
<i>; function callFunction1()</i>
&nbsp;
<i>; function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function1"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; function1(nil)</i>
0003    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function1"</i>
0004    <strong>KPRI</strong>     1   0
0005    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function1(42)</i>
0006    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function1"</i>
0007    <strong>KSHORT</strong>   1  42
0008    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function1(1, 2)</i>
0009    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "function1"</i>
0010    <strong>KSHORT</strong>   1   1
0011    <strong>KSHORT</strong>   2   2
0012    <strong>CALL</strong>     0   1   3    <i>; volání funkce</i>
&nbsp;
<i>; function1("xyzzy")</i>
0013    <strong>GGET</strong>     0   0        <i>; "function1"</i>
0014    <strong>KSTR</strong>     1   2        <i>; "xyzzy"</i>
0015    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; end</i>
0016    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:55-61
<i>; function callFunction2()</i>
&nbsp;
<i>; function2()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function2"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; function2(nil)</i>
0003    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function2"</i>
0004    <strong>KPRI</strong>     1   0
0005    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function2(42)</i>
0006    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function2"</i>
0007    <strong>KSHORT</strong>   1  42
0008    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function2(1, 2)</i>
0009    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "function2"</i>
0010    <strong>KSHORT</strong>   1   1
0011    <strong>KSHORT</strong>   2   2
0012    <strong>CALL</strong>     0   1   3    <i>; volání funkce</i>
&nbsp;
<i>; function2("xyzzy")</i>
0013    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function2"</i>
0014    <strong>KSTR</strong>     1   2        <i>; "xyzzy"</i>
0015    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
0016    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:68-74
<i>; function callFunction3()</i>
&nbsp;
<i>; function3()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function3"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; function3(nil)</i>
0003    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function3"</i>
0004    <strong>KPRI</strong>     1   0
0005    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function3(42)</i>
0006    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function3"</i>
0007    <strong>KSHORT</strong>   1  42
0008    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
&nbsp;
<i>; function3(1, 2)</i>
0009    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function3"</i>
0010    <strong>KSHORT</strong>   1   1
0011    <strong>KSHORT</strong>   2   2
0012    <strong>CALL</strong>     0   1   3    <i>; volání funkce</i>
&nbsp;
<i>; function3("xyzzy")</i>
0013    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "function3"</i>
0014    <strong>KSTR</strong>     1   1        <i>; "xyzzy"</i>
0015    <strong>CALL</strong>     0   1   2    <i>; volání funkce</i>
0016    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:81-85
<i>; function main()</i>
&nbsp;
<i>; callFunction1()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "callFunction1"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction2()</i>
0003    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "callFunction2"</i>
0004    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction3()</i>
0005    <strong>GGET</strong>     0   2        <i>; získání reference na funkci se jménem "callFunction3"</i>
0006    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; end</i>
0007    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test20.lua:0-94
&nbsp;
<i>; main()</i>
<i>; vytvoøení, "registrace" a následné volání funkce main()</i>
0001    <strong>FNEW</strong>     0   0        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:12</i>
0002    <strong>GSET</strong>     0   1        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function1"</i>
&nbsp;
0003    <strong>FNEW</strong>     0   2        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:20</i>
0004    <strong>GSET</strong>     0   3        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function2"</i>
&nbsp;
0005    <strong>FNEW</strong>     0   4        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:29</i>
0006    <strong>GSET</strong>     0   5        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function3"</i>
&nbsp;
0007    <strong>FNEW</strong>     0   6        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:42</i>
0008    <strong>GSET</strong>     0   7        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction1"</i>
&nbsp;
0009    <strong>FNEW</strong>     0   8        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:55</i>
0010    <strong>GSET</strong>     0   9        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction2"</i>
&nbsp;
0011    <strong>FNEW</strong>     0  10        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:68</i>
0012    <strong>GSET</strong>     0  11        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction3"</i>
&nbsp;
0013    <strong>FNEW</strong>     0  12        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test20.lua:81</i>
0014    <strong>GSET</strong>     0  13        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "main"</i>
&nbsp;
0015    <strong>GGET</strong>     0  13        <i>; získání reference na funkci se jménem "main"</i>
0016    <strong>CALL</strong>     0   1   1    <i>; zavolání funkce main()</i>
&nbsp;
0017    <strong>RET0</strong>     0   1        <i>; návrat z programu</i>
&nbsp;
<i>; konec</i>
</pre>



<p><a name="k05"></a></p>
<h2 id="k05">5. Demonstraèní pøíklad <strong>test21.lua</strong>: volání &bdquo;statických metod&ldquo;</h2>

<p>Díky tomu, ¾e funkce jsou v&nbsp;programovacím jazyku Lua plnohodnotným
datovým typem, je mo¾né odkazy/reference na funkce vkládat i do tabulek (co¾ je
vlastnì jediný strukturovaný datový typ tohoto jazyka). Tímto zpùsobem je mo¾né
v&nbsp;Lue vytvoøit objekty, pøièem¾ funkce vlo¾ené do tabulek lze chápat jako
obdobu &bdquo;statických metod&ldquo;. &bdquo;Statické metody&ldquo; jsou bì¾né
funkce, pøi jejich¾ deklaraci je mezi jménem tabulky a jménem funkce pou¾ita
teèka, která je té¾ pou¾ita pøi volání této funkce. Podívejme se na pøíklad
<strong>test21.lua</strong>, který je pøímo odvozen od dne¹ního druhého
pøíkladu <strong>test20.lua</strong> a¾ na ten rozdíl, ¾e pùvodní funkce
<strong>function1()</strong>, <strong>function2()</strong> a
<strong>function3()</strong> jsou ulo¾eny do tabulky nazvané
<strong>testClass</strong>.</p>



<p><a name="k051"></a></p>
<h3 id="k051">5.1 Zdrojový kód pøíkladu <strong>test21.lua</strong></h3>

<pre>
<i>--</i>
<i>-- demonstraèní pøíklad èíslo 21.</i>
<i>--</i>
<i>-- Volání "statických metod" v programovacím jazyce Lua.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
testClass = {}
&nbsp;
<i>--</i>
<i>-- Funkce/statická metoda bez parametrù.</i>
<i>--</i>
<strong>function</strong> testClass.function1()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce/statická metoda s jedním parametrem.</i>
<i>--</i>
<strong>function</strong> testClass.function2(x)
    <strong>return</strong> x
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce/statická metoda se dvìma parametry.</i>
<i>--</i>
<strong>function</strong> testClass.function3(x, y)
    <strong>if</strong> x <strong>and</strong> y <strong>then</strong>
        <strong>return</strong> x+y
    <strong>else</strong>
        <strong>return</strong> nil
    <strong>end</strong>
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkcí/statických metod.</i>
<i>--</i>
<strong>function</strong> callFunction1()
    testClass.function1()
    testClass.function1(nil)
    testClass.function1(42)
    testClass.function3(1, 2)
    testClass.function1("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function2().</i>
<i>--</i>
<strong>function</strong> callFunction2()
    testClass.function2()
    testClass.function2(nil)
    testClass.function2(42)
    testClass.function3(1, 2)
    testClass.function2("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function3().</i>
<i>--</i>
<strong>function</strong> callFunction3()
    testClass.function3()
    testClass.function3(nil)
    testClass.function3(42)
    testClass.function3(1, 2)
    testClass.function3("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Spu¹tìní testu.</i>
<i>--</i>
<strong>function</strong> main()
    callFunction1()
    callFunction2()
    callFunction3()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
main()
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Finito.</i>
<i>--</i>
</pre>



<p><a name="k052"></a></p>
<h3 id="k052">5.2 Pøeklad pøíkladu <strong>test21.lua</strong> do mezijazyka LuaJITu</h3>

<p>V&nbsp;sekvenci instrukcí pøelo¾eného demonstraèního pøíkladu
<strong>test21.lua</strong> mù¾eme mj.&nbsp;vidìt následující trojici instrukcí
pou¾itou pro zavolání vybrané statické metody:</p>

<pre>
<i>; testClass.function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0003    <strong>CALL</strong>     0   1   1    <i>; volání funkce/metody</i>
</pre>

<p>Z&nbsp;této sekvence je patrné, ¾e se nejdøíve získá reference na tabulku
nazvanou "testClass" z&nbsp;globální tabulky _G a následnì se pøeète reference
na vybranou funkci. Pro ètení z&nbsp;obou tabulek se pou¾ívají klíèe, které
jsou typu øetìzec. Tato funkce je následnì zavolána.</p>

<pre>
<i>; Pøeklad demonstraèního pøíkladu test21.lua</i>
<i>; do IR vyu¾ívaného virtuálním strojem a JIT</i>
<i>; pøekladaèem LuaJIT.</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:14-15
<i>; function testClass.function1()</i>
&nbsp;
<i>; end</i>
0001    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:22-24
<i>; function testClass.function2()</i>
&nbsp;
<i>; return x</i>
0001    <strong>RET1</strong>     0   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:31-37
<i>; function testClass.function3(x, y)</i>
&nbsp;
<i>; if x and y then</i>
0001    <strong>ISF</strong>          0        <i>; test, zda není první parametr funkce false èi nil</i>
0002    <strong>JMP</strong>      2 =&gt; 0008    <i>; + podmínìný skok</i>
0003    <strong>ISF</strong>          1        <i>; test, zda není druhý parametr funkce false èi nil</i>
0004    <strong>JMP</strong>      2 =&gt; 0008    <i>; + podmínìný skok</i>
&nbsp;
<i>; return x+y</i>
0005    <strong>ADDVV</strong>    2   0   1    <i>; výpoèet návratové hodnoty</i>
0006    <strong>RET1</strong>     2   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
<i>; else</i>
0007    <strong>JMP</strong>      2 =&gt; 0010    <i>; nepodmínìný skok</i>
&nbsp;
<i>; return nil</i>
0008 =&gt; <strong>KPRI</strong>     2   0        <i>; návratová hodnota</i>
0009    <strong>RET1</strong>     2   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
0010 =&gt; <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:44-50
<i>; function callFunction1()</i>
&nbsp;
<i>; testClass.function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0003    <strong>CALL</strong>     0   1   1    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(nil)</i>
0004    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0005    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0006    <strong>KPRI</strong>     1   0        <i>; parametr volané funkce - hodnota nil</i>
0007    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(42)</i>
0008    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0009    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0010    <strong>KSHORT</strong>   1  42        <i>; parametr volané funkce - hodnota 42</i>
0011    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(1, 2)</i>
0012    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0013    <strong>TGETS</strong>    0   0   2    <i>; získání reference na funkci se jménem "function1"</i>
0014    <strong>KSHORT</strong>   1   1        <i>; první parametr volané funkce - hodnota 1</i>
0015    <strong>KSHORT</strong>   2   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0016    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1("xyzzy")</i>
0017    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0018    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0019    <strong>KSTR</strong>     1   3        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0020    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0021    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:57-63
<i>; function callFunction2()</i>
&nbsp;
<i>; testClass.function2()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0003    <strong>CALL</strong>     0   1   1    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(nil)</i>
0004    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0005    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0006    <strong>KPRI</strong>     1   0        <i>; parametr volané funkce - hodnota nil</i>
0007    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(42)</i>
0008    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0009    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0010    <strong>KSHORT</strong>   1  42        <i>; parametr volané funkce - hodnota 42</i>
0011    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(1, 2)</i>
0012    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0013    <strong>TGETS</strong>    0   0   2    <i>; získání reference na funkci se jménem "function2"</i>
0014    <strong>KSHORT</strong>   1   1        <i>; první parametr volané funkce - hodnota 1</i>
0015    <strong>KSHORT</strong>   2   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0016    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2("xyzzy")</i>
0017    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0018    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0019    <strong>KSTR</strong>     1   3        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0020    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0021    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:70-76
<i>; function callFunction3()</i>
&nbsp;
<i>; testClass.function3()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0003    <strong>CALL</strong>     0   1   1    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(nil)</i>
0004    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0005    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0006    <strong>KPRI</strong>     1   0        <i>; parametr volané funkce - hodnota nil</i>
0007    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(42)</i>
0008    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0009    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0010    <strong>KSHORT</strong>   1  42        <i>; parametr volané funkce - hodnota 42</i>
0011    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(1, 2)</i>
0012    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0013    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0014    <strong>KSHORT</strong>   1   1        <i>; první parametr volané funkce - hodnota 1</i>
0015    <strong>KSHORT</strong>   2   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0016    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3("xyzzy")</i>
0017    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0018    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0019    <strong>KSTR</strong>     1   2        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0020    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0021    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:83-87
<i>; function main()</i>
&nbsp;
<i>; callFunction1()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "callFunction1"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction2()</i>
0003    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "callFunction2"</i>
0004    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction3()</i>
0005    <strong>GGET</strong>     0   2        <i>; získání reference na funkci se jménem "callFunction3"</i>
0006    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; end</i>
0007    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test21.lua:0-99
&nbsp;
<i>; main()</i>
<i>; vytvoøení, "registrace" a následné volání funkce main(), inicializace tøídy testClass</i>
0001    <strong>TNEW</strong>     0   0        <i>; vytvoøení nové tabulky</i>
0002    <strong>GSET</strong>     0   0        <i>; ulo¾ení tabulky do _G pod jménem "testClass"</i>
&nbsp;
0003    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0004    <strong>FNEW</strong>     1   2        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test21.lua:14</i>
0005    <strong>TSETS</strong>    1   0   1    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function1"</i>
&nbsp;
0006    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0007    <strong>FNEW</strong>     1   4        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test21.lua:22</i>
0008    <strong>TSETS</strong>    1   0   3    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function2"</i>
&nbsp;
0009    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0010    <strong>FNEW</strong>     1   6        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test21.lua:31</i>
0011    <strong>TSETS</strong>    1   0   5    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function3"</i>
&nbsp;
0012    <strong>FNEW</strong>     0   7        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku  test21.lua:44</i>
0013    <strong>GSET</strong>     0   8        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction1"</i>
&nbsp;
0014    <strong>FNEW</strong>     0   9        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku  test21.lua:57</i>
0015    <strong>GSET</strong>     0  10        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction2"</i>
&nbsp;
0016    <strong>FNEW</strong>     0  11        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku  test21.lua:70</i>
0017    <strong>GSET</strong>     0  12        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction3"</i>
&nbsp;
0018    <strong>FNEW</strong>     0  13        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku  test21.lua:83</i>
0019    <strong>GSET</strong>     0  14        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "main"</i>
&nbsp;
0020    <strong>GGET</strong>     0  14        <i>; získání reference na funkci se jménem "main"</i>
0021    <strong>CALL</strong>     0   1   1    <i>; zavolání funkce main()</i>
&nbsp;
0022    <strong>RET0</strong>     0   1        <i>; návrat z programu</i>
&nbsp;
<i>; konec</i>
</pre>



<p><a name="k06"></a></p>
<h2 id="k06">6. Demonstraèní pøíklad <strong>test22.lua</strong>: volání &bdquo;metod&ldquo;</h2>

<p>V&nbsp;programovacím jazyku Lua je mo¾né funkce vkládat do tabulek i
s&nbsp;vyu¾itím dvojteèky namísto teèky. Tento malý syntaktický rozdíl v¹ak
vede k&nbsp;vytvoøení sémanticky odli¹ného kódu &ndash; takto vytvoøená funkce
toti¾ bude mít navíc jeden parametr, v&nbsp;nìm¾ se pøedá odkaz na objekt, tedy
hodnota, která se v&nbsp;jiných programovacích jazycích oznaèuje klíèovým
slovem <strong>self</strong> nebo <strong>this</strong>. Odli¹né je pak i
volání takových funkcí, které lze podle jejich vlastností ji¾ nazývat
&bdquo;metodami&ldquo;.</p>



<p><a name="k061"></a></p>
<h3 id="k061">6.1 Zdrojový kód pøíkladu <strong>test22.lua</strong></h3>

<pre>
<i>--</i>
<i>-- demonstraèní pøíklad èíslo 22.</i>
<i>--</i>
<i>-- Volání "metod" v programovacím jazyce Lua.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
testClass = {}
&nbsp;
<i>--</i>
<i>-- Funkce/metoda bez parametrù.</i>
<i>--</i>
<strong>function</strong> testClass:function1()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce/metoda s jedním parametrem.</i>
<i>--</i>
<strong>function</strong> testClass:function2(x)
    <strong>return</strong> x
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce/metoda se dvìma parametry.</i>
<i>--</i>
<strong>function</strong> testClass:function3(x, y)
    <strong>if</strong> x <strong>and</strong> y <strong>then</strong>
        <strong>return</strong> x+y
    <strong>else</strong>
        <strong>return</strong> nil
    <strong>end</strong>
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function1().</i>
<i>--</i>
<strong>function</strong> callFunction1()
    testClass:function1()
    testClass:function1(nil)
    testClass:function1(42)
    testClass:function3(1, 2)
    testClass:function1("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function2().</i>
<i>--</i>
<strong>function</strong> callFunction2()
    testClass:function2()
    testClass:function2(nil)
    testClass:function2(42)
    testClass:function3(1, 2)
    testClass:function2("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Volání funkce function3().</i>
<i>--</i>
<strong>function</strong> callFunction3()
    testClass:function3()
    testClass:function3(nil)
    testClass:function3(42)
    testClass:function3(1, 2)
    testClass:function3("xyzzy")
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Spu¹tìní testu.</i>
<i>--</i>
<strong>function</strong> main()
    callFunction1()
    callFunction2()
    callFunction3()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
main()
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Finito.</i>
<i>--</i>
</pre>



<p><a name="k032"></a></p>
<h3 id="k062">6.2 Pøeklad pøíkladu <strong>test22.lua</strong> do mezijazyka LuaJITu</h3>

<p>V&nbsp;pøedchozím pøíkladu se pro zavolání statické metody pou¾íval tento
kód:</p>

<pre>
<i>; testClass.function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0003    <strong>CALL</strong>     0   1   1    <i>; volání funkce/metody</i>
</pre>

<p>Pro zavolání metody nestatické musíme zpracovat i parametr this/self:</p>

<pre>
<i>; testClass.function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0003    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0004    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
</pre>

<p>Tento rozdíl je hned nìkolikrát vidìt i v&nbsp;úplném výpisu IR:</p>

<pre>
<i>; Pøeklad demonstraèního pøíkladu test22.lua</i>
<i>; do IR vyu¾ívaného virtuálním strojem a JIT</i>
<i>; pøekladaèem LuaJIT.</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:14-15
<i>; function testClass.function1()</i>
&nbsp;
<i>; end</i>
0001    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:22-24
<i>; function testClass.function2()</i>
&nbsp;
<i>; return x</i>
0001    <strong>RET1</strong>     1   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:31-37
<i>; function testClass.function3(x, y)</i>
&nbsp;
<i>; if x and y then</i>
0001    <strong>ISF</strong>          1        <i>; test, zda není první parametr funkce false èi nil</i>
0002    <strong>JMP</strong>      3 =&gt; 0008    <i>; + podmínìný skok</i>
0003    <strong>ISF</strong>          2        <i>; test, zda není druhý parametr funkce false èi nil</i>
0004    <strong>JMP</strong>      3 =&gt; 0008    <i>; + podmínìný skok</i>
&nbsp;
<i>; return x+y</i>
0005    <strong>ADDVV</strong>    3   1   2    <i>; výpoèet návratové hodnoty</i>
0006    <strong>RET1</strong>     3   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
<i>; else</i>
0007    <strong>JMP</strong>      3 =&gt; 0010    <i>; nepodmínìný skok</i>
&nbsp;
<i>; return nil</i>
0008 =&gt; <strong>KPRI</strong>     3   0        <i>; návratová hodnota</i>
0009    <strong>RET1</strong>     3   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
0010 =&gt; <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:44-50
<i>; function callFunction1()</i>
&nbsp;
<i>; testClass.function1()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0003    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0004    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(nil)</i>
0005    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0006    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0007    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0008    <strong>KPRI</strong>     2   0        <i>; parametr volané funkce - hodnota nil</i>
0009    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(42)</i>
0010    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0011    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0012    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0013    <strong>KSHORT</strong>   2  42        <i>; parametr volané funkce - hodnota 42</i>
0014    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1(1, 2)</i>
0015    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0016    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0017    <strong>TGETS</strong>    0   0   2    <i>; získání reference na funkci se jménem "function1"</i>
0018    <strong>KSHORT</strong>   2   1        <i>; první parametr volané funkce - hodnota 1</i>
0019    <strong>KSHORT</strong>   3   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0020    <strong>CALL</strong>     0   1   4    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function1("xyzzy")</i>
0021    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0022    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0023    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function1"</i>
0024    <strong>KSTR</strong>     2   3        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0025    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0026    <strong>RET0</strong>     0   1
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:57-63
<i>; function callfunction2()</i>
&nbsp;
<i>; testClass.function2()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0003    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0004    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(nil)</i>
0005    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0006    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0007    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0008    <strong>KPRI</strong>     2   0        <i>; parametr volané funkce - hodnota nil</i>
0009    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(42)</i>
0010    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0011    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0012    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0013    <strong>KSHORT</strong>   2  42        <i>; parametr volané funkce - hodnota 42</i>
0014    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2(1, 2)</i>
0015    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0016    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0017    <strong>TGETS</strong>    0   0   2    <i>; získání reference na funkci se jménem "function2"</i>
0018    <strong>KSHORT</strong>   2   1        <i>; první parametr volané funkce - hodnota 1</i>
0019    <strong>KSHORT</strong>   3   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0020    <strong>CALL</strong>     0   1   4    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function2("xyzzy")</i>
0021    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0022    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0023    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function2"</i>
0024    <strong>KSTR</strong>     2   3        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0025    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0026    <strong>RET0</strong>     0   1
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:70-76
<i>; function callfunction3()</i>
&nbsp;
<i>; testClass.function3()</i>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0002    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0003    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0004    <strong>CALL</strong>     0   1   2    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(nil)</i>
0005    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0006    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0007    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0008    <strong>KPRI</strong>     2   0        <i>; parametr volané funkce - hodnota nil</i>
0009    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(42)</i>
0010    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0011    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0012    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0013    <strong>KSHORT</strong>   2  42        <i>; parametr volané funkce - hodnota 42</i>
0014    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3(1, 2)</i>
0015    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0016    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0017    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0018    <strong>KSHORT</strong>   2   1        <i>; první parametr volané funkce - hodnota 1</i>
0019    <strong>KSHORT</strong>   3   2        <i>; druhý parametr volané funkce - hodnota 2</i>
0020    <strong>CALL</strong>     0   1   4    <i>; volání funkce/metody</i>
&nbsp;
<i>; testClass.function3("xyzzy")</i>
0021    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass" z globální tabulky _G</i>
0022    <strong>MOV</strong>      1   0        <i>; pøi volání se pou¾ije i skrytý parametr this/self</i>
0023    <strong>TGETS</strong>    0   0   1    <i>; získání reference na funkci se jménem "function3"</i>
0024    <strong>KSTR</strong>     2   2        <i>; první parametr volané funkce - odkaz na øetìzec "xyzzy"</i>
0025    <strong>CALL</strong>     0   1   3    <i>; volání funkce/metody</i>
&nbsp;
<i>; end</i>
0026    <strong>RET0</strong>     0   1
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:83-87
<i>; function main()</i>
&nbsp;
<i>; callFunction1()</i>
0001    <strong>GGET</strong>     0   0        <i>; získání reference na funkci se jménem "callFunction1"</i>
0002    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction2()</i>
0003    <strong>GGET</strong>     0   1        <i>; získání reference na funkci se jménem "callFunction2"</i>
0004    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; callFunction3()</i>
0005    <strong>GGET</strong>     0   2        <i>; získání reference na funkci se jménem "callFunction3"</i>
0006    <strong>CALL</strong>     0   1   1    <i>; volání funkce</i>
&nbsp;
<i>; end</i>
0007    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test22.lua:0-99
&nbsp;
<i>; main()</i>
<i>; vytvoøení, "registrace" a následné volání funkce main(), inicializace tøídy testClass</i>
0001    <strong>TNEW</strong>     0   0        <i>; vytvoøení nové tabulky</i>
0002    <strong>GSET</strong>     0   0        <i>; ulo¾ení tabulky do _G pod jménem "testClass"</i>
&nbsp;
0003    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0004    <strong>FNEW</strong>     1   2        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:14</i>
0005    <strong>TSETS</strong>    1   0   1    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function1"</i>
&nbsp;
0006    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0007    <strong>FNEW</strong>     1   4        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:22</i>
0008    <strong>TSETS</strong>    1   0   3    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function2"</i>
&nbsp;
0009    <strong>GGET</strong>     0   0        <i>; pøeètení reference na tabulku "testClass"</i>
0010    <strong>FNEW</strong>     1   6        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:31</i>
0011    <strong>TSETS</strong>    1   0   5    <i>; ulo¾ení uzávìru do vybrané tabulky _G pod jménem "function3"</i>
&nbsp;
0012    <strong>FNEW</strong>     0   7        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:44</i>
0013    <strong>GSET</strong>     0   8        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction1"</i>
&nbsp;
0014    <strong>FNEW</strong>     0   9        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:57</i>
0015    <strong>GSET</strong>     0  10        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction2"</i>
&nbsp;
0016    <strong>FNEW</strong>     0  11        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:70</i>
0017    <strong>GSET</strong>     0  12        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "callFunction3"</i>
&nbsp;
0018    <strong>FNEW</strong>     0  13        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test22.lua:83</i>
0019    <strong>GSET</strong>     0  14        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "main"</i>
&nbsp;
0020    <strong>GGET</strong>     0  14        <i>; získání reference na funkci se jménem "main"</i>
0021    <strong>CALL</strong>     0   1   1    <i>; zavolání funkce main()</i>
&nbsp;
0022    <strong>RET0</strong>     0   1        <i>; návrat z programu</i>
&nbsp;
<i>; konec</i>
</pre>



<p><a name="k07"></a></p>
<h2 id="k07">7. Demonstraèní pøíklad <strong>test23.lua</strong>: zpùsob vracení parametrù z&nbsp;volaných funkcí</h2>

<p>V&nbsp;pátém a souèasnì i v&nbsp;dne¹ním posledním demonstraèním pøíkladu
nazvaném <strong>test23.lua</strong> si vysvìtlíme zpùsob vracení parametrù
z&nbsp;volaných funkcí. Takté¾ si uká¾eme, jak LuaJIT optimalizuje volání typu
<strong>print(funcX())</strong> v&nbsp;pøípadì, ¾e se z&nbsp;funkce
<strong>funcX()</strong> vrací vìt¹í poèet hodnot. Technika vyu¾ívaná LuaJITem
se v&nbsp;mnoha ohledech odli¹uje od technik, které najdeme v&nbsp;jiných
pøekladaèích popø.&nbsp;v&nbsp;odli¹ných bajtkódech.</p>



<p><a name="k071"></a></p>
<h3 id="k071">7.1 Zdrojový kód pøíkladu <strong>test23.lua</strong></h3>

<p>Nejprve si uka¾me zdrojový kód pátého demonstraèního pøíkladu, v&nbsp;nìm¾
mù¾eme vidìt deklaraci ètyø funkcí nazvaných <strong>function1</strong> a¾
<strong>function4</strong>. Funkce vrací rùzný poèet i typ parametrù. Tyto
funkce jsou následnì volány stylem <strong>print(function1())</strong>, co¾
znamená, ¾e hodnota èi hodnoty vrácené funkcí jsou ihned pøedány do dal¹í
funkce:</p>

<pre>
<i>--</i>
<i>-- LuaJIT: demonstraèní pøíklad èíslo 23</i>
<i>--</i>
<i>-- Volání funkci v programovacím jazyce Lua</i>
<i>-- a vraceni hodnot z funkci.</i>
<i>--</i>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce nevracející ¾ádnou hodnotu.</i>
<i>--</i>
<strong>function</strong> function1()
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce vracející jednu hodnotu.</i>
<i>--</i>
<strong>function</strong> function2()
    <strong>return</strong> 42
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Funkce vracející dvì hodnoty</i>
<i>--</i>
<strong>function</strong> function3()
    <strong>return</strong> 1,2
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Dal¹í funkce vracející dvì hodnoty</i>
<i>--</i>
<strong>function</strong> function4()
    <strong>return</strong> 1,nil
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
<i>--</i>
<i>-- Spu¹tìní testu.</i>
<i>--</i>
<strong>function</strong> main()
    print(function1());
    print(function2());
    print(function3());
    print(function4());
<strong>end</strong>
&nbsp;
&nbsp;
&nbsp;
main()
&nbsp;
&nbsp;
<i>-- finito</i>
</pre>



<p><a name="k072"></a></p>
<h3 id="k072">7.2 Pøeklad pøíkladu <strong>test23.lua</strong> do mezijazyka LuaJITu</h3>

<p>V&nbsp;IR dne¹ního posledního demonstraèního pøíkladu je patrné, jak se
pøekládá pøíkaz <strong>print(function1())</strong> a samozøejmì i v¹echny
podobné pøíkazy. Vyu¾ívá se zde dvojice instrukcí <strong>CALL+CALLM</strong>,
pøièem¾ druhá zmínìná instrukce doká¾e zpracovat libovolný poèet hodnot
pøedaných pøes sloty:</p>

<pre>
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na funkci "print"</i>
0002    <strong>GGET</strong>     1   1        <i>; pøeètení reference na funkci "function1"</i>
0003    <strong>CALL</strong>     1   0   1    <i>; zavolání funkce function1()</i>
0004    <strong>CALLM</strong>    0   1   0    <i>; zavolání funkce print() s parametry vrácenými pøedchozí funkcí</i>
</pre>

<p>Následuje výpis celého IR:</p>

<pre>
<i>; Pøeklad demonstraèního pøíkladu test23.lua</i>
<i>; do IR vyu¾ívaného virtuálním strojem a JIT</i>
<i>; pøekladaèem LuaJIT.</i>
&nbsp;
-- BYTECODE -- test23.lua:13-14
<i>; function function1()</i>
&nbsp;
<i>; end</i>
0001    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test23.lua:21-23
<i>; function function2()</i>
&nbsp;
<i>; return 42</i>
0001    <strong>KSHORT</strong>   0  42        <i>; do slotu 0 ulo¾it konstantu</i>
0002    <strong>RET1</strong>     0   2        <i>; návrat z funkce + pøedání návratové hodnoty</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test23.lua:30-32
<i>; function function3()</i>
&nbsp;
<i>; return 1,2</i>
0001    <strong>KSHORT</strong>   0   1        <i>; do slotu 0 ulo¾it konstantu</i>
0002    <strong>KSHORT</strong>   1   2        <i>; do slotu 1 ulo¾it konstantu</i>
0003    <strong>RET</strong>      0   3        <i>; návrat z funkce + pøedání návratových hodnot</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test23.lua:39-41
<i>; function function4()</i>
0001    <strong>KSHORT</strong>   0   1        <i>; do slotu 0 ulo¾it konstantu</i>
0002    <strong>KPRI</strong>     1   0        <i>; do slotu 1 ulo¾it konstantu</i>
0003    <strong>RET</strong>      0   3        <i>; návrat z funkce + pøedání návratových hodnot</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test23.lua:48-53
<i>; function main()</i>
&nbsp;
0001    <strong>GGET</strong>     0   0        <i>; pøeètení reference na funkci "print"</i>
0002    <strong>GGET</strong>     1   1        <i>; pøeètení reference na funkci "function1"</i>
0003    <strong>CALL</strong>     1   0   1    <i>; zavolání funkce function1()</i>
0004    <strong>CALLM</strong>    0   1   0    <i>; zavolání funkce print() s parametry vrácenými pøedchozí funkcí</i>
&nbsp;
0005    <strong>GGET</strong>     0   0        <i>; pøeètení reference na funkci "print"</i>
0006    <strong>GGET</strong>     1   2        <i>; pøeètení reference na funkci "function2"</i>
0007    <strong>CALL</strong>     1   0   1    <i>; zavolání funkce function2()</i>
0008    <strong>CALLM</strong>    0   1   0    <i>; zavolání funkce print() s parametry vrácenými pøedchozí funkcí</i>
&nbsp;
0009    <strong>GGET</strong>     0   0        <i>; pøeètení reference na funkci "print"</i>
0010    <strong>GGET</strong>     1   3        <i>; pøeètení reference na funkci "function3"</i>
0011    <strong>CALL</strong>     1   0   1    <i>; zavolání funkce function3()</i>
0012    <strong>CALLM</strong>    0   1   0    <i>; zavolání funkce print() s parametry vrácenými pøedchozí funkcí</i>
&nbsp;
0013    <strong>GGET</strong>     0   0        <i>; pøeètení reference na funkci "print"</i>
0014    <strong>GGET</strong>     1   4        <i>; pøeètení reference na funkci "function4"</i>
0015    <strong>CALL</strong>     1   0   1    <i>; zavolání funkce function4()</i>
0016    <strong>CALLM</strong>    0   1   0    <i>; zavolání funkce print() s parametry vrácenými pøedchozí funkcí</i>
&nbsp;
0017    <strong>RET0</strong>     0   1        <i>; návrat z funkce</i>
&nbsp;
&nbsp;
&nbsp;
-- BYTECODE -- test23.lua:0-62
<i>; main()</i>
<i>; vytvoøení a "registrace" v¹ech funkcí</i>
0001    <strong>FNEW</strong>     0   0        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test23.lua:13</i>
0002    <strong>GSET</strong>     0   1        <i>; "ulo¾ení uzávìru do globální tabulky _G pod jménem function1"</i>
&nbsp;
0003    <strong>FNEW</strong>     0   2        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test23.lua:21</i>
0004    <strong>GSET</strong>     0   3        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function2"</i>
&nbsp;
0005    <strong>FNEW</strong>     0   4        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test23.lua:30</i>
0006    <strong>GSET</strong>     0   5        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function3"</i>
&nbsp;
0007    <strong>FNEW</strong>     0   6        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test23.lua:39</i>
0008    <strong>GSET</strong>     0   7        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "function4"</i>
&nbsp;
0009    <strong>FNEW</strong>     0   8        <i>; vytvoøení uzávìru z prototypu zaèínajícího na øádku test23.lua:48</i>
0010    <strong>GSET</strong>     0   9        <i>; ulo¾ení uzávìru do globální tabulky _G pod jménem "main"</i>
&nbsp;
0011    <strong>GGET</strong>     0   9        <i>; získání reference na funkci se jménem "main"</i>
0012    <strong>CALL</strong>     0   1   1    <i>; zavolání funkce main()</i>
&nbsp;
0013    <strong>RET0</strong>     0   1        <i>; návrat z programu</i>
&nbsp;
<i>; konec</i>
</pre>



<p><a name="k08"></a></p>
<h2 id="k08">8. Repositáø se zdrojovými kódy v¹ech pìti dne¹ních demonstraèních pøíkladù</h2>

<p>V¹ech pìt dnes popsaných a takté¾ &bdquo;disasemblovaných&ldquo;
demonstraèních pøíkladù bylo ulo¾eno do Git repositáøe umístìného na adrese <a
href="https://github.com/tisnik/luajit-examples">https://github.com/tisnik/luajit-examples</a>.
Odkazy na prozatím poslední verze tìchto pìti pøíkladù naleznete v&nbsp;tabulce
umístìné pod tímto odstavcem:</p>

<table>
<tr><th> #</th><th>Zdrojový kód</th><th>Umístìní</th></tr>
<tr><td> 1</td><td>test19.lua</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/src/test19.lua">https://github.com/tisnik/luajit-examples/blob/master/src/test19.lua</a></td></tr>
<tr><td> 2</td><td>test20.lua</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/src/test20.lua">https://github.com/tisnik/luajit-examples/blob/master/src/test20.lua</a></td></tr>
<tr><td> 3</td><td>test21.lua</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/src/test21.lua">https://github.com/tisnik/luajit-examples/blob/master/src/test21.lua</a></td></tr>
<tr><td> 4</td><td>test22.lua</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/src/test22.lua">https://github.com/tisnik/luajit-examples/blob/master/src/test22.lua</a></td></tr>
<tr><td> 5</td><td>test23.lua</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/src/test23.lua">https://github.com/tisnik/luajit-examples/blob/master/src/test23.lua</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 6</td><td>test19.asm</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/asm/test19.asm">https://github.com/tisnik/luajit-examples/blob/master/asm/test19.asm</a></td></tr>
<tr><td> 7</td><td>test20.asm</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/asm/test20.asm">https://github.com/tisnik/luajit-examples/blob/master/asm/test20.asm</a></td></tr>
<tr><td> 8</td><td>test21.asm</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/asm/test21.asm">https://github.com/tisnik/luajit-examples/blob/master/asm/test21.asm</a></td></tr>
<tr><td> 9</td><td>test22.asm</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/asm/test22.asm">https://github.com/tisnik/luajit-examples/blob/master/asm/test22.asm</a></td></tr>
<tr><td>10</td><td>test23.asm</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/asm/test23.asm">https://github.com/tisnik/luajit-examples/blob/master/asm/test23.asm</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>11</td><td>Makefile</td><td><a href="https://github.com/tisnik/luajit-examples/blob/master/Makefile">https://github.com/tisnik/luajit-examples/blob/master/Makefile</a></td></tr>
</table>



<p><a name="k09"></a></p>
<h2 id="k09">9. Odkazy na Internetu</h2>

<ol>

<li>Wikipedia: Mezijazyk<br />
<a href="http://cs.wikipedia.org/wiki/Mezijazyk">http://cs.wikipedia.org/wiki/Mezijazyk</a>
</li>

<li>The LuaJIT Project<br />
<a href="http://luajit.org/index.html">http://luajit.org/index.html</a>
</li>

<li>LuaJIT FAQ<br />
<a href="http://luajit.org/faq.html">http://luajit.org/faq.html</a>
</li>

<li>LuaJIT Performance Comparison<br />
<a href="http://luajit.org/performance.html">http://luajit.org/performance.html</a>
</li>

<li>LuaJIT 2.0 intellectual property disclosure and research opportunities<br />
<a href="http://article.gmane.org/gmane.comp.lang.lua.general/58908">http://article.gmane.org/gmane.comp.lang.lua.general/58908</a>
</li>

<li>LuaJIT Wiki<br />
<a href="http://wiki.luajit.org/Home">http://wiki.luajit.org/Home</a>
</li>

<li>LuaJIT 2.0 Bytecode Instructions<br />
<a href="http://wiki.luajit.org/Bytecode-2.0">http://wiki.luajit.org/Bytecode-2.0</a>
</li>

<li>Programming in Lua 9.1 &ndash; Coroutine Basics,<br />
<a href="http://www.lua.org/pil/9.1.html">http://www.lua.org/pil/9.1.html</a>
</li>

<li>Programming in Lua (first edition)<br />
<a href="http://www.lua.org/pil/contents.html">http://www.lua.org/pil/contents.html</a>
</li>

<li>Programming in Lua: 6 - More about Functions<br />
<a href="http://www.lua.org/pil/6.html">http://www.lua.org/pil/6.html</a>
</li>

<li>Lua Lanes<br />
<a href="http://kotisivu.dnainternet.net/askok/bin/lanes/">http://kotisivu.dnainternet.net/askok/bin/lanes/</a>
</li>

<li>Programming in Lua: 6.1 - Closures<br />
<a href="http://www.lua.org/pil/6.1.html">http://www.lua.org/pil/6.1.html</a>
</li>

<li>Programming in Lua: 9.1 - Coroutine Basics<br />
<a href="http://www.lua.org/pil/9.1.html">http://www.lua.org/pil/9.1.html</a>
</li>

<li>Programming in Lua: Numeric for<br />
<a href="http://www.lua.org/pil/4.3.4.html">http://www.lua.org/pil/4.3.4.html</a>
</li>

<li>Programming in Lua: break and return<br />
<a href="http://www.lua.org/pil/4.4.html">http://www.lua.org/pil/4.4.html</a>
</li>

<li>Programming in Lua: Tables<br />
<a href="http://www.lua.org/pil/2.5.html">http://www.lua.org/pil/2.5.html</a>
</li>

<li>Programming in Lua: Table Constructors<br />
<a href="http://www.lua.org/pil/3.6.html">http://www.lua.org/pil/3.6.html</a>
</li>

<li>Programovací jazyk Lua<br />
<a href="http://palmknihy.cz/web/kniha/programovaci-jazyk-lua-12651.htm">http://palmknihy.cz/web/kniha/programovaci-jazyk-lua-12651.htm</a>
</li>

<li>Lua: Tables Tutorial<br />
<a href="http://lua-users.org/wiki/TablesTutorial">http://lua-users.org/wiki/TablesTutorial</a>
</li>

<li>Lua: Control Structure Tutorial<br />
<a href="http://lua-users.org/wiki/ControlStructureTutorial">http://lua-users.org/wiki/ControlStructureTutorial</a>
</li>

<li>Lua Types Tutorial<br />
<a href="http://lua-users.org/wiki/LuaTypesTutorial">http://lua-users.org/wiki/LuaTypesTutorial</a>
</li>

<li>Goto Statement in Lua<br />
<a href="http://lua-users.org/wiki/GotoStatement">http://lua-users.org/wiki/GotoStatement</a>
</li>

<li>Lua 5.2 sources<br />
<a href="http://www.lua.org/source/5.2/">http://www.lua.org/source/5.2/</a>
</li>

<li>Lua 5.2 sources - lopcodes.h<br />
<a href="http://www.lua.org/source/5.2/lopcodes.h.html">http://www.lua.org/source/5.2/lopcodes.h.html</a>
</li>

<li>Lua 5.2 sources - lopcodes.c<br />
<a href="http://www.lua.org/source/5.2/lopcodes.c.html">http://www.lua.org/source/5.2/lopcodes.c.html</a>
</li>

<li>Lambda the Ultimate: Coroutines in Lua,<br />
<a href="http://lambda-the-ultimate.org/node/438">http://lambda-the-ultimate.org/node/438</a>
</li>

<li>Coroutines Tutorial,<br />
<a href="http://lua-users.org/wiki/CoroutinesTutorial">http://lua-users.org/wiki/CoroutinesTutorial</a>
</li>

<li>Lua Coroutines Versus Python Generators,<br />
<a href="http://lua-users.org/wiki/LuaCoroutinesVersusPythonGenerators">http://lua-users.org/wiki/LuaCoroutinesVersusPythonGenerators</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2014</small></p>
</body>
</html>

