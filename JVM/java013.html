<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Vyu¾ití skrytých vlastností JDK (1)</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Vyu¾ití skrytých vlastností JDK (1)</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V&nbsp;dne¹ním èlánku o vlastnostech JDK 6 a JDK 7 si øekneme základní informace o jedné skryté (pøesnìji øeèeno velmi málo zdokumentované a známé) vlastnosti nových verzí JDK. Jedná se o alternativní varianty tøíd HashMap, LinkedHashMap a TreeMap ulo¾ené v&nbsp;archivu alt-rt.jar. Tyto tøídy nabízí pro nìkteré aplikace vìt¹í výkonnost ne¾ standardní verze tìchto tøíd ulo¾ené v&nbsp;archivu rt.jar.</p>



<h2>Obsah</h2>

<p><a href="#k01">1. Skryté vlastnosti Oracle JDK</a></p>
<p><a href="#k02">2. Archivní soubory alt-rt.jar a alt-string.jar</a></p>
<p><a href="#k03">3. Za jakých podmínek se archivy alt-rt.jar a alt-string.jar pou¾ijí?</a></p>
<p><a href="#k04">4. Výkonnostní rozdíly mezi pou¾itím tøíd z&nbsp;rt.jar a alt-rt.jar</a></p>
<p><a href="#k05">5. Zdrojový kód testovacího pøíkladu</a></p>
<p><a href="#k06">6. Výsledky bìhu testovacího pøíkladu s&nbsp;JDK b24</a></p>
<p><a href="#k07">7. Podpora pro alternativní knihovny v&nbsp;OpenJDK (IcedTea)</a></p>
<p><a href="#k08">8. Dal¹í vliv volby <strong>-XX:+AggressiveOpts</strong> na výkonnost aplikací</a></p>
<p><a href="#k09">9. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2>1. Skryté vlastnosti Oracle JDK</h2>

<p>V&nbsp;dne¹ní èásti seriálu o programovacím jazyku Java a jeho bìhovém
prostøedí <i>JRE (Java Runtime Environment)</i> si povíme základní informace o
jedné pomìrnì neznámé a málo vyu¾ívané vlastnosti, kterou je mo¾né vyu¾ít
pøedev¹ím v&nbsp;proprietární <i>Oracle JDK 6</i>. Tato varianta <i>JDK</i>,
nebo pøesnìji øeèeno její bìhové prostøedí <i>JRE</i>, obsahuje, jak je to
ostatnì obvyklé, archivní soubor s&nbsp;názvem <strong>rt.jar</strong>,
v&nbsp;nìm¾ jsou ulo¾eny prakticky v¹echny tøídy, rozhraní a výètové typy
tvoøící aplikaèní programové rozhraní (API) J2SDK. Pouze nìkolik spí¹e
doplòkových tøíd je ulo¾eno v&nbsp;dal¹ích archivech. Kromì toho v¹ak mù¾eme
v&nbsp;novìj¹ích verzích <i>JDK 6</i> najít i dva nové archivy, které jsou
pojmenované <strong>alt-rt.jar</strong> a <strong>alt-string.jar</strong>
(tento soubor najdeme a¾ v&nbsp;B23). Tyto archivy jsou ulo¾eny ve stejném
podadresáøi, v&nbsp;jakém le¾í i archiv <strong>rt.jar</strong>,
tj.&nbsp;v&nbsp;podadresáøi <strong>jre/lib/</strong>. Strukturu podadresáøe
<strong>jre/lib/</strong> s&nbsp;výpisem v¹ech javovských archivù (*.jar) si
mù¾eme zobrazit napøíklad pomocí utility <i>tree</i>:</p>

<pre>
tree jre/lib -P "*.jar"
</pre>

<p>Struktura tohoto podadresáøe je zhruba následující (pov¹imnìte si hned
prvního a druhého záznamu zvýraznìného hvìzdièkami):</p>

<pre>
jre/lib
|-- alt-rt.jar ***
|-- alt-string.jar ***
|-- amd64
|   |-- headless
|   |-- jli
|   |-- motif21
|   |-- native_threads
|   |-- server
|   `-- xawt
|-- applet
|-- audio
|-- charsets.jar
|-- cmm
|-- deploy
|-- deploy.jar
|-- desktop
|   |-- applications
|   |-- icons
|   |   |-- HighContrast
|   |   |   |-- 16x16
|   |   |   |   |-- apps
|   |   |   |   `-- mimetypes
|   |   |   `-- 48x48
|   |   |       |-- apps
|   |   |       `-- mimetypes
|   |   |-- HighContrastInverse
|   |   |   |-- 16x16
|   |   |   |   |-- apps
|   |   |   |   `-- mimetypes
|   |   |   `-- 48x48
|   |   |       |-- apps
|   |   |       `-- mimetypes
|   |   |-- LowContrast
|   |   |   |-- 16x16
|   |   |   |   |-- apps
|   |   |   |   `-- mimetypes
|   |   |   `-- 48x48
|   |   |       |-- apps
|   |   |       `-- mimetypes
|   |   `-- hicolor
|   |       |-- 16x16
|   |       |   |-- apps
|   |       |   `-- mimetypes
|   |       `-- 48x48
|   |           |-- apps
|   |           `-- mimetypes
|   `-- mime
|       `-- packages
|-- endorsed
|-- ext
|   |-- dnsns.jar
|   |-- localedata.jar
|   |-- sunjce_provider.jar
|   `-- sunpkcs11.jar
|-- fonts
|-- im
|   |-- indicim.jar
|   `-- thaiim.jar
|-- images
|   |-- cursors
|   `-- icons
|-- javaws.jar
|-- jce.jar
|-- jsse.jar
|-- locale
|   |-- de
|   |   `-- LC_MESSAGES
|   |-- es
|   |   `-- LC_MESSAGES
|   |-- fr
|   |   `-- LC_MESSAGES
|   |-- it
|   |   `-- LC_MESSAGES
|   |-- ja
|   |   `-- LC_MESSAGES
|   |-- ko
|   |   `-- LC_MESSAGES
|   |-- ko.UTF-8
|   |   `-- LC_MESSAGES
|   |-- sv
|   |   `-- LC_MESSAGES
|   |-- zh
|   |   `-- LC_MESSAGES
|   |-- zh.GBK
|   |   `-- LC_MESSAGES
|   |-- zh_HK.BIG5HK
|   |   `-- LC_MESSAGES
|   |-- zh_TW
|   |   `-- LC_MESSAGES
|   `-- zh_TW.BIG5
|       `-- LC_MESSAGES
|-- management
|-- management-agent.jar
|-- oblique-fonts
|-- plugin.jar
|-- resources.jar
|-- rt.jar
|-- security
|   |-- US_export_policy.jar -&gt; /etc/alternatives/jce_1.6.0_sun_us_export_policy.x86_64
|   `-- local_policy.jar -&gt; /etc/alternatives/jce_1.6.0_sun_local_policy.x86_64
|-- servicetag
`-- zi
    |-- Africa
    |-- America
    |   |-- Argentina
    |   |-- Indiana
    |   |-- Kentucky
    |   `-- North_Dakota
    |-- Antarctica
    |-- Asia
    |-- Atlantic
    |-- Australia
    |-- Etc
    |-- Europe
    |-- Indian
    |-- Pacific
    `-- SystemV

98 directories, 18 files
</pre>



<p><a name="k02"></a></p>
<h2>2. Archivní soubory alt-rt.jar a alt-string.jar</h2>

<p>Jak ji¾ název souborù <strong>alt-rt.jar</strong> a
<strong>alt-string</strong> napovídá, jedná se o javovské archivy obsahující
alternativní verze nìkterých tøíd tvoøících standardní API J2SDK. Tyto
alternativní tøídy byly vytvoøeny s&nbsp;ohledem na dosa¾ení co nejlep¹ího
výkonu (zejména v&nbsp;oficiálních benchmarcích bì¾ících na poèítaèích
s&nbsp;vìt¹ím poètem procesorových jader, typicky se jedná o benchmark
<i>SPECjbb</i>), ov¹em prozatím by se tato implementace mìla pova¾ovat za
experimentální, i kdy¾ na ¾ádné vìt¹í problémy èi chyby pravdìpodobnì
v&nbsp;praxi nenarazíte (a ve skuteènosti byste ani nemìli na problémy narazit,
proto¾e ¾ádná z&nbsp;voleb pøedávaných JRE pøi jeho spou¹tìní by nemìla
ovlivnit chování JRE do takové míry, ¾e by do¹lo k&nbsp;chybì v&nbsp;nìkterém
testu kompatibility &ndash; <i>TCK</i>). Archiv <strong>alt-rt-jar</strong>
obsahuje pøedev¹ím binární (pøelo¾ené) podoby optimalizovaných verzí tøíd
<strong>HashMap</strong>, <strong>LinkedHashMap</strong> a
<strong>TreeMap</strong> (tj.&nbsp;tøíd implementujících rozhraní
<strong>Map</strong>) a samozøejmì i rùzné pomocné tøídy a rozhraní,
popø.&nbsp;anonymní tøídy.</p>

<p>Zatímco v¹echny tøi vý¹e zmínìné tøídy ulo¾ené v&nbsp;archivu
<strong>rt.jar</strong> neobsahují prakticky ¾ádné optimalizace, které by
zapøíèinily vìt¹í slo¾itost èi men¹í èitelnost jejich zdrojového kódu (o èem¾
se ostatnì mù¾ete sami pøesvìdèit pøi pohledu do zdrojových kódù tìchto tøíd,
napøíklad pøi zkoumání metod <strong>put</strong> a <strong>get</strong>), jsou
v&nbsp;archivu <strong>alt-rt.jar</strong> umístìny tøídy
s&nbsp;optimalizovaným kódem vyu¾ívajícím napøíklad vyrovnávací pamìti pro ty
prvky mapy, ke kterým se èastìji pøistupuje atd. V&nbsp;archivu
<strong>alt-string.jar</strong> mù¾eme najít pøedev¹ím upravenou variantu tøídy
<strong>String</strong>, která doká¾e pracovat s&nbsp;&bdquo;komprimovanými
øetìzci&ldquo;, co¾ je ov¹em jen honosnì znìjící název pro bì¾né øetìzce (které
se pou¾ívají napøíklad v&nbsp;céèku) obsahující pouze ASCII znaky. Pokud je
vytvoøen øetìzec slo¾ený výhradnì z&nbsp;ASCII znakù (tj.&nbsp;øetìzec
neobsahuje napøíklad znaky azbuky, nabodeníèka atd.), je ulo¾en do pole
s&nbsp;prvky typu <strong>byte</strong> a nikoli do pole s&nbsp;prvky typu
<strong>char</strong>. To vede jak k&nbsp;úspoøe pamìti alokované na haldì, tak
i k&nbsp;urychlení nìkterých operací, proto¾e se mù¾e pracovat
s&nbsp;polovièním poètem bajtù pro daný øetìzec.</p>



<p><a name="k03"></a></p>
<h2>3. Za jakých podmínek se archivy alt-rt.jar a alt-string.jar pou¾ijí?</h2>

<p>Alternativní tøídy obsa¾ené v&nbsp;archivu <strong>alt-rt.jar</strong> a
<strong>alt-string.jar</strong> se nepou¾ívají automaticky pøi ka¾dém startu
bìhového prostøedí Javy. Naètou a pou¾ijí se pouze pøi splnìní dvou podmínek.
První podmínkou je, ¾e daný archiv musí existovat, co¾ je prozatím pouze pøípad
<i>Oracle JDK</i>, nikoli v¹ak <i>OpenJDK</i> ani dal¹ích variant <i>JDK</i>.
Druhou podmínkou, která musí být splnìna, je pou¾ití pøepínaèe
<strong>-XX:+AggressiveOpts</strong> pøi startu <i>JRE</i>. Pokud není alespoò
jedna z&nbsp;tìchto podmínek splnìna, nevypí¹e se ¾ádné chybové hlá¹ení, ale
tøídy <strong>HashMap</strong>, <strong>TreeMap</strong>,
<strong>String</strong> atd.&nbsp;se jednodu¹e naètou z&nbsp;originálního
archivu <strong>rt.jar</strong>. O tom, zda se naèítají pùvodní verze tøíd nebo
jejich alternativní a výkonnìj¹í verze, se mù¾eme pøesvìdèit pou¾itím pøepínaèe
<strong>-verbose</strong> pøi startu bìhového prostøedí Javy, napøíklad
následujícím zpùsobem:</p>

<pre>
java -verbose | grep Opened
</pre>

<p>Pøi spu¹tìní vý¹e uvedeného pøíkazu, kde se pomocí pøepínaèe
<strong>-verbose</strong> povoluje výpis v¹ech naèítaných tøíd a otevíraných
archivù obsahujících tyto tøídy (my ov¹em vìt¹inu pro nás nepodstatných
informací vyfiltrujeme), získáme následující výstup. Na rùzných verzích
<i>Oracle JDK</i> a na rùzných platformách se mohou nìkteré údaje odli¹ovat,
pøedev¹ím se to samozøejmì týká cesty k&nbsp;javovskému archivu:</p>

<pre>
[Opened /opt/jdk/sun/jdk1.6.0_23-x86_64/jre/lib/rt.jar]
</pre>

<p>Ov¹em pøi pou¾ití pøepínaèe <strong>-XX:+AggressiveOpts</strong>,
tj.&nbsp;pøi spu¹tìní následujícího pøíkazu:</p>

<pre>
java -XX:+AggressiveOpts -verbose | grep Opened
</pre>

<p>mù¾eme z&nbsp;vyfiltrovaného standardního výstupu zjistit, ¾e se skuteènì
naèítají i alternativní knihovny ulo¾ené v&nbsp;archivu
<strong>alt-rt.jar</strong>:</p>

<pre>
[Opened /opt/jdk/sun/jdk1.6.0_23-x86_64/jre/lib/alt-rt.jar]
[Opened /opt/jdk/sun/jdk1.6.0_23-x86_64/jre/lib/rt.jar]
</pre>



<p><a name="k04"></a></p>
<h2>4. Výkonnostní rozdíly mezi pou¾itím tøíd z&nbsp;rt.jar a alt-rt.jar</h2>

<p>V&nbsp;pøedchozí kapitole jsme si øekli, ¾e binární (pøelo¾ené) tvary tøíd
ulo¾ených v&nbsp;javovských archivech <strong>alt-rt.jar</strong> a
<strong>alt-string.jar</strong> by mìly být výkonnìj¹í ne¾ originální varianty
tìchto tøíd. Ov¹em toto tvrzení je samozøejmì nutné potvrdit (navíc toto
tvrzení nemusí být platné za v¹ech podmínek!), a to buï benchmarkem stávajících
aplikací, napøíklad spu¹tìním serverové aplikace s&nbsp;pøepínaèem
<strong>-XX:+AggressiveOpts</strong> s&nbsp;následným mìøením doby odezvy této
aplikace, nebo vytvoøením syntetického testu zamìøeného pouze na zji¹tìní
rychlosti implementace tøíd <strong>HashMap</strong>,
<strong>LinkedHashMap</strong> a <strong>TreeMap</strong>. Pro úèely zmìøení
výkonnosti metod <strong>Map.put()</strong> a <strong>Map.get()</strong> za
stanovených podmínek jsem vytvoøil jednoduchý pøíklad, jeho¾ zdrojový kód lze
najít v&nbsp;následující kapitole. V&nbsp;tomto pøíkladu se pro instance v¹ech
tøí vý¹e zmínìných tøíd testuje rychlost, s&nbsp;jakou se do mapy vkládají
objekty typu <strong>Integer</strong>, jejich¾ klíèe jsou takté¾ hodnoty typu
<strong>Integer</strong>. Takté¾ se zji¹»uje rychlost získávání objektù
z&nbsp;mapy metodou <strong>Map.get()</strong>.</p>

<p>Dùvod, proè je pou¾ita rostoucí èíselná posloupnost klíèù, je jednoduchý
&ndash; objekty jsou v&nbsp;he¹ovací mapì (instanci tøídy
<strong>HashMap</strong>) uspoøádány na základì he¹ovací hodnoty (<i>hash
code</i>) svého klíèe, co¾ je ov¹em v&nbsp;pøípadì instance tøídy
<strong>Integer</strong> pøímo hodnota tohoto klíèe (opìt je mo¾né se podívat
do zdrojových kódù tøídy <strong>Integer</strong>). Pøi &bdquo;vhodnì&ldquo;
zvolené posloupnosti hodnot klíèù tedy mù¾e docházet ke kolizím, které úèinnost
he¹ovací mapy sni¾ují. Naopak v&nbsp;pøípadì pou¾ití tøídy
<strong>TreeMap</strong> jsou objekty v&nbsp;mapì uspoøádány pøímo na základì
hodnoty klíèe, pøesnìji øeèeno na základì porovnání klíèù pomocí komparátorù.
Èíselná posloupnost hodnot klíèù èi jejich he¹ovacích hodnot pak ovlivòuje
interní strukturu mapy i dobu ukládání nového prvku a ètení prvku z&nbsp;mapy
&ndash; napøíklad tøída <strong>TreeMap</strong> internì vyu¾ívá Red-Black
stromy, jejich¾ struktura se pøi vkládání nových prvkù musí mìnit (viz animace
dostupná na adrese <a
href="http://www.aisee.com/anim/maple.htm">http://www.aisee.com/anim/maple.htm</a>).</p>



<p><a name="k05"></a></p>
<h2>5. Zdrojový kód testovacího pøíkladu</h2>

<p>Ve zdrojovém kódu testovacího pøíkladu se pou¾ívají tøídy implementující
rozhraní <strong>ValueGenerator</strong>, které slou¾í pro generování hodnot
ulo¾ených v&nbsp;instancích tøídy <strong>Integer</strong>. Klíèe jsou v¹ak
tvoøeny jednoduchou aritmetickou posloupností celých èísel &ndash; sami si
mù¾ete vyzkou¹et, jak se doba bìhu aplikace zmìní v&nbsp;pøípadì, ¾e se pro
vytváøení klíèù (ne hodnot) pou¾ije odli¹ná posloupnost:</p>

<pre>
import java.util.Map;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Random;
import java.util.TreeMap;

interface ValueGenerator {
    public void reset();

    public Integer nextValue();
}

class SequenceGenerator implements ValueGenerator {
    private int value = 0;

    @Override
    public Integer nextValue() {
        this.value++;
        return Integer.valueOf(this.value);
    }

    @Override
    public void reset() {
        this.value = 0;
    }
}

class InverseSequenceGenerator implements ValueGenerator {
    private int value = Integer.MAX_VALUE;

    @Override
    public Integer nextValue() {
        this.value--;
        return Integer.valueOf(this.value);
    }

    @Override
    public void reset() {
        this.value = Integer.MAX_VALUE;
    }
}

class RandomSequenceGenerator implements ValueGenerator {
    private static final long SEED = 42;
    private Random rand = new Random(SEED);

    @Override
    public Integer nextValue() {
        return Integer.valueOf(this.rand.nextInt());
    }

    @Override
    public void reset() {
        this.rand.setSeed(SEED);
    }
}

public class MapBenchmark {

    private static final int EXT_LOOP_COUNT = 100;
    public static final int INT_LOOP_COUNT = 100000;

    public static long mapTest(Map&lt;Integer, Integer&gt; map, ValueGenerator generator) {
        long t1 = System.currentTimeMillis();
        for (int j = 0; j &lt; EXT_LOOP_COUNT; j++) {
            map.clear();
            generator.reset();
            for (int i = 0; i &lt; INT_LOOP_COUNT; i++) {
                Integer I = Integer.valueOf(i);
                map.put(I, generator.nextValue());
            }
            generator.reset();
            for (int i = 0; i &lt; INT_LOOP_COUNT; i++) {
                if (!map.get(Integer.valueOf(i)).equals(generator.nextValue()))
                    throw new RuntimeException("Cannot find value");
            }
        }
        long t2 = System.currentTimeMillis();
        return t2 - t1;
    }

    private static void doTests(Map&lt;Integer, Integer&gt; map) {
        System.out.print(mapTest(map, new SequenceGenerator())+"\t");
        System.out.print(mapTest(map, new InverseSequenceGenerator())+"\t");
        System.out.print(mapTest(map, new RandomSequenceGenerator())+"\t");
    }

    public static void main(String[] args) {
        long t1 = System.currentTimeMillis();

        doTests(new HashMap&lt;Integer, Integer&gt;());
        doTests(new LinkedHashMap&lt;Integer, Integer&gt;());
        doTests(new TreeMap&lt;Integer, Integer&gt;());

        long t2 = System.currentTimeMillis();
        System.out.println(t2 - t1);
    }

}
</pre>



<p><a name="k06"></a></p>
<h2>6. Výsledky bìhu testovacího pøíkladu s&nbsp;JDK b24</h2>

<p>V&nbsp;této kapitole jsou uvedeny výsledky tøí bìhù vý¹e popsaného
testovacího pøíkladu. V&nbsp;prvním bìhu nebyla volba
<strong>-XX:+AggressiveOpts</strong> pou¾ita, tudí¾ se naèetly tøídy
z&nbsp;archivu <strong>rt.jar</strong>. Ve druhém pøípadì sice byla vý¹e
zmínìná volba pou¾ita, ale soubor <strong>alt-rt.jar</strong> nebyl dostupný,
tak¾e opìt do¹lo (bez výpisu varovného hlá¹ení!) k&nbsp;naètení tøíd
z&nbsp;archivu <strong>rt.jar</strong>. Teprve ve tøetím pøípadu se díky
pou¾ití volby <strong>-XX:+AggressiveOpts</strong> a dostupnosti archivu
<strong>alt-rt.jar</strong> naèetly alternativní verze knihoven, co¾ mìlo za
daných podmínek pozitivní dopad na dobu bìhu aplikace. Ka¾dý test byl spu¹tìný
dvacetkrát, aby se omezily náhodné vlivy ostatních procesù bì¾ících
v&nbsp;systému.</p>

<p>Spu¹tìní demonstraèního pøíkladu bez dal¹ích voleb (pou¾it archiv
<strong>rt.jar</strong>):</p>

<pre>
HashMap                 LinkedHashMap           TreeMap                 Total
seq    invseq random    seq     invseq  random  seq     invseq  random  time
2533    1996    2743    2549    2340    3046    5969    5861    6861    33913
2484    1991    2747    2575    2334    3051    5936    5912    6949    33996
2583    1754    2396    2415    2086    2688    5839    5801    6826    32392
2530    1992    2742    2623    2293    3113    6065    5868    6901    34134
2519    2008    2816    2780    2406    3117    6080    5870    6921    34525
2556    2063    2790    2816    2206    3067    5914    5803    6816    34036
2598    1999    2752    2970    2319    3050    5986    5923    6882    34485
2472    1981    2791    2456    2335    3070    5995    5913    6919    33939
2502    2060    2775    2818    2203    3059    5936    5847    6838    34053
2513    2046    2787    2629    2337    3122    5927    5655    6786    33816
2521    2007    2735    2969    2316    3065    5970    5939    6918    34447
2561    2005    2756    2454    2437    3203    5990    5904    6926    34251
2579    1782    2477    2623    2490    3294    5922    5778    6856    33807
2514    2053    2779    2789    2227    3072    6039    5862    6893    34233
2541    1995    2779    2584    2329    3102    5920    5901    6902    34059
2612    1997    2741    2951    2315    3045    6120    5895    6910    34592
2482    1982    2748    2497    2444    3195    5997    5684    6873    33916
2512    2048    2786    2785    2215    3063    5995    5898    6872    34186
2509    1989    2775    2970    2623    3347    5943    5707    6853    34720
2528    1986    2735    2935    2343    3054    6020    5877    6895    34387
</pre>

<p>Spu¹tìní demonstraèního pøíkladu s&nbsp;volbou
<strong>-XX:+AggressiveOpts</strong>, ov¹em ve chvíli, kdy není archiv
<strong>alt-rt.jar</strong> dostupný (ve výsledku je pou¾it archiv
<strong>rt.jar</strong>):</p>

<pre>
HashMap                 LinkedHashMap           TreeMap                 Total
seq    invseq random    seq     invseq  random  seq     invseq  random  time
2684    2276    2794    2791    2443    3202    5949    5905    6767    34823
2692    2254    2820    2698    2450    3210    6055    5937    6837    34969
2705    2247    2788    2785    2467    3275    5924    5807    6703    34708
2680    2237    2798    2755    2427    3163    6004    5857    6762    34690
2733    2257    2803    2787    2744    3462    5998    5859    6717    35369
2639    2246    2797    2746    2448    3198    6013    6207    6979    35281
2497    2262    2939    2825    2509    3212    5991    5798    6755    34802
2643    2258    2782    2735    2477    3244    6011    5837    6727    34721
2666    2268    2837    2474    2418    3156    6049    5927    6843    34643
2701    2239    2771    2458    2470    3222    5979    5879    6730    34459
2680    2271    2801    2559    2344    3153    5962    5824    6782    34384
2660    2259    2858    2744    2448    3263    5970    5939    6748    34894
2669    2249    2800    2715    2663    3439    5982    5785    6753    35059
2692    2253    2809    2743    2432    3240    5956    5884    6766    34780
2675    1844    2511    2463    2396    3090    5909    5807    6742    33443
2705    2243    2787    2425    2444    3267    5935    5861    6752    34425
2704    2240    2794    2804    2404    3184    5989    5811    6723    34660
2709    2289    2819    2721    2444    3269    5935    5820    6699    34710
2680    2244    2792    2524    2378    3095    5994    5785    6742    34240
2688    2284    2824    2425    2447    3206    5948    5846    6783    34465
</pre>

<p>Spu¹tìní demonstraèního pøíkladu s&nbsp;volbou
<strong>-XX:+AggressiveOpts</strong> ve chvíli, kde je archiv
<strong>alt-rt.jar</strong> dostupný:</p>

<pre>
HashMap                 LinkedHashMap           TreeMap                 Total
seq    invseq random    seq     invseq  random  seq     invseq  random  time
2397    1886    2527    2433    2434    3159    4709    4379    5230    29162
2390    1833    2441    2861    2748    3428    4660    4363    5209    29942
2415    1792    2472    2715    2518    3174    4688    4362    5192    29334
2412    1781    2456    2664    2385    2994    4614    4290    5188    28804
2344    1761    2428    2658    2479    3130    4806    4338    5226    29177
2473    1886    2508    2743    2487    3148    4668    4346    5202    29467
2449    1795    2403    2620    2451    3220    4665    4498    5230    29339
2499    1742    2476    2556    2398    3080    4815    4198    5353    29140
2429    1799    2472    2691    2425    3191    4663    4369    5220    29264
2453    1803    2459    2724    2431    3188    4687    4174    5240    29173
2437    1785    2374    2554    2430    3172    4638    4280    5106    28783
2374    1841    2538    2519    2382    3116    4663    4153    5236    28841
2456    1765    2414    2493    2307    2924    4563    4188    5114    28230
2357    1824    2470    2663    2465    3180    4635    4355    5237    29193
2434    1855    2446    2750    2444    3173    6883    4357    5221    31569
2466    1791    2427    2536    2488    3175    4673    4347    5251    29170
2492    1892    2506    2690    2415    3153    4694    4380    5228    29465
2471    1791    2413    2299    2410    3017    4731    4175    5228    28543
2429    1679    2369    2395    2362    2960    4595    4234    5148    28176
2364    1838    2512    2694    2426    3209    4693    4332    5188    29261
</pre>

<p>Snadno mù¾eme vypoèítat, ¾e zrychlení demonstraèního pøíkladu dosahuje za
daných podmínek cca 15%.</p>



<p><a name="k07"></a></p>
<h2>7. Podpora pro alternativní knihovny v&nbsp;OpenJDK (IcedTea)</h2>

<p>Zajímavé je, ¾e podpora pro pou¾ití alternativního archivu
<strong>alt-rt.jar</strong> (nikoli v¹ak <strong>alt-string.jar</strong>)
existuje i v&nbsp;<i>OpenJDK</i> a tím pádem i v&nbsp;<i>IcedTea</i>. Ostatnì
se není èemu divit, proto¾e zdrojové kódy <i>OpenJDK</i> i proprietární
<i>Oracle JDK</i> jsou sdílené, i kdy¾ nìkteré relativnì malé èásti
<i>OpenJDK</i> musely být zmìnìny, pøedev¹ím kvùli nekompatibilním licencím a
problémùm s&nbsp;otevøením knihoven tøetích stran (tj.&nbsp;knihoven dodaných
dal¹ími vývojáøskými firmami spoleènosti <i>Sun Microsystems</i> a posléze
<i>Oracle</i>). Nicménì se vra»me k&nbsp;obìma alternativním archivùm. Ve
zdrojových kódech <i>OpenJDK</i> lze dohledat, ¾e se alternativní archiv
<strong>alt-rt.jar</strong> skuteènì pøi spou¹tìní JRE hledá a popø.&nbsp;i
naèítá, a to za stejných podmínek, jako u proprietární <i>Oracle JDK</i>.
Ostatnì pøesvìdèit se mù¾eme pøímo pohledem do zdrojového kódu souboru
<strong>hotspot/src/share/vm/runtime/arguments.cpp</strong> na øádky 2064 a¾
2077 (èísla øádkù odpovídají HotSpotu verze 20, jeho¾ zdrojové kódy lze najít
na adrese <a
href="http://hg.openjdk.java.net/hsx/hsx20/master">http://hg.openjdk.java.net/hsx/hsx20/master</a>):</p>

<pre>
  if (AggressiveOpts) {
    // Insert alt-rt.jar between user-specified bootclasspath
    // prefix and the default bootclasspath.  os::set_boot_path()
    // uses meta_index_dir as the default bootclasspath directory.
    const char* altclasses_jar = "alt-rt.jar";
    size_t altclasses_path_len = strlen(get_meta_index_dir()) + 1 +
                                 strlen(altclasses_jar);
    char* altclasses_path = NEW_C_HEAP_ARRAY(char, altclasses_path_len);
    strcpy(altclasses_path, get_meta_index_dir());
    strcat(altclasses_path, altclasses_jar);
    scp.add_suffix_to_prefix(altclasses_path);
    scp_assembly_required = true;
    FREE_C_HEAP_ARRAY(char, altclasses_path);
  }
</pre>

<p>Jediný problém spoèívá v&nbsp;tom, ¾e zdrojové kódy obou alternativních
archivù nejsou prozatím v&nbsp;<i>OpenJDK</i> dostupné, i kdy¾ je teoreticky
mo¾né (pøi dodr¾ení licenèního ujednání potvrzeného pøi instalaci <i>Oracle
JDK</i>) pou¾ít archivy právì z&nbsp;<i>Oracle JDK</i>.</p>



<p><a name="k08"></a></p>
<h2>8. Dal¹í vliv volby <strong>-XX:+AggressiveOpts</strong> na výkonnost aplikací</h2>

<p>Pou¾ití volby <strong>-XX:+AggressiveOpts</strong> má pomìrnì velký vliv na
výkonnost aplikací, a to i ve chvíli, kdy nejsou alternativní knihovny dostupné
a/nebo pou¾ívané. Vliv této volby si mù¾eme vyzkou¹et na ji¾ mnohokrát
ukazovaném pøíkladu <strong>ConcatTest1.java</strong>, který je upraven takovým
zpùsobem, aby dokázal zobrazit èas konkatenace øetìzce pro rùzné poèty iterací,
co¾ má samozøejmì vliv jak na dobu trvání smyèky, tak i na obsazení haldy a
zatí¾ení správcù pamìti. Zdrojový tvar upraveného testovacího pøíkladu má
tvar:</p>

<pre>
public class ConcatTest1
{
    private static final int MAX_LOOP_COUNT = 200000;

    public static String createString(int loopCount)
    {
        String str = "";
        for (int i = 0; i &lt; loopCount; i++)
        {
            str += i + " ";
        }
        return str;
    }

    public static void main(String[] args)
    {
        for (int loopCount = 256; loopCount &lt; MAX_LOOP_COUNT; loopCount *= 2)
        {
            long t1 = System.currentTimeMillis();
            String str = createString(loopCount);
            //System.out.println("String length: " + str.length());
            long t2 = System.currentTimeMillis();
            System.out.println("loops: " + loopCount + "  time:" + (t2 - t1));
        }
    }
}
</pre>

<p>V&nbsp;následující tabulce jsou zobrazeny èasy bìhu &bdquo;konkatenaèní
smyèky&ldquo; v&nbsp;pøípadì spu¹tìní JVM bez volby
<strong>-XX:+AggressiveOpts</strong> i s&nbsp;pou¾itím této volby (výsledky
byly získány s&nbsp;JDK b23 na platformì x86_64):</p>

<table>
<tr><th>loopCount</th><th>JVM bez dal¹ích voleb</th><th>Volba -XX:+AggressiveOpts</th><th>Zrychlení</th></tr>
<tr><td>   256</td><td>     6</td><td>    4</td><td>33%</td></tr>
<tr><td>   512</td><td>    15</td><td>    8</td><td>47%</td></tr>
<tr><td>  1024</td><td>    25</td><td>   25</td><td>0%</td></tr>
<tr><td>  2048</td><td>    58</td><td>   74</td><td>-28% *******</td></tr>
<tr><td>  4096</td><td>   222</td><td>  222</td><td>0%</td></tr>
<tr><td>  8192</td><td>   731</td><td>  727</td><td>1%</td></tr>
<tr><td> 16384</td><td>  2617</td><td>  584</td><td>78%</td></tr>
<tr><td> 32768</td><td> 13674</td><td> 3156</td><td>77%</td></tr>
<tr><td> 65536</td><td> 64446</td><td>16102</td><td>75%</td></tr>
<tr><td>131072</td><td>317944</td><td>73220</td><td>77%</td></tr>
</table>

<p>Vliv této volby na bìh JVM si vysvìtlíme pøí¹tì.</p>



<p><a name="k09"></a></p>
<h2>9. Odkazy na Internetu</h2>

<ol>

<li>The Java Compatibility Test Tools: JavaTest Harness<br />
<a href="http://java.sun.com/developer/technicalArticles/JCPtools2/">http://java.sun.com/developer/technicalArticles/JCPtools2/</a>
</li>

<li>Java HotSpot VM Options<br />
<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a></li>

<li>HugePages<br />
<a href="http://linux-mm.org/HugePages">http://linux-mm.org/HugePages</a>
</li>

<li>Tuning big java heap and linux huge pages<br />
<a href="http://www.tikalk.com/alm/forums/tuning-big-java-heap-and-linux-huge-pages">http://www.tikalk.com/alm/forums/tuning-big-java-heap-and-linux-huge-pages</a>
</li>

<li>How do I set up hugepages in Red Hat Enterprise Linux 4<br />
<a href="http://magazine.redhat.com/2007/05/29/how-do-i-set-up-hugepages-in-red-hat-enterprise-linux-4/">http://magazine.redhat.com/2007/05/29/how-do-i-set-up-hugepages-in-red-hat-enterprise-linux-4/</a>
</li>

<li>Java SE Tuning Tip: Large Pages on Windows and Linux<br />
<a href="http://blogs.sun.com/dagastine/entry/java_se_tuning_tip_large">http://blogs.sun.com/dagastine/entry/java_se_tuning_tip_large</a>
</li>

<li>Translation lookaside buffer<br />
<a href="http://en.wikipedia.org/wiki/Translation_lookaside_buffer">http://en.wikipedia.org/wiki/Translation_lookaside_buffer</a>
</li>

<li>Physical Address Extension<br />
<a href="http://en.wikipedia.org/wiki/Physical_Address_Extension">http://en.wikipedia.org/wiki/Physical_Address_Extension</a>
</li>

<li>Java HotSpot VM Options<br />
<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a>
</li>

<li>Amdahl's law<br />
<a href="http://en.wikipedia.org/wiki/Amdahl_law">http://en.wikipedia.org/wiki/Amdahl_law</a>
</li>

<li>Garbage collection (computer science)<br />
<a href="http://en.wikipedia.org/wiki/Garbage_collection_(computer_science)">http://en.wikipedia.org/wiki/Garbage_collection_(computer_science)</a>
</li>

<li>Dr. Dobb's | G1: Java's Garbage First Garbage Collector<br />
<a href="http://www.drdobbs.com/article/printableArticle.jhtml?articleId=219401061&amp;dept_url=/java/">http://www.drdobbs.com/article/printableArticle.jhtml?articleId=219401061&amp;dept_url=/java/</a>
</li>

<li>Java's garbage-collected heap<br />
<a href="http://www.javaworld.com/javaworld/jw-08-1996/jw-08-gc.html">http://www.javaworld.com/javaworld/jw-08-1996/jw-08-gc.html</a>
</li>

<li>Compressed oops in the Hotspot JVM<br />
<a href="http://wikis.sun.com/display/HotSpotInternals/CompressedOops">http://wikis.sun.com/display/HotSpotInternals/CompressedOops</a>
</li>

<li>32-bit or 64-bit JVM? How about a Hybrid?<br />
<a href="http://blog.juma.me.uk/2008/10/14/32-bit-or-64-bit-jvm-how-about-a-hybrid/">http://blog.juma.me.uk/2008/10/14/32-bit-or-64-bit-jvm-how-about-a-hybrid/</a>
</li>

<li>Compressed object pointers in Hotspot VM<br />
<a href="http://blogs.sun.com/nike/entry/compressed_object_pointers_in_hotspot">http://blogs.sun.com/nike/entry/compressed_object_pointers_in_hotspot</a>
</li>

<li>Java HotSpot(tm) Virtual Machine Performance Enhancements<br />
<a href="http://download.oracle.com/javase/7/docs/technotes/guides/vm/performance-enhancements-7.html">http://download.oracle.com/javase/7/docs/technotes/guides/vm/performance-enhancements-7.html</a>
</li>

<li>Using jconsole<br />
<a href="http://download.oracle.com/javase/1.5.0/docs/guide/management/jconsole.html">http://download.oracle.com/javase/1.5.0/docs/guide/management/jconsole.html</a>
</li>

<li>jconsole &ndash; Java Monitoring and Management Console<br />
<a href="http://download.oracle.com/javase/1.5.0/docs/tooldocs/share/jconsole.html">http://download.oracle.com/javase/1.5.0/docs/tooldocs/share/jconsole.html</a>
</li>

<li>Great Computer Language Shootout<br />
<a href="http://c2.com/cgi/wiki?GreatComputerLanguageShootout">http://c2.com/cgi/wiki?GreatComputerLanguageShootout</a>
</li>

<li>x86-64<br />
<a href="http://en.wikipedia.org/wiki/X86-64">http://en.wikipedia.org/wiki/X86-64</a>
</li>

<li>Physical Address Extension<br />
<a href="http://en.wikipedia.org/wiki/Physical_Address_Extension">http://en.wikipedia.org/wiki/Physical_Address_Extension</a>
</li>

<li>Java performance<br />
<a href="http://en.wikipedia.org/wiki/Java_performance">http://en.wikipedia.org/wiki/Java_performance</a>
</li>

<li>1.6.0_14 (6u14)<br />
<a href="http://www.oracle.com/technetwork/java/javase/6u14-137039.html?ssSourceSiteId=otncn">http://www.oracle.com/technetwork/java/javase/6u14-137039.html?ssSourceSiteId=otncn</a>
</li>

<li>Update Release Notes<br />
<a href="http://www.oracle.com/technetwork/java/javase/releasenotes-136954.html">http://www.oracle.com/technetwork/java/javase/releasenotes-136954.html</a>
</li>

<li>Java virtual machine: 4.10 Limitations of the Java Virtual Machine<br />
<a href="http://java.sun.com/docs/books/jvms/second_edition/html/ClassFile.doc.html#88659">http://java.sun.com/docs/books/jvms/second_edition/html/ClassFile.doc.html#88659</a>
</li>

<li>Java(TM) Platform, Standard Edition 7 Binary Snapshot Releases<br />
<a href="http://dlc.sun.com.edgesuite.net/jdk7/binaries/index.html">http://dlc.sun.com.edgesuite.net/jdk7/binaries/index.html</a>
</li>

<li>Trying the prototype<br />
<a href="http://mail.openjdk.java.net/pipermail/lambda-dev/2010-August/002179.html">http://mail.openjdk.java.net/pipermail/lambda-dev/2010-August/002179.html</a>
</li>

<li>Better closures (for Java)<br />
<a href="http://blogs.sun.com/jrose/entry/better_closures">http://blogs.sun.com/jrose/entry/better_closures</a>
</li>

<li>Lambdas in Java: An In-Depth Analysis<br />
<a href="http://www.infoq.com/articles/lambdas-java-analysis">http://www.infoq.com/articles/lambdas-java-analysis</a>
</li>

<li>Class ReflectiveOperationException<br />
<a href="http://download.java.net/jdk7/docs/api/java/lang/ReflectiveOperationException.html">http://download.java.net/jdk7/docs/api/java/lang/ReflectiveOperationException.html</a>
</li>

<li>Proposal: Indexing access syntax for Lists and Maps<br />
<a href="http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/001108.html">http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/001108.html</a>
</li>

<li>Proposal: Elvis and Other Null-Safe Operators<br />
<a href="http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/000047.html">http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/000047.html</a>
</li>

<li>Java 7 : Oracle pushes a first version of closures<br />
<a href="http://www.baptiste-wicht.com/2010/05/oracle-pushes-a-first-version-of-closures/">http://www.baptiste-wicht.com/2010/05/oracle-pushes-a-first-version-of-closures/</a>
</li>

<li>Groovy: An agile dynamic language for the Java Platform<br />
<a href="http://groovy.codehaus.org/Operators">http://groovy.codehaus.org/Operators</a>
</li>

<li>Better Strategies for Null Handling in Java<br />
<a href="http://www.slideshare.net/Stephan.Schmidt/better-strategies-for-null-handling-in-java">http://www.slideshare.net/Stephan.Schmidt/better-strategies-for-null-handling-in-java</a>
</li>

<li>Control Flow in the Java Virtual Machine<br />
<a href="http://www.artima.com/underthehood/flowP.html">http://www.artima.com/underthehood/flowP.html</a>
</li>

<li>Java Virtual Machine<br />
<a href="http://en.wikipedia.org/wiki/Java_virtual_machine">http://en.wikipedia.org/wiki/Java_virtual_machine</a>
</li>

<li>==, .equals(), compareTo(), and compare()<br />
<a href="http://leepoint.net/notes-java/data/expressions/22compareobjects.html">http://leepoint.net/notes-java/data/expressions/22compareobjects.html</a>
</li>

<li>New JDK7 features<br />
<a href="http://openjdk.java.net/projects/jdk7/features/">http://openjdk.java.net/projects/jdk7/features/</a>
</li>

<li>Project Coin: Bringing it to a Close(able)<br />
<a href="http://blogs.sun.com/darcy/entry/project_coin_bring_close">http://blogs.sun.com/darcy/entry/project_coin_bring_close</a>
</li>

<li>ClosableFinder source code<br />
<a href="http://blogs.sun.com/darcy/resource/ProjectCoin/CloseableFinder.java">http://blogs.sun.com/darcy/resource/ProjectCoin/CloseableFinder.java</a>
</li>

<li>Joe Darcy blog about JDK<br />
<a href="http://blogs.sun.com/darcy">http://blogs.sun.com/darcy</a>
</li>

<li>Java 7 - more dynamics<br />
<a href="http://www.baptiste-wicht.com/2010/04/java-7-more-dynamics/">http://www.baptiste-wicht.com/2010/04/java-7-more-dynamics/</a>
</li>

<li>ArrayList (JDK 1.4)<br />
<a href="http://download.oracle.com/javase/1.4.2/docs/api/java/util/ArrayList.html">http://download.oracle.com/javase/1.4.2/docs/api/java/util/ArrayList.html</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2011</small></p>
</body>
</html>

