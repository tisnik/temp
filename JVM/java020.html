<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Pohled pod kapotu JVM (3.èást - pokraèování popisu struktury souborù .class)</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Pohled pod kapotu JVM (3.èást - pokraèování popisu struktury souborù .class)</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V dne¹ní èásti seriálu o programovacím jazyce Java i o vlastnostech JVM se ji¾ potøetí vrátíme ke struktuøe bajtkódu, tj. k souborùm s koncovkou .class. Øekneme si, jakým zpùsobem jsou v bajtkódu ulo¾eny dal¹í dùle¾ité informace: pøíznaky tøídy èi rozhraní, jméno implementované tøídy, jméno nadtøídy a koneènì i seznam v¹ech implementovaných rozhraní.</p>



<h2>Obsah</h2>

<p><a href="#k01">1. Pohled pod kapotu JVM (3.èást - pokraèování popisu struktury souborù .class)</a></p>
<p><a href="#k02">2. Definice pøíznakù tøídy èi rozhraní</a></p>
<p><a href="#k03">3. Úprava demonstraèního dekompileru a pøíznaky nastavené u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</a></p>
<p><a href="#k04">4. Jméno tøídy/rozhraní/výètu/anotace a jméno nadøazené tøídy</a></p>
<p><a href="#k05">5. Jména tøíd a nadøazených tøíd u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</a></p>
<p><a href="#k06">6. Seznam implementovaných rozhraní</a></p>
<p><a href="#k07">7. (Prozatím) finální verze dekompileru souborù .class &ndash; doplnìní o výpis v¹ech implementovaných rozhraní</a></p>
<p><a href="#k08">8. Výpis v¹ech implementovaných rozhraní u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</a></p>
<p><a href="#k09">9. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. Pohled pod kapotu JVM (3.èást - pokraèování popisu struktury souborù .class)</h2>

<p>V&nbsp;pøedchozích dvou èástech <a
href="http://www.root.cz/serialy/programovaci-jazyk-java-a-jvm/">seriálu o
programovacím jazyce Java i o vlastnostech virtuálního stroje</a> tohoto jazyka
jsme si podrobnì popsali strukturu <i>constant poolu</i>, jen¾ tvoøí nedílnou
souèást ka¾dého bajtkódu, tj.&nbsp;ka¾dého souboru s&nbsp;koncovkou
<strong>.class</strong> generovaného pøekladaèem Javy (vìt¹inou programem
<strong>javac</strong>). Pro výpis obsahu <i>constant poolu</i> byl pou¾it
relativnì jednoduchý nástroj naprogramovaný v&nbsp;céèku, který budeme
v&nbsp;dne¹ním èlánku postupnì roz¹iøovat. Pøipomeòme si, ¾e v&nbsp;<i>constant
poolu</i> jsou umístìny v¹echny øetìzcové konstanty (literály), celoèíselné i
reálné konstanty, jména tøíd, signatury metod a koneènì i signatury atributù.
Signatura metody se skládá z&nbsp;jejího jména, zakódovaného návratového typu i
zakódovaných typù v¹ech argumentù metody. U signatury atributu je vedle jeho
jména ulo¾en (opìt v&nbsp;zakódované podobì) i jeho datový typ. V&nbsp;dne¹ním
èlánku si alespoò zhruba popí¹eme dal¹í údaje, které je mo¾né v&nbsp;souborech
<strong>.class</strong> nalézt.</p>

<p>Celkovou strukturu bajtkódu jsme si ji¾ popsali. Z&nbsp;minula ji¾ víme, co
obsahuje hlavièka souborù <strong>.class</strong> a známe i zpùsob ulo¾ení
informací v&nbsp;<i>constant poolu</i>. Dal¹í údaje v&nbsp;bajtkódu jsou v¹ak
neménì dùle¾ité. Jedná se pøedev¹ím o pøíznaky tøídy èi rozhraní, informace o
jménì tøídy i nadtøídy, seznam implementovaných rozhraní, atributy tøídy a
koneènì i o nejdùle¾itìj¹í typ údajù &ndash; instrukce tvoøící tìla
jednotlivých metod:</p>

<pre>
+-----------------------------------+
|  Hlavièka                         |
+-----------------------------------+
|  Constant pool                    |
|  .....                            |
|  .....                            |
|  .....                            |
+-----------------------------------+
|  Definice pøíznakù tøídy/rozhraní |
+-----------------------------------+
|  Jméno tøídy a nadtøídy           |
+-----------------------------------+
|  Implementovaná rozhraní          |
|  .....                            |
+-----------------------------------+
|  Atributy tøídy                   |
|  .....                            |
+-----------------------------------+
|  Kódy jednotlivých metod          |
|  .....                            |
|  .....                            |
|  .....                            |
+-----------------------------------+
|  Dal¹í metadata tøídy             |
+-----------------------------------+
</pre>



<p><a name="k02"></a></p>
<h2 id="k02">2. Definice pøíznakù tøídy èi rozhraní</h2>

<p>Pojïme si tedy podrobnìji popsat dal¹í údaje, z&nbsp;nich¾ je sestaven ka¾dý
javovský bajtkód. Ihned za posledním záznamem ulo¾eným v&nbsp;<i>constant
poolu</i> se nachází dal¹í dùle¾itá informace. Jedná se o pøíznaky pøiøazené ke
tøídì, k&nbsp;výètovému typu, k&nbsp;rozhraní èi k&nbsp;anotaci, z&nbsp;ní¾
soubor <strong>.class</strong> vznikl. V¹echny tyto pøíznaky jsou spoleènì
zakódované ve dvojici bajtù, jejich¾ poøadí opìt (stejnì jako u jiných typù
záznamù v&nbsp;bajtkódu) odpovídá poøadí <i>big endian</i>. V&nbsp;následující
tabulce jsou vypsány v¹echny pøíznaky, s&nbsp;nimi¾ se mù¾eme setkat
v&nbsp;rùzných verzích bajtkódu. Prvních pìt pøíznakù se pou¾ívá ji¾ od prvních
verzí <i>JVM</i>, dal¹í pøíznaky byly postupnì pøidávány s&nbsp;tím, jak se
roz¹iøovala syntaxe a samozøejmì i sémantika programovacího jazyka <i>Java</i>.
Jedná se pøedev¹ím o pøíznak <strong>ACC_ANNOTATION</strong>, který se objevil
spoleènì s&nbsp;anotacemi (<i>Java 5</i>) a takté¾ o pøíznak
<strong>ACC_ENUM</strong> oznaèující výètový typ (<i>enumeration</i>):</p>

<table>
<tr><th>#</th><th>Jméno pøíznaku</th><th>Bitová maska</th><th>Význam pøíznaku</th></tr>
<tr><td>1</td><td>ACC_PUBLIC    </td><td>0x0001</td><td>veøejná tøída èi rozhraní</td></tr>
<tr><td>2</td><td>ACC_FINAL     </td><td>0x0010</td><td>finální tøída (nelze z&nbsp;ní vytváøet dal¹í odvozené tøídy)</td></tr>
<tr><td>3</td><td>ACC_SUPER     </td><td>0x0020</td><td>mìní význam volání metod nadtøídy pomocí instrukce <strong>invokespecial</strong></td></tr>
<tr><td>4</td><td>ACC_INTERFACE </td><td>0x0200</td><td>pøíznak oznaèující, ¾e se jedná o rozhraní</td></tr>
<tr><td>5</td><td>ACC_ABSTRACT  </td><td>0x0400</td><td>abstraktní tøída (nelze vytvoøit její pøímou instanci)</td></tr>
<tr><td>6</td><td>ACC_SYNTHETIC </td><td>0x1000</td><td>obvykle se jedná o tøídu generovanou pøímo pøekladaèem (neexistuje k&nbsp;ní zdrojový kód)</td></tr>
<tr><td>7</td><td>ACC_ANNOTATION</td><td>0x2000</td><td>jedná se o anotaci</td></tr>
<tr><td>8</td><td>ACC_ENUM      </td><td>0x4000</td><td>jedná se o výèet</td></tr>
</table>

<p>Vzhledem ke vztahu mezi vý¹e popsanými pøíznaky a sémantikou programovacího
jazyka Java je zøejmé, ¾e zdaleka ne v¹echny kombinace pøíznakù jsou korektní.
Napøíklad platí, ¾e pøíznak <strong>ACC_INTERFACE</strong> by mìl být pou¾it
spoleènì s&nbsp;pøíznakem <strong>ACC_ABSTRACT</strong>. Podobnì platí, ¾e
pokud se jedná o anotaci, tj.&nbsp;je nastaven pøíznak
<strong>ACC_ANNOTATION</strong>, mìl by být spoleènì nastaven pøíznak
<strong>ACC_INTERFACE</strong>. Takté¾ je pochopitelné, ¾e pøíznaky
<strong>ACC_FINAL</strong> a <strong>ACC_ABSTRACT</strong> nesmí být nastaveny
spoleènì &ndash; nelze toti¾ vytvoøit finální a souèasnì i abstraktní tøídu.
Speciální význam má pøíznak <strong>ACC_SUPER</strong>, který mìní význam
instrukce <strong>invokespecial</strong>. O významu této instrukce se zmíníme
v&nbsp;následující èásti tohoto seriálu.</p>



<p><a name="k03"></a></p>
<h2 id="k03">3. Úprava demonstraèního dekompileru a pøíznaky nastavené u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</h2>

<p>Pøidání výpisu pøíznakù tøídy, rozhraní, anotace èi výètu do pomocného
nástroje popsaného v&nbsp;pøedchozí èásti tohoto seriálu je velmi snadné,
proto¾e postaèuje ihned po zpracování <i>constant poolu</i> pøeèíst
z&nbsp;bajtkódu dvojici bajtù nacházejících se za posledním záznamem ulo¾eným
v&nbsp;<i>constant poolu</i> a následnì správnì interpretovat jednotlivé bity
ulo¾ené v&nbsp;této dvojici bajtù. Do programu tedy staèí doplnit jeden výèet
(skupinu celoèíselných konstant) a jednu novou funkci:</p>

<pre>
/*
 * Priznaky tridy ci rozhrani.
 */
enum
{
    ACC_PUBLIC     = 0x0001,     /* verejna trida/rozhrani */
    ACC_FINAL      = 0x0010,     /* finalni trida */
    ACC_SUPER      = 0x0020,     /* semantika instrukce invokespecial */
    ACC_INTERFACE  = 0x0200,     /* rozliseni trida/rozhrani */
    ACC_ABSTRACT   = 0x0400,     /* abstraktni trida */
    ACC_SYNTHETIC  = 0x1000,     /* synteticka trida */
    ACC_ANNOTATION = 0x2000,     /* anotace */
    ACC_ENUM       = 0x4000,     /* vycet */
};
</pre>

<p>Tyto konstanty jsou pou¾ity v&nbsp;nové funkci
<strong>process_class_flags</strong>:</p>

<pre>
/*
 * Nacteni a vypis atributu tridy ci rozhrani.
 */
void process_class_flags(FILE *fin)
{
    uint16_t flags;

    flags = read_two_bytes(fin);
    printf("\nClass/interface attributes: 0x%04x\n", flags);

    if (flags &amp; ACC_PUBLIC)     puts("    ACC_PUBLIC");
    if (flags &amp; ACC_FINAL)      puts("    ACC_FINAL");
    if (flags &amp; ACC_SUPER)      puts("    ACC_SUPER");
    if (flags &amp; ACC_INTERFACE)  puts("    ACC_INTERFACE");
    if (flags &amp; ACC_ABSTRACT)   puts("    ACC_ABSTRACT");
    if (flags &amp; ACC_SYNTHETIC)  puts("    ACC_SYNTHETIC");
    if (flags &amp; ACC_ANNOTATION) puts("    ACC_ANNOTATION");
    if (flags &amp; ACC_ENUM)       puts("    ACC_ENUM");
}
</pre>

<p>Zdrojový text tímto zpùsobem upraveného dekompileru souborù
<strong>.class</strong> mù¾ete nalézt <a
href="http://i.iinfo.cz/files/root/134/decompiler2-c.c">zde</a>, popø.&nbsp;si
mù¾ete prohlédnout i <a
href="http://i.iinfo.cz/files/root/60/decompiler2-html.html">zdrojový kód se
zvýraznìnou syntaxí</a>.</p>

<p>Uka¾me si nyní výpis pøíznakù pro standardní <strong>.class</strong> soubory
získané z&nbsp;archivu <strong>rt.jar</strong>, který vìt¹inou mù¾ete nalézt
v&nbsp;adresáøi <strong>/usr/lib/jvm/java***/jre/lib</strong>. Pøipomeòme si,
¾e v&nbsp;archivu <strong>rt.jar</strong> se nachází v¹echny tøídy tvoøící
standardní API Javy:</p>

<p><strong>java.lang.Object</strong>:</p>

<pre>
Class/interface attributes: 0x0021
    ACC_PUBLIC
    ACC_SUPER
</pre>

<p><strong>java.lang.String</strong>:</p>

<pre>
Class/interface attributes: 0x0031
    ACC_PUBLIC
    ACC_FINAL
    ACC_SUPER
</pre>

<p><strong>java.lang.Number</strong>:</p>

<pre>
Class/interface attributes: 0x0421
    ACC_PUBLIC
    ACC_SUPER
    ACC_ABSTRACT
</pre>

<p><strong>java.lang.Integer</strong>:</p>

<pre>
Class/interface attributes: 0x0031
    ACC_PUBLIC
    ACC_FINAL
    ACC_SUPER
</pre>

<p><strong>java.lang.Comparable</strong>:</p>

<pre>
Class/interface attributes: 0x0601
    ACC_PUBLIC
    ACC_INTERFACE
    ACC_ABSTRACT
</pre>

<p><strong>java.lang.Override</strong>:</p>

<pre>
Class/interface attributes: 0x2601
    ACC_PUBLIC
    ACC_INTERFACE
    ACC_ABSTRACT
    ACC_ANNOTATION
</pre>

<p><strong>java.lang.Exception</strong>:</p>

<pre>
Class/interface attributes: 0x0021
    ACC_PUBLIC
    ACC_SUPER
</pre>

<p><strong>java.lang.NullPointerException</strong>:</p>

<pre>
Class/interface attributes: 0x0021
    ACC_PUBLIC
    ACC_SUPER
</pre>

<p><strong>java.lang.Class</strong>:</p>

<pre>
Class/interface attributes: 0x0031
    ACC_PUBLIC
    ACC_FINAL
    ACC_SUPER
</pre>



<p><a name="k04"></a></p>
<h2 id="k04">4. Jméno tøídy/rozhraní/výètu/anotace a jméno nadøazené tøídy</h2>

<p>Ihned za dvojicí bajtù, v&nbsp;nich¾ jsou ulo¾eny pøíznaky tøídy, výètu,
rozhraní èi anotace, se nachází dal¹í dùle¾itý údaj. Tento údaj reprezentuje
jméno tøídy, rozhraní, anotace èi výètu, ke které pøíslu¹í daný soubor
<strong>.class</strong>. Ve skuteènosti v¹ak na tomto místì bajtkódu není
ulo¾en pøímo øetìzec s&nbsp;názvem pøíslu¹ného jazykového prvku, ale pouze
dvoubajtový odkaz na záznam umístìný v&nbsp;<i>constant poolu</i>. Musí se
pøitom v¾dy jednat o odkaz na záznam typu <i>CONSTANT_Class</i>, co¾ je
samozøejmì nále¾itì kontrolováno ji¾ pøi naèítání bajtkódu do virtuálního
stroje Javy. Pøipomeòme si, ¾e záznam typu <i>CONSTANT_Class</i> obsahuje odkaz
(index) na záznam typu <i>CONSTANT_Utf8</i>, který ji¾ obsahuje ký¾enou
øetìzcovou konstantu (literál) se jménem tøídy. Poznamenejme, ¾e jméno tøídy je
uvedeno v&nbsp;plné podobì, tj.&nbsp;i se jménem balíèku, v&nbsp;nìm¾ se tøída
nachází. Pro oddìlení jednotlivých èástí &bdquo;cesty&ldquo; ke tøídì je pou¾it
znak lomítka, který lze pro úèely tisku zmìnit na znak teèky.</p>

<p>Velmi podobný význam má i dal¹í dvojice bajtù ulo¾ená v&nbsp;bajtkódu. Tento
údaj obsahuje informaci o jménu nadøazené tøídy (<i>super class</i>) a opìt se
musí jednat o index do <i>constant poolu</i>, jen¾ odkazuje na záznam typu
<i>CONSTANT_Class</i> (není snad nutné pøipomínat, ¾e pøi naèítání bajtkódu je
jeho korektnost opìt kontrolována). Mezi obìma zmínìnými názvy je v¹ak jeden
rozdíl &ndash; zatímco název tøídy musí být v¾dy korektnì vyplnìn,
v&nbsp;pøípadì názvu nadøazené tøídy je mo¾né, aby tento údaj obsahoval nulu,
ov¹em pouze v&nbsp;tom speciálním pøípadì, ¾e bajtkód byl získán pøekladem
tøídy <strong>Object</strong>, která nemá ¾ádnou nadtøídu, co¾ vyplývá ze
samotné specifikace programovacího jazyka Java. Ostatní tøídy, vèetnì tøíd bez
explicitnì specifikované nadtøídy, mají tento údaj vyplnìn.</p>



<p><a name="k05"></a></p>
<h2 id="k05">5. Jména tøíd a nadøazených tøíd u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</h2>

<p>Úprava na¹eho demonstraèního dekompileru bajtkódu takovým zpùsobem, aby
dokázal zobrazit jméno tøídy (atributu, výètu...) a jméno pøíslu¹né nadtøídy,
není vùbec slo¾itá, nebo» postaèuje naèíst obì dvojice bajtù a následnì je
pou¾ít jako indexy do <i>constant poolu</i>, jeho¾ obsah je ulo¾en v&nbsp;poli
<strong>pool_entries</strong>. Funkce pro výpis jména tøídy (èi jiného
jazykového prvku) vypadá následovnì:</p>

<pre>
/*
 * Nacteni a vypis jmena tridy.
 */
void process_class_name(FILE *fin)
{
    /* nacist index z bajtkodu */
    uint16_t index = read_two_bytes(fin);

    /* v cecku se indexuje od 0, v constant poolu od 1 */
    index--;

    printf("\nClass name is stored in constant pool #%d\n", index);

    PoolEntry pool_entry = pool_entries[index];
    print_class_info(&amp;pool_entry);
}
</pre>

<p>Výpis jména nadøazené tøídy je nepatrnì slo¾itìj¹í, nebo» je zapotøebí
detekovat speciální pøípad tøídy <strong>Object</strong>:</p>

<pre>
/*
 * Nacteni a vypis jmena nadrazene tridy.
 */
void process_superclass_name(FILE *fin)
{
    /* nacist index z bajtkodu */
    uint16_t index = read_two_bytes(fin);

    /* test na specialni pripad */
    if (index == 0)
    {
        printf("\nIt's a class without super class!\n");
    }
    else
    {
        /* v cecku se indexuje od 0, v constant poolu od 1 */
        index--;

        printf("\nSuper class name is stored in constant pool #%d\n", index);
        PoolEntry pool_entry = pool_entries[index];
        print_class_info(&amp;pool_entry);
    }
}
</pre>

<p>Zdrojový text tøetí verze demonstraèního dekompileru souborù
<strong>.class</strong> mù¾ete nalézt <a
href="http://i.iinfo.cz/files/root/586/decompiler3-c.c">zde</a>, popø.&nbsp;si
mù¾ete prohlédnout i <a
href="http://i.iinfo.cz/files/root/143/decompiler3-html.html">zdrojový kód se
zvýraznìnou syntaxí</a>.</p>

<p>Opìt si mù¾eme vyzkou¹et, jaké údaje získáme analýzou
<strong>.class</strong> souborù ze standardního balíèku
<strong>java.lang</strong>:</p>

<p><strong>java.lang.Object</strong>:</p>

<pre>
Class name is stored in constant pool #17
Class            74        java/lang/Object
It's a class without super class!
</pre>

<p><strong>java.lang.String</strong>:</p>

<pre>
Class name is stored in constant pool #39
Class           414        java/lang/String
Super class name is stored in constant pool #116
Class           493        java/lang/Object
</pre>

<p><strong>java.lang.Number</strong>:</p>

<pre>
Class name is stored in constant pool #2
Class            34        java/lang/Number
Super class name is stored in constant pool #3
Class            35        java/lang/Object
</pre>

<p><strong>java.lang.Integer</strong>:</p>

<pre>
Class name is stored in constant pool #32
Class           231        java/lang/Integer
Super class name is stored in constant pool #69
Class           258        java/lang/Number
</pre>

<p><strong>java.lang.Comparable</strong>:</p>

<pre>
Class name is stored in constant pool #0
Class            10        java/lang/Comparable
Super class name is stored in constant pool #1
Class            11        java/lang/Object
</pre>

<p><strong>java.lang.Override</strong>:</p>

<pre>
Class name is stored in constant pool #0
Class            14        java/lang/Override
Super class name is stored in constant pool #1
Class            15        java/lang/Object
</pre>

<p><strong>java.lang.Exception</strong>:</p>

<pre>
Class name is stored in constant pool #4
Class            32        java/lang/Exception
Super class name is stored in constant pool #5
Class            33        java/lang/Throwable
</pre>

<p><strong>java.lang.NullPointerException</strong>:</p>

<pre>
Class name is stored in constant pool #2
Class            19        java/lang/NullPointerException
Super class name is stored in constant pool #3
Class            20        java/lang/RuntimeException
</pre>

<p><strong>java.lang.Class</strong>:</p>

<pre>
Class name is stored in constant pool #26
Class           681        java/lang/Class
Super class name is stored in constant pool #237
Class           882        java/lang/Object
</pre>

<p>Pokud pro jednoduchost nebudeme brát do úvahy implementovaná rozhraní, lze
celou objektovou hierarchii v¹ech tøíd zrekonstruovat pomocí dvojice údajù
popsaných v&nbsp;pøedchozích odstavcích.</p>



<p><a name="k06"></a></p>
<h2 id="k06">6. Seznam implementovaných rozhraní</h2>

<p>Z&nbsp;informací, které jsme a¾ doposud z&nbsp;bajtkódu získali, je ji¾
mo¾né èásteènì zrekonstruovat hlavièku libovolné tøídy, proto¾e ji¾ známe její
pøíznaky (<strong>public</strong>, <strong>abstract</strong>,
<strong>final</strong> atd.) a samozøejmì i její plné jméno i jméno nadøazené
tøídy (vèetnì uvedení balíèku). Ov¹em ve skuteènosti mù¾e tøída implementovat i
libovolný poèet rozhraní, co¾ je dal¹í informace, kterou je nutné nìjakým
zpùsobem pøeèíst z&nbsp;bajtkódu. To je ve skuteènosti velmi jednoduché, nebo»
ihned za dvojicí indexù odkazujících na jméno tøídy a nadøazené tøídy se
v&nbsp;bajtkódu nachází ¹estnáctibitové slovo s&nbsp;poètem v¹ech
implementovaných rozhraní (èistì teoreticky jich tedy mù¾e být a¾ 65535) a
ihned za tímto údajem se nachází <i>n</i> ¹estnáctibitových indexù do
<i>constant poolu</i>, kde <i>n</i> odpovídá poètu implementovaných rozhraní
(toto pole indexù mù¾e samozøejmì být i prázdné, pokud tøída ¾ádné rozhraní
neimplementuje, tj.&nbsp;<i>n==0</i>). Podobnì jako u jména tøídy i jména
nadtøídy, musí ka¾dý index v&nbsp;poli s&nbsp;rozhraními odkazovat na záznam
typu <i>CONSTANT_Class</i>, který sám obsahuje odkaz na záznam typu
<i>CONSTANT_Utf8</i>, tj.&nbsp;na vlastní øetìzec se jménem rozhraní.</p>



<p><a name="k07"></a></p>
<h2 id="k07">7. (Prozatím) finální verze dekompileru souborù .class &ndash; doplnìní o výpis v¹ech implementovaných rozhraní</h2>

<p>Doplnìní na¹eho demonstraèního dekompileru bajtkódu o výpis v¹ech
implementovaných rozhraní je obstaráno funkcí
<strong>process_all_implemented_interfaces()</strong>, kterou je nutné zavolat
ihned po funkci <strong>process_superclass_name()</strong> (pøesnìji øeèeno se
nemusí tyto funkce volat ihned po sobì, mezi voláním tìchto funkcí v¹ak nesmí
dojít ke ètení údajù z&nbsp;bajtkódu, proto¾e by do¹lo k&nbsp;posunu internì
udr¾ovaného offsetu poslednì naèteného bajtu). Funkce
<strong>process_all_implemented_interfaces</strong> je velmi jednoduchá &ndash;
pouze pøeète poèet indexù v&nbsp;tabulce implementovaných rozhraní a posléze
celou tabulku zpracuje a vytiskne pøíslu¹né referencované hodnoty získané
z&nbsp;<i>constant poolu</i>:</p>

<pre>
/*
 * Nacteni a vypis vsech implementovanych rozhrani
 */
void process_all_implemented_interfaces(FILE *fin)
{
    int i;
    /* nacist pocet implementovanych rozhrani */
    uint16_t interfaces = read_two_bytes(fin);
    /* zakladni informace pro uzivatele */
    printf("\nNumber of implemented interfaces: %d\n", interfaces);

    /* vypis vsech rozhrani */
    for (i = 0; i &lt; interfaces; i++)
    {
        /* nacist index do constant poolu */
        int index = read_two_bytes(fin);
        /* v cecku se indexuje od 0, v constant poolu od 1 */
        index--;
        /* ziskat a vypsat pozadovanou informaci */
        PoolEntry pool_entry = pool_entries[index];
        print_class_info(&amp;pool_entry);
        putchar('\n');
    }
}
</pre>

<p>Zdrojový text ji¾ ètvrté varianty dekompileru souborù
<strong>.class</strong> mù¾ete nalézt <a
href="http://i.iinfo.cz/files/root/105/decompiler4-c.c">zde</a>, popø.&nbsp;si
mù¾ete prohlédnout i <a
href="http://i.iinfo.cz/files/root/656/decompiler4-html.html">zdrojový kód se
zvýraznìnou syntaxí</a>.</p>



<p><a name="k08"></a></p>
<h2 id="k08">8. Výpis v¹ech implementovaných rozhraní u vybraných souborù .class pocházejících z&nbsp;balíèku java.lang</h2>

<p>S&nbsp;vyu¾itím prozatím finální verze demonstraèního dekompileru bajtkódu
je mo¾né snadno zjistit seznam v¹ech rozhraní implementovaných vybranými
tøídami ze standardního balíèku <strong>java.lang</strong>:</p>

<p><strong>java.lang.Object</strong>:</p>

<pre>
Number of implemented interfaces: 0
</pre>

<p><strong>java.lang.String</strong>:</p>

<pre>
Number of implemented interfaces: 3
Class           494        java/io/Serializable
Class           495        java/lang/Comparable
Class           496        java/lang/CharSequence
</pre>

<p><strong>java.lang.Number</strong>:</p>

<pre>
Number of implemented interfaces: 1
Class            36        java/io/Serializable
</pre>

<p><strong>java.lang.Integer</strong>:</p>

<pre>
Number of implemented interfaces: 1
Class           259        java/lang/Comparable
</pre>

<p><strong>java.lang.Comparable</strong>:</p>

<pre>
Number of implemented interfaces: 0
</pre>

<p><strong>java.lang.Override</strong>:</p>

<pre>
Number of implemented interfaces: 1
Class            16        java/lang/annotation/Annotation
</pre>

<p><strong>java.lang.Exception</strong>:</p>

<pre>
Number of implemented interfaces: 0
</pre>

<p><strong>java.lang.NullPointerException</strong>:</p>

<pre>
Number of implemented interfaces: 0
</pre>

<p><strong>java.lang.Class</strong>:</p>

<pre>
Number of implemented interfaces: 4
Class           923        java/io/Serializable
Class           924        java/lang/reflect/GenericDeclaration
Class           925        java/lang/reflect/Type
Class           926        java/lang/reflect/AnnotatedElement
</pre>



<p><a name="k09"></a></p>
<h2 id="k09">9. Odkazy na Internetu</h2>

<ol>

<li>The JavaTM Virtual Machine Specification, Second Edition<br />
<a href="http://java.sun.com/docs/books/jvms/second_edition/html/VMSpecTOC.doc.html">http://java.sun.com/docs/books/jvms/second_edition/html/VMSpecTOC.doc.html</a>
</li>

<li>The class File Format<br />
<a href="http://java.sun.com/docs/books/jvms/second_edition/html/ClassFile.doc.html">http://java.sun.com/docs/books/jvms/second_edition/html/ClassFile.doc.html</a>
</li>

<li>javap - The Java Class File Disassembler<br />
<a href="http://docs.oracle.com/javase/1.4.2/docs/tooldocs/windows/javap.html">http://docs.oracle.com/javase/1.4.2/docs/tooldocs/windows/javap.html</a>
</li>

<li>javap-java-1.6.0-openjdk(1) - Linux man page<br />
<a href="http://linux.die.net/man/1/javap-java-1.6.0-openjdk">http://linux.die.net/man/1/javap-java-1.6.0-openjdk</a>
</li>

<li>Using javap<br />
<a href="http://www.idevelopment.info/data/Programming/java/miscellaneous_java/Using_javap.html">http://www.idevelopment.info/data/Programming/java/miscellaneous_java/Using_javap.html</a>
</li>

<li>Examine class files with the javap command<br />
<a href="http://www.techrepublic.com/article/examine-class-files-with-the-javap-command/5815354">http://www.techrepublic.com/article/examine-class-files-with-the-javap-command/5815354</a>
</li>

<li>BCEL Home page<br />
<a href="http://commons.apache.org/bcel/">http://commons.apache.org/bcel/</a>
</li>

<li>BCEL Manual<br />
<a href="http://commons.apache.org/bcel/manual.html">http://commons.apache.org/bcel/manual.html</a>
</li>

<li>Byte Code Engineering Library (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/BCEL">http://en.wikipedia.org/wiki/BCEL</a>
</li>

<li>Java programming dynamics, Part 7: Bytecode engineering with BCEL<br />
<a href="http://www.ibm.com/developerworks/java/library/j-dyn0414/">http://www.ibm.com/developerworks/java/library/j-dyn0414/</a>
</li>

<li>Bytecode Engineering<br />
<a href="http://book.chinaunix.net/special/ebook/Core_Java2_Volume2AF/0131118269/ch13lev1sec6.html">http://book.chinaunix.net/special/ebook/Core_Java2_Volume2AF/0131118269/ch13lev1sec6.html</a>
</li>

<li>BCEL Tutorial<br />
<a href="http://www.smfsupport.com/support/java/bcel-tutorial!/">http://www.smfsupport.com/support/java/bcel-tutorial!/</a>
</li>

<li>ASM Home page<br />
<a href="http://asm.ow2.org/">http://asm.ow2.org/</a>
</li>

<li>Seznam nástrojù vyu¾ívajících projekt ASM<br />
<a href="http://asm.ow2.org/users.html">http://asm.ow2.org/users.html</a>
</li>

<li>ObjectWeb ASM (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/ObjectWeb_ASM">http://en.wikipedia.org/wiki/ObjectWeb_ASM</a>
</li>

<li>Java Bytecode BCEL vs ASM<br />
<a href="http://james.onegoodcookie.com/2005/10/26/java-bytecode-bcel-vs-asm/">http://james.onegoodcookie.com/2005/10/26/java-bytecode-bcel-vs-asm/</a>
</li>

<li>Bytecode Outline plugin for Eclipse (screenshoty + info)<br />
<a href="http://asm.ow2.org/eclipse/index.html">http://asm.ow2.org/eclipse/index.html</a>
</li>

<li>aspectj (Eclipse)<br />
<a href="http://www.eclipse.org/aspectj/">http://www.eclipse.org/aspectj/</a>
</li>

<li>Aspect-oriented programming (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Aspect_oriented_programming">http://en.wikipedia.org/wiki/Aspect_oriented_programming</a>
</li>

<li>AspectJ (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/AspectJ">http://en.wikipedia.org/wiki/AspectJ</a>
</li>

<li>EMMA: a free Java code coverage tool<br />
<a href="http://emma.sourceforge.net/">http://emma.sourceforge.net/</a>
</li>

<li>Cobertura<br />
<a href="http://cobertura.sourceforge.net/">http://cobertura.sourceforge.net/</a>
</li>

<li>FindBugs<br />
<a href="http://findbugs.sourceforge.net/">http://findbugs.sourceforge.net/</a>
</li>

<li>GNU Classpath<br />
<a href="www.gnu.org/s/classpath/">www.gnu.org/s/classpath/</a></li>

<li>Java VMs Compared<br />
<a href="http://bugblogger.com/java-vms-compared-160/">http://bugblogger.com/java-vms-compared-160/</a>
</li>

<li>JSRs: Java Specification Requests &ndash; JSR 223: Scripting for the Java Platform<br />
<a href="http://www.jcp.org/en/jsr/detail?id=223">http://www.jcp.org/en/jsr/detail?id=223</a>
</li>

<li>Scripting for the Java Platform<br />
<a href="http://java.sun.com/developer/technicalArticles/J2SE/Desktop/scripting/">http://java.sun.com/developer/technicalArticles/J2SE/Desktop/scripting/</a>
</li>

<li>Scripting for the Java Platform (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Scripting_for_the_Java_Platform">http://en.wikipedia.org/wiki/Scripting_for_the_Java_Platform</a>
</li>

<li>Java Community Process<br />
<a href="http://en.wikipedia.org/wiki/Java_Specification_Request">http://en.wikipedia.org/wiki/Java_Specification_Request</a>
</li>

<li>Java HotSpot VM Options<br />
<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html</a></li>

<li>Great Computer Language Shootout<br />
<a href="http://c2.com/cgi/wiki?GreatComputerLanguageShootout">http://c2.com/cgi/wiki?GreatComputerLanguageShootout</a>
</li>

<li>Java performance<br />
<a href="http://en.wikipedia.org/wiki/Java_performance">http://en.wikipedia.org/wiki/Java_performance</a>
</li>

<li>Trying the prototype<br />
<a href="http://mail.openjdk.java.net/pipermail/lambda-dev/2010-August/002179.html">http://mail.openjdk.java.net/pipermail/lambda-dev/2010-August/002179.html</a>
</li>

<li>Better closures (for Java)<br />
<a href="http://blogs.sun.com/jrose/entry/better_closures">http://blogs.sun.com/jrose/entry/better_closures</a>
</li>

<li>Lambdas in Java: An In-Depth Analysis<br />
<a href="http://www.infoq.com/articles/lambdas-java-analysis">http://www.infoq.com/articles/lambdas-java-analysis</a>
</li>

<li>Class ReflectiveOperationException<br />
<a href="http://download.java.net/jdk7/docs/api/java/lang/ReflectiveOperationException.html">http://download.java.net/jdk7/docs/api/java/lang/ReflectiveOperationException.html</a>
</li>

<li>Proposal: Indexing access syntax for Lists and Maps<br />
<a href="http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/001108.html">http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/001108.html</a>
</li>

<li>Proposal: Elvis and Other Null-Safe Operators<br />
<a href="http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/000047.html">http://mail.openjdk.java.net/pipermail/coin-dev/2009-March/000047.html</a>
</li>

<li>Java 7 : Oracle pushes a first version of closures<br />
<a href="http://www.baptiste-wicht.com/2010/05/oracle-pushes-a-first-version-of-closures/">http://www.baptiste-wicht.com/2010/05/oracle-pushes-a-first-version-of-closures/</a>
</li>

<li>Groovy: An agile dynamic language for the Java Platform<br />
<a href="http://groovy.codehaus.org/Operators">http://groovy.codehaus.org/Operators</a>
</li>

<li>Better Strategies for Null Handling in Java<br />
<a href="http://www.slideshare.net/Stephan.Schmidt/better-strategies-for-null-handling-in-java">http://www.slideshare.net/Stephan.Schmidt/better-strategies-for-null-handling-in-java</a>
</li>

<li>Control Flow in the Java Virtual Machine<br />
<a href="http://www.artima.com/underthehood/flowP.html">http://www.artima.com/underthehood/flowP.html</a>
</li>

<li>Java Virtual Machine<br />
<a href="http://en.wikipedia.org/wiki/Java_virtual_machine">http://en.wikipedia.org/wiki/Java_virtual_machine</a>
</li>

<li>==, .equals(), compareTo(), and compare()<br />
<a href="http://leepoint.net/notes-java/data/expressions/22compareobjects.html">http://leepoint.net/notes-java/data/expressions/22compareobjects.html</a>
</li>

<li>New JDK7 features<br />
<a href="http://openjdk.java.net/projects/jdk7/features/">http://openjdk.java.net/projects/jdk7/features/</a>
</li>

<li>Project Coin: Bringing it to a Close(able)<br />
<a href="http://blogs.sun.com/darcy/entry/project_coin_bring_close">http://blogs.sun.com/darcy/entry/project_coin_bring_close</a>
</li>

<li>CloseableFinder source code<br />
<a href="http://blogs.sun.com/darcy/resource/ProjectCoin/CloseableFinder.java">http://blogs.sun.com/darcy/resource/ProjectCoin/CloseableFinder.java</a>
</li>

<li>Joe Darcy blog about JDK<br />
<a href="http://blogs.sun.com/darcy">http://blogs.sun.com/darcy</a>
</li>

<li>Java 7 - more dynamics<br />
<a href="http://www.baptiste-wicht.com/2010/04/java-7-more-dynamics/">http://www.baptiste-wicht.com/2010/04/java-7-more-dynamics/</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2011</small></p>
</body>
</html>

