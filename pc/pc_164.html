<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Instrukce typu SIMD na mikroprocesorech RISC (3.èást - MIPS-3D a VIS)</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Instrukce typu SIMD na mikroprocesorech RISC (3.èást - MIPS-3D a VIS)</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V dne¹ní èásti seriálu o architekturách poèítaèù se ji¾ potøetí budeme zabývat popisem instrukèních sad s &bdquo;vektorovými&ldquo; instrukcemi SIMD, které jsou vyu¾ívány na mikroprocesorech RISC. Zatímco minule jsme se zamìøili na popis instrukcí MAX-1 a MAX-2 pou¾ívaných na procesorech øady PA-RISC, dnes se na chvíli vrátíme k èipùm MIPS s roz¹íøením MIPS-3D i k procesorùm SPARC s roz¹íøením VIS.</p>



<h2>Obsah</h2>

<p><a href="#k01">1. Roz¹íøení instrukèních sad MIPS-3D a VIS</a></p>
<p><a href="#k02">2. Instrukèní sada MIPS-3D</a></p>
<p><a href="#k03">3. Datové typy (skaláry a vektory) pou¾ité v&nbsp;instrukèní sadì MIPS-3D</a></p>
<p><a href="#k04">4. Instrukce obsa¾ené v&nbsp;sadì MIPS-3D</a></p>
<p><a href="#k05">5. Pou¾ití instrukcí MIPS-3D v&nbsp;algoritmech poèítaèové grafiky</a></p>
<p><a href="#k06">6. Operace dìlení a výpoètu druhé odmocniny v&nbsp;instrukèní sadì MIPS-3D</a></p>
<p><a href="#k07">7. Instrukèní sada VIS (Visual Instruction Set)</a></p>
<p><a href="#k08">8. Datové typy pou¾ívané instrukcemi VIS</a></p>
<p><a href="#k09">9. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2>1. Roz¹íøení instrukèních sad MIPS-3D a VIS</h2>

<p>V&nbsp;pøedchozích dvou èástech seriálu o architekturách poèítaèù jsme se
zabývali popisem roz¹iøujících instrukèních sad procesorù <i>RISC</i>, které
byly do tìchto èipù implementovány v&nbsp;rámci pomìrnì intenzivního rozvoje
technologie <i>SIMD</i>, co¾ je jedna z&nbsp;ponìkud zjednodu¹ených forem
vektorových instrukcí. Prozatím jsme si popsali instrukèní sadu <i>MDMX
(MadMax, MIPS Digital Media eXtension)</i> pro èipy <i>MIPS</i> <a
href="http://www.root.cz/clanky/instrukce-typu-simd-na-mikroprocesorech-risc/">[1]</a>
a dále sady <i>MAX-1</i> i <i>MAX-2</i> urèené pro procesory z&nbsp;rodiny
<i>PA-RISC</i> <a
href="http://www.root.cz/clanky/instrukce-typu-simd-na-mikroprocesorech-risc-2-cast/">[2]</a>.
Výèet instrukèních sad se <i>SIMD</i> instrukcemi na èipech RISC by v¹ak nebyl
úplný, kdybychom zapomnìli na instrukèní sady <i>VIS (Visual Instruction
Set)</i> pro mikroprocesory <i>SPARC</i> a na sadu <i>MIPS-3D</i> urèenou
&ndash; jak je z&nbsp;názvu patrné &ndash; pro èipy <i>MIPS</i> (zde se v¹ak
jednalo o zcela jinou mno¾inu instrukcí, ne¾ byla ji¾ popsaná sada <i>MDMX</i>,
na nìkterých mikroprocesorech se tyto sady mohly vhodnì doplòovat).</p>

<img src="http://i.iinfo.cz/images/660/pc93-2.jpg" alt="pc93" height="260" width="368" />
<p><i>Obrázek 1: Slavná Uta¾ská èajová konvice (Utah teapot). V&nbsp;dobì
vzniku instrukèní sady MIPS-3D se je¹tì pomìrnì velké mno¾ství výpoètù nutných
pro vykreslení této scény provádìlo na mikroprocesoru; teprve pozdìji do¹lo
k&nbsp;postupnému pøevodu vìt¹iny operací na grafický akcelerátor.</i></p>

<p>Pro pøipomenutí si je¹tì jednou uka¾me tabulku s&nbsp;rùznými <i>SIMD</i>
technologiemi pou¾ívanými na èipech <i>RISC</i>:</p>

<table>
<tr><th>#</th><th>Zkratka/název</th><th>Plný název</th><th>Rodina procesorù</th></tr>
<tr><td>1</td><td>MAX-1  </td><td><a href="http://www.root.cz/clanky/instrukce-typu-simd-na-mikroprocesorech-risc-2-cast/">Multimedia Acceleration eXtensions v1</a></td><td>HP-PA RISC</td></tr>
<tr><td>2</td><td>MAX-2  </td><td><a href="http://www.root.cz/clanky/instrukce-typu-simd-na-mikroprocesorech-risc-2-cast/">Multimedia Acceleration eXtensions v2</a></td><td>HP-PA RISC</td></tr>
<tr><td>3</td><td>VIS 1  </td><td>Visual Instruction Set v1</td><td>SPARC V9</td></tr>
<tr><td>4</td><td>VIS 2  </td><td>Visual Instruction Set v2</td><td>SPARC V9</td></tr>
<tr><td>5</td><td>AltiVec</td><td>(obchodní názvy Velocity Engine, VMX)</td><td>PowerPC</td></tr>
<tr><td>6</td><td>MDMX   </td><td><a href="http://www.root.cz/clanky/instrukce-typu-simd-na-mikroprocesorech-risc/">MIPS Digital Media eXtension (MaDMaX)</a></td><td>MIPS</td></tr>
<tr><td>7</td><td>MIPS-3D</td><td>MIPS-3D</td><td>MIPS</td></tr>
<tr><td>8</td><td>MVI    </td><td>Motion Video Instructions</td><td>DEC Alpha</td></tr>
<tr><td>9</td><td>NEON   </td><td>Advanced SIMD</td><td>Cortex (ARMv7)</td></tr>
</table>

<img src="http://i.iinfo.cz/images/660/pc93-4.jpg" alt="pc93" height="392" width="410" />
<p><i>Obrázek 4: Trojrozmìrná scéna vykreslená s&nbsp;vyu¾itím efektu mlhy
(fog), který byl ve své nejjednodu¹¹í podobì implementován ji¾ na prvních
grafických 3D akcelerátorech pro PC vybavených èipy 3dfx (Voodoo Graphics
PCI).</i></p>



<p><a name="k02"></a></p>
<h2>2. Instrukèní sada MIPS-3D</h2>

<p>Nejprve se budeme zabývat instrukèní sadou nazvanou pøíznaènì
<i>MIPS-3D</i>. Název této instrukèní sady alespoò èásteènì naznaèuje, jaké
instrukce zde mù¾eme najít &ndash; jedná se o instrukce urèené pro urychlení
provádìní nìkterých operací typických pro 3D grafiku. Pøedev¹ím se jedná o
transformace, perspektivní promítání, normalizaci vektorù a oøezávání
(clipping). V&nbsp;souèasnosti je sice mo¾né provádìní tìchto operací pøenechat
grafickému akcelerátoru, ale v&nbsp;dobì vzniku technologie <i>MIPS-3D</i> byly
grafické akcelerátory urèeny pøedev¹ím pro rasterizaci trojúhelníkù a øe¹ení
viditelnosti pomocí pamìti hloubky (<i>Z-bufferu</i>), zatímco základní
zpracování trojrozmìrné scény bylo ponecháno na mikroprocesoru; ostatnì se
mù¾eme sami podívat na postupný vývoj nìkterých èipù urèených pro pou¾ití na
grafických akcelerátorech. Kromì prvního èipu se jedná o integrované obvody
pou¾ívané pøedev¹ím na PC. Ty byly zhruba na pøelomu tisíciletí nahrazeny
výkonnìj¹ími 3D akcelerátory druhé generace:</p>

<table>
<tr><th>#</th>Akcelerátor/èip</th><th>Rok vydání</th></tr>
<tr><td>1</td>Intel i860         </td><td>1989</td></tr>
<tr><td>2</td>Voodoo Graphics PCI</td><td>1996</td></tr>
<tr><td>3</td>S3 Savage 3D       </td><td>1998</td></tr>
<tr><td>4</td>Intel i740         </td><td>1998</td></tr>
</table>

<img src="http://i.iinfo.cz/images/660/pc93-1.png" alt="pc93" height="275" width="450" />
<p><i>Obrázek 3: Vykreslovací øetìzec pou¾ívaný grafickými akcelerátory pøi
zpracovávání trojrozmìrných scén. Do vykreslovacího øetìzce vstupují dva typy
dat &ndash; informace o vrcholech polygonù (trojúhelníkù, plo¹ných ètyøúhelníkù
atd.) a rastrová data, vìt¹inou bitmapy (znaky v&nbsp;rastrové podobì, bitové
masky, sprity, kurzory my¹i) a pøedev¹ím textury naná¹ené na vykreslované
polygony.</i></p>

<p>Popisem mikroprocesorù z&nbsp;rodiny <i>MIPS</i> jsme se u¾ <a
href="http://www.root.cz/clanky/procesory-s-architekturou-risc-v-pracovnich-stanicich-a-serverech/">v&nbsp;tomto
seriálu zabývali</a>, tak¾e ji¾ víme, ¾e se jednalo o procesory s&nbsp;typicky
minimalistickou &bdquo;RISCovou&ldquo; koncepcí, kdy se v&nbsp;instrukèní
pipeline provádìly v¹echny jednodu¹¹í aritmetické a logické instrukce, skoky i
instrukce pro pøenos dat mezi operaèní pamìtí a pracovními registry. Mimo tuto
pipeline byly provádìny nìkteré slo¾itìj¹í instrukce, typicky násobení. Pro
aritmetické operace s&nbsp;hodnotami reprezentovanými v&nbsp;systému plovoucí
øádové èárky (FP) byla pou¾ita zvlá¹tní pipeline. Zcela stejný minimalistický
princip byl pou¾it i u instrukèní sady <i>MIPS</i>, která je v&nbsp;porovnání
s&nbsp;<i>MMX</i>, <i>3DNow!</i> a samozøejmì té¾ <i>SSE</i> velmi elegantní a
pøitom splòující daný úèel.</p>

<img src="http://i.iinfo.cz/images/660/pc93-6.png" alt="pc93" height="240" width="320" />
<p><i>Obrázek 4: Pøi výpoètu mlhy je nutné provést pro ka¾dý vykreslovaný
fragment (fragment je, zjednodu¹enì øeèeno, entita nesoucí informaci o jednom
pixelu doplnìnou o dal¹í atributy, napøíklad hloubku/vzdálenost fragmentu od
pozorovatele) smíchání pùvodní barvy fragmentu s&nbsp;barvou mlhy, pøièem¾
pomìr mezi pùvodní barvou a barvou mlhy je urèen na základì vzdálenosti
fragmentu od pozorovatele a hustoty mlhy. Tato operace je v&nbsp;naprosté
vìt¹inì pøípadù ji¾ provádìna na grafickém akcelerátoru, i kdy¾ nìkteré SIMD
instrukce byly urèeny pro zjednodu¹ení tìchto výpoètù.</i></p>



<p><a name="k03"></a></p>
<h2>3. Datové typy (skaláry a vektory) pou¾ité v&nbsp;instrukèní sadì MIPS-3D</h2>

<p>Podobnì jako u popisù dal¹ích instrukèních sad obsahujících <i>SIMD</i>
instrukce, si i u technologie <i>MIPS-3D</i> nejprve popí¹eme formát dat, se
kterými se mohou provádìt rùzné operace. <i>MIPS-3D</i> se v&nbsp;mnoha
ohledech podobá ji¾ popsané sadì <i>3DNow!</i> (pøesnìji øeèeno je tomu spí¹e
naopak :-), proto¾e vìt¹ina instrukcí je urèena pro práci s&nbsp;vektory
obsahujícími dvojici numerických hodnot reprezentovaných v&nbsp;systému
plovoucí øádové èárky (<i>floating point</i>). Vzhledem k&nbsp;tomu, ¾e ka¾dý
prvek vektoru odpovídá 32bitovému datovému typu <i>single</i> èi <i>float</i>,
mají dvouprvkové vektory ¹íøku 64 bitù a mohou se vejít do existujících
64bitových registrù matematického koprocesoru (co¾ pro nás opìt není ¾ádná
novinka). Ov¹em kromì dvouprvkových vektorù jsou podporovány i dal¹í datové
typy, které jsou i s&nbsp;pøíslu¹ným oznaèením (pou¾itým dále) uvedeny
v&nbsp;následující tabulce. Pov¹imnìte si toho, ¾e typy <strong>PL</strong> a
<strong>PU</strong> reprezentují v¾dy jen jeden prvek vektoru a typ
<strong>PW</strong> se od ostatních pìti typù li¹í v&nbsp;tom, ¾e pøedstavuje
dvouprvkový vektor celých hodnot (<i>integer</i>):</p>

<table>
<tr><th>#</th><th>Oznaèení</th><th>Typ</th><th>Formát skaláru èi vektoru</th><th>Struèný popis datového typu</th></tr>
<tr><td>1</td><td>S </td><td>skalár</td><td>1&times;32</td><td>datový typ <i>single/float</i> s&nbsp;plovoucí øádovou èárkou o ¹íøce 32 bitù</td></tr>
<tr><td>2</td><td>D </td><td>skalár</td><td>1&times;64</td><td>datový typ <i>double</i> s&nbsp;plovoucí øádovou èárkou o ¹íøce 64 bitù</td></tr>
<tr><td>3</td><td>PS</td><td>vektor</td><td>2&times;32</td><td>vektor obsahující dvojici prvkù typu <i>single</i>, základ pro vìt¹inu 3D operací</td></tr>
<tr><td>4</td><td>PL</td><td>skalár</td><td>1&times;32</td><td>první/spodní prvek ulo¾ený v&nbsp;dvouprvkovém vektoru (<i>single</i>)</td></tr>
<tr><td>5</td><td>PU</td><td>skalár</td><td>1&times;32</td><td>druhý/horní prvek ulo¾ený v&nbsp;dvouprvkovém vektoru (<i>single</i>)</td></tr>
<tr><td>6</td><td>PW</td><td>vektor</td><td>2&times;32</td><td>dvì celoèíselné hodnoty, ka¾dá o ¹íøce 32 bitù</td></tr>
</table>

<img src="http://i.iinfo.cz/images/660/pc93-7.png" alt="pc93" height="280" width="450" />
<p><i>Obrázek 5: Operace s&nbsp;fragmenty provádìné pøi rasterizaci
trojúhelníkù èi obecnìj¹ích konvexních polygonù na grafickém
akcelerátoru.</i></p>



<p><a name="k04"></a></p>
<h2>4. Instrukce obsa¾ené v&nbsp;sadì MIPS-3D</h2>

<p>Instrukèní sada <i>MIPS-3D</i> se od vìt¹iny podobných technologií
zavádìjících <i>SIMD</i> instrukce pomìrnì výraznì odli¹uje v&nbsp;celkovém
poètu instrukcí i v&nbsp;tom, jaké instrukce byly vybrány. Poèet instrukcí je
toti¾ roven pouze tøinácti, ov¹em s&nbsp;tím, ¾e nìkteré z&nbsp;tìchto
instrukcí mohou pracovat s&nbsp;rùznými datovými typy, tak¾e se poèet kombinací
ponìkud zvìt¹uje a¾ na 23 mo¾ností. Zmínìných tøináct instrukcí je mo¾né podle
jejich funkce rozdìlit do ètyø kategorií &ndash; aritmetické instrukce,
konverzní instrukce, instrukce porovnání (relace) a koneènì instrukce pro
provádìní podmínìných skokù.</p>

<img src="http://i.iinfo.cz/images/135/pc164-1.png" width="500" height="279" alt="&#160;" />
<p><i>Obrázek 6: Rozdìlení v¹ech tøinácti instrukcí MIPS-3D do ètyø
skupin.</i></p>

<p>V¹echny instrukce jsou vypsány v&nbsp;následující tabulce, kde je také pro
ka¾dou instrukci uvedeno, s&nbsp;jakými datovými typy je mo¾né tuto instrukci
spustit (viz té¾ tabulka uvedená v&nbsp;pøedchozí kapitole). Nyní ji¾ následuje
slíbená tabulka:</p>

<table>
<tr><th> #</th><th>Kategorie</th><th>Instrukce</th><th>Datové typy</th><th>Popis</th></tr>
<tr><td> 1</td><td>aritmetické   </td><td>ADDR     </td><td>PS     </td><td>souèet dvouprvkových vektorù</td></tr>
<tr><td> 2</td><td>aritmetické   </td><td>MULR     </td><td>PS     </td><td>vynásobení prvkù dvouprvkových vektorù</td></tr>
<tr><td> 3</td><td>aritmetické   </td><td>RECIP1   </td><td>S,D,PS </td><td>první (nepøesný ale rychlý) krok výpoètu pøevrácené hodnoty</td></tr>
<tr><td> 4</td><td>aritmetické   </td><td>RECIP2   </td><td>S,D,PS </td><td>zpøesnìní výpoètu pøevrácené hodnoty</td></tr>
<tr><td> 5</td><td>aritmetické   </td><td>RSQRT1   </td><td>S,D,PS </td><td>první (nepøesný ale rychlý) krok výpoètu druhé odmocniny</td></tr>
<tr><td> 6</td><td>aritmetické   </td><td>RSQRT2   </td><td>S,D,PS </td><td>zpøesnìní výpoètu druhé odmocniny</td></tr>
<tr><td> 7</td><td>konverzní     </td><td>CVT.PS.PW</td><td>PW&rarr;PS</td><td>konverze 32bitových celých èísel na dvojici FP hodnot</td></tr>
<tr><td> 8</td><td>konverzní     </td><td>CVT.PW.PS</td><td>PS&rarr;PW</td><td>konverze dvouprvkového vektoru FP hodnot na dvojici 32bitových celých èísel èi èísel s&nbsp;pevnou èárkou</td></tr>
<tr><td> 9</td><td>porovnání     </td><td>CABS     </td><td>S,D,PS </td><td>porovnání prvkù vektorù èi dvojice skalárních hodnot, jedna z&nbsp;nejdùle¾itìj¹ích operací pøipravujících pøíznaky pro podmínìné skoky</td></tr>
<tr><td>10</td><td>podmínìný skok</td><td>BC1ANY2F </td><td>&times;</td><td>skok v&nbsp;pøípadì, ¾e alespoò jeden ze dvou zvolených pøíznakù je nepravdivý (false), relativní 18bitová adresa</td></tr>
<tr><td>11</td><td>podmínìný skok</td><td>BC1ANY2T </td><td>&times;</td><td>skok v&nbsp;pøípadì, ¾e alespoò jeden ze dvou zvolených pøíznakù je pravdivý (true), relativní 18bitová adresa</td></tr>
<tr><td>12</td><td>podmínìný skok</td><td>BC1ANY4F </td><td>&times;</td><td>skok v&nbsp;pøípadì, ¾e alespoò jeden ze ètyø zvolených pøíznakù je nepravdivý (false), relativní 18bitová adresa</td></tr>
<tr><td>13</td><td>podmínìný skok</td><td>BC1ANY4T </td><td>&times;</td><td>skok v&nbsp;pøípadì, ¾e alespoò jeden ze ètyø zvolených pøíznakù je pravdivý (true), relativní 18bitová adresa</td></tr>
</table>

<img src="http://i.iinfo.cz/images/135/pc164-2.png" width="500" height="343" alt="&#160;" />
<p><i>Obrázek 7: Instrukce <strong>ADDR</strong> pracuje s&nbsp;dvojicí
vektorù, z&nbsp;nich¾ ka¾dý obsahuje dvì 32bitové hodnoty typu single/float.</i></p>



<p><a name="k05"></a></p>
<h2>5. Pou¾ití instrukcí MIPS-3D v&nbsp;algoritmech poèítaèové grafiky</h2>

<p>Pøi pohledu na tabulku se seznamem instrukcí <i>MIPS-3D</i> uvedenou
v&nbsp;pøedchozí kapitole se na první pohled mù¾e zdát, ¾e instrukce byly
vybírány náhodnì. Ve skuteènosti to v¹ak není pravda, proto¾e instrukèní sada
<i>MIPS-3D</i> byla naschvál navr¾ena takovým zpùsobem, aby byla co
nejjednodu¹¹í, co¾ mj.&nbsp;jejím tvùrcùm umo¾nilo se lépe soustøedit na
optimalizaci implementace v¹ech instrukcí na èipu. Z&nbsp;toho napøíklad
vyplývá i to, ¾e se aritmetické instrukce zú¾ily na dvì základní operace souètu
a násobku, které byly doplnìny o výpoèet pøevrácené hodnoty (základ pro dìlení)
a výpoèet odmocniny, co¾ zajisté není implementaènì zcela jednoduchá operace,
ov¹em v&nbsp;poèítaèové grafice se odmocnina velmi èasto pou¾ívá, typicky pøi
výpoètu vzdálenosti a normalizacích vektorù.</p>

<p>V&nbsp;praxi je mo¾né pøi implementaci algoritmù pro zpracování a
vykreslování trojrozmìrných scén vyu¾ít instrukce ze sady <i>MIPS-3D</i>
následujícím zpùsobem:</p>

<ul>
<li>Transformace vrcholù (vertexù) &ndash; <strong>ADDR</strong></li>
<li>Pohledové transformace &ndash; <strong>ADDR</strong>, <strong>MULR</strong></li>
<li>Oøezání (clipping) &ndash; <strong>CABS</strong>, <strong>BC*</strong> (podmínìné skoky)</li>
<li>Normalizace vektorù &ndash; <strong>RECIP</strong>, <strong>RSQRT</strong></li>
<li>Perspektivní promítání &ndash; <strong>RECIP</strong></li>
<li>Odstranìní odvrácených polygonù &ndash; <strong>ADDR</strong>, <strong>CABS</strong>, <strong>BC*</strong> (podmínìné skoky)</li>
</ul>

<img src="http://i.iinfo.cz/images/135/pc164-3.png" width="500" height="340" alt="&#160;" />
<p><i>Obrázek 8: Instrukce <strong>MULR</strong> pracuje s&nbsp;dvojicí
vektorù, z&nbsp;nich¾ ka¾dý obsahuje dvì 32bitové hodnoty.</i></p>



<p><a name="k06"></a></p>
<h2>6. Operace dìlení a výpoètu druhé odmocniny v&nbsp;instrukèní sadì MIPS-3D</h2>

<p>Podívejme se nyní podrobnìji na aritmetické instrukce
<strong>RECIP1</strong>, <strong>RECIP2</strong>, <strong>RSQRT1</strong> a
<strong>RSQRT2</strong>. Jedná se o dvojici párù instrukcí, pøièem¾ první pár
tvoøený instrukcemi <strong>RECIP1+RECIP2</strong> je urèen pro výpoèet
pøevrácené hodnoty s&nbsp;pøesností specifikovanou programátorem a druhý pár
<strong>RSQRT1+RSQRT2</strong> slou¾í k&nbsp;výpoètu druhé odmocniny.
V&nbsp;obou pøípadech se jedná operace, které se v&nbsp;trojrozmìrné poèítaèové
grafice provádí pomìrnì èasto, typicky pøi normalizaci vektorù (pøi výpoètu
osvìtlení apod.) a takté¾ pøi perspektivním promítání, proto¾e výpoèet
pøevrácené hodnoty mù¾e být vyu¾it pro dìlení, co¾ je operace, která není
v&nbsp;<i>MIPS-3D</i> implementována (a ve skuteènosti ani nemusí být). Po
zavolání instrukce <strong>RECIP1</strong> je pøevrácená hodnota vypoètena sice
velmi rychle (se zpo¾dìním jen o jeden takt), ov¹em pøesnost výpoètu je 14 bitù
pro datový typ <i>single</i> a 23 bitù pro datový typ <i>double</i>.
V&nbsp;pøípadì, ¾e programátorovi tato pøesnost nedostaèuje (nìkdy je ov¹em
více ne¾ dostateèná), mù¾e pou¾ít instrukci <strong>RECIP2</strong> a výpoèet
tak dále zpøesnit podle svých po¾adavkù (nìkdy je nutné zavolat
<strong>RECIP2</strong> i vícekrát).</p>

<img src="http://i.iinfo.cz/images/135/pc164-4.png" width="500" height="366" alt="&#160;" />
<p><i>Obrázek 9: Jednotka FPU je v&nbsp;procesorech UltraSPARC pou¾ita jak pro
výpoèty se skaláry (trojice blokù FP), tak i pro vektorové operace (dvojice
blokù GR)</i></p>

<p>Uveïme si jednoduchý pøíklad: výpoèet pøevrácené hodnoty s&nbsp;pøesností
minimálnì 24 bitù (v¹echny výpoèty se provádí s&nbsp;FPU registry pojmenovanými
<strong>fx</strong>):</p>

<pre>
RECIP1.S f1, f0           ; pøesnost výsledku jen 16 bitù (ov¹em výpoèet proveden rychle)
RECIP2.S f2, f1, f0       
MADD.S   f3, f1, f1, f2   ; pøesnost výsledku je nyní 24 bitù
</pre>

<p>Druhý pøíklad: výpoèet pøevrácené hodnoty s&nbsp;pøesností 52 bitù:</p>

<pre>
RECIP1.S f1, f0           ; pøesnost výsledku jen 16 bitù (ov¹em výpoèet proveden rychle)
RECIP2.D f2, f1, f0
MADD.D   f3, f1, f1, f2   ; nyní ji¾ máme pøesnost minimálnì 32 bitù
RECIP2.D f4, f3, f0
MADD.D   f5, f3, f3, f4   ; a teï ji¾ plných 52 bitù
</pre>

<p>Podobné sekvence instrukcí lze pou¾ít i u dvojice operací
<strong>RSQRT1</strong> a <strong>RSQRT2</strong>. Opìt se jedná o vìdomou a
svobodnou volbu mezi rychlostí výpoètu a jeho pøesností.</p>

<p><ins>Poznámka: pøipomeòme si, ¾e o podobné technologii jsme se ji¾ zmiòovali
pøi popisu dnes ji¾ ponìkud neprávem opomíjené instrukèní sady <i>3DNow!</i>,
která mj.&nbsp;obsahovala i instrukce <strong>PFRCP</strong>,
<strong>PFRSQRT</strong>, <strong>PFRCPIT1</strong>, <strong>PFRSQIT1</strong>
a <strong>PFRCPIT2</strong> s&nbsp;významem podobným, jako je tomu u vý¹e
uvedených instrukcí <strong>RECIP1, RECIP2, RSQRT1</strong> a
<strong>RSQRT2</strong>.</ins></p>

<img src="http://i.iinfo.cz/images/135/pc164-5.png" width="500" height="330" alt="&#160;" />
<p><i>Obrázek 10: Jeden z&nbsp;formátù vektorové operace násobení nabízený
instrukèní sadou VIS.</i></p>



<p><a name="k07"></a></p>
<h2>7. Instrukèní sada VIS (Visual Instruction Set)</h2>

<p>Po popisu technologie <i>MIPS-3D</i> se ve zbývajících dvou kapitolách
budeme zabývat technologií urèenou pro konkurenèní mikroprocesory z&nbsp;rodiny
<i>UltraSPARC</i>. Jedná se o technologii nazvanou <i>VIS</i>, co¾ je zkratka
plného názvu &bdquo;Visual Instruction Set&ldquo;. Instrukèní sada <i>VIS</i>
se v&nbsp;mnoha ohledech odli¹uje od vý¹e popsané sady <i>MIPS-3D</i>, co¾ v¹ak
není pøekvapivé, proto¾e se jedná o instrukèní sadu urèenou pro jiné úèely.
V&nbsp;rámci <i>VIS</i> byly mikroprocesory <i>UltraSPARC</i> obohaceny o
pøibli¾nì padesát nových instrukcí, které implementovaly aritmetické operace,
logické operace, rozbalení a zabalení dat ve vektorech, zmìnu zarovnání dat ve
vektorech, datové konverze a na závìr i operace zjednodu¹ující adresování
jednorozmìrných, dvourozmìrných a trojrozmìrných polí. Nesmíme zapomenout ani
na blokové operace, které v&nbsp;dobì vzniku této technologie umo¾òovaly
blokový pøenos dat rychlostí a¾ 300 MB/sekundu, a to pøi libovolném
zarovnání.</p>

<img src="http://i.iinfo.cz/images/135/pc164-6.png" width="500" height="340" alt="&#160;" />
<p><i>Obrázek 11: Porovnávání ¹estnáctibitových prvkù vektorù s&nbsp;nastavením
ètveøice bitových pøíznakù. Instrukce, která toto porovnání provádí, se jmenuje
<strong>fcmp*16</strong>, pøièem¾ za hvìzdièku lze dosadit <strong>gt</strong>,
<strong>ge</strong>, <strong>eq</strong> atd.</i></p>

<p>Spoleènì s&nbsp;novými instrukcemi byl roz¹íøen i poèet funkèních modulù
matematického koprocesoru. Ten byl rozdìlen na ¹est základních modulù
pracujících nezávisle na sobì:</p>

<table>
<tr><th> #</th><th>Oznaèení modulu</th><th>Popis funkce modulu</th></tr>
<tr><td> 1</td><td>FP +</td><td>souèet skalárních hodnot typu <i>single/float</i> a <i>double</i></td></tr>
<tr><td> 2</td><td>FP &times;</td><td>souèin skalárních hodnot typu <i>single/float</i> a <i>double</i></td></tr>
<tr><td> 3</td><td>FP &divide; &#8730;</td><td>výpoèet podílu a druhé odmocniny (provádìno mimo instrukèní pipeline &ndash; out of order)</td></tr>
<tr><td> 4</td><td>GR +</td><td>souèet dvou vektorù s&nbsp;rùznými formáty (internì se jedná o ètveøici ALU + shifter)</td></tr>
<tr><td> 5</td><td>GR &times;</td><td>souèin dvou vektorù s&nbsp;rùznými formáty</td></tr>
<tr><td> 6</td><td>Load/Store</td><td>pøenos dat z a do operaèní pamìti</td></tr>
</table>

<p>Díky internímu uspoøádání matematického koprocesoru bylo mo¾né souèasnì
provádìt dvì aritmetické operace souètu a souèinu a navíc ve stejný okam¾ik
ukládat èi naèítat hodnotu z&nbsp;operaèní pamìti. Dìlení a výpoèet druhé
odmocniny se provádìl mimo instrukèní pipeline (<i>out of order</i>). Podobnì
tomu bylo u obou &bdquo;grafických&ldquo; modulù &ndash; pro souèet se vyu¾íval
modul s&nbsp;klasickou pipeline, tj.&nbsp;v&nbsp;ka¾dém taktu bylo mo¾né
dokonèit jednu operaci (provádìnou nad celým vektorem), zatímco násobení prvkù
vektorù trvalo o tøi takty déle, ov¹em bylo ho mo¾né provádìt paralelnì a
nezávisle na ostatních probíhajících operacích.</p>

<img src="http://i.iinfo.cz/images/135/pc164-7.png" width="500" height="339" alt="&#160;" />
<p><i>Obrázek 12: Porovnávání tøicetidvoubitových prvkù vektorù
s&nbsp;nastavením dvojice bitových pøíznakù. Instrukce, která toto porovnání
provádí, se jmenuje <strong>fcmp*32</strong>, pøièem¾ za hvìzdièku lze dosadit
<strong>gt</strong>, <strong>ge</strong>, <strong>eq</strong> atd., podobnì
jako u pøedchozí instrukce <strong>fcmp*16</strong></i></p>



<p><a name="k08"></a></p>
<h2>8. Datové typy pou¾ívané instrukcemi VIS</h2>

<p>Podobnì jako u technologií <i>MIPS-3D</i>, <i>MMX</i> èi <i>3DNow!</i> se i
v&nbsp;pøípadì technologie <i>VIS</i> v¹echny operace provádìly s&nbsp;registry
urèenými pùvodnì pro matematický koprocesor, co¾ samozøejmì souvisí i
s&nbsp;interní strukturou mikroprocesoru zmínìnou v&nbsp;pøedchozí kapitole.
Registrù pou¾ívaných matematickým koprocesorem je celkem 32 a ka¾dý z&nbsp;nich
má ¹íøku 64 bitù, co¾ odpovídá datovému typu <i>double</i>. Pro úèely operací
nad vektory vyu¾ívanými jak v&nbsp;2D, tak i v&nbsp;3D poèítaèové grafice byly
v&nbsp;rámci technologie <i>VIS</i> vytvoøeny dal¹í tøi datové struktury
(vektory):</p>

<ol>
<li>2&times;32 bitù (celá èísla se znaménkem nebo bez znaménka, té¾ typ <i>float/single</i>)</li>
<li>4&times;16 bitù (celá èísla se znaménkem nebo bez znaménka)</li>
<li>8&times;8 bitù (celá èísla se znaménkem nebo bez znaménka)</li>
</ol>

<p>Instrukèní sada <i>VIS</i> obsahuje velké mno¾ství instrukcí urèených pro
provádìní rùzných operací s&nbsp;rastrovými daty. Typicky se jedná o operaci
násobení vektoru s&nbsp;osmibitovými hodnotami (barvovými slo¾kami jednotlivých
pixelù), co¾ je operace pou¾ívaná napøíklad pøi alpha blendingu (prolínání dvou
obrázkù s&nbsp;postupnou zmìnou jejich prùhlednosti), ale takté¾ pøi diskrétní
kosinové transformaci vyu¾ívané ve formátech JPEG/JFIF a MPEG. Mnoho instrukcí
je urèeno pro konverze dat &ndash; viz té¾ naznaèení funkce tìchto instrukcí na
poslední trojici obrázkù. Pøi tìchto operacích se pomìrnì intenzivnì vyu¾ívá
shifter zapojený za ètveøicí aritmeticko-logických jednotek.</p>

<img src="http://i.iinfo.cz/images/135/pc164-8.png" width="500" height="220" alt="&#160;" />
<p><i>Obrázek 13: Jednoduchá konverzní operace &ndash; zmìna ¹íøky prvkù
vektoru z&nbsp;16 bitù na 8 bitù s&nbsp;volitelným zachováním znaménka.</i></p>

<p>To znamená, ¾e (nejenom) z&nbsp;tohoto pohledu se technologie <i>VIS</i>
podobá ji¾ døíve popsané technologii <i>MMX</i>, co¾ je mo¾ná i pochopitelné,
proto¾e tyto technologie vznikly zhruba ve stejnou dobu. Firma <i>Sun
Microsystems</i> (je¹tì v&nbsp;dobì své slávy) toti¾ pøedstavila <i>VIS</i> ji¾
v&nbsp;roce 1994 a poprvé ji do praxe zavedla v&nbsp;roce 1995 spoleènì
s&nbsp;mikroprocesory <i>UltraSPARC</i>, zatímco spoleènost <i>Intel</i> pøi¹la
s&nbsp;technologií <i>MMX</i> a¾ o rok pozdìji. Dodejme je¹tì, ¾e pro rodinu
<i>SPARC64</i> se <i>VIS</i> pou¾ila v&nbsp;roce 2000 a druhá verze instrukèní
sady oznaèovaná jako <i>VIS 2</i> byla implementována v&nbsp;mikroprocesorech
<i>UltraSPARC III</i>. Ov¹em z&nbsp;praktického hlediska je mezi obìma
zmiòovanými technologiemi pøece jen jeden dosti podstatný rozdíl &ndash;
<i>MMX</i> mù¾e vyu¾ívat pouze osmici 64bitových registrù, zatímco pøekladaèe
urèené pro <i>UltraSPARC</i> a <i>VIS</i> mohou své programy optimalizovat na
vyu¾ití celé sady 32 registrù, ka¾dého o ¹íøce 64 bitù.</p>

<img src="http://i.iinfo.cz/images/135/pc164-9.png" width="500" height="342" alt="&#160;" />
<p><i>Obrázek 14: Ukázka jedné z&nbsp;mnoha konverzních operací, které lze
provádìt díky instrukèní sadì VIS. Umístìní naètených 16bitových dat
v&nbsp;32bitovém slovì lze v&nbsp;urèité míøe mìnit.</i></p>



<p><a name="k09"></a></p>
<h2>9. Odkazy na Internetu</h2>

<ol>

<li>MIPS-3D(r) ASE<br />
<a href="http://www.mips.com/products/architectures/mips-3d-ase/">http://www.mips.com/products/architectures/mips-3d-ase/</a>
</li>

<li>An introduction to SPARC's SIMD offerings<br />
<a href="http://mikeburrell.wordpress.com/2007/12/14/an-introduction-to-sparcs-simd-offerings/">http://mikeburrell.wordpress.com/2007/12/14/an-introduction-to-sparcs-simd-offerings/</a>
</li>

<li>MIPS64<sup>TM</sup> Architecture for Programmers Volume IV-c: The MIPS-3D<sup>TM</sup> Application-Specific Extension to the MIPS64<sup>TM</sup><br />
<a href="http://www.weblearn.hs-bremen.de/risse/RST/docs/MIPS/MD00099-2B-MIPS3D64-AFP-01.11.pdf">http://www.weblearn.hs-bremen.de/risse/RST/docs/MIPS/MD00099-2B-MIPS3D64-AFP-01.11.pdf</a>
</li>

<li>Visual Instruction Set<br />
<a href="http://www.enotes.com/topic/Visual_Instruction_Set">http://www.enotes.com/topic/Visual_Instruction_Set</a>
</li>

<li>NEON<br />
<a href="http://www.arm.com/products/processors/technologies/neon.php">http://www.arm.com/products/processors/technologies/neon.php</a>
</li>

<li>Architecture and Implementation of the ARM Cortex-A8 Microprocessor<br />
<a href="http://www.design-reuse.com/articles/11580/architecture-and-implementation-of-the-arm-cortex-a8-microprocessor.html">http://www.design-reuse.com/articles/11580/architecture-and-implementation-of-the-arm-cortex-a8-microprocessor.html</a>
</li>

<li>Multimedia Acceleration eXtensions (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Multimedia_Acceleration_eXtensions">http://en.wikipedia.org/wiki/Multimedia_Acceleration_eXtensions</a>
</li>

<li>AltiVec (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/AltiVec">http://en.wikipedia.org/wiki/AltiVec</a>
</li>

<li>Visual Instruction Set (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Visual_Instruction_Set">http://en.wikipedia.org/wiki/Visual_Instruction_Set</a>
</li>

<li>MAJC (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MAJC">http://en.wikipedia.org/wiki/MAJC</a>
</li>

<li>MDMX (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MDMX">http://en.wikipedia.org/wiki/MDMX</a>
</li>

<li>MIPS Multiply Unit<br />
<a href="http://programmedlessons.org/AssemblyTutorial/Chapter-14/ass14_3.html">http://programmedlessons.org/AssemblyTutorial/Chapter-14/ass14_3.html</a>
</li>

<li>Silicon Graphics Introduces Enhanced MIPS Architecture<br />
<a href="http://bwrc.eecs.berkeley.edu/CIC/otherpr/enhanced_mips.html">http://bwrc.eecs.berkeley.edu/CIC/otherpr/enhanced_mips.html</a>
</li>

<li>MIPS-3D (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MIPS-3D">http://en.wikipedia.org/wiki/MIPS-3D</a>
</li>

<li>MIPS Technologies, Inc. announces new MIPS-3D technology to provide silicon-efficient 3D graphics acceleration<br />
<a href="http://www.design-reuse.com/news/2057/mips-mips-3d-technology-silicon-efficient-3d-graphics-acceleration.html">http://www.design-reuse.com/news/2057/mips-mips-3d-technology-silicon-efficient-3d-graphics-acceleration.html</a>
</li>

<li>MIPS-3D Built-in Function (gcc.gnu.org)<br />
<a href="http://gcc.gnu.org/onlinedocs/gcc/MIPS_002d3D-Built_002din-Functions.html">http://gcc.gnu.org/onlinedocs/gcc/MIPS_002d3D-Built_002din-Functions.html</a>
</li>

<li>
Baha Guclu Dundar:<br />
Intel MMX, SSE, SSE2, SSE3/SSSE3/SSE4 Architectures
</li>

<li>
SSE (Streaming SIMD Extentions)<br />
<a href="http://www.songho.ca/misc/sse/sse.html">http://www.songho.ca/misc/sse/sse.html</a>
</li>

<li>
Timothy A. Chagnon: SSE and SSE2<br />
<a href="http://www.cs.drexel.edu/~tc365/mpi-wht/sse.pdf">http://www.cs.drexel.edu/~tc365/mpi-wht/sse.pdf</a>
</li>

<li>
Intel corporation: Extending the Worldr's Most Popular Processor Architecture<br />
<a href="http://download.intel.com/technology/architecture/new-instructions-paper.pdf">http://download.intel.com/technology/architecture/new-instructions-paper.pdf</a>
</li>

<li>
SIMD architectures:<br />
<a href="http://arstechnica.com/old/content/2000/03/simd.ars/">http://arstechnica.com/old/content/2000/03/simd.ars/</a>
</li>

<li>
Tour of the Black Holes of Computing!: Floating Point<br />
<a href="http://www.cs.hmc.edu/~geoff/classes/hmc.cs105.../slides/class02_floats.ppt">http://www.cs.hmc.edu/~geoff/classes/hmc.cs105.../slides/class02_floats.ppt</a>
</li>

<li>3Dnow! Technology Manual<br />
AMD Inc., 2000</li>

<li>Intel MMX<sup>TM</sup> Technology Overview<br />
Intel corporation, 1996</li>

<li>MultiMedia eXtensions<br />
<a href="http://softpixel.com/~cwright/programming/simd/mmx.php">http://softpixel.com/~cwright/programming/simd/mmx.php</a>i
</li>

<li>AMD K5 ("K5" / "5k86")<br />
<a href="http://www.pcguide.com/ref/cpu/fam/g5K5-c.html">http://www.pcguide.com/ref/cpu/fam/g5K5-c.html</a>
</li>

<li>Sixth Generation Processors<br />
<a href="http://www.pcguide.com/ref/cpu/fam/g6.htm">http://www.pcguide.com/ref/cpu/fam/g6.htm</a>
</li>

<li>Great Microprocessors of the Past and Present<br />
<a href="http://www.cpushack.com/CPU/cpu1.html">http://www.cpushack.com/CPU/cpu1.html</a>
</li>

<li>Very long instruction word (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Very_long_instruction_word">http://en.wikipedia.org/wiki/Very_long_instruction_word</a>
</li>

<li>CPU design (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/CPU_design">http://en.wikipedia.org/wiki/CPU_design</a>
</li>

<li>Control unit (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Control_unit">http://en.wikipedia.org/wiki/Control_unit</a>
</li>

<li>Cray History<br />
<a href="http://www.cray.com/About/History.aspx?404;http://www.cray.com:80/about_cray/history.html">http://www.cray.com/About/History.aspx?404;http://www.cray.com:80/about_cray/history.html</a>
</li>

<li>Cray Historical Timeline<br />
<a href="http://www.cray.com/Assets/PDF/about/CrayTimeline.pdf">http://www.cray.com/Assets/PDF/about/CrayTimeline.pdf</a>
</li>

<li>Computer Speed Claims 1980 to 1996<br />
<a href="http://homepage.virgin.net/roy.longbottom/mips.htm">http://homepage.virgin.net/roy.longbottom/mips.htm</a>
</li>

<li>Superpoèítaèe Cray<br />
<a href="http://www.root.cz/clanky/superpocitace-cray/">http://www.root.cz/clanky/superpocitace-cray/</a>
</li>

<li>Superpoèítaèe Cray (druhá èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-druha-cast/">http://www.root.cz/clanky/superpocitace-cray-druha-cast/</a>
</li>

<li>Superpoèítaèe Cray (tøetí èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-treti-cast/">http://www.root.cz/clanky/superpocitace-cray-treti-cast/</a>
</li>

<li>Superpoèítaèe Cray (ètvrtá èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-ctvrta-cast/">http://www.root.cz/clanky/superpocitace-cray-ctvrta-cast/</a>
</li>

<li>Superpoèítaèe Cray (pátá èást): architektura Cray X-MP<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-pata-cast-architektura-pocitace-cray-x-mp-a-jeho-pouziti-ve-filmovem-prumyslu/">http://www.root.cz/clanky/superpocitace-cray-pata-cast-architektura-pocitace-cray-x-mp-a-jeho-pouziti-ve-filmovem-prumyslu/</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2011</small></p>
</body>
</html>

