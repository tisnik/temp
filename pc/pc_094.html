<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Grafické algoritmy implementované v 3D akcelerátoru Voodoo 1</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1></h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V dne¹ní èásti seriálu o architekturách poèítaèù si popí¹eme grafické algoritmy implementované 3D grafickým akcelerátorem Voodoo I. Budeme se zabývat pøedev¹ím tìmi algoritmy, které jsou provádìny èipem FBI (Pixelfx), zejména Gouraudovým stínováním, double bufferingem a pou¾itím pamìti hloubky (Z-bufferu).</p



<h2>Obsah</h2>

<p><a href="#k01">1. Grafické algoritmy implementované 3D grafickým akcelerátorem Voodoo I</a></p>
<p><a href="#k02">2. Gouraudovo stínování</a></p>
<p><a href="#k03">3. Struktura pamìti grafického akcelerátoru Voodoo</a></p>
<p><a href="#k04">4. Framebuffer</a></p>
<p><a href="#k05">5. Double a triple buffering</a></p>
<p><a href="#k06">6. Pamì» hloubky (Z-buffer)</a></p>
<p><a href="#k07">7. Formát záznamù ulo¾ených v&nbsp;pamìti hloubky (Z-bufferu)</a></p>
<p><a href="#k08">8. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2>1. Grafické algoritmy implementované 3D grafickým akcelerátorem Voodoo I</h2>

<p>V&nbsp;pøedchozí èásti seriálu o architekturách poèítaèù jsme si
mj.&nbsp;struènì popsali základní vlastnosti grafického akcelerátoru nazvaného
<i>Voodoo 1</i> firmy <i>3Dfx</i>, která stála na samém poèátku vývoje 3D
grafických akcelerátorù urèených pro bì¾né osobní poèítaèe typu PC (na
grafických stanicích byla situace samozøejmì ponìkud odli¹ná, bli¾¹í informace
si v¹ak øekneme a¾ v&nbsp;nìkterém z&nbsp;dal¹ích pokraèování tohoto seriálu).
Víme ji¾, ¾e se jednalo o pøídavnou akceleraèní kartu specializovanou na
vykreslování trojrozmìrné grafiky urèenou pro universální sbìrnici PCI, která
&bdquo;pouze&ldquo; doplòovala prakticky libovolnou grafickou kartu typu VGA,
SVGA èi nìkterý 2D grafický akcelerátor. Pro bì¾nou práci s&nbsp;poèítaèem se
vyu¾ívalo funkcí grafické karty, její¾ výstup (video signály) byl pøes 3D
akcelerátor <i>Voodoo 1</i> posílán pøímo do monitoru. Teprve pøi práci
s&nbsp;trojrozmìrnými scénami se video signály docházející z&nbsp;grafické
karty do akcelerátoru ignorovaly (odpojily) a øízení zobrazování pøevzal
samotný grafický akcelerátor <i>Voodoo 1</i>.</p>

<a href="http://i.iinfo.cz/images/210/pc9401.jpg"><img src="http://i.iinfo.cz/images/210/pc9401-prev.jpg" width="358" height="270" alt="pc9401" /></a>
<p><i>Obrázek 1: Polygony pokryté texturou, které byly vykresleny grafickým
systémem Sunstone vyvinutým ji¾ v&nbsp;roce 1979 Edem Emshwillerem.</i></p>

<p>Minule jsme si také øekli, ¾e na tomto grafickém akcelerátoru se kromì
obrazové pamìti implementované pomocí pamì»ových modulù EDO DRAM (rozdìlené na
dvì èásti &ndash; framebuffer a samostatnì adresovatelnou texturovací pamì»)
nacházela i dvojice specializovaných èipù nazvaná <i>FBI (Pixelfx)</i> a <i>TMU
(Texelfx)</i>. Èip <i>FBI</i> zaji¹»oval pøedev¹ím komunikaci s&nbsp;poèítaèem
pøes sbìrnici PCI, pøístup do lineárního framebufferu (obrazové pamìti, viz
dal¹í kapitoly), implementoval Gouraudovo stínování pomocí hardwarových
interpolátorù, funkci Z-bufferu (pamìti hloubky), dithering obrazu pøi jeho
ukládání do obrazové pamìti a takté¾ výpoèet efektu mlhy. Naproti tomu èip
<i>TMU</i> slou¾il zejména pro mapování textur, bilineární a trilineární
filtraci textur a mip-mapping, který s&nbsp;filtrací textur úzce souvisí.
V&nbsp;následujících kapitolách jsou podrobnìji popsány nejdùle¾itìj¹í
algoritmy implementované v&nbsp;obou vý¹e zmínìných èipech.</p>

<a href="http://i.iinfo.cz/images/540/pc9402.jpg"><img src="http://i.iinfo.cz/images/540/pc9402-prev.jpg" width="370" height="256" alt="pc9402" /></a>
<p><i>Obrázek 2: Grafický akcelerátor Voodoo 1 s&nbsp;èipy FBI a TMU (viz
potisk) a pamì»mi EDO DRAM, pomocí nich¾ je sestavený framebuffer i pamì» pro
textury.</i></p>

<p>Detailním popisem komunikace mezi grafickým akcelerátorem a mikroprocesorem
se v&nbsp;tomto èlánku nebudeme podrobnìji zabývat, nebo» tato èinnost pøímo
nesouvisí s&nbsp;grafickou akcelerací vykreslování prostorových scén. Pro
zajímavost v¹ak stojí za zmínku informace, ¾e pøi poslání pøíkazu na grafický
akcelerátor <i>Voodoo 1</i> musel programátor èekat na potvrzení jeho vykonání,
pøièem¾ stav grafického akcelerátoru bylo nutné zji¹»ovat aktivnì,
tj.&nbsp;periodickým naèítáním stavu v&nbsp;programové smyèce. U souèasných
grafických akcelerátorù jsou komunikaèní protokoly vytvoøeny s&nbsp;ohledem na
co nejvìt¹í propustnost dat, tj.&nbsp;tak, aby grafický akcelerátor v&nbsp;daný
okam¾ik dostával pøesnì ta data, která pro svoji èinnost potøebuje (mù¾e se
napøíklad jednat o prokládání dat nesoucích informace o texturách
s&nbsp;geometrickými informacemi, tj.&nbsp;souøadnicemi vrcholù polygonù atd.).
Dal¹í informace o této problematice si øekneme pøí¹tì, stejnì jako popis
algoritmù implementovaných v&nbsp;texturovací jednotce &ndash; <i>TMU</i>.</p>



<p><a name="k02"></a></p>
<h2>2. Gouraudovo stínování</h2>

<p>Jedním ze základních a pøitom velmi dùle¾itých algoritmù implementovaných na
grafickém akcelerátoru <i>Voodoo 1</i> je algoritmus <i>Gouraudova
stínování</i>. Jedná se o implementaènì pomìrnì jednoduchý a tudí¾ i rychlý
zpùsob vykreslení trojúhelníkù èi slo¾itìj¹ích konvexních polygonù
v&nbsp;pøípadì, ¾e jsou zadány (nebo vypoèteny, napøíklad pomocí Phongova
osvìtlovacího modelu) barvy ve vrcholech polygonù. Pomocí Gouraudova stínování
je s&nbsp;vyu¾itím lineární interpolace vypoètena barva celé plochy polygonu,
tj.&nbsp;barva v¹ech pixelù (pøesnìji øeèeno v¹ech <i>fragmentù</i>), které
polygon tvoøí po jeho vykreslení (rasterizaci) do framebufferu. Gouraudovo
stínování je implementováno na v¹ech moderních grafických akcelerátorech,
proto¾e se pomocí nìho mù¾e povrch tìles vizuálnì vyhladit tak, ¾e se na nìm
nevyskytují takzvané nepravé hrany, tj.&nbsp;hrany vzniklé aproximací
zaobleného povrchu tìlesa pomocí plo¹ek &ndash; polygonù (pùvodní aproximovaný
tvar tìlesa je v¹ak stále patrný, napøíklad pøi pohledu na jeho kontury).</p>

<img src="http://i.iinfo.cz/images/555/pc9403.jpg" width="368" height="260" alt="pc9403" />
<p><i>Obrázek 3: Utah teapot vykreslený na grafickém akcelerátoru. Tento známý
trojrozmìrný model je sice reprezentován pomocí spline ploch (datové soubory
lze relativnì snadno najít na Internetu), ale pøed vykreslením jsou tyto plochy
rozdìleny na sí» trojúhelníkù a plo¹ných ètyøúhelníkù, které jsou následnì
posílány do grafického akcelerátoru (pøesnìji øeèeno jsou do grafického
akcelerátoru posílány informace o barvách vrcholù a o jejich souøadnicích).
Grafický akcelerátor v¹echny polygony vykreslil s&nbsp;vyu¾itím Gouraudova
stínování, tak¾e do¹lo ke zdánlivému vyhlazení vykresleného povrchu, i kdy¾ se
jeho geometrie nezmìnila (stále se jedná o plo¹ky).</i></p>

<p>Na grafickém akcelerátoru <i>Voodoo 1</i> lze vyu¾ít i takzvané konstantní
stínování (<i>constant shading</i>, nìkdy té¾ oznaèené termínem <i>flat
shading</i>), pøi kterém má celá plocha polygonu (trojúhelníku) konstantní
barvu, tak¾e jednotlivé plo¹ky, ze kterých se povrch tìlesa skládá, jsou
viditelné a jasnì odli¹itelné. Pøedností konstantního stínování je urychlení
vykreslování celé trojrozmìrné scény, samozøejmì za cenu její hor¹í vizuální
kvality, zejména v&nbsp;tìch pøípadech, kdy je skuteèný povrch tìlesa pouze
hrubì aproximován malým mno¾stvím polygonù (velké problémy vznikají napøíklad
pøi modelování lidských oblièejù èi celých postav).</p>



<p><a name="k03"></a></p>
<h2>3. Struktura pamìti grafického akcelerátoru Voodoo I</h2>

<p>Jednou z&nbsp;pøíèin velké oblíbenosti a souèasnì i roz¹íøenosti grafického
akcelerátoru <i>Voodoo 1</i> byla i jeho pøíznivá cena, která byla
mj.&nbsp;zpùsobena tím, ¾e jeho tvùrci pou¾ili relativnì levné pamì»ové moduly
typu EDO DRAM (nikoli tedy drahé VRAM), jejich¾ cena postupnì klesala, a to
pomìrnì výraznì právì v&nbsp;dobì, kdy byl tento grafický akcelerátor uveden na
trh. Pamì» grafického akcelerátoru <i>Voodoo 1</i> je rozdìlena do dvou èástí
(na dne¹ní akcelerátorech je mo¾né velikost oblastí dynamicky mìnit). První
èást pamìti je urèena pro ulo¾ení textur (texturovací pamì»), èást druhá o
shodné kapacitì slou¾í jako oblast, ve které se nachází <i>framebuffer</i>.
Kapacita texturovací pamìti byla na vìt¹inì karet rovna dvìma megabajtùm, ov¹em
samotný èip <i>TMU</i> dokázal obslou¾it i pamì» s&nbsp;dvojnásobnou kapacitou
(karty <i>Voodoo 2</i> byly vybaveny ètyømi èi dokonce osmi megabajty
texturovací pamìti, tak¾e celková kapacita v¹ech pamì»ových modulù na tomto
akcelerátoru mohla dosáhnout a¾ 12 MB). Framebuffer mìl na kartách <i>Voodoo
1</i> velikost takté¾ dvou megabajtù, na dal¹í verzi <i>Voodoo 2</i> se v¹ak
ji¾ mohla jeho kapacita zvý¹it na 4 MB, co¾ umo¾nilo jak implementaci
triple-bufferingu (viz dal¹í kapitolu), tak i zvý¹ení grafického rozli¹ení
z&nbsp;640&times;480 pixelù na 800&times;600 pixelù.</p>



<p><a name="k04"></a></p>
<h2>4. Framebuffer</h2>

<p><i>Framebuffer</i> se na grafickém akcelerátoru <i>Voodoo 1</i> skládá
z&nbsp;nìkolika bufferù: takzvaného <i>pøedního bufferu</i> (front buffer),
který je v&nbsp;daném okam¾iku zobrazen na monitoru, jednoho èi dvou <i>zadních
bufferù</i> (back buffers), do nich¾ lze provádìt vykreslování bez toho, aby to
u¾ivatel mohl zaregistrovat (ten toti¾ má na monitoru v&nbsp;prùbìhu
vykreslování do zadního bufferu zobrazen starý snímek ulo¾ený v&nbsp;pøedním
bufferu, viz následující odstavec) a koneènì <i>Z-buffer</i> neboli pamì»
hloubky pou¾ívanou pro implementaci skrývání neviditelných (zakrytých) èástí
polygonù. Konfigurace <i>framebufferu</i> je volitelná, typicky se v¹ak pou¾ívá
nastavení se tøemi buffery: pøedním, zadním a Z-bufferem. Vzhledem k&nbsp;tomu,
¾e bitová hloubka v¹ech tøí zmínìných bufferù je rovna ¹estnácti bitùm, je
maximální mo¾né rozli¹ení povolené v&nbsp;této konfiguraci (pøi instalaci 2 MB
EDO DRAM pro framebuffer) rovno 640&times;480 pixelùm, proto¾e pøi pou¾ití
tohoto rozli¹ení je zapotøebí alokovat:
640&times;480&times;2&times;3=1&nbsp;843&nbsp;200 bajtù, co¾ zhruba odpovídá
maximální kapacitì framebufferu: 2&nbsp;097&nbsp;152 (2MB).</p>

<img src="http://i.iinfo.cz/images/561/pc9404.png" width="450" height="275" alt="pc9404" />
<p><i>Obrázek 4: Do framebufferu jsou ukládány jak barvy jednotlivých fragmentù
vzniklé po rasterizaci polygonù, tak i vzdálenosti fragmentù od pozorovatele.
Data je mo¾né do framebufferu i pøímo kopírovat popø.&nbsp;naopak naèítat zpìt
do operaèní pamìti.</i></p>

<p>V&nbsp;následující tabulce jsou vypsána maximální mo¾ná rozli¹ení výsledného
obrazu zobrazovaného na monitoru pro rùzné kapacity pamìti rezervované pro
framebuffer i pro jeho rùzné konfigurace (nìkteré konfigurace lze vyu¾ít pouze
na grafickém akcelerátoru <i>Voodoo 2</i>, nikoli na <i>Voodoo 1</i>). Je
zøejmé, ¾e v&nbsp;pøípadì pou¾ití pouze dvou bufferù (double bufferingu) je
mo¾né vyu¾ívat vìt¹í rozli¹ení 800&times;600 pixelù ne¾ v&nbsp;pøípadì, ¾e jsou
pou¾ity buffery tøi (v&nbsp;tomto pøípadì se jedná buï o double buffering
doplnìný o Z-buffer nebo o triple buffering). Význam double bufferingu a triple
bufferingu pøi vykreslování trojrozmìrných scén bude uveden v&nbsp;následující
kapitole.</p>

<table>
<tr><th>Kapacita framebufferu</th><th>double buffer</th><th>double buffer+Z-buffer</th><th>triple buffer</th></tr>
<tr><td>2&nbsp;MB</td><td>800&times;600&times;16</td><td>640&times;480&times;16</td><td>640&times;480&times;16</td></tr>
<tr><td>4&nbsp;MB</td><td>800&times;600&times;16</td><td>800&times;600&times;16</td><td>800&times;600&times;16</td></tr>
</table>



<p><a name="k05"></a></p>
<h2>5. Double a triple buffering</h2>

<p>Pøi interaktivní práci s&nbsp;prostorovou scénou (napøíklad ve hrách) je
nutné mìnit pohled na scénu, tj.&nbsp;bod umístìní kamery i dal¹í parametry
kamery, popø.&nbsp;pohybovat s&nbsp;prostorovými objekty, které se ve scénì
nachází. Po ka¾dé zmìnì pohledu se musí celá prostorová scéna znovu pøekreslit,
proto¾e se vìt¹inou zmìní souøadnice v¹ech vrcholù grafických primitiv na
obrazovce. Toto pøekreslení celé scény (které ve vìt¹inì pøípadù zaèíná
vymazáním plochy obrazovky barvou pozadí) v¹ak nìjakou dobu trvá a v&nbsp;této
dobì by u¾ivatel vidìl problikávání zpùsobené postupnou zmìnou barev pixelù
v&nbsp;pøedním (barvovém) bufferu. Tomuto problikávání lze zabránit tak, ¾e se
místo jednoho barvového bufferu pou¾ijí buffery dva. Do jednoho z&nbsp;tìchto
bufferù se vykresluje (ji¾ zmínìný <i>zadní buffer &ndash; back buffer</i>) a
druhý je zobrazený u¾ivateli na monitoru (takzvaný <i>pøední buffer &ndash;
front buffer</i>). V&nbsp;grafické knihovnì <i>GLIDE</i>, která byla pro úèely
ovládání grafických akcelerátorù <i>Voodoo</i> vyvinuta, jsou jednotlivé
buffery oznaèeny pomocí následujících konstant:</p>

<table>
<tr><th>Konstanta</th><th>Význam</th></tr>
<tr><td>GR_BUFFER_FRONTBUFFER</td><td>pøední (barvový) buffer</td></tr>
<tr><td>GR_BUFFER_BACKBUFFER </td><td>zadní (barvový) buffer</td></tr>
<tr><td>GR_BUFFER_DEPTHBUFFER</td><td>Z-buffer (pamì» hloubky)</td></tr>
</table>

<p>Po dokonèení vykreslování do prvního bufferu se tento zobrazí u¾ivateli a
role bufferù se obrátí &ndash; tomuto vyu¾ití dvou barvových bufferù se øíká
<i>double buffering</i>. Dùle¾ité je, ¾e pøi zmìnì role obou bufferù není
zapotøebí provádìt ¾ádné pøesuny dat v&nbsp;obrazové pamìti. Jednou
z&nbsp;(mála) nevýhod double bufferingu je skuteènost, ¾e po ukonèení
vykreslení celé scény musí grafický akcelerátor èekat na návrat elektronového
paprsku, aby mohl prohodit funkce obou bufferù (<i>wait for V-sync</i>). Pokud
by se na návrat paprsku neèekalo, mohlo by dojít k&nbsp;viditelnému
horizontálnímu lomu mezi pøedposledním a posledním snímkem. Ov¹em èekání na
návrat paprsku znamená, ¾e se funkce grafického akcelerátoru na urèitou dobu
zastaví. Aby se zbyteènému èekání zabránilo, mù¾e se pou¾ít takzvaný triple
buffering, pøi nìm¾ jsou k&nbsp;dispozici dva zadní buffery a jeden buffer
pøední, ov¹em druhý zadní buffer je na grafických akcelerátorech <i>Voodoo</i>
kvùli omezené kapacitì framebufferu vytvoøen namísto pamìti hloubky
(Z-bufferu).</p>



<p><a name="k06"></a></p>
<h2>6. Pamì» hloubky (Z-buffer)</h2>

<p>Pøi vykreslování prostorové scény s&nbsp;vyu¾itím grafického 3D akcelerátoru
<i>Voodoo 1</i> (ale i vìt¹iny dal¹ích grafických akcelerátorù) se postupuje
pomìrnì pøímoèarým zpùsobem. Nejdøíve se programovì nastaví základní parametry
vykreslování, napøíklad identifikátor textury, která se má pou¾ít pøi
vykreslování ploch èi transformaèní matice pou¾ívané pøi projekci vrcholù
polygonù ze svìtového prostoru (<i>world space</i>) do prostoru obrazového.
Posléze se do grafického akcelerátoru posílají geometrické informace o
jednotlivých polygonech, které se mají vykreslit. Jedná se o souøadnice
jednotlivých vrcholù doplnìné o nìkteré dal¹í dùle¾ité atributy, pøedev¹ím o
barvu vrcholù (viz vý¹e uvedená kapitola vìnovaná <i>Gouraudovu stínování</i>)
a souøadnice vrcholù v&nbsp;prostoru textur (jde o dvì èi tøi souøadnice,
tj.&nbsp;buï o dvojici <i>[u, v]</i> nebo o trojici <i>[u, v, w]</i>).</p>

<img src="http://i.iinfo.cz/images/237/pc9405.png" width="450" height="450" alt="pc9405" />
<p><i>Obrázek 5: Utah teapot pokrytý texturou, která je modulovaná barvovým
pøechodem vypoèteným pomocí Gouraudova stínování na základì jednotlivých
vrcholù polygonù.</i></p>

<p>Pokud by se v¹ak polygony rastrovaly do framebufferu pøímo (tj.&nbsp;bez
vyu¾ití dal¹ích programových èi technických prostøedkù), docházelo by
k&nbsp;jejich nekorektnímu pøekryvu, proto¾e poøadí polygonù posílané do
grafického akcelerátoru obecnì <strong>ne</strong>odpovídá reálné viditelnosti
jednotlivých stìn (v&nbsp;nìkterých pøípadech to ani není technicky mo¾né,
proto¾e napøíklad tøi polygony mohou být umístìny v&nbsp;prostoru tak, ¾e nelze
rozhodnout, který je blí¾e k&nbsp;pozorovateli a který dále). Jedno
z&nbsp;øe¹ení viditelnosti by mohlo spoèívat v&nbsp;ruèním (algoritmickém)
seøazení jednotlivých polygonù tak, ¾e nejdøíve by se vykreslily stìny
(polygony) nejvzdálenìj¹í a poté by se postupnì pøekreslovaly stìny bli¾¹í.</p>

<p> Toto øe¹ení, které se také nazývá <i>malíøùv algoritmus (painter's
algorithm)</i> je v¹ak èasovì nároèné (stìny se musí seøadit a to po ka¾dé
zmìnì v&nbsp;prostorové scénì nebo pøi ka¾dém pohybu
kamery&ndash;pozorovatele), nepodporuje proudové zpracování dat (opakované
øazení) a mù¾e vést k&nbsp;nejednoznaènostem pøi vyhodnocování vzdálenosti
jednotlivých stìn, napøíklad v&nbsp;ji¾ zmínìném pøípadì, kdy se tøi stìny
vzájemnì pøekrývají. Z&nbsp;tohoto dùvodu se v&nbsp;grafických akcelerátorech
pou¾ívá jiná technika, která je optimalizovaná pro proudové zpracování dat bez
nutnosti tvorby a udr¾ování slo¾itých datových struktur èi pou¾ití èasovì
nároèných algoritmù. V&nbsp;této technice je pro øe¹ení viditelnosti
jednotlivých polygonù èi jejich èástí (tj.&nbsp;fragmentù) pou¾ita takzvaná
<i>pamì» hloubky</i>, neboli <i>depth buffer</i>, popø.&nbsp;
<i>Z-buffer</i>.</p>

<img src="http://i.iinfo.cz/images/663/pc9406.png" width="450" height="312" alt="pc9406" />
<p><i>Obrázek 6: Operace s&nbsp;fragmenty provádìné pøi vykreslování. Na tomto
schématu je zvýraznìný blok zabezpeèující vykreslení pouze tìch fragmentù,
které se nachází nejblí¾e k&nbsp;u¾ivateli.</i></p>

<p><i>Pamì» hloubky</i> obsahuje rastrová data, nejsou zde v¹ak ulo¾eny barvy
jednotlivých fragmentù, ale jejich kolmé vzdálenosti od projekèní roviny (ve
skuteènosti se vìt¹inou internì ukládají pøevrácené hodnoty tìchto vzdáleností,
jak si ostatnì vysvìtlíme v&nbsp;dal¹ím textu). Pøed vykreslením barvy
fragmentu do barvového bufferu se nejdøíve provede nìkolik testù, mezi nì¾
patøí i test na vzdálenost (hloubku) fragmentu. Pokud fragment tímto testem
projde (jeho vzdálenost od pozorovatele je men¹í ne¾ hodnota ulo¾ená
v&nbsp;Z-bufferu), znamená to, ¾e je blí¾e pozorovateli ne¾li fragmenty
pøedchozí (samozøejmì na tom samém místì obrazovky), co¾ znaèí, ¾e mù¾e být
vykreslen a pøíslu¹ný údaj v&nbsp;Z-bufferu mù¾e být pøepsán hloubkou právì
vykresleného fragmentu. V&nbsp;opaèném pøípadì je z&nbsp;dal¹ího zpracování
vyjmut. Testy a operace s&nbsp;fragmenty jsou naznaèeny na ¹estém obrázku, kde
je zvýraznìn blok pro testy hloubky fragmentu s&nbsp;hodnotou ulo¾enou
v&nbsp;pamìti hloubky. Pøi vykreslování 3D scény tedy mù¾e být ka¾dý pixel
pøekreslen nìkolikrát, v&nbsp;nejhor¹ím pøípadì tolikrát, kolik se vykresluje
polygonù.</p>



<p><a name="k07"></a></p>
<h2>7. Formát záznamù ulo¾ených v&nbsp;pamìti hloubky (Z-bufferu)</h2>

<p>Rozli¹ení Z-bufferu je vìt¹inou shodné s&nbsp;rozli¹ením výsledné rastrové
mapy, která má být vykreslena. Pøed vykreslením nového snímku jsou hloubky
v¹ech fragmentù nastaveny na maximální vzdálenost, v&nbsp;<i>GLIDE</i>
je tato hodnota reprezentována konstantou <i>GR_ZDEPTHVALUE_FARTHEST</i>. Pokud
by se poèáteèní hloubky fragmentù nastavily na jinou hodnotu, docházelo by pøi
vykreslování scény k&nbsp;oøezávání vzdálených polygonù (resp.&nbsp;jejich
èástí), co¾ mù¾e být v&nbsp;nìkterých pøípadech ¾ádoucí vlastnost. Na tomto
místì stojí za upozornìní fakt, ¾e pøi vykreslování poloprùhledných polygonù,
tj.&nbsp;polygonù s&nbsp;nanesenou texturou obsahující poloprùhledné texely,
nedoká¾e Z-buffer korektnì s&nbsp;tìmito polygony pracovat. Z&nbsp;tohoto
dùvodu je nutné nejdøíve (s&nbsp;povoleným zápisem do Z-bufferu) vykreslit
v¹echny neprùhledné polygony a poté zakázat zápis do Z-bufferu a následnì
vykreslit poloprùhledné polygony, ov¹em <strong>setøídìné</strong> podle jejich
klesající vzdálenosti od pozorovatele (kamery).</p>

<p>Do pamìti hloubky (Z-bufferu) je mo¾né ukládat vzdálenosti fragmentù od
pozorovatele (kamery) ve dvou formátech, v&nbsp;obou pøípadech je v¹ak ka¾dý
údaj v¾dy ulo¾en na ¹estnácti bitech. Pøi pou¾ití prvního zpùsobu se do
Z-bufferu skuteènì ukládají vzdálenosti fragmentù, pøesnìji øeèeno celoèíselná
èást vzdálenosti (výpoèty vzdálenosti se provádí pøesnìji, ale výsledek je pøi
ukládání zaokrouhlen). Tento formát není pøíli¹ výhodný, proto¾e po projekci 3D
scény ze svìtových souøadnic do prostoru obrazovky není krok mezi jednotlivými
vzdálenostmi konstantní, co¾ vede k&nbsp;vizuálním chybám pøi vykreslování
(rozli¹ení pouze 2<sup>16</sup> vzdáleností je v&nbsp;tomto pøípadì
nedostateèné). Z&nbsp;tohoto dùvodu se preferuje druhý zpùsob (nazývaný také
<i>w-buffer</i>), pøi nìm¾ se do Z-bufferu ukládají pøevrácené hodnoty
vzdálenosti, a to ve speciálním formátu èísel s&nbsp;pohyblivou øádovou teèkou
(èárkou), který má následující strukturu pøipomínající formát definovaný
v&nbsp;IEEE 754:</p>

<p>
1.mantissa &times; 2<sup>exponent</sup>
</p>

<p>V&nbsp;tomto formátu je pro mantisu vyhrazeno dvanáct bitù a pro exponent
ètyøi bity. Pov¹imnìte si implicitní jednièky pøed desetinnou teèkou i toho, ¾e
¾ádný bit není vyhrazen pro ulo¾ení znaménka &ndash; vzdálenosti (a samozøejmì
i jejich pøevrácené hodnoty) jsou v¾dy kladné. Minimální hodnota, kterou lze
tímto zpùsobem ulo¾it, je rovna jednièce (0x0000 ~ 1.000000000000<sub>2</sub>&times;2<sup>0</sup>),
maximální hodnota 65528.0 (0xffff ~ 1.111111111111<sub>2</sub>&times;2<sup>15</sup>).
Podobné &bdquo;krátké&ldquo; formáty èísel
s&nbsp;plovoucí øádovou teèkou jsou v&nbsp;oblasti grafických akcelerátorù
velmi oblíbené, o èem¾ se pøesvìdèíme i v&nbsp;navazujících èástech tohoto
seriálu.</p>



<p><a name="k08"></a></p>
<h2>8. Odkazy na Internetu</h2>

<ol>

<li>3dfx Voodoo1 PCI<br />
<a href="http://www.v3info.de/english/html/v1.shtml">http://www.v3info.de/english/html/v1.shtml</a>
</li>

<li>Glide 2.2 Programming Guide<br />
<a href="http://www.gamers.org/dEngine/xf3D/glide/glidepgm.htm">http://www.gamers.org/dEngine/xf3D/glide/glidepgm.htm</a>
</li>

<li>3dfx Interactive<br />
<a href="http://en.wikipedia.org/wiki/3dfx_Voodoo_Graphics">http://en.wikipedia.org/wiki/3dfx_Voodoo_Graphics</a>
</li>

<li>Glide API<br />
<a href="http://en.wikipedia.org/wiki/Glide_API">http://en.wikipedia.org/wiki/Glide_API</a>
</li>

<li>Edwin Catmull<br />
<a href="http://en.wikipedia.org/wiki/Edwin_Catmull">http://en.wikipedia.org/wiki/Edwin_Catmull</a>
</li>

<li>Intel i860<br />
<a href="http://en.wikipedia.org/wiki/Intel_860">http://en.wikipedia.org/wiki/Intel_860</a>
</li>

<li>Intel i860 64-Bit Microprocessor<br />
<a href="http://www.microprocessor.sscc.ru/i860.html">http://www.microprocessor.sscc.ru/i860.html</a>
</li>

<li>Intel i740<br />
<a href="http://en.wikipedia.org/wiki/Intel740">http://en.wikipedia.org/wiki/Intel740</a>
</li>

<li>Intel i740 Datasheet<br />
<a href="ftp://download.intel.com/support/graphics/intel740/29061902.pdf">ftp://download.intel.com/support/graphics/intel740/29061902.pdf</a>
</li>

<li>Intel740(TM) Graphics Accelerator P854 Hardware<br />
<a href="ftp://download.intel.com/support/graphics/intel740/29062202.pdf">ftp://download.intel.com/support/graphics/intel740/29062202.pdf</a>
</li>

<li>Intel 860@cpu-collection<br />
<a href="http://www.cpu-collection.de/?l0=co&l1=Intel&l2=i860">http://www.cpu-collection.de/?l0=co&l1=Intel&l2=i860</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2009</small></p>
</body>
</html>

