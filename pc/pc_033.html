<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Podrobnìj¹í popis sbìrnice PCI</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Podrobnìj¹í popis sbìrnice PCI</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>Ve tøicáté tøetí èásti seriálu o architekturách poèítaèù budou popsány rùzné varianty PCI sbìrnic, vèetnì jejich vzájemných kombinací. Zamìøíme se také na podrobný popis komunikace zaøízení (pøídavných karet) pøipojených na PCI sbìrnici s&nbsp;mikroprocesorem.</p>



<h1>Obsah</h1>
<p>
<a href="#k01">1. Rùzné varianty PCI sbìrnic</a><br />
<a href="#k02">2. Tvary konektorù PCI sbìrnic</a><br />
<a href="#k03">3. Komunikace procesoru a zaøízení pøipojených na PCI sbìrnici</a><br />
<a href="#k04">4. Pøenos dat pøes mailboxy èipu AMCC S5933/S5935</a><br />
<a href="#k05">5. Pøenosové operace typu <i>Pass Thru</i> (do pamìti mapované regiony)</a><br />
<a href="#k06">6. Blokové pøenosy dat</a><br />
<a href="#k07">7. Bus-master pøenos</a><br />
<a href="#k08">8. Literatura a odkazy na Internetu</a><br />
<a href="#k09">9. Obsah následující èásti seriálu</a><br />
</p>



<p><a name="k01"></a></p>
<h1>1. Rùzné varianty PCI sbìrnic</h1>

<p>V&nbsp;pøedchozí èásti tohoto seriálu byly uvedeny základní informace o
universální sbìrnici <i>PCI</i>. Øekli jsme si také, ¾e tato sbìrnice existuje
v&nbsp;nìkolika variantách, které se od sebe odli¹ují pøedev¹ím v&nbsp;napìtí
adresových, datových i logických signálù, v&nbsp;rychlosti sbìrnice (pøesnìji
øeèeno frekvencí hodinového signálu) a také v&nbsp;¹íøce datové èásti sbìrnice.
Úroveò logických signálù (tj.&nbsp;napìtí logické jednièky &ndash; logická nula
se od tohoto napìtí odvozuje) mù¾e nabývat hodnoty buï 5 voltù nebo 3,3 voltù.
Taktovací frekvence a ¹íøka datové sbìrnice pøímo urèují maximální datový tok.
Teoretické maximální pøenosové rychlosti jsou vypsány v&nbsp;následující
tabulce, pøièem¾ platí, ¾e reálné maximální rychlosti bývají o cca 10% a¾ 20%
ni¾¹í z&nbsp;dùvodu latence pøi zpracování pøeru¹ení, vìt¹inou omezené
velikosti dat pøená¹ených v&nbsp;jednom bloku atd. U bì¾ných desktopových
poèítaèù se nejèastìji mù¾eme setkat se sbìrnicí taktovanou na 33 MHz
s&nbsp;¹íøkou datové èásti 32 bitù (teoretická maximální rychlost je tedy 132
MB.s<sup>-1</sup>) a úrovnìmi logických signálù 5 voltù.</p>

<table>
<tr><th>Taktovací frekvence</th><th>©íøka datové èásti</th><th>Maximální datový tok</th></tr>
<tr><td> 33 MHz</td><td>32 bitù</td><td> 132 MB.s<sup>-1</sup></td></tr>
<tr><td> 33 MHz</td><td>64 bitù</td><td> 264 MB.s<sup>-1</sup></td></tr>
<tr><td> 66 MHz</td><td>32 bitù</td><td> 264 MB.s<sup>-1</sup></td></tr>
<tr><td> 66 MHz</td><td>64 bitù</td><td> 532 MB.s<sup>-1</sup></td></tr>
<tr><td>133 MHz</td><td>32 bitù</td><td> 532 MB.s<sup>-1</sup></td></tr>
<tr><td>133 MHz</td><td>64 bitù</td><td>1066 MB.s<sup>-1</sup></td></tr>
</table>



<p><a name="k02"></a></p>
<h1>2. Tvary konektorù PCI sbìrnic</h1>

<p>Pøi návrhu konektorù sbìrnice <i>PCI</i> museli její tvùrci vyøe¹it jeden
pomìrnì záva¾ný problém &ndash; jak zajistit, aby se do konektoru, na nìj¾ jsou
pøivádìny pìtivoltové signály, zasunovaly pouze karty urèené pro 5 V a naopak.
Po pøipojení karty urèené pro rozhraní 3,3 voltù by mohlo dojít jak ke znièení
samotné karty, tak i k&nbsp;po¹kození øadièe sbìrnice èi dal¹ích pøipojených
karet. Øe¹ení je jednoduché &ndash; v&nbsp;konektoru jsou na pøesnì urèených
místech takzvané <i>klíèe</i>. V&nbsp;podstatì se jedná o pøeru¹ení vlastního
konektoru takovým zpùsobem, ¾e v&nbsp;kartì musí být na pøíslu¹ném místì
vyøíznut &bdquo;zub&ldquo;, jinak nedojde k&nbsp;jejímu zasunutí. Vzhledem
k&nbsp;tomu, ¾e existují sbìrnice <i>PCI</i> s&nbsp;¹íøkou datové èásti 32 bitù
a 64 bitù a souèasnì (nezávisle na bitové ¹íøce) se mù¾e jednat o rozhraní
pracující na pìti voltech èi 3,3 voltech, mù¾eme se v&nbsp;praxi setkat se
ètyømi typy konektorù. Na prvním obrázku jsou v&nbsp;dolní èásti zobrazeny
konektory pro 32 bitovou PCI sbìrnici, nahoøe jsou mo¾né tvary karet pro
jednotlivé konektory.</p>

<image id="7394" />
<p-center><i>Obrázek 1: Dva mo¾né tvary konektorù pro tøicetidvoubitovou PCI sbìrnici</i></p-center>

<p>V¹imnìte si, ¾e se klíèe nachází jak na pìtivoltové variantì, tak i na
variantì s&nbsp;rozhraním 3,3 V, poka¾dé v¹ak na jiném místì. Tímto zpùsobem je
zaruèeno, ¾e do konektoru bude v¾dy vlo¾ena pouze karta urèená pro dané
rozhraní. Pokud se výrobce karty rozhodne vytvoøit takzvanou universální kartu
pracující jak na 3,3 V, tak i na 5 V, mù¾e takovou kartu jednodu¹e vyrobit
&ndash; postaèuje na plo¹ném spoji udìlat &bdquo;zuby&ldquo; dva (teoreticky by
bylo mo¾né vytvoøit i universální konektor, který by ¾ádné klíèe neobsahoval,
z&nbsp;praktického hlediska v¹ak toto øe¹ení postrádá smysl). Podobným zpùsobem
je vyøe¹ený konektor urèený pro ¹edesátiètyøbitovou variantu sbìrnice
<i>PCI</i>. Samotný konektor je podobný, jako u <i>PCI</i> sbìrnice
s&nbsp;polovièní datovou ¹íøkou (shodné je i umístìní klíèù), ov¹em na pravé
stranì se nachází dal¹í signály, které datovou ¹íøku roz¹iøují na po¾adovaných
64 bitù. Jak konektory, tak i mo¾né tvary karet pro ¹edesátiètyøbitovou PCI
jsou zobrazeny na druhém obrázku.</p>

<image id="7395" />
<p-center><i>Obrázek 2: Dva mo¾né tvary konektorù pro ¹edesátiètyøbitovou PCI sbìrnici</i></p-center>

<p>K&nbsp;tvarùm konektorù i plo¹ných spojù desek, které se do konektorù
zasouvají, je nutné øíci je¹tì jednu dùle¾itou informaci &ndash;
¹edesátiètyøbitové roz¹íøení je pova¾ováno za nepovinné (základní konektor má
62 pinù, roz¹íøený pak 94 pinù). Podobnì jako u <i>PC</i> a <i>ISA</i>
sbìrnice, které byly postaveny na spoleèném základì, je mo¾né i do
¹edesátiètyøbitové varianty <i>PCI</i> zapojovat tøicetidvoubitové karty.
Mechanicky je to umo¾nìno tím, ¾e se za vlastní konektorovou èástí plo¹ného
spoje karty ji¾ nenachází ¾ádné souèástky ani jiné prvky, které by zabraòovaly
vlo¾ení karty do del¹ího konektoru &ndash; viz tøetí obrázek, na kterém je
zvuková karta zapojitelná do tøicetidvoubitové i ¹edesátiètyøbitové varianty
PCI nezávisle na tom, zda se jedná o rozhraní 3,3 voltù èi pìt voltù:</p>

<image id="7396" />
<p-center><i>Obrázek 3: Zvuková karta urèená pro sbìrnici PCI</i></p-center>

<p>Po¾adavky na rozhraní <i>PCI</i> sbìrnice se li¹í podle její verze. <i>PCI
verze 2.2</i> napøíklad pro systémy s&nbsp;frekvencí hodinových pulsù 66 MHz
vy¾aduje rozhraní 3,3 V, zatímco pro frekvenci 33 MHz je mo¾ná volba 3,3 V èi 5
V. Ov¹em na obou typech konektorù je vy¾adována pøítomnost napájecího napìtí
3,3 V. U <i>PCI verze 2.3</i> se ji¾ pracuje pouze s&nbsp;kartami
s&nbsp;napìtím 3,3 V èi universálními kartami, pìtivoltové karty ji¾ nejsou
podporovány. <i>PCI verze 3.0</i>, co¾ je finální standard, ji¾
s&nbsp;rozhraním 5 voltù nepoèítá vùbec. To je vzhledem k&nbsp;technologickému
vývoji pochopitelné.</p>

<image id="7397" />
<p-center><i>Obrázek 4: Povolené kombinace karet a konektorù pro tøicetidvoubitovou PCI</i></p-center>

<image id="7398" original="no" />
<p-center><i>Obrázek 5: Povolené kombinace karet a konektorù pro ¹edesátiètyøbitovou PCI</i></p-center>



<p><a name="k03"></a></p>
<h1>3. Komunikace procesoru a zaøízení pøipojených na PCI sbìrnici</h1>

<p>V&nbsp;normì PCI sbìrnice je do v¹ech podrobností popsán protokol pøenosu
dat i èasový prùbìh v¹ech dùle¾itých signálù. Dodr¾ení standardu je
implementaènì velmi slo¾ité, z&nbsp;tohoto dùvodu je jednodu¹¹í pou¾ít na
pøídavné kartì ji¾ vytvoøený  a dùkladnì otestovaný zákaznický obvod, který
zajistí ve¹kerou potøebnou komunikaci zaøízení s&nbsp;PCI sbìrnicí. Mezi tento
typ obvodù patøí i èip <i>S5933</i> nebo <i>S5935</i> firmy <i>AMCC</i> (plným
názvem &bdquo;Applied Micro Circuits Corporation&ldquo;), pomocí kterého je
mo¾né pøená¹et data pøes sbìrnici PCI nìkolika zpùsoby, které se li¹í jak
nároèností  implementace, tak i maximální dosa¾itelnou rychlostí a úrovní
zatí¾ení sbìrnice. Mezi mo¾nosti pøesunu dat pomocí èipu S5933/S5935 patøí:</p>

<ul>

<li>Jednosmìrný pøenos jednotlivých bytù, ¹estnáctibitových slov èi 32bitových
slov pøes specializované registry, takzvané <i>mailboxy</i>. Pro omezení
aktivního èekání na data lze vyu¾ít mo¾nosti generování pøeru¹ení pøi zápisu
a/nebo ètení z&nbsp;mailboxu.</li>

<li>Pøímé ètení èi zápis do pamìti umístìné na pøipojené desce pomocí
pamì»ových mapovaných regionù. Jedná se o&nbsp;takzvané <i>Pass Thru</i>
operace. Pro tento typ komunikace musí být na pøídavné desce vytvoøena adresová
a datová sbìrnice, ke které je pamì» pøipojena.</li>

<li>Blokový pøenos dat pøes dvì jednosmìrné fronty typu FIFO. Jednou
z&nbsp;modifikací tohoto zpùsobu pøenosu je i nìkolikrát zmínìný <i>bus-master
pøenos</i>, který se provádí v&nbsp;pøípadì, ¾e øízení pøenosu pøevezme
pøídavná karta pøipojená na PCI sbìrnici. Celý pøenos mù¾e øídit právì èip AMCC
5933/5935, který obstará ètení z&nbsp;pamìti pøídavné karty a zápis do operaèní
pamìti hostitelského poèítaèe, popø.&nbsp;i opaènou operaci.</li>

</ul>

<image id="7399" />
<p-center><i>Obrázek 6: Karta urèená pro ¹edesátiètyøbitovou PCI sbìrnici s&nbsp;rozhraním 3,3 V</i></p-center>

<p>V&nbsp;dal¹ím textu se budu zmiòovat o nìkterých registrech, pøièem¾ se
rozli¹ují tøi skupiny registrù:</p>

<ol>

<li><i>PCI configuration registers</i> &ndash; jejich hodnoty bývají typicky
ulo¾eny v&nbsp;nevolatilní pamìti na pøídavné kartì, je zde mj.&nbsp;i
identifikace karty a identifikace výrobce. Pøes èip AMCC jsou hodnoty tìchto
registrù pøístupné pro ètení, èeho¾ vyu¾ívá napøíklad BIOS poèítaèe pøi
pøidìlování adresových oblastí pro jednotlivé pøídavné karty.</li>

<li><i>PCI bus operation registers</i> &ndash; jedná se o skupinu ¹estnácti
32bitových registrù, které øídí èinnost èipu AMCC, právì zde se nachází
mailboxy, obousmìrná komunikaèní fronta, øídicí registry pro bus master pøenos
atd. Tyto registry jsou dostupné pro ètení pøíp.&nbsp;zápis na stranì
PCI sbìrnice.</li>

<li><i>Add-on bus operation registers</i> &ndash; registry pøístupné pouze
z&nbsp;pøídavné karty, které øídí obvod AMCC &bdquo;z&nbsp;druhé strany&ldquo;.
Typicky k&nbsp;tìmto registrùm pøistupuje mikroøadiè èi DSP umístìný na
pøídavné desce. Napøíklad zápis do mailboxu <strong>OMB#1</strong> procesorem
poèítaèe znamená, ¾e se zapisovaný obsah na &bdquo;druhé stranì&ldquo; objeví
v&nbsp;registru <strong>AIMB#1</strong>.</li>

</ol>

<pre>
nvRAM
firmware [AMCC] ...... PCI sbìrnice ...... [North bridge] ...... [Procesor]
karty
</pre



<p><a name="k04"></a></p>
<h1>4. Pøenos dat pøes mailboxy èipu AMCC S5933/S5935</h1>

<p>Pøenos dat po PCI sbìrnici pøes mailboxy èipu AMCC S5933/S5935 je velmi
jednoduchý, proto¾e mailboxy se z&nbsp;programátorského hlediska chovají jako
registry. Do ka¾dého mailboxu lze zapsat informaci (jeden byte, ¹estnáctibitové
slovo èi 32bitové slovo) a tuto informaci je mo¾né z&nbsp;mailboxu následnì
pøeèíst. Komunikace v¹ak funguje jednosmìrnì &ndash; pokud se informace zapí¹e
ze strany pøídavné karty, je ji mo¾né pøeèíst pøes sbìrnici PCI a naopak.
Obvody AMCC S5933 a S5935 mají vytvoøeny ètyøi mailboxy pro pøenos dat smìrem
do periferního zaøízení a ètyøi mailboxy pro pøenos opaèný,
tj.&nbsp;z&nbsp;pøídavné karty smìrem k&nbsp;procesoru.</p>

<p>Výstupní mailboxy jsou v&nbsp;adresovém prostoru PCI zaøízení pojmenovány
<strong>OMB#1</strong> a¾ <strong>OMB#4</strong> (<i>Output MailBox</i>), vstupní
mailboxy mají jména <strong>IMB#1</strong> a¾ <strong>IMB#4</strong> (<i>Input
MailBox</i>). Zaplnìní nebo naopak pøeètení (vyprázdnìní) mailboxu je signalizováno
nastavením pøíslu¹ného stavového bitu v&nbsp;registrech
<strong>MBEF</strong>/<strong>AMBEF</strong> (<i>MailBox Empty/Full status
register</i>), pøièem¾ je mo¾né generovat pøeru¹ení, pokud jsou korektnì nastaveny
øídicí registry <strong>INTCSR</strong>/<strong>AINT</strong> (<i>Interrupt
Control/Status register</i>). Pøeru¹ení je v¹ak mo¾né nastavit pouze pro jeden
mailbox na ka¾dé komunikující stranì, co¾ v¹ak není omezující vlastnost
sbìrnice PCI, ale obvodu AMCC. V&nbsp;nìkterých pøípadech mù¾e být prospì¹né,
¾e se mohou automaticky prohazovat poøadí bytù ve&nbsp;slovech ukládaných do
mailboxù.&nbsp;</p>

<image id="7400" original="no" />
<p-center><i>Obrázek 7: Základní deska obsahující dvì varianty PCI sbìrnice</i></p-center>

<p>Ka¾dé ètení z&nbsp;mailboxu ze strany PCI (tj.&nbsp;pøi komunikaci procesoru
s&nbsp;èipem AMCC) vy¾aduje minimálnì tøi hodinové cykly na sbìrnici.
V&nbsp;prvním cyklu se pøenese adresa mailboxu (který le¾í v&nbsp;adresovém
prostoru PCI zaøízení), druhý cyklus je vìnován dekódování adresy a pøenosu
pøes èip AMCC a teprve ve&nbsp;tøetím cyklu je mo¾né data z&nbsp;mailboxu
pøeèíst. Vzhledem k&nbsp;tomu, ¾e jeden hodinový cyklus PCI sbìrnice má na
poèítaèích typu PC délku trvání 0,03 mikrosekundy, trvá ètení dat
z&nbsp;mailboxu èipu AMCC S5933/S5935 cca 0,1 mikrosekundy &ndash; jde tedy o
jednoduchý ale relativnì pomalý zpùsob pøenosu dat. Také se jedná o snadno
&bdquo;odladitelný&ldquo; pøenos dat &ndash; na obou stranách èipu AMCC
mù¾e vývoj a ladìní probíhat zcela oddìlenì. Pokud se nìkdo ze ètenáøù zabývá
návrhem karet do PCI sbìrnice, je toto nejlep¹í zpùsob, kde zaèít.</p>

<p>Zápis do mailboxu ze strany PCI sbìrnice (tj.&nbsp;procesoru) je ponìkud
rychlej¹í, nebo» je zapotøebí pouze dvou hodinových cyklù: v&nbsp;prvním cyklu
je pøenesena adresa mailboxu a ve&nbsp;druhém cyklu jsou pøenesena potøebná
data.</p>



<p><a name="k05"></a></p>
<h1>5. Pøenosové operace typu <i>Pass Thru</i> (do pamìti mapované regiony)</h1>

<p>Dal¹ím mo¾ným zpùsobem pøenosu dat z/do operaèní pamìti hostitelského
poèítaèe je pou¾ití pamì»ovì mapovaných regionù. Jedná se o&nbsp;takzvané
<i>Pass Thru</i> operace, pøi kterých se èást pamì»ového prostoru pøídavné
karty mapuje do pamì»ového prostoru hostitelského poèítaèe &ndash; pro procesor
èi jiné zaøízení se tedy napøíklad framebuffer grafického akcelerátoru chová
jako souvislá oblast operaèní pamìti. Pro zaji¹tìní Pass Thru operací obsahuje
èip AMCC nìkolik registrù, kterými se nastavuje jak pamì»ový rozsah, tak i
adresa, od které se bude mapování adres provádìt.</p>

<p>Ètení nebo zápis z&nbsp;pamìti na pøídavné kartì je indikován signály na PCI
sbìrnici; konkrétnì se jedná o&nbsp;signály resp.&nbsp;vodièe
<strong>C/BE0#</strong> a¾ <strong>C/BE3#</strong>, pomocí kterých procesor èi
jiné zaøízení posílá kód operace, která se má provést na pøídavné kartì. Pro
ètení z&nbsp;pamìti umístìné na kartì musí být procesorem poslán pøíkaz
<strong>Memory Read</strong>, pro zápis pak pøíkaz <strong>Memory
Write</strong>. Adresa, ze které se má èíst, nebo na kterou se má zapisovat, se
posílá po vodièích <strong>AD00</strong> a¾ <strong>AD31</strong>, tedy po
bì¾ných adresových a datových vodièích sbìrnice PCI (jak jsem ji¾ zdùrazòoval
døíve, je sbìrnice PCI multiplexovaná, proto jsou adresové a datové vodièe
toto¾né).</p>

<p>Pro ka¾dé zaøízení pøipojené ke&nbsp;sbìrnici PCI je pomocí takzvaných PCI
konfiguraèních registrù (jedná se o&nbsp;konfiguraèní registry
<strong>BADR#0</strong> a¾ <strong>BADR#5</strong>) definováno maximálnì ¹est
pamì»ových regionù, které jsou pro dané periferní zaøízení vyhrazeny a do nich¾
je mo¾no zapisovat data, nebo data naopak èíst. Ka¾dý region mù¾e pracovat ve
dvou re¾imech &ndash; ¹estnáctibitovém a 32 bitovém. ©estnáctibitový region je
urèen pro práci v&nbsp;operaèních systémech DOS a Windows 3.11, 32bitový region
je pou¾itelný ve v¹ech 32bitových operaèních systémech, vèetnì Linuxu a BSD
Unixu.</p>

<p>Poèáteèní adresa regionu je pøidìlována v&nbsp;dobì inicializace poèítaèe
systémem BIOS, mù¾e se tedy s&nbsp;ka¾dým spu¹tìním li¹it. Nicménì ovladaè
zaøízení si kdykoli mù¾e pøeèíst v¹echny poèáteèní adresy i povolené rozsahy
adres, které jsou ulo¾eny v&nbsp;registrech <strong>BADR#0</strong> &ndash;
<strong>BADR#5</strong> tak¾e práce s&nbsp;mapovanou pamìtí je pomìrnì
jednoduchá a nijak se neli¹í od práce s&nbsp;regulární operaèní pamìtí
hostitelského poèítaèe.</p>

<p>Pøi práci s&nbsp;èipem AMCC S5933/S5935 jsou do prvního pamì»ového regionu,
jeho¾ poèáteèní adresa a velikost je ulo¾ena v&nbsp;konfiguraèním registru
<strong>BADR#0</strong>, mapovány pøímo øídicí a stavové registry èipu AMCC.
Ostatní ètyøi pamì»ové regiony, jejich¾ konfiguraci lze zjistit z&nbsp;registrù
<strong>BADR#1</strong> &ndash; <strong>BADR#4</strong>, mohou být
nakonfigurovány v&nbsp;dobì inicializace systému pøímo pøídavnou kartou, která
kvùli tomu musí obsahovat stálou (nevolatilní) pamì» typu ROM, v&nbsp;ní¾ je
konfigurace ulo¾ena (pokud se tedy nejedná o nejmenované sí»ové karty od Intelu,
které pøi vhodných podmínkách obsah své nevolatilní pamìti ztratí :-). Poslední
region definovaný registrem <strong>BADR#5</strong> není èipem AMCC
podporován.</p>

<p>Ka¾dá pamì»ová oblast mù¾e mít velikost a¾ 512MB, co¾ je pro pøenos
prakticky v¹ech myslitelných typù dat zcela dostateèná hodnota. Pøi zápisu èi
ètení pøes pamì»ový region dochází k&nbsp;zápisu adresy do registru
<strong>APTA</strong> a dat do registru <strong>APTD</strong> (registry
<strong>APTA</strong> a <strong>APTD</strong> jsou umístìny na&nbsp;èipu AMCC
S5933/S5935. Tyto registry je mo¾né na stranì pøídavné karty èíst a samozøejmì
do nich zapisovat nové hodnoty.</p>

<p>Pass Thru operace pøístupu do pamìti pracují na principu
<i>handshakingu</i>. Pokud se zapisují data smìrem z&nbsp;PCI sbìrnice
(tj.&nbsp;buï procesorem nebo jiným zaøízením), musí pøídavná karta tato data
pøeèíst, jinak nedojde k&nbsp;uvolnìní PCI sbìrnice. Pokud naopak procesor èi
jiné zaøízení ète data z&nbsp;pamìti pøídavné karty, musí ovládací obvod karty
data pøes AMCC èip skuteènì zapsat, jinak se opìt PCI sbìrnice neuvolní. To
znamená, ¾e pokud se z&nbsp;nìjakého dùvodu ¹patnì vyhodnotí objem pøená¹ených
dat, dochází zákonitì k&nbsp;zastavení celého systému, nebo» procesor buï na
nìjaká data marnì èeká, nebo naopak pøídavná karta èeká se zápisem dat, které
procesor u¾ nepøeète &ndash; v&nbsp;obou pøípadech dochází k&nbsp;nepotvrzení
operace ètení/zápisu. Z&nbsp;hlediska stability celého systému je nutno tuto
vlastnost pova¾ovat za znaènou nevýhodu &ndash; z&nbsp;vlastní zku¹enosti
také mohu potvrdit, ¾e v¹echny chyby jsou kvùli okam¾itému &bdquo;zamrznutí&ldquo;
poèítaèe tì¾ko odhalitelné, zejména v&nbsp;pøípadì, ¾e není k&nbsp;dispozici
logický analyzátor PCI (to je pìkná, ale také dosti drahá hraèka).</p>

<p>Dal¹í dùle¾itou vlastností Pass Thru operací je rychlost pøenosu dat. Èip
AMCC S5933/S5935 v&nbsp;tomto re¾imu pracuje na plné rychlosti PCI sbìrnice,
v&nbsp;ka¾dém cyklu tedy lze (kvùli multiplexování adres a dat) pøeèíst èi
zapsat buï adresu èi jeden balík informace &ndash; 32 bitù.</p>

<p>Pokud je pou¾it <i>burst re¾im</i> pøenosu, kdy se adresa pøená¹í pouze na
zaèátku sekvence dat, je teoreticky mo¾né dosáhnout maximální pøenosové
rychlosti sbìrnice PCI, tj. 132 MB.s<sup>-1</sup>. Z&nbsp;tohoto hlediska jsou
tedy pamì»ové pøenosy pomocí Pass Thru operací stejnì výkonné jako bus-master
re¾im pøenosu.</p>



<p><a name="k06"></a></p>
<h1>6. Blokové pøenosy dat</h1>

<p>Z&nbsp;hlediska maximálního objemu pøenesených dat za urèitou èasovou
jednotku je nejvýhodnìj¹í provádìt blokový pøenos dat po PCI sbìrnici
s&nbsp;vyu¾itím <i>burst</i> re¾imu. Ten je mo¾né implementovat dvìma
zpùsoby:</p>

<ol>

<li>Celé øízení pøenosu pøevezme procesor poèítaèe, který pomocí øadièe PCI
sbìrnice nastaví komunikaèní protokol, poèáteèní adresu pøenosu dat a poèet
pøenesených slov. Poté se v&nbsp;programové smyèce provede vlastní pøenos,
tj.&nbsp;generování pøíkazù <strong>Memory Read</strong> na PCI sbìrnici a
ètení dat.</li>

<li>Øízení pøenosu pøevezme pøímo PCI zaøízení, které se tak, podle
terminologie PCI, pro tento pøenos stane <i>Mastrem</i>. Zaøízení typu
<i>Master</i> má odpovìdnost za ve¹keré ustanovení komunikaèního protokolu i
za&nbsp;jeho provedení, vèetnì generování potøebných signálù na sbìrnici
PCI.</li>

</ol>



<p><a name="k07"></a></p>
<h1>7. Bus-master pøenos</h1>

<p>V&nbsp;následujících odstavcích se budu zabývat pouze druhým pøípadem, který
budu nazývat (opìt v&nbsp;rámci terminologie PCI) <i>bus-master</i> pøenos.
Pro bus-master pøenos je obvod AMCC S5933/S5935 vybaven nìkolika registry.
Z&nbsp;tìchto registrù je nejdùle¾itìj¹í registr <strong>FIFO</strong>, pomocí
kterého se zapisuje èi ète z&nbsp;jedné jednostranné fronty. Pro ètení dat
z&nbsp;PCI zaøízení je pou¾ita první fronta, pro zápis dat na PCI zaøízení se
pou¾ívá fronta druhá. Pøi ètení nebo zápisu do fronty mù¾e docházet
ke&nbsp;konverzi dat mezi rùznými typy ulo¾ení bitù a bytù v&nbsp;pøená¹ených
slovech.</p>

<p>Dal¹í registry jsou <strong>MWAR</strong> (<i>Master Write Address
Register</i>) a <strong>MRAR</strong> (<i>Master Read Address Register</i>),
ve&nbsp;kterých jsou ulo¾eny poèáteèní adresy pamì»ových regionù
v&nbsp;operaèní pamìti poèítaèe, na které se budou zapisovat popø.&nbsp;ze
kterých se budou èíst data pomocí bus-master pøenosu. Pøed vlastním pøenosem se
poèet zapisovaných slov ulo¾í do registru <strong>MWTC</strong> (<i>Master
Write Transfer Count Register.</i>). V&nbsp;pøípadì ètení dat se jejich poèet
zapí¹e do registru <strong>MRTC</strong> (<i>Master Read Transfer Count
Register.</i>). Pokud je komunikace mezi poèítaèem a PCI zaøízením korektní,
zaène pøenos probíhat pøi zápisu nenulové hodnoty do jednoho z&nbsp;registrù
<strong>MWTC</strong> èi <strong>MRTC</strong>. Obsah registrù
<strong>MWAR</strong>, <strong>MRAR</strong>, <strong>MWTC</strong> a
<strong>MRTC</strong> se bìhem pøenosu prùbì¾nì mìní, fungují tedy jako
poèitadla, èeho¾ je mo¾né vyu¾ít napøíklad pøi ladìní.</p>

<p>Na konci provádìní blokového bus-master pøenosu mù¾e být generováno
pøeru¹ení, pomocí nìj¾ je procesoru oznámeno uvolnìní PCI sbìrnice. Pokud je
generování pøeru¹ení zakázáno, musí procesor prùbì¾nì testovat stav registrù
<strong>MWTC</strong> nebo <strong>MRTC</strong>, jejich¾ hodnota se bìhem
pøenosu sni¾uje smìrem k&nbsp;nule (samozøejmì se vìt¹inou nejedná o zcela
aktivní a neustálé ètení registrù v&nbsp;programové smyèce, na úrovni API jádra
jsou k&nbsp;dispozici funkce, které doká¾ou bìhem èekání pøedat øízení dal¹ímu
procesu). Generování pøeru¹ení lze nastavit jak pro blokové operace ètení, tak
i pro blokový zápis v&nbsp;registru <strong>INTCSR</strong> (<i>Interrupt
Control/Status Register</i>), který je takté¾ umístìn na èipu AMCC S5933/S5935.
Re¾im pøenosu lze zmìnit zápisem korektních informací do registru
<strong>MCSR</strong> (<i>Master Control/Status Register</i>), ve kterém lze
mimo jiné i pøedepsat prioritu ètení pøed zápisem, èi naopak zápisu pøed
ètením.</p>

<p>Ka¾dá fronta má délku osmi 32bitových slov. Pøi vyprázdnìní fronty èi pøi
jejím pøeplnìní je generováno pøeru¹ení na stranì PCI sbìrnice èi pøídavné
karty, na její¾ podnìt musí být do fronty zapsána èi pøeètena dal¹í data.
Pomocí registru <strong>MCSR</strong> v¹ak mù¾e být nastaven re¾im, kdy je
pøeru¹ení generováno u¾ pøi pøekroèení polovièní kapacity fronty
(tj.&nbsp;ètvrtého slova). Vzhledem k&nbsp;tomu, ¾e je v&nbsp;tomto pøípadì
pøeru¹ení generováno døíve, mù¾e pøenos probíhat dále souèasnì s&nbsp;plnìním
fronty &ndash; tímto zpùsobem je mo¾né zabezpeèit kontinuální <i>burst</i>
pøenos celého bloku dat, èím¾ dochází k&nbsp;optimálnímu vyu¾ití pøenosového
pásma PCI sbìrnice, jeliko¾ pøi <i>burst</i> pøenosu se nemusí neustále
pøená¹et adresy pamì»ových míst.</p>

<p>Jedinou vá¾nìj¹í nevýhodou tohoto zpùsobu pøenosu dat, je nutnost pøenesení
celých násobkù 32bitových slov. Nelze tedy pøenést napøíklad lichý poèet bytù
&ndash; první èi poslední byty celé sekvence by se musely pøes registr FIFO
pøenést programovì. Vìt¹inou lze toto omezení obejít buï na stranì programu
nebo firmwaru na pøídavné desce. Bus-master pøenos se implementuje a ladí
pomìrnì snadno &ndash; podle mých zku¹eností je nejlep¹í nejprve vlastní kartu
&bdquo;nauèit&ldquo; komunikovat pøes mailboxy a kdy¾ v¹e pracuje dobøe,
urychlit blokové pøesuny dat pomocí bus-master pøenosu.</p>



<p><a name="k08"></a></p>
<h1>8. Literatura a odkazy na Internetu</h1>

<ol>

<li>Wikipedia EN: Peripheral Component Interconnect,<br />
<a href="http://en.wikipedia.org/wiki/Peripheral_Component_Interconnect">http://en.wikipedia.org/wiki/Peripheral_Component_Interconnect</a></li>

<li>PCI Vendor and Device Lists,<br />
<a href="http://www.pcidatabase.com/index.php">http://www.pcidatabase.com/index.php</a></li>

<li>Seznam PCI VID/DID,<br />
<a href="http://www.pcidatabase.com/reports.php?type=csv">http://www.pcidatabase.com/reports.php?type=csv</a></li>

<li>PCI bus pinout,<br />
<a href="http://pinouts.ru/Slots/PCI_pinout.shtml">http://pinouts.ru/Slots/PCI_pinout.shtml</a></li>

<li>How to recognise a 3.3 Volt PCI slot,<br />
<a href="http://www94.web.cern.ch/hsi/s-link/devices/s32pci64/slottypes.html">http://www94.web.cern.ch/hsi/s-link/devices/s32pci64/slottypes.html</a></li>

<li>Computer Bus and BackPlane Design,<br />
<a href="http://www.interfacebus.com/Design_Interface_table.html">http://www.interfacebus.com/Design_Interface_table.html</a></li>

<li>VESA Local Bus,<br />
<a href="http://en.wikipedia.org/wiki/VESA_Local_Bus">http://en.wikipedia.org/wiki/VESA_Local_Bus</a></li>

<li>VESA Local Bus,<br />
<a href="http://cs.wikipedia.org/wiki/VESA_Local_Bus">http://cs.wikipedia.org/wiki/VESA_Local_Bus</a></li>

<li>Applied Micro Circuits Corporation:<br />
S5935 PCI product Data Book,<br />
Applied Micro Circuits Corporation, San Diego, 1999</li>

<li>Bhatt Ajay V.:<br />
Creating a PCI Express Interconnect,<br />
Technology and Research Labs, Intel Corporation, 2003</li>

<li>Intel Coproration, Neshati Ramin:<br />
PCI Express Base Specification 1.0a,<br />
Intel Corporation, 2003</li>

</ol>

<image id="7402" />
<p-center><i>Obrázek 8: Analyzátor PCI sbìrnice, který se zapojuje mezi
základní desku a PCI kartu</i></p-center>



<p><a name="k09"></a></p>
<h1>9. Obsah následující èásti seriálu</h1>

<p>Prakticky nejznámìj¹ím roz¹íøením sbìrnice <i>PCI</i> je sbìrnice oznaèovaná
<i>PCI Express</i>. Nejedná se v¹ak o faktické roz¹íøení na fyzické úrovni, ale
na úrovni programové. Na fyzické úrovni se jedná o zcela nový (a nutno øíci, ¾e
velmi zajímavì navr¾ený) typ sbìrnice, která se v&nbsp;nìkterých aspektech
dokonce podobá propojovací síti s&nbsp;topologií odli¹nou od topologie
sbìrnicové (lineární). Pøenosová rychlost se u této sbìrnice pohybuje
v&nbsp;øádech jednotek a¾ desítek GBs<sup>-1</sup>, pro dnes nejèastìj¹í mìdìné
spoje je maximální rychlost stanovena na 10 GBps<sup>-1</sup>. Právì tímto
typem sbìrnice se budeme podrobnìji zabývat v&nbsp;navazující èásti tohoto
seriálu. Popí¹eme si také port <i>AGP</i>, vèetnì jeho zvlá¹tních re¾imù a
funkcí.</p>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/&nbsp;tisnovpa">Pavel Ti¹novský</a> &nbsp; 2008</small></p>
</body>
</html>

