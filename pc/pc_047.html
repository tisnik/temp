<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Pøenos dat po universální sériové sbìrnici</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Pøenos dat po universální sériové sbìrnici</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V dne¹ní èásti seriálu o architekturách poèítaèù si popí¹eme jednotlivé typy paketù, které jsou pou¾ity pro øízení pøenosu dat i pro vlastní pøenos u¾iteèných informací mezi jednotlivými uzly pøipojenými k universální sériové sbìrnici (USB). Také si øekneme, jak lze zaøízení pøevést do re¾imu spánku a posléze ho opìt vzbudit.</p>



<h1>Obsah</h1>
<p>
<a href="#k01">1. Napì»ové úrovnì L a H, stavy sbìrnice a kódování pøená¹ených bitù</a><br />
<a href="#k02">2. Zpùsob pøenosu dat</a><br />
<a href="#k03">3. Zaèátek a konec paketu</a><br />
<a href="#k04">4. Token paket</a><br />
<a href="#k05">5. Datové pakety</a><br />
<a href="#k06">6. SOF (Start of Frame) paket</a><br />
<a href="#k07">7. Handshake pakety</a><br />
<a href="#k08">8. Funkce suspend, resume a reset</a><br />
<a href="#k09">9. Literatura a odkazy na Internetu</a><br />
</p>



<p><a name="k01"></a></p>
<h1>1. Napì»ové úrovnì L a H, stavy sbìrnice a kódování pøená¹ených bitù</h1>

<p>Pøed popisem zpùsobu pøenosu øídicích i datových paketù pou¾ívaných na
universální sériové sbìrnici (<i>USB</i>) si pøipomeòme nìkteré
charakteristické vlastnosti pøenosu dat po kroucené dvojlince, kterou jsou
propojeny v¾dy dvì zaøízení (uzly) pøipojená na jeden segment <i>USB</i>. Pro
zaøízení pracující v&nbsp;re¾imu nízké rychlosti (<i>Low Speed</i>) i rychlosti
normální (<i>Full Speed</i>) se pou¾ívají shodné napì»ové úrovnì na signálových
vodièích oznaèovaných symboly <i>D+</i> a <i>D-</i>. Pro nízkou logickou úroveò
<strong>L</strong> je stanoven rozsah 0,0 a¾ 0,3 V, pro vysokou logickou úroveò
<strong>H</strong> pak rozsah 2,8 a¾ 3,6 V. V&nbsp;re¾imu vysoké rychlosti
(<i>High Speed</i>) jsou v¹ak napì»ové úrovnì zcela odli¹né: -10mV a¾ 10mV pro
logickou úroveò <strong>L</strong> a 360-440 mV pro logickou úroveò
<strong>H</strong>. Ov¹em zmínìné úrovnì <strong>H</strong> a
<strong>L</strong> nereprezentují pøímo pøená¹ené bity, proto¾e je pou¾ito
ponìkud upravené kódování <i>NRZI</i> (viz dal¹í odstavec). Data jsou pøená¹ena
pomocí zmìny stavu datových linek. Rozeznávají se pøitom dvì vý¹e uvedená
základní napìtí vodièù &ndash; <strong>H</strong> a <strong>L</strong>. To
znamená, ¾e na dvou datových (signálových) vodièích je mo¾né binárnì zakódovat
v¾dy jeden ze ètyø stavù. Tøi z&nbsp;tìchto stavù jsou povoleny (mohou se
v&nbsp;prùbìhu komunikace na datových vodièích vyskytnout), ètvrtý stav je za
obvyklých podmínek zakázaný. Stav sbìrnice, pøi ní¾ jsou logické úrovnì na
signálových vodièích opaèné, se oznaèuje písmeny <strong>J</strong> nebo
<strong>K</strong>, v&nbsp;závislosti na polaritì napìtí mìøeného mezi
signálovými vodièi a zvolenou pøenosovou rychlostí.</p>

<table>
<tr><td>Stav sbìrnice          </td><td>Úroveò na vodièi D+</td><td>Úroveò na vodièi D-</td><td>Poznámka</td></tr>
<tr><td>Differential '1'       </td><td><strong>H</strong></td><td><strong>L</strong></td><td>pøedstavuje buï <strong>J</strong> èi <strong>K</strong> podle zvolené rychlosti</td></tr>
<tr><td>Differential '0'       </td><td><strong>L</strong></td><td><strong>H</strong></td><td>pøedstavuje buï <strong>J</strong> èi <strong>K</strong> podle zvolené rychlosti</td></tr>
<tr><td>Single Ended Zero (SE0)</td><td><strong>L</strong></td><td><strong>L</strong></td><td>konec paketu, reset atd.</td></tr>
<tr><td>Single Ended One (SE1) </td><td><strong>H</strong></td><td><strong>H</strong></td><td>nepovoleno</td></tr>
</table>

<image id="8112" />
<p-center><i>Obrázek 1: Kit umo¾òující pøipojení mikroøadièù Atmel
k&nbsp;universální sériové sbìrnici.</i></p-center>

<p>Samotný proud bitù je zakódován (inverzní) metodou <i>NRZI</i>, její¾
princip je velmi jednoduchý &ndash; bit s&nbsp;binární hodnotou nula je
reprezentován jako zmìna stavu mezi <strong>J</strong> a <strong>K</strong> èi
naopak jako zmìna stavu mezi <strong>K</strong> a <strong>J</strong>, zatímco
bit s&nbsp;logickou hodnotou jedna znamená, ¾e se stav pøenosové linky nezmìní,
tj.&nbsp;linka zùstane v&nbsp;pùvodním stavu (buï <strong>J</strong> nebo
<strong>K</strong>). To v¹ak není v¹echno. Kvùli tomu, aby byla zaruèena
synchronizace pøená¹ených dat, je v&nbsp;pøípadì, ¾e se v&nbsp;bitovém proudu
vyskytne za sebou ¹est jednièek (tj.&nbsp;¹estkrát za sebou by se stav linky
nezmìnil), navíc vlo¾en bit s&nbsp;hodnotou nula, co¾ znamená, ¾e se
&bdquo;vynutí&ldquo; zmìna stavu na lince, èeho¾ mohou obì komunikující strany
vyu¾ít k&nbsp;vzájemné synchronizaci hodin (pøijímaè se zasynchronizuje podle
vysílaèe). Pokud by se na pøenosové lince vyskytlo sedm za sebou jdoucích bitù
s&nbsp;logickou hodnotou jedna, je to pova¾ováno za chybu. Napì»ové úrovnì
pøiøazené stavùm <strong>J</strong> a <strong>K</strong>, které jsou pou¾ité
pro pøenos zakódovaného proudu bitù, se li¹í podle toho, jakou rychlostí se
data pøená¹í:</p>

<table>
<tr><td>Stav</td><td>Re¾im Low speed</td><td>Re¾im Full speed</td></tr>
<tr><td><strong>J</strong></td><td>Differential '0'</td><td>Differential '1'</td></tr>
<tr><td><strong>K</strong></td><td>Differential '1'</td><td>Differential '0'</td></tr>
</table>

<image id="8113" original="no" />
<p-center><i>Obrázek 2: LCD displej ovládaný pøes sbìrnici USB pomocí
mikroøadièe Atmel.</i></p-center>



<p><a name="k02"></a></p>
<h1>2. Zpùsob pøenosu dat</h1>

<p>Vzhledem k&nbsp;tomu, ¾e universální sériová sbìrnice je na fyzické úrovni
tvoøena uzly, které jsou navzájem propojeny tak, ¾e tvoøí stromovou strukturu
s&nbsp;jedním koøenovým uzlem (nazývaným <i>host</i>), je øízení pøenosu dat
centralizováno právì do koøenového uzlu &ndash; tento uzel postupnì adresuje
ostatní pøipojená zaøízení a iniciuje pøenosy dat. Pøedností tohoto zpùsobu
øízení je znaèná jednoduchost, proto¾e není zapotøebí zavádìt slo¾itou arbitrá¾
sbìrnice, soubì¾nì bì¾ící pøenosy mezi nìkolika uzly apod. Nevýhodou je
nedostateèné vyu¾ití pøenosového pásma a také nutnost aktivního zji¹»ování
stavu v¹ech pøipojených zaøízení, proto¾e neexistuje mo¾nost, jak by zaøízení
(kromì koøenového uzlu) samo o sobì mohlo po¾ádat o pøedání sbìrnice. Pro
nìkteré úèely tedy není pou¾ití USB vhodné &ndash; napøíklad tam, kde se
vy¾adují rychlé reakce v&nbsp;zaruèeném èasovém intervalu. Nyní si øeknìme
základní princip pøenosu dat. Vzhledem k&nbsp;tomu, ¾e kromì dvou datových
vodièù a dvou vodièù napájecích USB neobsahuje ¾ádné dal¹í signálové vodièe,
musí být øízení pøenosu realizováno na vy¹¹í úrovni. Kromì vlastních
&bdquo;u¾iteèných&ldquo; dat jsou pøená¹eny i pøíkazy, kterými <i>host</i> øídí
pøipojená zaøízení a ty mu naopak posílají informaci o stavu pøenosu dat,
pøipravenosti pro pøíjem èi vysílání dat atd.</p>

<image id="8114" original="no" />
<p-center><i>Obrázek 3: Zapojení LCD displeje na USB je s&nbsp;pomocí
mikroøadièe Atmel velmi jednoduché. Ve schématu je navíc i IR pøijímaè, data
jsou dekódována programovì (ostatnì i USB protokol je
naprogramovaný).</i></p-center>



<p><a name="k03"></a></p>
<h1>3. Zaèátek a konec paketu</h1>

<p>V&nbsp;pøedchozím textu jsme si øekli, ¾e sbìrnice je øízena v¾dy
z&nbsp;koøenového uzlu. Tento uzel na zaøízení, se kterým potøebuje
komunikovat, po¹le takzvaný <i>token paket</i> s&nbsp;pøíkazem, za ním typicky
následuje <i>datový paket</i> (pøená¹ený buï ze zaøízení do koøenového uzlu èi
naopak) a komunikace je ukonèena <i>handshake paketem</i>, ve kterém je
potvrzen pøenos dat nebo je naopak indikována nìjaká chyba. Pokud je na
sbìrnici zapojen i rozboèovaè (<i>hub</i>), je jeho povinností pakety smìrovat
do po¾adovaného uzlu v&nbsp;závislosti na pøená¹ené adrese zaøízení (viz dal¹í
kapitoly). Ka¾dý paket zaèíná <i>synchronizaèním bajtem</i>, který má bitovou
hodnotu 00000001. Vzhledem k&nbsp;tomu, ¾e klidový stav sbìrnice (datových
vodièù) odpovídá stavu <strong>J</strong> a bitová nula se pøená¹í jako zmìna
stavu <strong>J&rarr;K</strong> èi <strong>K&rarr;J</strong>, vypadá pøenos
synchronizaèního bajtu následovnì: <strong>KJKJKJKK</strong>. Poslední dvojice
stavù <strong>KK</strong> znaèí konec synchronizaèního bajtu a zaèátek paketu.
Paket mù¾e mít podle svého typu rùznou délku (na rozdíl od Ethernetových
rámcù), poèet bitù je v¹ak v¾dy zarovnán na celé bajty. U zaøízení pracujících
vysokou rychlostí je synchronizaèní sekvence prodlou¾ena &ndash; místo osmi
bitù se pøená¹í celých 32 bitù, pøièem¾ pouze poslední bit je jednièkový;
tj.&nbsp;na sbìrnici se vyskytnou následující stavy:
<strong>KJKJKJKJKJKJKJKJKJKJKJKJKJKJKJKK</strong> (ve skuteènosti na délce
synchronizaèní sekvence pøíli¹ nezále¾í, zaøízení zaène pøijímat data a¾
tehdy, kdy¾ zjistí dvojici za sebou jdoucích stavù <strong>KK</strong>).</p>

<image id="8115" />
<p-center><i>Obrázek 4: Stromová topologie universální sériové sbìrnice.
V&nbsp;celém segmentu sbìrnice USB existuje pouze jeden øídicí uzel (host),
který je vìt¹inou pøedstavován samotným poèítaèem (pøesnìji øeèeno øadièem USB
umístìným na základní desce nebo pøídavné kartì). K&nbsp;tomuto uzlu se
pøipojují buï pøímo koncová zaøízení pracující rùznou rychlostí nebo
rozboèovaèe (hubs). Maximální poèet pøipojených zaøízení mù¾e dosáhnout hodnoty
127 (adresa zaøízení má rozsah sedmi bitù, jedna adresa je rezervovaná), poèet
úrovní je omezen na pìt.</i></p-center>

<p>Pøenos celého paketu je ukonèen sekvencí nazvanou <strong>EOP</strong>
(<i>End of Packet</i>). Nejprve se na dobu pøenosu dvou bitù nastaví stav
<strong>SE0</strong> (<i>Single Ended Zero</i> &ndash; viz pøedchozí kapitola),
po nìm¾ následuje pøechod do stavu <strong>J</strong> na dobu minimálnì jednoho
bitu. V&nbsp;tomto stavu mù¾e daný segment sbìrnice setrvat po libovolnì
dlouhou dobu; jedná se o re¾im <i>idle</i>. V&nbsp;pøedchozí èásti tohoto
seriálu jsme si øekli, jakým zpùsobem jsou nastaveny napì»ové úrovnì na obou
signálových vodièích ihned po pøipojení nìjakého zaøízení &ndash; pomocí
pull-up a pull-down rezistorù je v¾dy jeden signálový vodiè nastaven na vysokou
úroveò a druhý vodiè na úroveò nízkou. Jedná se o stejné úrovnì, jaké jsou
pou¾ité v&nbsp;re¾imu <i>idle</i>, co¾ znamená, ¾e pro udr¾ení tohoto re¾imu
není zapotøebí ¾ádná øídicí logika &ndash; v¹e obstarají pull-up a pull-down
rezistory tvoøící na jednom signálovém vodièi napì»ový dìliè.</p>

<image id="8116" />
<p-center><i>Obrázek 5: Konec paketu (EOP) a pøechod do re¾imu
idle.</i></p-center>



<p><a name="k04"></a></p>
<h1>4. Token paket</h1>

<p>Prvním typem paketu, který koøenový uzel posílá do zvoleného zaøízení, je
takzvaný <i>token paket</i>. Tímto paketem koøenový uzel zvolené zaøízení
adresuje, specifikuje i jeho koncový bod (jedná se o logickou adresu
v&nbsp;rámci zvoleného zaøízení &ndash; pou¾ito u tìch zaøízení, které mají
více funkcí, napøíklad se jedná o èteèky více typù pamì»ových karet) a
mj.&nbsp;urèuje, zda se data budou pøená¹et od koøenového uzlu do zaøízení èi
naopak. Token paket má v¾dy délku 24 bitù (bez zapoèítání synchronizaèního
bajtu) s&nbsp;následující strukturou:</p>

<table>
<tr><th>Oznaèení</th><th>Poèet bitù</th><th>Význam</th></tr>
<tr><td>Sync</td><td>8/32</td><td>synchronizaèní sekvence</td></tr>
<tr><td>PID</td><td>8</td><td>identifikace typu paketu</td></tr>
<tr><td>ADDR</td><td>7</td><td>adresa zaøízení 1-127</td></tr>
<tr><td>ENDP</td><td>4</td><td>koncový bod v&nbsp;rámci zvoleného zaøízení</td></tr>
<tr><td>CRC5</td><td>5</td><td>kontrolní souèet</td></tr>
<tr><td>EOP</td><td></td><td>konec paketu</td></tr>
</table>

<p><strong>PID</strong>, neboli identifikace typu paketu, je ètyøbitové èíslo,
které je v&nbsp;osmi bitech zapsáno dvakrát &ndash; jednou v&nbsp;pøímé podobì,
podruhé inverznì. Díky tomu je umo¾nìna detekce chyby pøi pøenosu a také to, ¾e
je <strong>PID</strong> v¾dy pøenesen bez nutnosti vkládání dodateèného bitu
(ten je do sekvence pøená¹ených bitù vlo¾en tehdy, kdy¾ za sebou následuje sedm
jednièek, dùvod byl uveden v&nbsp;úvodních kapitolách). Význam jednotlivých
kódù <strong>PID</strong> je vypsán v&nbsp;tabulce ní¾e. Adresa zaøízení má
délku sedmi bitù, z&nbsp;èeho¾ vyplývá, ¾e je mo¾né adresovat a¾ 127 zaøízení
pøipojených na jeden segment USB. Adresa s&nbsp;hodnotou 0 je rezervována pro
ta zaøízení, kterým je¹tì nebyla adresa pøidìlena. V&nbsp;jednom zaøízení se
mù¾e nacházet a¾ ¹estnáct koncových bodù (<i>endpoint</i>), které jsou
adresovány ètyømi bity. To znamená, ¾e pøenos dat není na logické úrovni
provádìn mezi uzly (fyzickými zaøízeními), ale mezi koncovými body.
Z&nbsp;tohoto hlediska se mù¾e napøíklad ji¾ zmínìná èteèka pamì»ových karet
v&nbsp;systému chovat jako nìkolik zaøízení typu mass-storage (nìkolik
logických diskù). Za èíslem koncového bodu následuje pìtibitový kontrolní
souèet <strong>CRC5</strong> a konec paketu. Povolené <strong>PID</strong>
v&nbsp;token paketu:</p>

<table>
<tr><th>PID</th><th>Bitová hodnota</th><th>Význam</th></tr>
<tr><td>OUT</td><td>0001</td><td>pøenos dat z&nbsp;koøenového uzlu do zaøízení (zápis)</td></tr>
<tr><td>IN</td><td>1001</td><td>pøenos dat ze zaøízení do koøenového uzlu (ètení)</td></tr>
<tr><td>SETUP</td><td>1101</td><td>inicializace zaøízení (speciální datový paket o délce osmi bytù)</td></tr>
</table>



<p><a name="k05"></a></p>
<h1>5. Datové pakety</h1>

<p>Po vyslání vý¹e popsaného <i>token paketu</i> mù¾e následovat <i>datový
paket</i>, který je pøená¹en buï z&nbsp;adresovaného zaøízení do koøenového
uzlu èi naopak. Pakety z&nbsp;této skupiny mají podobnou strukturu jako
<i>token paket</i>: zaèínají synchronizaèním bajtem následovaným
identifikátorem paketu. Poté jsou pøenesena data, za nimi¾ je ulo¾en kontrolní
souèet (nyní ¹estnáctibitový, ne pouze pìtibitový) a koneènì
<strong>EOP</strong>:</p>

<table>
<tr><th>Oznaèení</th><th>Poèet bitù</th><th>Význam</th></tr>
<tr><td>Sync</td><td>8/32</td><td>synchronizaèní sekvence</td></tr>
<tr><td>PID</td><td>8</td><td>identifikace typu paketu</td></tr>
<tr><td>DATA0/DATA1/DATA2/MDATA</td><td>max.&nbsp;8192</td><td>pøená¹ená data</td></tr>
<tr><td>CRC16</td><td>16</td><td>kontrolní souèet</td></tr>
<tr><td>EOP</td><td></td><td>konec paketu</td></tr>
</table>

<p>Datové pakety typu <strong>DATA0</strong> a <strong>DATA1</strong> se
pou¾ívají pro zaøízení pracujících pomalou i normální rychlostí (délka datového
bloku je v&nbsp;re¾imu normální rychlosti 0-1023 bajtù, v&nbsp;re¾imu rychlosti
pomalé v¹ak pouze osm bajtù! &ndash; v&nbsp;tomto pøípadì je pøenosová kapacita
sbìrnice vyu¾ita velmi neefektivnì), ve standardu USB 2.0 pak pøibyly typy
<strong>DATA2</strong> a <strong>MDATA</strong>, které umo¾òují pøená¹et data
rozdìlená do blokù o velikosti a¾ jeden kilobajt. Pøi pøenosu vìt¹ího mno¾ství
dat do èi z&nbsp;jednoho uzlu se musí støídat pakety typu
<strong>DATA0</strong> a <strong>DATA1</strong>. Støídání tìchto paketù je
toti¾ souèástí pøenosového protokolu &ndash; nejprve jsou pøenesena data, která
by mìla být potvrzena handshake paketem typu <strong>ACK</strong>. Pokud v¹ak
vysílací uzel tento paket nepøijme, mù¾e to znamenat, ¾e se buï data vùbec
nepøenesla, nebo se ztratil samotný potvrzovací paket. Proto si pøijímací
zaøízení pamatuje, který typ datového paketu byl pøenesen a v&nbsp;pøípadì, ¾e
se zaèíná vysílat paket stejného typu, je sice pøeèten, ale ignorován (jedná se
toti¾ s&nbsp;velkou pravdìpodobností o situaci, kdy pøijímaè z&nbsp;rùzných
pøíèin nedostal handshake paket <strong>ACK</strong> a proto data vyslal
znovu). Následuje výpis identifikaèních kódù jednotlivých typù datových
paketù:</p>

<table>
<tr><th>PID</th><th>Bitová hodnota</th><th>Význam</th></tr>
<tr><td>DATA0</td><td>0011</td><td>data o délce 0-1023 bytù (pro low speed 8 bytù)</td></tr>
<tr><td>DATA1</td><td>1011</td><td>data o délce 0-1023 bytù (pro low speed 8 bytù)</td></tr>
<tr><td>DATA2</td><td>0111</td><td>pou¾ito pro vysokorychlostní pøenosy</td></tr>
<tr><td>MDATA</td><td>1111</td><td>pou¾ito pro vysokorychlostní pøenosy</td></tr>
</table>



<p><a name="k06"></a></p>
<h1>6. SOF (Start of Frame) paket</h1>

<p>Paket typu <strong>SOF</strong> (<i>Start of Frame</i>) je pou¾íván pro
synchronizaci pøi izochronním pøenosu dat. Formát tohoto paketu je (opìt)
odvozen od token paketu, ov¹em s&nbsp;tím rozdílem, ¾e místo adresy zaøízení a
èísla koncového bodu je pøená¹ena jedenáctibitová hodnota poèitadla. Tento
paket by mìl být na zaøízení vyslán ka¾dou milisekundu, tj.&nbsp;pro zaøízení
pracující plnou rychlostí po uplynutí doby odpovídající pøenosu 12000 bitù.
Hodnota poèitadla se postupnì zvy¹uje s&nbsp;tím, ¾e po pøekroèení maximální
hodnoty (2<sup>11</sup>-1=2047) se zaèíná s&nbsp;èítáním od nuly. Formát tohoto
paketu je následující:</p>

<table>
<tr><th>Oznaèení</th><th>Poèet bitù</th><th>Význam</th></tr>
<tr><td>Sync</td><td>8/32</td><td>synchronizaèní sekvence</td></tr>
<tr><td>PID</td><td>8</td><td>identifikace typu paketu</td></tr>
<tr><td>frame#</td><td>11</td><td>aktuální hodnota poèitadla</td></tr>
<tr><td>CRC5</td><td>5</td><td>kontrolní souèet</td></tr>
<tr><td>EOP</td><td></td><td>konec paketu</td></tr>
</table>

<table>
<tr><th>PID</th><th>Bitová hodnota</th><th>Význam</th></tr>
<tr><td>SOF</td><td>0101</td><td>PID paketu typu Start of Frame</td></tr>
</table>



<p><a name="k07"></a></p>
<h1>7. Handshake pakety</h1>

<p>Pomocí této skupiny paketù oznamuje zaøízení svùj stav koøenovému uzlu,
popø.&nbsp;je mo¾ná i opaèná varianta, podle smìru pøenosu dat. Jedná se o
paket, který je vybraným zaøízením poslaný ihned po pøíjmu datového paketu
(popø.&nbsp;inicializaèního paketu) nebo naopak po pokusu o odvysílání datového
paketu do koøenového uzlu. Formát je velmi jednoduchý:</p>

<table>
<tr><th>Oznaèení</th><th>Poèet bitù</th><th>Význam</th></tr>
<tr><td>Sync</td><td>8/32</td><td>synchronizaèní sekvence</td></tr>
<tr><td>PID</td><td>8</td><td>identifikace typu paketu</td></tr>
<tr><td>EOP</td><td></td><td>konec paketu</td></tr>
</table>

<p>Mezi dva základní stavy pøenosu patøí <strong>ACK</strong>
(<i>acknowledged</i> &ndash; potvrzení vysílání/pøíjmu) a <strong>NAK</strong>
(<i>not acknowledged</i> &ndash; vysílání/pøíjem se nezdaøil, nejde v¹ak o
trvalou chybu). Pokud zaøízení zjistí trvalou chybu, vrátí stav
<strong>STALL</strong>. Pøi pøenosu blokových dat v&nbsp;takzvaných rozdìlených
transakcích se pou¾ívají stavy <strong>NYET</strong> (<i>not responsible
yet</i>) a <strong>ERR</strong> (rozdìlené transakce jsou podporovány a¾ ve
standardu USB 2.0). Význam jednotlivých potvrzovacích kódù a jim pøidìlených
identifikátorù paketù:</p>

<table>
<tr><th>PID</th><th>Bitová hodnota</th><th>Význam</th></tr>
<tr><td>ACK</td><td>0010</td><td>datový paket byl v&nbsp;poøádku pøeèten</td></tr>
<tr><td>NAK</td><td>1010</td><td>zaøízení nemohlo data pøijmout èi odvysílat</td></tr>
<tr><td>STALL</td><td>1110</td><td>zaøízení je ve stavu trvalé chyby, èeká se na reset od koøenového uzlu</td></tr>
<tr><td>NYET</td><td>0110</td><td>USB 2.0 - rozdìlená transakce (více blokù dat) nebyla je¹tì dokonèena</td></tr>
<tr><td>ERR</td><td>1100</td><td>rozdìlená transakce (více blokù dat) nebyla dokonèena z&nbsp;dùvodu chyby</td></tr>
</table>



<p><a name="k08"></a></p>
<h1>8. Funkce suspend, resume a reset</h1>

<p>Zaøízení mù¾e být koøenovým uzlem pøepnuto do re¾imu <i>idle</i>, který je
po urèité dobì nahrazen re¾imem <i>suspend</i>. Pøechod do tohoto re¾imu je
zobrazen na ¹estém obrázku. Po pøenosu posledního paketu (s&nbsp;jeho korektním
ukonèením) zaøízení pøechází do re¾imu <i>idle</i>, ve kterém oèekává pøíjem
dal¹ích paketù (vysílání, jak jsme si ji¾ øekli, nemù¾e samo zaøízení
iniciovat). Pokud re¾im <i>idle</i> trvá alespoò 3ms, pøechází se do re¾imu
<i>suspend</i>:</p>

<image id="8117" />
<p-center><i>Obrázek 6: Pøechod do re¾imu suspend</i></p-center>

<p>Z&nbsp;re¾imu <i>suspend</i> se mù¾e zaøízení &bdquo;probudit&ldquo;
posloupností signálù zobrazených na sedmém obrázku. Nejprve dojde ke zmìnì
napì»ových úrovní na obou signálových vodièích, které by mìlo zùstat zachováno
po dobu alespoò 20 ms. Poté øídicí uzel (<i>host</i> nebo rozboèovaè) po dobu
trvání pøenosu dvou bitù nastaví stav <strong>SE0</strong>, který je následnì
zmìnìn na stav <strong>J</strong>. V&nbsp;této chvíli je zaøízení pøipraveno
pøijmout synchronizaèní sekvenci a øídicí èi datový paket.</p>

<image id="8118" />
<p-center><i>Obrázek 7: Funkce resume</i></p-center>

<p>Reset zaøízení (pøesnìji øeèeno pouze reset jeho komunikaèní èásti) se
provádí posloupností signálù zobrazených na osmém obrázku. Pokud se zaøízení
nachází v&nbsp;re¾imu <i>idle</i>, postaèuje, aby po dobu alespoò deseti
milisekund byl nastavený stav <strong>SE0</strong>. Poté dojde k&nbsp;resetu
komunikaèní èásti zaøízení. Po uplynutí dal¹ích nìkolika milisekund lze zaèít
s&nbsp;pøenosem synchronizaèní sekvence a øídicího èi datového paketu.</p>

<image id="8119" />
<p-center><i>Obrázek 8: Funkce reset</i></p-center>



<p><a name="k09"></a></p>
<h1>9. Literatura a odkazy na Internetu</h1>

<ol>

<li>USB in a Nutshell,<br />
<a href="http://www.beyondlogic.org/usbnutshell/usb2.htm">http://www.beyondlogic.org/usbnutshell/usb2.htm</a>
</li>

<li>USB Chips, Links to USB Host and Device Controller Chips,<br />
<a href="http://www.lvr.com/usbchips.htm">http://www.lvr.com/usbchips.htm</a>
</li>

<li>Jan Axelson: USB Complete. Everything You Need to Develop Custom USB Peripherals, Third Edition,<br />
<a href="http://www.lvr.com/usbc.htm">http://www.lvr.com/usbc.htm</a>
</li>

<li>Jan Axelson: USB Mass Storage. Designing and Programming Devices and Embedded Hosts,<br />
<a href="http://www.lvr.com/usbms.htm">http://www.lvr.com/usbms.htm</a>
</li>

<li>NRZ Encoding Definition,<br />
<a href="http://www.interfacebus.com/NRZ_Definition.html">http://www.interfacebus.com/NRZ_Definition.html</a>
</li>

<li>Non-return-to-zero,<br />
<a href="http://en.wikipedia.org/wiki/Non-return-to-zero">http://en.wikipedia.org/wiki/Non-return-to-zero</a>
</li>

<li>Universal Serial Bus - USB Interface,<br />
<a href="http://www.interfacebus.com/Design_Connector_USB.html">http://www.interfacebus.com/Design_Connector_USB.html</a>
</li>

<li>USB.ORG,<br />
<a href="http://www.usb.org/">http://www.usb.org/</a>
</li>

<li>Bit-banging,<br />
<a href="http://en.wikipedia.org/wiki/Bit-banging">http://en.wikipedia.org/wiki/Bit-banging</a>
</li>

<li>List of USB ID's,<br />
<a href="http://www.linux-usb.org/usb.ids">http://www.linux-usb.org/usb.ids</a>
</li>

<li>EUSB to SPI bus Kit,<br />
<a href="http://www.eidusa.com/Electronics_Kits_EUSB_To_SPI_BUS.htm">http://www.eidusa.com/Electronics_Kits_EUSB_To_SPI_BUS.htm</a>
</li>

<li>Basic USB Configuration,<br />
<a href="http://www.linux-usb.org/USB-guide/c122.html#AEN124">http://www.linux-usb.org/USB-guide/c122.html#AEN124</a>
</li>

<li>Linux-USB device overview,<br />
<a href="http://www.qbik.ch/usb/devices/">http://www.qbik.ch/usb/devices/</a>
</li>

<li>USBMan - USB 1, 2, &amp; 3 Help and Information,<br />
<a href="http://www.usbman.com/linuxusb.htm">http://www.usbman.com/linuxusb.htm</a>
</li>

<li>ThinkGeek - Elekronics Gadgets,<br />
<a href="http://www.thinkgeek.com/gadgets/electronic/85b6/">http://www.thinkgeek.com/gadgets/electronic/85b6/</a>
</li>

<li>HID Information,<br />
<a href="http://www.usb.org/developers/hidpage/">http://www.usb.org/developers/hidpage/</a>
</li>

<li>Bit rate,<br />
<a href="http://en.wikipedia.org/wiki/Bit_rate">http://en.wikipedia.org/wiki/Bit_rate</a>
</li>

<li>USB 3.0 vs. FireWire 3200,<br />
<a href="http://www.pcfastlane.com/features/usb-30-vs-firewire-3200/">http://www.pcfastlane.com/features/usb-30-vs-firewire-3200/</a>
</li>

</ol>

<image id="8120" original="no" />
<p-center><i>Obrázek 9: Postupný vývoj pøenosových rychlostí interních sbìrnic,
externí sbìrnice USB a sí»ového rozhraní Ethernet.</i></p-center>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2008</small></p>
</body>
</html>

