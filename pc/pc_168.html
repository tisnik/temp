<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Mikroprocesory ARM a instrukèní sada Thumb</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Mikroprocesory ARM a instrukèní sada Thumb</h1>

<h3>Pavel Ti¹novský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V dne¹ní èásti seriálu o architekturách poèítaèù se budeme zabývat instrukèní sadou Thumb podporovanou u moderních variant mikroprocesorù s architekturou ARM. Zavedením této instrukèní sady se konstruktéøi procesorù ARM sna¾ili o spojení pøedností architektury RISC s vìt¹í &bdquo;hustotou kódu&ldquo; dosahovanou u nìkterých procesorù s&nbsp;architekturou CISC.</p>



<h2>Obsah</h2>

<p><a href="#k01">1. Mikroprocesory ARM a instrukèní sada Thumb</a></p>
<p><a href="#k02">2. Instrukce urèené pro provádìní ALU operací</a></p>
<p><a href="#k03">3. ALU operace pou¾ívající tøíbitovou a osmibitovou konstantu</a></p>
<p><a href="#k04">4. Bitové posuny a rotace</a></p>
<p><a href="#k05">5. Nepodmínìné skoky</a></p>
<p><a href="#k06">6. Podmínìné skoky</a></p>
<p><a href="#k07">7. Podpora pro práci se zásobníkem</a></p>
<p><a href="#k08">8. Instrukce typu Push a Pop</a></p>
<p><a href="#k09">9. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. Mikroprocesory ARM a instrukèní sada Thumb</h2>

<p><a
href="http://www.root.cz/clanky/instrukcni-sada-mikroprocesoru-arm/">V&nbsp;pøedchozí
èásti</a> <a href="http://www.root.cz/serialy/co-se-deje-v-pocitaci/">seriálu o
architekturách poèítaèù</a> jsme si popsali vìt¹inu instrukcí pou¾ívaných u
mikroprocesorù s&nbsp;architekturou <i>ARM</i> ve chvíli, kdy tyto procesory
pracují v&nbsp;takzvaném &bdquo;re¾imu ARM&ldquo;. Pøipomeòme si, ¾e se jedná o
pùvodní re¾im tìchto procesorù, pøi nìm¾ se ideálnì v&nbsp;ka¾dém taktu naète
jedno instrukèní slovo o ¹íøce 32 bitù (výjimku tvoøí pøedev¹ím skoky a takté¾
reakce na pøeru¹ení). Díky takto ¹irokému instrukènímu slovu bylo mo¾né
instrukèní sadu navrhnout tak, aby se v&nbsp;ka¾dé instrukci nacházely ètyøi
podmínkové bity, aby byly aritmetické a logické instrukce tøíadresové
(tj.&nbsp;obsahovaly adresy dvou zdrojových registrù a registru cílového) a
takté¾ to, aby se kromì kódu vlastní operace mohl v&nbsp;instrukcích uvést i
poèet bitù, o nì¾ se má hodnota druhého operandu posunout èi zrotovat
v&nbsp;<i>barrel shifteru</i>. Tato instrukèní sada vycházela z&nbsp;dobových
po¾adavkù a zku¹eností, kdy se po nìkolika nevydaøených projektech se slo¾itými
procesory s&nbsp;architekturou <i>CISC</i> konstruktéøi obrátili opaèným smìrem
a zaèali se zabírat procesory s&nbsp;architekturou, pro ni¾ se pozdìji v¾il
název <i>RISC</i>.</p>

<p>Ov¹em mikroprocesory <i>ARM</i>, které byly pùvodnì navr¾eny pro vyu¾ití
v&nbsp;osobních poèítaèích, se postupnì zaèaly pou¾ívat i v&nbsp;jiných
oblastech, pøedev¹ím ve vestavìných (<i>embedded</i>) systémech, kde vládnou
ponìkud jiné po¾adavky. Ve vestavìných systémech je toti¾ kromì nízké spotøeby,
popø.&nbsp;rychlé reakce na pøeru¹ení, kladen i velký dùraz na to, aby binární
obrazy programù byly co nejmen¹í, proto¾e programy jsou ukládány do pamìtí
ROM/EPROM/EEPROM/Flash s&nbsp;relativnì vysokou cenou za jeden bit a nikoli na
vysokokapacitních pamì»ových médiích (pevné disky) tak, jak je tomu na osobních
poèítaèích. Navíc do¹lo k&nbsp;postupné zmìnì i v&nbsp;oblasti osobních
poèítaèù &ndash; rychlosti procesorù rostly vìt¹ím tempem, ne¾ rychlost pamìtí
DRAM &ndash; co¾ s&nbsp;sebou pøiná¹elo nutnost pou¾ití drahých vyrovnávacích
pamìtí zalo¾ených na technologii SRAM. V&nbsp;jeden okam¾ik se dokonce zdálo,
¾e tento vývoj bude znamenat konec procesorù typu <i>RISC</i>, které jsou
mj.&nbsp;typické i tím, ¾e pou¾ívají instrukèní sady s&nbsp;instrukcemi pevné
¹íøky (asi nejblí¾e se klasické architektuøe <i>RISC</i> v&nbsp;souèasnosti
blí¾í mikroprocesory <i>MIPS</i>, kterými jsme se ji¾ v&nbsp;tomto seriálu
zabývali).</p>

<p>Odpovìdí spoleènosti <i>ARM</i> na obì nové skuteènosti &ndash; po¾adavek na
men¹í velikost binárních obrazù programù a zvy¹ující se rozdíl v&nbsp;rychlosti
CPU a DRAM &ndash; bylo zavedení nové <strong>alternativní</strong> instrukèní
sady nazvané <i>Thumb</i>, v&nbsp;ní¾ mají v¹echny instrukce ¹íøku jen ¹estnáct
bitù, co¾ znamená, ¾e v&nbsp;pamìti urèité kapacity lze ulo¾it pøibli¾nì
dvakrát tolik instrukcí <i>Thumb</i>, nì¾ pùvodních RISCových instrukcí (slovo
&bdquo;pøibli¾nì&ldquo; je zde pou¾ito pøedev¹ím z&nbsp;toho dùvodu, ¾e se
v&nbsp;kódu vyskytují i 32bitové konstanty, nezávisle na pou¾ité instrukèní
sadì). Ov¹em men¹í ¹íøka instrukcí znamenala i urèitá omezení. Zcela zmizely
podmínkové kódy, které zùstaly zachovány jen u instrukce podmínìného skoku.
Takté¾ se mo¾nost pou¾ití <i>barrel shifteru</i> omezila jen na urèitou skupinu
instrukcí. Ov¹em asi nejvìt¹í zmìnou bylo to, ¾e se sada pracovních registrù
<strong>R0-R15</strong> rozdìlila na spodní polovinu <strong>R0-R7</strong>
(<i>Lo registers</i>) a horní polovinu <strong>R8-R15</strong> (<i>Hi
registers</i>), pøièem¾ vìt¹ina instrukcí doká¾e pracovat pouze s&nbsp;prvními
osmi registry, zatímco nìkteré registry z&nbsp;horní skupiny mají speciální
význam (èítaè instrukcí, ukazatel na vrchol zásobníku atd.).</p>



<p><a name="k02"></a></p>
<h2 id="k02">2. Instrukce urèené pro provádìní ALU operací</h2>

<p>Vý¹e zmínìné rozdìlení pracovních registrù na dvì poloviny o rùzných
významech je patrné i na tìch instrukcích, pomocí nich¾ se realizují
aritmetické a logické operace. ©estnáctibitové instrukèní slovo je u tìchto
instrukcí rozdìleno na ètyøi èásti: ¹estibitový prefix mající binární hodnotu
<strong>010000</strong>, ètyøbitový kód aritmetické èi logické operace,
tøíbitový index druhého zdrojového registru <strong>Rs</strong> a takté¾
tøíbitový index prvního zdrojového registru <strong>Rd</strong>, který je
souèasnì i registrem cílovým, tj.&nbsp;registrem, do nìj¾ se ulo¾í výsledek
operace (výjimku tvoøí instrukce komparace a testu, u nich¾ se výsledek
porovnání nikam neukládá). Zde je ostatnì patrné i dal¹í omezení instrukèní
sady <i>Thumb</i>, kdy do úzkého instrukèního slova není mo¾né vlo¾it indexy
tøí registrù, ale pouze registrù dvou, co¾ potenciálnì zvy¹uje èetnost pøesunù
dat mezi registry a navíc se i sni¾uje úèinnost nìkterých optimalizaèních
technik provádìných buï pøímo programátory v&nbsp;assembleru nebo
pøekladaèi:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 1 | 0 | 0 | 0 | 0 |    operace    |    Rs     |    Rd     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Podporováno je celkem ¹estnáct aritmetických a logických operací (+ operací
bitového posunu a rotace) urèených bity 6 a¾ 9 instrukèního slova. Tyto operace
jsou vypsány v&nbsp;tabulce pod tímto odstavcem. Ve tøetím sloupci tabulky je
pro ilustraci uvedena ekvivalentní instrukce dostupná v&nbsp;re¾imu ARM):</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Ekvivalent ARM</th><th>Význam</th></tr>
<tr><td>0000</td><td>AND Rd, Rs</td><td>ANDS Rd, Rd, Rs</td><td>Rd:= Rd AND Rs</td></tr>
<tr><td>0001</td><td>EOR Rd, Rs</td><td>EORS Rd, Rd, Rs</td><td>Rd:= Rd EOR Rs (EOR=XOR)</td></tr>
<tr><td>0010</td><td>LSL Rd, Rs</td><td>MOVS Rd, Rd, LSL Rs</td><td>Rd := Rd &lt;&lt; Rs (bitový posun)</td></tr>
<tr><td>0011</td><td>LSR Rd, Rs</td><td>MOVS Rd, Rd, LSR Rs</td><td>Rd := Rd &gt;&gt; Rs (bitový posun)</td></tr>
<tr><td>0100</td><td>ASR Rd, Rs</td><td>MOVS Rd, Rd, ASR Rs</td><td>Rd := Rd ASR Rs (aritmetický posun)</td></tr>
<tr><td>0101</td><td>ADC Rd, Rs</td><td>ADCS Rd, Rd, Rs</td><td>Rd := Rd + Rs + C-bit</td></tr>
<tr><td>0110</td><td>SBC Rd, Rs</td><td>SBCS Rd, Rd, Rs</td><td>Rd := Rd - Rs - NOT C-bit</td></tr>
<tr><td>0111</td><td>ROR Rd, Rs</td><td>MOVS Rd, Rd, ROR Rs</td><td>Rd := Rd ROR Rs (rotace)</td></tr>
<tr><td>1000</td><td>TST Rd, Rs</td><td>TST Rd, Rs</td><td>Nastavení pøíznakù podle operace Rd AND Rs</td></tr>
<tr><td>1001</td><td>NEG Rd, Rs</td><td>RSBS Rd, Rs, #0</td><td>Rd = -Rs</td></tr>
<tr><td>1010</td><td>CMP Rd, Rs</td><td>CMP Rd, Rs</td><td>Nastavení pøíznakù podle operace Rd - Rs</td></tr>
<tr><td>1011</td><td>CMN Rd, Rs</td><td>CMN Rd, Rs</td><td>Nastavení pøíznakù podle operace Rd + Rs</td></tr>
<tr><td>1100</td><td>ORR Rd, Rs</td><td>ORRS Rd, Rd, Rs</td><td>Rd := Rd OR Rs</td></tr>
<tr><td>1101</td><td>MUL Rd, Rs</td><td>MULS Rd, Rs, Rd</td><td>Rd := Rs * Rd</td></tr>
<tr><td>1110</td><td>BIC Rd, Rs</td><td>BICS Rd, Rd, Rs</td><td>Rd := Rd AND NOT Rs</td></tr>
<tr><td>1111</td><td>MVN Rd, Rs</td><td>MVNS Rd, Rs</td><td>Rd := NOT Rs</td></tr>
</table>



<p><a name="k03"></a></p>
<h2 id="k03">3. ALU operace pou¾ívající tøíbitovou a osmibitovou konstantu</h2>

<p>Instrukèní sada <i>Thumb</i> poskytuje pro vybrané operace i instrukce,
v&nbsp;nich¾ se vyskytuje konstanta, popø.&nbsp;v&nbsp;nich¾ je mo¾né pou¾ít
tøíadresový kód. Tyto instrukce mohou být reprezentovány operaèními slovy tøí
formátù. První formát vypadá následovnì:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 0 | 0 | 1 | 1 | 0 | op|    Rn     |    Rs     |    Rd     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Jak je z&nbsp;vý¹e uvedeného formátu instrukèního slova patrné, je
v&nbsp;nìm pro ulo¾ení kódu operace ponechán pouze jeden bit, ov¹em slovo navíc
obsahuje indexy tøí pracovních registrù: dvou registrù zdrojových a jednoho
registru cílového. Pomocí ji¾ zmínìného jednoho bitu je rozhodnuto, která
aritmetická operace se má provést:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Význam</th></tr>
<tr><td>0</td><td>ADD Rd, Rs, Rn</td><td>Rd:= Rs + Rn</td></tr>
<tr><td>1</td><td>SUB Rd, Rs, Rn</td><td>Rd:= Rs - Rn</td></tr>
</table>

<p>Druhý formát pou¾ívá instrukèní slovo rozdìlené prakticky stejným zpùsobem,
a¾ na ten rozdíl, ¾e se namísto indexu registru <strong>Rn</strong> ve slovì
vyskytuje tøíbitová konstanta vystupující v&nbsp;roli druhého operandu:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 0 | 0 | 1 | 1 | 1 | op|  const.   |    Rs     |    Rd     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Význam bitu èíslo 9 je následující:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Význam</th></tr>
<tr><td>0</td><td>ADD Rd, Rs, #const</td><td>Rd:= Rs + const</td></tr>
<tr><td>1</td><td>SUB Rd, Rs, #const</td><td>Rd:= Rs - const</td></tr>
</table>

<p>V&nbsp;pøípadì, ¾e je nutné v&nbsp;instrukci pou¾ít vìt¹í konstantu, lze
vyu¾ít následující instrukèní formát, v&nbsp;nìm¾ je obsa¾en index pouze
jednoho pracovního registru, ov¹em souèasnì se v&nbsp;instrukèním slovu nachází
i osmibitová konstanta:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 0 | 1 |operace|    Rd     |      osmibitová konstanta     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Tímto instrukèním slovem mohou být reprezentovány ètyøi operace:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Význam</th></tr>
<tr><td>00</td><td>MOV Rd, #const</td><td>Rd:= const</td></tr>
<tr><td>01</td><td>CMP Rd, #const</td><td>Nastavení pøíznakù podle Rd - const</td></tr>
<tr><td>10</td><td>ADD Rd, #const</td><td>Rd:= Rd + const</td></tr>
<tr><td>11</td><td>SUB Rd, #const</td><td>Rd:= Rd - const</td></tr>
</table>

<p>Zajímavé je, ¾e v&nbsp;pøekvapivì velkém poètu pøípadù je pou¾ití
&bdquo;pouze&ldquo; osmibitových konstant dostateèné. Ostatnì se staèí podívat
na reálné programy, v&nbsp;nich¾ se hojnì vyskytují poèítané programové smyèky,
v&nbsp;nich¾ se hodnota poèitadla zvy¹uje o jednièku, v&nbsp;jiných èástech
programu se pracuje s&nbsp;osmibitovými znaky, osmibitovými barvovými slo¾kami
RGB atd.</p>



<p><a name="k04"></a></p>
<h2 id="k04">4. Bitové posuny a rotace</h2>

<p>Ji¾ <a href="#k02">ve druhé kapitole</a> se v&nbsp;tabulce se ¹estnácti
aritmetickými a logickými operacemi vyskytovalo nìkolik operací urèených pro
provádìní bitových posunù a rotací. Ve skuteènosti v¹ak instrukèní sada
<i>Thumb</i> obsahuje pro bitové posuny a rotace je¹tì nìkolik dal¹ích
instrukcí, v&nbsp;jejich¾ instrukèním slovu se mj.&nbsp;nachází i pìtibitová
konstanta udávající poèet bitù, o nì¾ se má hodnota zdrojového registru
posunout. Formát instrukèního slova je v&nbsp;tomto pøípadì následující:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 0 | 0 |operace|      offset       |    Rs     |    Rd     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Kód operace je zapsán ve dvojici bitù s&nbsp;indexy 11 a 12, tak¾e by se
mohlo zdát, ¾e je mo¾né rozli¹it a¾ ètyøi operace. Ve skuteènosti je v¹ak mo¾né
pou¾ít pouze bitové kombinace <strong>00</strong>, <strong>01</strong></p> a
<strong>10</strong>, proto¾e zbývající bitová kombinace <strong>11</strong> je
ji¾ obsazena instrukèním slovem popsaným <a href="#k03">ve tøetí
kapitole</a>:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 0 | 0 | 0 | 1 | 1 | 0 | op|    Rn     |    Rs     |    Rd     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>V&nbsp;následující tabulce jsou v¹echny tøi podporované operace bitového
posunu a rotace s&nbsp;vyu¾itím konstanty vypsány:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Ekvivalent ARM</th><th>Význam</th></tr>
<tr><td>00</td><td>LSL Rd, Rs, #offset</td><td>MOVS Rd, Rs, LSL #offset</td><td>Rd := Rs &lt;&lt; #offset</td></tr>
<tr><td>01</td><td>LSR Rd, Rs, #offset</td><td>MOVS Rd, Rs, LSR #offset</td><td>Rd := Rs &gt;&gt; #offset</td></tr>
<tr><td>10</td><td>ASR Rd, Rs, #offset</td><td>MOVS Rd, Rs, ASR #offset</td><td>Rd := Rs ASR #offset (aritmetický posun)</td></tr>
</table>



<p><a name="k05"></a></p>
<h2 id="k05">5. Nepodmínìné skoky</h2>

<p>V&nbsp;této kapitole si popí¹eme formát instrukcí nepodmínìných skokù.
Základní instrukcí skoku je instrukce <strong>B</strong> (<i>branch</i>), která
má ve svém instrukèním slovu vyhrazeno celých jedenáct bitù pro ulo¾ení offsetu
skoku. Jedná se tedy o relativní skok, který je obecnìj¹í ne¾ skok absolutní
(ov¹em zále¾í i na dal¹ích vlastnostech procesoru a jeho <i>MMU</i>).
Jedenáctibitová konstanta ulo¾ená v&nbsp;instrukci skoku je nejprve posunuta o
jeden bit doleva, proto¾e v¹echny instrukce <i>Thumb</i> musí být
v&nbsp;operaèní pamìti zarovnány na dva bajty. Posléze se vypoètená
dvanáctibitová hodnota pøipoète k&nbsp;obsahu registru <i>PC</i>, který je
ov¹em v&nbsp;dobì výpoètu adresy ji¾ zvý¹en o hodnotu 4 (v&nbsp;pøípadì re¾imu
<i>ARM</i> byl posun roven osmi, zde pouze ètyøem, proto¾e instrukce mají
polovièní ¹íøku):</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 1 | 1 | 1 | 0 | 0 |         jedenáctibitová konstanta         |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Implementaènì zajímavìj¹í je formát instrukce <strong>BL</strong> neboli
<i>branch and link</i>. Ji¾ z&nbsp;pøedchozích èástí tohoto seriálu víme, ¾e
tato instrukce provádí nepodmínìný skok, ov¹em souèasnì ukládá návratovou
adresu do registru nazvaného <strong>LR</strong> (<i>link register</i>):</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 1 | 1 | 1 | 1 | H |         jedenáctibitová konstanta         |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Zajímavost této instrukce spoèívá v&nbsp;tom, ¾e obsah jedenáctibitové
konstanty ulo¾ené v&nbsp;instrukèním slovu je mo¾né zpracovat rozdílným
zpùsobem. Pokud je bit <strong>H</strong> s&nbsp;indexem 11 nastaven na nulu,
je konstanta posunuta o dvanáct bitù doleva a následnì je pøiètena
k&nbsp;obsahu registru <strong>PC</strong>. Výsledek této operace je ulo¾en do
registru <strong>LR</strong>, skok se ov¹em prozatím neprovede. Po této
instrukci následuje instrukce se stejným formátem, ov¹em s&nbsp;bitem
<strong>H</strong> nastaveným na jednièku. V&nbsp;tomto pøípadì se
jedenáctibitová konstanta posune doleva o jeden bit a výsledek této operace je
pøièten k&nbsp;obsahu registru <strong>LR</strong> (nastaveného pøedchozí
operací). Výsledkem je, ¾e registr <strong>LR</strong> nyní obsahuje 23bitovou
adresu, na ní¾ je následnì proveden skok (pøesun do <strong>PC</strong>),
s&nbsp;tím, ¾e do <strong>LR</strong> je souèasnì ulo¾ena i návratová
adresa:</p>

<pre>
LR := PC + (Offset1 &lt;&lt; 12)
PCtemp = PC
PC := LR + (Offset2 &lt; 1)
LR := PCtemp + 2
</pre>



<p><a name="k06"></a></p>
<h2 id="k06">6. Podmínìné skoky</h2>

<p>Samozøejmì nesmíme zapomenout ani na instrukce podmínìného skoku. Formát
instrukèního slova podmínìných skokù se li¹í od formátu uvedeného <a
href="#k05">v&nbsp;pøedchozí kapitole</a>, a to pøedev¹ím z&nbsp;toho dùvodu,
¾e do instrukèního slova je nutné pøidat i kód podmínky, který je ètyøbitový.
Z&nbsp;tohoto dùvodu je offset ulo¾ený pøímo v&nbsp;instrukèním slovu pouze
osmibitový. Vzhledem k&nbsp;tomu, ¾e instrukce jsou v&nbsp;pamìti zarovnány na
sudé adresy, je osmibitový offset pøeètený z&nbsp;instrukèního slova nejprve
posunut o jeden bit doleva, co¾ v&nbsp;praxi znamená mo¾nost skoku
v&nbsp;rozmezí -256 a¾ 254 (s&nbsp;tím, ¾e se pøi skoku ji¾ registr <i>PC</i>
staèil zvý¹it o hodnotu 4), co¾ zhruba znamená, ¾e se mù¾e provést podmínìný
skok o +-120 instrukcí. V&nbsp;praxi se ukazuje, ¾e pro velké mno¾ství
konstrukcí typu <i>if-then-else</i>, popø.&nbsp;pro poèítané smyèky <i>for</i>
i pro nepoèítané smyèky (<i>while</i>, <i>do-while</i>) je tento rozsah
dostaèující. Pokud by bylo nutné provést podmínìný skok na vìt¹í vzdálenost,
musí se vyu¾ít techniky známé i z&nbsp;jiných typù procesorù: provede se krátký
skok s&nbsp;opaènou podmínkou o jednu instrukci (tedy podmínìný
pøeskok/vynechání instrukce &ndash; <i>skip</i>), pøièem¾ tato instrukce je ve
skuteènosti &bdquo;dlouhým&ldquo; nepodmínìným skokem.</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 1 | 1 | 0 | 1 |   podmínka    |      osmibitová konstanta     |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Pomocí bitù 8 a¾ 11 je v&nbsp;instrukèním slovu zakódována podmínka, pøi
jejím¾ splnìní se skok provede:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Význam</th><th>Pøedchozí operace porovnání</th></tr>
<tr><td>0000</td><td>BEQ label</td><td>skok v pøípadì, ¾e Z==1 (rovno)</td><td>signed i unsigned</td></tr>
<tr><td>0001</td><td>BNE label</td><td>skok v pøípadì, ¾e Z==0 (nerovno)</td><td>signed i unsigned</td></tr>
<tr><td>0010</td><td>BCS label</td><td>skok v pøípadì, ¾e C==1 (vìt¹í nebo rovno)</td><td>unsigned</td></tr>
<tr><td>0011</td><td>BCC label</td><td>skok v pøípadì, ¾e C==0 (men¹í ne¾)</td><td>unsigned</td></tr>
<tr><td>0100</td><td>BMI label</td><td>skok v pøípadì, ¾e N==1 (záporný výsledek)</td><td>signed</td></tr>
<tr><td>0101</td><td>BPL label</td><td>skok v pøípadì, ¾e N==0 (kladný nebo nulový výsledek)</td><td>signed</td></tr>
<tr><td>0110</td><td>BVS label</td><td>skok v pøípadì, ¾e V==1 (pøeteèení)</td><td>signed</td></tr>
<tr><td>0111</td><td>BVC label</td><td>skok v pøípadì, ¾e V==0 (nedo¹lo k pøeteèení)</td><td>signed</td></tr>
<tr><td>1000</td><td>BHI label</td><td>skok v pøípadì, ¾e C==1 &amp; Z==0 (vet¹í ne¾)</td><td>unsigned</td></tr>
<tr><td>1001</td><td>BLS label</td><td>skok v pøípadì, ¾e C==0 | Z==1 (men¹í nebo rovno)</td><td>unsigned</td></tr>
<tr><td>1010</td><td>BGE label</td><td>skok v pøípadì, ¾e N==V (vìt¹í nebo rovno)</td><td>signed</td></tr>
<tr><td>1011</td><td>BLT label</td><td>skok v pøípadì, ¾e N!=V (men¹í ne¾)</td><td>signed</td></tr>
<tr><td>1100</td><td>BGT label</td><td>skok v pøípadì, ¾e Z==0 &amp; N==V (vìt¹í ne¾)</td><td>signed</td></tr>
<tr><td>1101</td><td>BLE label</td><td>skok v pøípadì, ¾e Z==1 N!=V (men¹í nebo rovno)</td><td>signed</td></tr>
</table>

<p>Zajisté nebude velkým pøekvapením fakt, ¾e vý¹e uvedené kódy operací
podmínìných skokù jsou shodné s&nbsp;podmínkovými kódy pou¾ívanými
v&nbsp;re¾imu ARM. Bli¾¹í informace o tìchto kódech lze nalézt <a
href="http://www.root.cz/clanky/mikroprocesory-s-architekturou-arm/">v&nbsp;pøedposlední
èásti tohoto seriálu</a>.</p>



<p><a name="k07"></a></p>
<h2 id="k07">7. Podpora pro práci se zásobníkem</h2>

<p>V&nbsp;instrukèní sadì <i>Thumb</i> se nachází i nìkolik typù instrukcí
urèených pro práci s&nbsp;hodnotami ulo¾enými na zásobníku. Jako ukazatel na
vrchol zásobníku se pøitom vyu¾ívá registru <strong>R13</strong>, který se
neformálnì ve stejném významu pou¾ívá i v&nbsp;re¾imu <i>ARM</i> (zde v¹ak jde
pouze o konvenci, nikoli o pou¾ití vynucené instrukèní sadou). Prvním typem
instrukcí pro práci se zásobníkem jsou instrukce umo¾òující pøímo zvý¹it èi
sní¾it obsah <strong>SP/R13</strong> o zadanou konstantu (která je v¹ak nejprve
posunuta o jeden bit doleva):</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 1 | 0 | 1 | 1 | 0 | 0 | 0 | 0 | S |         konstanta         |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Bit <strong>S</strong> s&nbsp;indexem 7 urèuje provádìnou operaci:</p>

<table>
<tr><th>Kód</th><th>Operace</th><th>Význam</th></tr>
<tr><td>0</td><td>ADD SP, #const</td><td>SP := SP + #const</td></tr>
<tr><td>1</td><td>ADD SP, #-const</td><td>SP := SP - #const</td></tr>
</table>



<p><a name="k08"></a></p>
<h2 id="k08">8. Instrukce typu Push a Pop</h2>

<p>Druhým typem instrukcí urèených pro práci se zásobníkem jsou instrukce typu
<i>push</i> a <i>pop</i>, které mohou v&nbsp;pøípadì instrukèní sady
<i>Thumb</i> pracovat nikoli pouze s&nbsp;jediným registrem, ale
s&nbsp;libovolnou kombinací v¹ech osmi ni¾¹ích pracovních registrù
<strong>R0-R7</strong> (èeho¾ lze mnohdy vyu¾ít pro efektivní volání subrutin
atd.). Formát instrukcí <i>push</i> a <i>pop</i> je následující:</p>

<pre>
 15  14  13  12  11  10   9   8   7   6   5   4   3   2   1   0
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
| 1 | 0 | 1 | 1 | L | 1 | 0 | R |        seznam registrù        |
+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
</pre>

<p>Jak je z&nbsp;vý¹e uvedeného formátu instrukcí <i>push</i> a <i>pop</i>
patrné, obsahuje instrukèní slovo nìkolik konstantních bitù, dále pak bit
<strong>L</strong> s&nbsp;indexem 11, bit <strong>R</strong> s&nbsp;indexem osm
a koneènì bitové pole reprezentované bity s&nbsp;indexy 0 a¾ 7. V&nbsp;tomto
bitovém poli je urèeno, kterých pracovních registrù se bude operace <i>push</i>
èi <i>pop</i> týkat. Lze zapsat libovolnou kombinaci a samozøejmì není nutné,
aby operace <i>push</i> a <i>pop</i> probíhaly nad stejnými registry (je to
podobné, jako u instrukcí <strong>LDM</strong> a <strong>STM</strong>
pou¾ívaných v&nbsp;re¾imu <i>ARM</i>). Význam bitu <strong>L</strong> spoèívá
v&nbsp;tom, ¾e se pomocí nìho rozli¹uje, která operace se provede:</p>

<table>
<tr><th>Bit L</th><th>Operace</th></tr>
<tr><td>0</td><td>PUSH registry</td></tr>
<tr><td>1</td><td>POP registry</td></tr>
</table>

<p>Zbývá nám popsat význam bitu <strong>R</strong>. Ten vlastnì roz¹iøuje
bitové pole o registr <strong>LR</strong> (<i>link register</i>)
resp.&nbsp;<strong>PC</strong> (<i>program counter</i>). Pokud je tento bit
nastaven, týká se vybraná operace jak pracovních registrù (zapsaných
v&nbsp;bitovém poli), tak i registru <strong>LR</strong> v&nbsp;pøípadì operace
<strong>PUSH</strong>, popø.&nbsp;registru <strong>PC</strong> v&nbsp;pøípadì
operace <strong>POP</strong>. Význam je zøejmý &ndash; tímto zpùsobem lze
relativnì snadno implementovat inicializaci subrutiny (s&nbsp;ulo¾ením
návratové hodnoty na zásobník) i návrat ze subrutiny:</p>

<table>
<tr><th>Bit L</th><th>Bit R</th><th>Operace</th></tr>
<tr><td>0</td><td>0</td><td>PUSH registry</td></tr>
<tr><td>1</td><td>0</td><td>POP registry</td></tr>
<tr><td>0</td><td>1</td><td>PUSH LR, PUSH registry</td></tr>
<tr><td>1</td><td>1</td><td>POP registry, POP PC (tj.&nbsp;skok)</td></tr>
</table>



<p><a name="k09"></a></p>
<h2 id="k09">9. Odkazy na Internetu</h2>

<ol>

<li>Introduction to ARM thumb<br />
<a href="http://www.eetimes.com/discussion/other/4024632/Introduction-to-ARM-thumb">http://www.eetimes.com/discussion/other/4024632/Introduction-to-ARM-thumb</a>
</li>

<li>ARM, Thumb, and ThumbEE instruction sets<br />
<a href="http://www.keil.com/support/man/docs/armasm/armasm_CEGBEIJB.htm">http://www.keil.com/support/man/docs/armasm/armasm_CEGBEIJB.htm</a>
</li>

<li>An Introduction to ARM Assembly Language<br />
<a href="http://dev.emcelettronica.com/introduction-to-arm-assembly-language">http://dev.emcelettronica.com/introduction-to-arm-assembly-language</a>
</li>

<li>Processors - ARM<br />
<a href="http://www.arm.com/products/processors/index.php">http://www.arm.com/products/processors/index.php</a>
</li>

<li>The ARM Instruction Set<br />
<a href="http://simplemachines.it/doc/arm_inst.pdf">http://simplemachines.it/doc/arm_inst.pdf</a>
</li>

<li>ARM Architecture (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/ARM_architecture">http://en.wikipedia.org/wiki/ARM_architecture</a>
</li>

<li>BBC BASIC<br />
<a href="http://www.bbcbasic.co.uk/bbcbasic.html">http://www.bbcbasic.co.uk/bbcbasic.html</a>
</li>

<li>BBC BASIC<br />
<a href="http://mdfs.net/Software/BBCBasic/">http://mdfs.net/Software/BBCBasic/</a>
</li>

<li>BBC BASIC (Z80) for the ZX Spectrum<br />
<a href="http://mdfs.net/Software/BBCBasic/Spectrum/">http://mdfs.net/Software/BBCBasic/Spectrum/</a>
</li>

<li>BBC BASIC (Wikipedia CZ)<br />
<a href="http://en.wikipedia.org/wiki/BBC_BASIC">http://en.wikipedia.org/wiki/BBC_BASIC</a>
</li>

<li>MIPS-3D(r) ASE<br />
<a href="http://www.mips.com/products/architectures/mips-3d-ase/">http://www.mips.com/products/architectures/mips-3d-ase/</a>
</li>

<li>An introduction to SPARC's SIMD offerings<br />
<a href="http://mikeburrell.wordpress.com/2007/12/14/an-introduction-to-sparcs-simd-offerings/">http://mikeburrell.wordpress.com/2007/12/14/an-introduction-to-sparcs-simd-offerings/</a>
</li>

<li>MIPS64<sup>TM</sup> Architecture for Programmers Volume IV-c: The MIPS-3D<sup>TM</sup> Application-Specific Extension to the MIPS64<sup>TM</sup><br />
<a href="http://www.weblearn.hs-bremen.de/risse/RST/docs/MIPS/MD00099-2B-MIPS3D64-AFP-01.11.pdf">http://www.weblearn.hs-bremen.de/risse/RST/docs/MIPS/MD00099-2B-MIPS3D64-AFP-01.11.pdf</a>
</li>

<li>Visual Instruction Set<br />
<a href="http://www.enotes.com/topic/Visual_Instruction_Set">http://www.enotes.com/topic/Visual_Instruction_Set</a>
</li>

<li>NEON<br />
<a href="http://www.arm.com/products/processors/technologies/neon.php">http://www.arm.com/products/processors/technologies/neon.php</a>
</li>

<li>Architecture and Implementation of the ARM Cortex-A8 Microprocessor<br />
<a href="http://www.design-reuse.com/articles/11580/architecture-and-implementation-of-the-arm-cortex-a8-microprocessor.html">http://www.design-reuse.com/articles/11580/architecture-and-implementation-of-the-arm-cortex-a8-microprocessor.html</a>
</li>

<li>Multimedia Acceleration eXtensions (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Multimedia_Acceleration_eXtensions">http://en.wikipedia.org/wiki/Multimedia_Acceleration_eXtensions</a>
</li>

<li>AltiVec (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/AltiVec">http://en.wikipedia.org/wiki/AltiVec</a>
</li>

<li>Visual Instruction Set (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Visual_Instruction_Set">http://en.wikipedia.org/wiki/Visual_Instruction_Set</a>
</li>

<li>MAJC (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MAJC">http://en.wikipedia.org/wiki/MAJC</a>
</li>

<li>MDMX (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MDMX">http://en.wikipedia.org/wiki/MDMX</a>
</li>

<li>MIPS Multiply Unit<br />
<a href="http://programmedlessons.org/AssemblyTutorial/Chapter-14/ass14_3.html">http://programmedlessons.org/AssemblyTutorial/Chapter-14/ass14_3.html</a>
</li>

<li>Silicon Graphics Introduces Enhanced MIPS Architecture<br />
<a href="http://bwrc.eecs.berkeley.edu/CIC/otherpr/enhanced_mips.html">http://bwrc.eecs.berkeley.edu/CIC/otherpr/enhanced_mips.html</a>
</li>

<li>MIPS-3D (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/MIPS-3D">http://en.wikipedia.org/wiki/MIPS-3D</a>
</li>

<li>MIPS Technologies, Inc. announces new MIPS-3D technology to provide silicon-efficient 3D graphics acceleration<br />
<a href="http://www.design-reuse.com/news/2057/mips-mips-3d-technology-silicon-efficient-3d-graphics-acceleration.html">http://www.design-reuse.com/news/2057/mips-mips-3d-technology-silicon-efficient-3d-graphics-acceleration.html</a>
</li>

<li>MIPS-3D Built-in Function (gcc.gnu.org)<br />
<a href="http://gcc.gnu.org/onlinedocs/gcc/MIPS_002d3D-Built_002din-Functions.html">http://gcc.gnu.org/onlinedocs/gcc/MIPS_002d3D-Built_002din-Functions.html</a>
</li>

<li>Baha Guclu Dundar:<br />
Intel MMX, SSE, SSE2, SSE3/SSSE3/SSE4 Architectures
</li>

<li>SSE (Streaming SIMD Extentions)<br />
<a href="http://www.songho.ca/misc/sse/sse.html">http://www.songho.ca/misc/sse/sse.html</a>
</li>

<li>Timothy A. Chagnon: SSE and SSE2<br />
<a href="http://www.cs.drexel.edu/~tc365/mpi-wht/sse.pdf">http://www.cs.drexel.edu/~tc365/mpi-wht/sse.pdf</a>
</li>

<li>Intel corporation: Extending the Worldr's Most Popular Processor Architecture<br />
<a href="http://download.intel.com/technology/architecture/new-instructions-paper.pdf">http://download.intel.com/technology/architecture/new-instructions-paper.pdf</a>
</li>

<li>SIMD architectures:<br />
<a href="http://arstechnica.com/old/content/2000/03/simd.ars/">http://arstechnica.com/old/content/2000/03/simd.ars/</a>

<li>Intel MMX<sup>TM</sup> Technology Overview<br />
Intel corporation, 1996</li>

<li>MultiMedia eXtensions<br />
<a href="http://softpixel.com/~cwright/programming/simd/mmx.php">http://softpixel.com/~cwright/programming/simd/mmx.php</a>i
</li>

<li>AMD K5 ("K5" / "5k86")<br />
<a href="http://www.pcguide.com/ref/cpu/fam/g5K5-c.html">http://www.pcguide.com/ref/cpu/fam/g5K5-c.html</a>
</li>

<li>Sixth Generation Processors<br />
<a href="http://www.pcguide.com/ref/cpu/fam/g6.htm">http://www.pcguide.com/ref/cpu/fam/g6.htm</a>
</li>

<li>Great Microprocessors of the Past and Present<br />
<a href="http://www.cpushack.com/CPU/cpu1.html">http://www.cpushack.com/CPU/cpu1.html</a>
</li>

<li>Very long instruction word (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Very_long_instruction_word">http://en.wikipedia.org/wiki/Very_long_instruction_word</a>
</li>

<li>Tour of the Black Holes of Computing!: Floating Point<br />
<a href="http://www.cs.hmc.edu/~geoff/classes/hmc.cs105.../slides/class02_floats.ppt">http://www.cs.hmc.edu/~geoff/classes/hmc.cs105.../slides/class02_floats.ppt</a>
</li>

<li>3Dnow! Technology Manual<br />
AMD Inc., 2000</li>
</li>

<li>CPU design (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/CPU_design">http://en.wikipedia.org/wiki/CPU_design</a>
</li>

<li>Control unit (Wikipedia)<br />
<a href="http://en.wikipedia.org/wiki/Control_unit">http://en.wikipedia.org/wiki/Control_unit</a>
</li>

<li>Cray History<br />
<a href="http://www.cray.com/About/History.aspx?404;http://www.cray.com:80/about_cray/history.html">http://www.cray.com/About/History.aspx?404;http://www.cray.com:80/about_cray/history.html</a>
</li>

<li>Cray Historical Timeline<br />
<a href="http://www.cray.com/Assets/PDF/about/CrayTimeline.pdf">http://www.cray.com/Assets/PDF/about/CrayTimeline.pdf</a>
</li>

<li>Computer Speed Claims 1980 to 1996<br />
<a href="http://homepage.virgin.net/roy.longbottom/mips.htm">http://homepage.virgin.net/roy.longbottom/mips.htm</a>
</li>

<li>Superpoèítaèe Cray<br />
<a href="http://www.root.cz/clanky/superpocitace-cray/">http://www.root.cz/clanky/superpocitace-cray/</a>
</li>

<li>Superpoèítaèe Cray (druhá èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-druha-cast/">http://www.root.cz/clanky/superpocitace-cray-druha-cast/</a>
</li>

<li>Superpoèítaèe Cray (tøetí èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-treti-cast/">http://www.root.cz/clanky/superpocitace-cray-treti-cast/</a>
</li>

<li>Superpoèítaèe Cray (ètvrtá èást)<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-ctvrta-cast/">http://www.root.cz/clanky/superpocitace-cray-ctvrta-cast/</a>
</li>

<li>Superpoèítaèe Cray (pátá èást): architektura Cray X-MP<br />
<a href="http://www.root.cz/clanky/superpocitace-cray-pata-cast-architektura-pocitace-cray-x-mp-a-jeho-pouziti-ve-filmovem-prumyslu/">http://www.root.cz/clanky/superpocitace-cray-pata-cast-architektura-pocitace-cray-x-mp-a-jeho-pouziti-ve-filmovem-prumyslu/</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Ti¹novský</a> &nbsp; 2012</small></p>
</body>
</html>

