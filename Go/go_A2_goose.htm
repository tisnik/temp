<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title>Migrace databázového schématu v ekosystému programovacího jazyka Go</title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1>Migrace databázového schématu v ekosystému programovacího jazyka Go</h1>

<h3>Pavel Tišnovský</h3>

<p></p>

<h1>Úvodník</h1>

<p></p>



<h2>Obsah</h2>

<p><a href="#k01">1. Migrace databázového schématu v&nbsp;ekosystému programovacího jazyka Go</a></p>
<p><a href="#k02">2. Balíček <strong>github.com/pressly/goose</strong></a></p>
<p><a href="#k03">3. Instalace balíčku Goose</a></p>
<p><a href="#k04">4. Kontrola instalace nástroje Goose</a></p>
<p><a href="#k05">*** 5. Vytvoření migračního skriptu s&nbsp;příkazem pro vytvoření tabulky</a></p>
<p><a href="#k06">*** 6. Inicializace databáze</a></p>
<p><a href="#k07">*** 7. Provedení migrace nástrojem <i>goose</i></a></p>
<p><a href="#k08">*** 8. Návrat zpět</a></p>
<p><a href="#k09">*** 9. Vícekroková migrace</a></p>
<p><a href="#k10">*** 10. Povýšení nebo naopak snížení schématu databáze na zvolenou verzi</a></p>
<p><a href="#k11">*** 11. </a></p>
<p><a href="#k12">*** 12. </a></p>
<p><a href="#k13">*** 13. </a></p>
<p><a href="#k14">*** 14. </a></p>
<p><a href="#k15">*** 15. </a></p>
<p><a href="#k16">*** 16. </a></p>
<p><a href="#k17">*** 17. </a></p>
<p><a href="#k18">*** 18. </a></p>
<p><a href="#k19">*** 19. Repositář s&nbsp;demonstračními příklady</a></p>
<p><a href="#k20">20. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. Migrace databázového schématu v&nbsp;ekosystému programovacího jazyka Go</h2>

<p>V&nbsp;prakticky každé aplikaci, komplexní službě nebo naopak mikroslužbě,
která ukládá data do relační databáze, je nutné nějakým způsobem řešit
problematiku <i>migrací</i> této databáze na nové schéma popř.&nbsp;naopak
migrací zpět na starší schéma (a to v&nbsp;naprosté většině případů zahrnuje i
migraci dat, která jsou již v&nbsp;databázi uložena). Pro tyto účely již bylo
vytvořeno poměrně velké množství nástrojů. Příkladem takového nástroje
aplikovaného především v&nbsp;ekosystému programovacího jazyka Python je
nástroj nazvaný <a
href="https://alembic.sqlalchemy.org/en/latest/">Alembic</a>, jenž byl vytvořen
autory známého a dosti často používaného databázového toolkitu <a
href="https://www.sqlalchemy.org/">SQLAlchemy</a>.</p>

*** image ***
<p><i>Obrázek 1: Logo databázového toolkitu SQLAlchemy.</i></p>

<p>V&nbsp;dnešním článku se ovšem zaměříme na ekosystém <a
href="https://www.root.cz/serialy/programovaci-jazyk-go/">programovacího jazyka
Go</a>. I pro Go pochopitelně existují nástroje zajišťující migraci databáze.
S&nbsp;jedním z&nbsp;těchto nástrojů, který se jmenuje <i>Goose</i>, se
seznámíme v&nbsp;dnešním článku. A v&nbsp;článku navazujícím se pak podíváme na
nástroj s&nbsp;všeříkajícím názvem <i>Migrate</i> (ten je opět určený pro Go a
v&nbsp;mnohém se podobá nástroji Goose).</p>



<p><a name="k02"></a></p>
<h2 id="k02">2. Balíček <strong>github.com/pressly/goose</strong></h2>

<p>Jak již bylo napsáno <a href="#k01">v&nbsp;úvodní kapitole</a>, slouží
nástroj Goose k&nbsp;podpoře migrace databázového schématu a dat. Určen je
primárně pro použití s&nbsp;relačními databázemi, mezi nimiž nechybí
PostgreSQL, MySQL či SQLite. Jednotlivé kroky migrace &ndash; ty jsou
pochopitelně verzovány &ndash; přitom mohou obsahovat jak krok nutný pro
povýšení schématu o jeden krok, tak i o jeho snížení o jeden krok. Tím pádem
může být zajištěna situace, kdy je nutné migraci vrátit o krok či o více kroků
zpět (což se v&nbsp;našem konkrétním případě stalo několikrát).  Jednotlivé
kroky migrace přitom mohou být zapsány přímo v&nbsp;programovacím jazyku Go,
což na jednu stranu může vypadat poněkud zvláštně, ovšem umožňuje nám to
například import číselníků z&nbsp;různých souborových formátů atd.</p>

<p>Goose podporuje migraci většího množství databází (pokud má k&nbsp;dispozici
příslušné ovladače), například:</p>

<ul>
<li>postgres</li>
<li>mysql</li>
<li>sqlite3</li>
<li>mssql</li>
<li>redshift</li>
<li>tidb</li>
<li>clickhouse</li>
<li>vertica</li>
</ul>



<p><a name="k03"></a></p>
<h2 id="k03">3. Instalace balíčku Goose</h2>

<p>Samotná instalace balíčku Goose je snadná. Předpokladem pochopitelně je, že
máte nainstalovány a nakonfigurovány základní nástroje programovacího jazyka
Go:</p>

<pre>
$ <strong>go install github.com/pressly/goose/v3/cmd/goose@latest</strong>
</pre>

<p>Goose má poměrně velké množství závislostí, což je patrné
z&nbsp;následujícího výpisu:</p>

<pre>
go: downloading github.com/pressly/goose v2.7.0+incompatible
go: downloading github.com/pressly/goose/v3 v3.10.0
go: downloading github.com/go-sql-driver/mysql v1.7.0
go: downloading github.com/denisenkom/go-mssqldb v0.12.3
go: downloading github.com/ClickHouse/clickhouse-go/v2 v2.7.0
go: downloading github.com/jackc/pgx/v4 v4.18.1
go: downloading github.com/vertica/vertica-sql-go v1.3.1
go: downloading github.com/ziutek/mymysql v1.5.4
go: downloading modernc.org/sqlite v1.21.0
go: downloading github.com/jackc/pgconn v1.14.0
go: downloading github.com/jackc/pgtype v1.14.0
go: downloading github.com/jackc/pgio v1.0.0
go: downloading github.com/jackc/pgproto3/v2 v2.3.2
go: downloading github.com/ClickHouse/ch-go v0.53.0
go: downloading github.com/andybalholm/brotli v1.0.5
go: downloading github.com/pkg/errors v0.9.1
go: downloading go.opentelemetry.io/otel/trace v1.14.0
go: downloading github.com/golang-sql/civil v0.0.0-20220223132316-b832511892a9
go: downloading github.com/golang-sql/sqlexp v0.1.0
go: downloading golang.org/x/crypto v0.7.0
go: downloading github.com/jackc/chunkreader/v2 v2.0.1
go: downloading github.com/jackc/pgpassfile v1.0.0
go: downloading github.com/jackc/pgservicefile v0.0.0-20221227161230-091c0ba34f0a
go: downloading go.opentelemetry.io/otel v1.14.0
go: downloading golang.org/x/text v0.8.0
go: downloading github.com/google/uuid v1.3.0
go: downloading github.com/paulmach/orb v0.9.0
go: downloading github.com/shopspring/decimal v1.3.1
go: downloading gopkg.in/yaml.v3 v3.0.1
go: downloading github.com/go-faster/city v1.0.1
go: downloading github.com/go-faster/errors v0.6.1
go: downloading github.com/klauspost/compress v1.16.0
go: downloading github.com/pierrec/lz4/v4 v4.1.17
go: downloading github.com/segmentio/asm v1.2.0
go: downloading github.com/elastic/go-sysinfo v1.9.0
go: downloading golang.org/x/sys v0.6.0
go: downloading github.com/joeshaw/multierror v0.0.0-20140124173710-69b34d4ec901
go: downloading howett.net/plist v1.0.0
go: downloading github.com/prometheus/procfs v0.9.0
go: downloading modernc.org/libc v1.22.3
go: downloading github.com/mattn/go-isatty v0.0.17
go: downloading github.com/dustin/go-humanize v1.0.1
go: downloading modernc.org/mathutil v1.5.0
go: downloading modernc.org/memory v1.5.0
go: downloading github.com/remyoudompheng/bigfft v0.0.0-20230129092748-24d4a6f8daec
</pre>



<p><a name="k04"></a></p>
<h2 id="k04">4. Kontrola instalace nástroje Goose</h2>

<p>Po instalaci se přesvědčíme, do jakého adresáře byl nástroj Goose
nainstalován (tento adresář by měl být uložen na <strong>$PATH</strong>, jak je
to obvyklé):</p>

<pre>
$ <strong>whereis goose</strong>
&nbsp;
goose: /home/ptisnovs/go/bin/goose
</pre>

<p>A nakonec se přesvědčíme, zda je možné Goose spustit:</p>

<pre>
$ <strong>goose</strong>
&nbsp;
Usage: goose [OPTIONS] DRIVER DBSTRING COMMAND
&nbsp;
or
&nbsp;
Set environment key
GOOSE_DRIVER=DRIVER
GOOSE_DBSTRING=DBSTRING
&nbsp;
Usage: goose [OPTIONS] COMMAND
&nbsp;
Drivers:
    postgres
    mysql
    sqlite3
    mssql
    redshift
    tidb
    clickhouse
    vertica
&nbsp;
Examples:
    goose sqlite3 ./foo.db status
    goose sqlite3 ./foo.db create init sql
    goose sqlite3 ./foo.db create add_some_column sql
    goose sqlite3 ./foo.db create fetch_user_data go
    goose sqlite3 ./foo.db up
&nbsp;
    goose postgres "user=postgres dbname=postgres sslmode=disable" status
    goose mysql "user:password@/dbname?parseTime=true" status
    goose redshift "postgres://user:password@qwerty.us-east-1.redshift.amazonaws.com:5439/db" status
    goose tidb "user:password@/dbname?parseTime=true" status
    goose mssql "sqlserver://user:password@dbname:1433?database=master" status
    goose clickhouse "tcp://127.0.0.1:9000" status
    goose vertica "vertica://user:password@localhost:5433/dbname?connection_load_balance=1" status
&nbsp;
    GOOSE_DRIVER=sqlite3 GOOSE_DBSTRING=./foo.db goose status
    GOOSE_DRIVER=sqlite3 GOOSE_DBSTRING=./foo.db goose create init sql
    GOOSE_DRIVER=postgres GOOSE_DBSTRING="user=postgres dbname=postgres sslmode=disable" goose status
    GOOSE_DRIVER=mysql GOOSE_DBSTRING="user:password@/dbname" goose status
    GOOSE_DRIVER=redshift GOOSE_DBSTRING="postgres://user:password@qwerty.us-east-1.redshift.amazonaws.com:5439/db" goose status
&nbsp;
Options:
&nbsp;
  -allow-missing
        applies missing (out-of-order) migrations
  -certfile string
        file path to root CA's certificates in pem format (only support on mysql)
  -dir string
        directory with migration files (default ".")
  -h    print help
  -no-color
        disable color output (NO_COLOR env variable supported)
  -no-versioning
        apply migration commands with no versioning, in file order, from directory pointed to
  -s    use sequential numbering for new migrations
  -ssl-cert string
        file path to SSL certificates in pem format (only support on mysql)
  -ssl-key string
        file path to SSL key in pem format (only support on mysql)
  -table string
        migrations table name (default "goose_db_version")
  -v    enable verbose mode
  -version
        print version
&nbsp;
Commands:
    up                   Migrate the DB to the most recent version available
    up-by-one            Migrate the DB up by 1
    up-to VERSION        Migrate the DB to a specific VERSION
    down                 Roll back the version by 1
    down-to VERSION      Roll back to a specific VERSION
    redo                 Re-run the latest migration
    reset                Roll back all migrations
    status               Dump the migration status for the current DB
    version              Print the current version of the database
    create NAME [sql|go] Creates new migration file with the current timestamp
    fix                  Apply sequential ordering to migrations
</pre>



<p><a name="k05"></a></p>
<h2 id="k05">5. Vytvoření migračního skriptu s&nbsp;příkazem pro vytvoření tabulky</h2>

<pre>
$ <strong>goose create users sql</strong>
&nbsp;
2023/07/08 11:39:41 Created new file: 20230708113941_users.sql
</pre>

<pre>
-- +goose Up
-- +goose StatementBegin
SELECT 'up SQL query';
-- +goose StatementEnd
&nbsp;
-- +goose Down
-- +goose StatementBegin
SELECT 'down SQL query';
-- +goose StatementEnd
</pre>

<pre>
-- +goose Up
-- +goose StatementBegin
CREATE TABLE users (
    id      INTEGER NOT NULL,
    name    VARCHAR NOT NULL,
    surname VARCHAR NOT NULL,
    PRIMARY KEY (id)
-- +goose StatementEnd

-- +goose Down
-- +goose StatementBegin
DROP TABLE users;
-- +goose StatementEnd
</pre>



<p><a name="k06"></a></p>
<h2 id="k06">6. Výchozí stav databáze</h2>

<pre>
$ goose sqlite3 ./test.db status
&nbsp;
2023/07/08 11:45:45     Applied At                  Migration
2023/07/08 11:45:45     =======================================
2023/07/08 11:45:45     Pending                  -- 20230708113941_users.sql
</pre>



<p><a name="k07"></a></p>
<h2 id="k07">7. Provedení migrace nástrojem <i>goose</i></h2>

<pre>
$ <strong>goose sqlite3 ./test.db up</strong>
&nbsp;
2023/07/08 11:46:59 OK   20230708113941_users.sql (3.61ms)
2023/07/08 11:46:59 goose: no migrations to run. current version: 20230708113941
</pre>

<pre>
$ <strong>sqlite3 test.db</strong>
&nbsp;
SQLite version 3.31.1 2020-01-27 19:55:54
Enter ".help" for usage hints.
sqlite&gt;
</pre>

<pre>
sqlite&gt; <strong>.tables</strong>
&nbsp;
goose_db_version  users           
</pre>

sqlite&gt; <strong>.schema goose_db_version </strong>
&nbsp;
CREATE TABLE goose_db_version (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                version_id INTEGER NOT NULL,
                is_applied INTEGER NOT NULL,
                tstamp TIMESTAMP DEFAULT (datetime('now'))
            );

sqlite&gt; <strong>.schema users</strong>
&nbsp;
CREATE TABLE users (
    id      INTEGER NOT NULL,
    name    VARCHAR NOT NULL,
    surname VARCHAR NOT NULL,
    PRIMARY KEY (id)
);

<pre>
sqlite&gt; <strong>select * from goose_db_version ;</strong>
&nbsp;
1|0|1|2023-07-08 09:46:57
2|20230708113941|1|2023-07-08 09:46:59
</pre>



<p><a name="k08"></a></p>
<h2 id="k08">8. Návrat zpět</h2>

<p></p>

<pre>
$ <strong>goose sqlite3 ./test.db down</strong>
&nbsp;
2023/07/08 11:50:43 OK   20230708113941_users.sql (1.7ms)
</pre>

<p></p>

<pre>
$ <strong>sqlite3 test.db </strong>
&nbsp;
SQLite version 3.31.1 2020-01-27 19:55:54
Enter ".help" for usage hints.
</pre>

<p></p>

<pre>
sqlite&gt; <strong>.tables</strong>
goose_db_version
&nbsp;
sqlite&gt; select * from goose_db_version ;
1|0|1|2023-07-08 09:46:57
</pre>



<p><a name="k09"></a></p>
<h2 id="k09">9. Vícekroková migrace</h2>

<pre>
$ <strong>goose create role-column sql</strong>
&nbsp;
2023/07/08 11:55:39 Created new file: 20230708115539_role_column.sql
</pre>

<pre>
-- +goose Up
-- +goose StatementBegin
ALTER TABLE users ADD COLUMN role VARCHAR;
-- +goose StatementEnd
&nbsp;
-- +goose Down
-- +goose StatementBegin
ALTER TABLE users DROP COLUMN role;
-- +goose StatementEnd
</pre>

<pre>
$ <strong>goose sqlite3 ./test.db status</strong>
&nbsp;
2023/07/08 11:58:30     Applied At                  Migration
2023/07/08 11:58:30     =======================================
2023/07/08 11:58:30     Pending                  -- 20230708113941_users.sql
2023/07/08 11:58:30     Pending                  -- 20230708115539_role_column.sql
</pre>

<pre>
$ <strong>goose sqlite3 ./test.db up</strong>
&nbsp;
2023/07/08 11:58:34 OK   20230708113941_users.sql (10ms)
2023/07/08 11:58:34 OK   20230708115539_role_column.sql (477.42µs)
2023/07/08 11:58:34 goose: no migrations to run. current version: 20230708115539
</pre>

<pre>
sqlite&gt; <strong>.schema users</strong>
&nbsp;
CREATE TABLE users (
    id      INTEGER NOT NULL,
    name    VARCHAR NOT NULL,
    surname VARCHAR NOT NULL,
    role    VARCHAR,
    PRIMARY KEY (id)
);
</pre>



<p><a name="k10"></a></p>
<h2 id="k10">10. Povýšení nebo naopak snížení schématu databáze na zvolenou verzi</h2>

<pre>
$ <strong>goose sqlite3 ./test.db down-to 20230708113941</strong>
&nbsp;
2023/07/08 12:02:58 OK   20230708115539_role_column.sql (7.95ms)
2023/07/08 12:02:58 goose: no migrations to run. current version: 20230708113941
</pre>

<pre>
$ <strong>sqlite3 test.db</strong>
&nbsp;
SQLite version 3.31.1 2020-01-27 19:55:54
Enter ".help" for usage hints.
&nbsp;
sqlite&gt; <strong>.schema users</strong>
&nbsp;
CREATE TABLE users (
    id      INTEGER NOT NULL,
    name    VARCHAR NOT NULL,
    surname VARCHAR NOT NULL,
    PRIMARY KEY (id)
);
</pre>



<p><a name="k11"></a></p>
<h2 id="k11">11. </h2>



<p><a name="k12"></a></p>
<h2 id="k12">12. </h2>



<p><a name="k13"></a></p>
<h2 id="k13">13. </h2>



<p><a name="k14"></a></p>
<h2 id="k14">14. </h2>



<p><a name="k15"></a></p>
<h2 id="k15">15. </h2>



<p><a name="k16"></a></p>
<h2 id="k16">16. </h2>



<p><a name="k17"></a></p>
<h2 id="k17">17. </h2>



<p><a name="k18"></a></p>
<h2 id="k18">18. </h2>



<p><a name="k19"></a></p>
<h2 id="k19">19. Repositář s&nbsp;demonstračními příklady</h2>

<p>Zdrojové kódy všech dnes použitých demonstračních příkladů naprogramovaných
v&nbsp;jazyku Go byly uloženy do Git repositáře, který je dostupný na adrese <a
href="https://github.com/tisnik/go-root">https://github.com/tisnik/go-root</a>.
V&nbsp;případě, že nebudete chtít klonovat celý repositář, můžete namísto toho
použít odkazy na jednotlivé demonstrační příklady, které naleznete
v&nbsp;následující tabulce:</p>

<table>
<tr><th> #</th><th>Příklad/soubor</th><th>Stručný popis</th><th>Cesta</th></tr>
<tr><td> 1</td><td></td><td></td><td><a href="https://github.com/tisnik/go-root/blob/master/article_A2/">https://github.com/tisnik/go-root/blob/master/article_A2/</a></td></tr>
<tr><td> 2</td><td></td><td></td><td><a href="https://github.com/tisnik/go-root/blob/master/article_A2/">https://github.com/tisnik/go-root/blob/master/article_A2/</a></td></tr>
<tr><td> 3</td><td></td><td></td><td><a href="https://github.com/tisnik/go-root/blob/master/article_A2/">https://github.com/tisnik/go-root/blob/master/article_A2/</a></td></tr>
</table>



<p><a name="k20"></a></p>
<h2 id="k20">20. Odkazy na Internetu</h2>

<ol>

<li>goose: a database migration tool<br />
<a href="https://github.com/pressly/goose">https://github.com/pressly/goose</a>
</li>

<li>Alembic na PyPi<br />
<a href="https://pypi.org/project/alembic/">https://pypi.org/project/alembic/</a>
</li>

<li>Welcome to Alembic’s documentation!<br />
<a href="https://alembic.sqlalchemy.org/en/latest/">https://alembic.sqlalchemy.org/en/latest/</a>
</li>

<li>The Python SQL Toolkit and Object Relational Mapper<br />
<a href="https://www.sqlalchemy.org/">https://www.sqlalchemy.org/</a>
</li>

<li>Library (documentation for SQLAlchemy)<br />
<a href="https://www.sqlalchemy.org/library.html">https://www.sqlalchemy.org/library.html</a>
</li>

<li>SQLAlchemy na Wikipedii<br />
<a href="https://en.wikipedia.org/wiki/SQLAlchemy">https://en.wikipedia.org/wiki/SQLAlchemy</a>
</li>

<li>Schema migration<br />
<a href="https://en.wikipedia.org/wiki/Schema_migration">https://en.wikipedia.org/wiki/Schema_migration</a>
</li>

<li>Intro to SqlAlchemy<br />
<a href="https://overiq.com/sqlalchemy-101/intro-to-sqlalchemy/">https://overiq.com/sqlalchemy-101/intro-to-sqlalchemy/</a>
</li>

<li>6 Database Migration Tools For Complete Data Integrity &amp; More<br />
<a href="https://hackernoon.com/6-database-migration-tools-for-complete-data-integrity-more">https://hackernoon.com/6-database-migration-tools-for-complete-data-integrity-more</a>
</li>

<li>DB Migration In Go Lang<br />
<a href="https://medium.com/geekculture/db-migration-in-go-lang-d325effc55de">https://medium.com/geekculture/db-migration-in-go-lang-d325effc55de</a>
</li>

<li>Golang Database Migration Tutorial<br />
<a href="https://golang.ch/golang-database-migration-tutorial/">https://golang.ch/golang-database-migration-tutorial/</a>
</li>

<li>Database migrations written in Go<br />
<a href="https://github.com/golang-migrate/migrate">https://github.com/golang-migrate/migrate</a>
</li>

<li>How to do Migration using golang-migrate<br />
<a href="https://stackoverflow.com/questions/69054061/how-to-do-migration-using-golang-migrate">https://stackoverflow.com/questions/69054061/how-to-do-migration-using-golang-migrate</a>
</li>

<li>Accessing relational databases<br />
<a href="https://go.dev/doc/database/">https://go.dev/doc/database/</a>
</li>

<li>Evolutionary Database Design<br />
<a href="https://martinfowler.com/articles/evodb.html">https://martinfowler.com/articles/evodb.html</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Tišnovský</a> &nbsp; 2023</small></p>
</body>
</html>

