<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<title></title>
<meta name="Author" content="Pavel Tisnovsky" />
<meta name="Generator" content="vim" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style type="text/css">
         body {color:#000000; background:#ffffff;}
         h1  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#c00000; text-align:center; padding-left:1em}
         h2  {font-family: arial, helvetica, sans-serif; color:#ffffff; background-color:#0000c0; padding-left:1em; text-align:left}
         h3  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#c0c0c0; padding-left:1em; text-align:left}
         h4  {font-family: arial, helvetica, sans-serif; color:#000000; background-color:#e0e0e0; padding-left:1em; text-align:left}
         a   {font-family: arial, helvetica, sans-serif;}
         li  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ol  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         ul  {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify; width:450px;}
         p   {font-family: arial, helvetica, sans-serif; color:#000000; text-align:justify;}
         pre {background:#e0e0e0}
</style>
</head>

<body>

<h1></h1>

<h3>Pavel Tišnovský</h3>

<p></p>

<h1>Úvodník</h1>

<p>V páté části seriálu o vývoji her a multimediálních dem určených pro slavnou a v mnoha ohledech přelomovou osmibitovou herní konzoli Nintendo Entertainment System (NES) si popíšeme způsob zobrazení spritů na ploše obrazovky.</p>



<h2>Obsah</h2>

<p><a href="#k01">*** 1. Sprity na osmibitových domácích mikropočítačích a herních konzolích</a></p>
<p><a href="#k02">*** 2. Osmibitová herní konzole Atari 2600</a></p>
<p><a href="#k03">*** 3. Osmibitové domácí počítače Atari</a></p>
<p><a href="#k04">*** 4. Počítač Commodore C64</a></p>
<p><a href="#k05">*** 5. Herní konzole NES</a></p>
<p><a href="#k06">*** 6. </a></p>
<p><a href="#k07">*** 7. </a></p>
<p><a href="#k08">*** 8. </a></p>
<p><a href="#k09">*** 9. </a></p>
<p><a href="#k10">*** 10. </a></p>
<p><a href="#k11">*** 11. </a></p>
<p><a href="#k12">*** 12. </a></p>
<p><a href="#k13">*** 13. </a></p>
<p><a href="#k14">*** 14. </a></p>
<p><a href="#k15">*** 15. </a></p>
<p><a href="#k16">*** 16. </a></p>
<p><a href="#k17">*** 17. </a></p>
<p><a href="#k18">*** 18. </a></p>
<p><a href="#k19">*** 19. Repositář s&nbsp;demonstračními příklady</a></p>
<p><a href="#k20">*** 20. Odkazy na Internetu</a></p>



<p><a name="k01"></a></p>
<h2 id="k01">1. Sprity na osmibitových domácích mikropočítačích a herních konzolích</h2>

<p></p>



<p><a name="k02"></a></p>
<h2 id="k02">2. Osmibitová herní konzole Atari 2600</h2>

<p></p>



<p><a name="k03"></a></p>
<h2 id="k03">3. Osmibitové domácí počítače Atari</h2>

<p>Prvním čipem typickým pro mnoho elektronických zařízení firmy <i>Atari</i>
byl čip nazvaný <i>GTIA</i>, neboli <i>Graphics Television Interface
Adaptor</i>, popř.&nbsp;též <i>George's Television Interface Adaptor</i> podle
jména svého tvůrce <i>George McLeoda</i>. Tento čip, jenž vznikl rozšířením
možností původního čipu <i>TIA</i> z&nbsp;<i>Atari 2600</i>, zajišťoval několik
funkcí: generování signálů nesoucích informaci o barvách a světlosti
(luminanci) pixelů, řízení a zobrazování spritů, řízení priority spritů a
pozadí a taktéž detekce kolizí mezi sprity navzájem, popř.&nbsp;kolizí mezi
sprity a pozadím. Navíc tento čip dokázal na pozadí zobrazovat bitmapu
generovanou spolupracujícím čipem <i>ANTIC</i>, popř.&nbsp;tuto bitmapu mohl
reinterpretovat takovým způsobem, že vznikly tři nové grafické režimy
s&nbsp;horizontálním rozlišením sníženým na 80 pixelů, protože každý pixel byl
představován čtveřicí bitů (jeden řádek má při použití standardních režimů ve
framebufferu velikost 20 nebo 40 bajtů, v&nbsp;rozšířeném hracím poli pak
maximálně 48 bajtů), ovšem s&nbsp;možností zobrazení až šestnácti barev či
šestnácti úrovní jedné barvy.</p>

<p><i>&bdquo;Good hardware-software tradeoffs make the product economically
viable.&ldquo;</i></p>

<p>Ve skutečnosti byly všechny tři nové grafické režimy podporované čipem
<i>GTIA</i> založené na monochromatickém režimu čipu <i>ANTIC</i> číslo 8,
který umožňoval na jednom řádku standardně zobrazit 320 pixelů (teoreticky bylo
sice možné tyto tři režimy založit například i na textovém režimu, ovšem
v&nbsp;praxi se tento způsob práce s&nbsp;grafikou příliš často nepoužíval).
Čip <i>GTIA</i> vždy čtveřici sousedních pixelů sloučil a výsledné čtyři bity
mu sloužily buď pro výběr barvy z&nbsp;barvové palety (k&nbsp;dispozici bylo
devět barev z&nbsp;možných šestnácti &ndash; jedná se o celkem zbytečné omezení
dané počtem barvových registrů), určení odstínu barvy (úroveň,
tj.&nbsp;světlost byla v&nbsp;tomto případě konstantní),
popř.&nbsp;k&nbsp;určení úrovně barvy, zatímco odstín byl konstantní (tímto
způsobem bylo možné například pracovat s&nbsp;černobílými fotografiemi). Čip
<i>GTIA</i> tedy ponechával značnou část práce, především časování, provádění
takzvaného display-listu atd., přístup do paměti, na obvodu <i>ANTIC</i>, což
se vlastně ani příliš neliší od principu práce čipu <i>TIA</i>.</p>

<img src="http://i.iinfo.cz/images/619/7611-1.png" width="336" height="240" alt="&#160;" />
<p><i>Obrázek 11: Další snímek ze hry Gyrrus.</i></p>

<p>Čip <i>GTIA</i> byl řízen pomocí 32 registrů, z&nbsp;nichž všechny byly
určeny pro zápis a některé taktéž pro čtení, tj.&nbsp;například pro zjišťování
kolizí atd. Některé z&nbsp;těchto registrů jsou vypsány v&nbsp;následující
tabulce:</p>

<table>
<tr><th>Registr</th><th>Režim</th><th>Význam</th></tr>
<tr><td>COLPM0</td><td>W</td><td>barva hráče číslo 0 a střely číslo 0</td></tr>
<tr><td>COLPM1</td><td>W</td><td>barva hráče číslo 1 a střely číslo 1</td></tr>
<tr><td>COLPM2</td><td>W</td><td>barva hráče číslo 2 a střely číslo 2</td></tr>
<tr><td>COLPM3</td><td>W</td><td>barva hráče číslo 3 a střely číslo 3</td></tr>
<tr><td>COLPF0</td><td>W</td><td>barva pro herní pole číslo 0</td></tr>
<tr><td>COLPF1</td><td>W</td><td>barva pro herní pole číslo 1</td></tr>
<tr><td>COLPF2</td><td>W</td><td>barva pro herní pole číslo 2</td></tr>
<tr><td>COLPF3</td><td>W</td><td>barva pro herní pole číslo 3</td></tr>
<tr><td>COLBK </td><td>W</td><td>barva pozadí</td></tr>
<tr><td>PRIOR </td><td>W</td><td>řízení priority objektů a taktéž výběr grafického režimu</td></tr>
<tr><td>HPOSP0</td><td>W</td><td>horizontální pozice hráče číslo 0</td></tr>
<tr><td>HPOSP1</td><td>W</td><td>horizontální pozice hráče číslo 1</td></tr>
<tr><td>HPOSP2</td><td>W</td><td>horizontální pozice hráče číslo 2</td></tr>
<tr><td>HPOSP3</td><td>W</td><td>horizontální pozice hráče číslo 3</td></tr>
<tr><td>HPOSM0</td><td>W</td><td>horizontální pozice střely číslo 0</td></tr>
<tr><td>HPOSM1</td><td>W</td><td>horizontální pozice střely číslo 1</td></tr>
<tr><td>HPOSM2</td><td>W</td><td>horizontální pozice střely číslo 2</td></tr>
<tr><td>HPOSM3</td><td>W</td><td>horizontální pozice střely číslo 3</td></tr>
<tr><td>SIZEP0</td><td>W</td><td>horizontální zvětšení hráče číslo 0 (1&times;, 2&times;, 4&times;)</td></tr>
<tr><td>SIZEP1</td><td>W</td><td>horizontální zvětšení hráče číslo 1 (1&times;, 2&times;, 4&times;)</td></tr>
<tr><td>SIZEP2</td><td>W</td><td>horizontální zvětšení hráče číslo 2 (1&times;, 2&times;, 4&times;)</td></tr>
<tr><td>SIZEP3</td><td>W</td><td>horizontální zvětšení hráče číslo 3 (1&times;, 2&times;, 4&times;)</td></tr>
<tr><td>SIZEM </td><td>W</td><td>horizontální zvětšení všech střel (1&times;, 2&times;, 4&times;)</td></tr>
<tr><td>GRAFP0</td><td>W</td><td>bitová data pro hráče číslo 0</td></tr>
<tr><td>GRAFP1</td><td>W</td><td>bitová data pro hráče číslo 1</td></tr>
<tr><td>GRAFP2</td><td>W</td><td>bitová data pro hráče číslo 2</td></tr>
<tr><td>GRAFP3</td><td>W</td><td>bitová data pro hráče číslo 3</td></tr>
<tr><td>GRAFM </td><td>W</td><td>bitová data pro všechny střely</td></tr>
<tr><td>M0PF</td><td>R</td><td>kolizní registr mezi střelou číslo 0 a herním polem</td></tr>
<tr><td>M1PF</td><td>R</td><td>kolizní registr mezi střelou číslo 1 a herním polem</td></tr>
<tr><td>M2PF</td><td>R</td><td>kolizní registr mezi střelou číslo 2 a herním polem</td></tr>
<tr><td>M3PF</td><td>R</td><td>kolizní registr mezi střelou číslo 3 a herním polem</td></tr>
<tr><td>P0PF</td><td>R</td><td>kolizní registr mezi hráčem číslo 0 a herním polem</td></tr>
<tr><td>P1PF</td><td>R</td><td>kolizní registr mezi hráčem číslo 1 a herním polem</td></tr>
<tr><td>P2PF</td><td>R</td><td>kolizní registr mezi hráčem číslo 2 a herním polem</td></tr>
<tr><td>P3PF</td><td>R</td><td>kolizní registr mezi hráčem číslo 3 a herním polem</td></tr>
<tr><td>M0PL</td><td>R</td><td>kolizní registr mezi střelou číslo 0 a hráčem</td></tr>
<tr><td>M1PL</td><td>R</td><td>kolizní registr mezi střelou číslo 1 a hráčem</td></tr>
<tr><td>M2PL</td><td>R</td><td>kolizní registr mezi střelou číslo 2 a hráčem</td></tr>
<tr><td>M3PL</td><td>R</td><td>kolizní registr mezi střelou číslo 3 a hráčem</td></tr>
<tr><td>P0PL</td><td>R</td><td>kolizní registr mezi hráčem číslo 0 a dalším hráčem</td></tr>
<tr><td>P1PL</td><td>R</td><td>kolizní registr mezi hráčem číslo 1 a dalším hráčem</td></tr>
<tr><td>P2PL</td><td>R</td><td>kolizní registr mezi hráčem číslo 2 a dalším hráčem</td></tr>
<tr><td>P3PL</td><td>R</td><td>kolizní registr mezi hráčem číslo 3 a dalším hráčem</td></tr>
</table>

<img src="http://i.iinfo.cz/images/165/7612-1.png" width="336" height="240" alt="&#160;" />
<p><i>Obrázek 12: Další snímek ze hry Gyrrus.</i></p>
<p>Čip <i>GTIA</i> kromě zavedení tří nových grafických režimů umožňoval
vykreslit čtyři sprity s&nbsp;rozlišením maximálně 8&times;256 pixelů
(popř.&nbsp;8&times;128 pixelů) a další čtyři sprity s&nbsp;rozlišením
2&times;256 pixelů, které bylo možno spojit do jednoho (pátého) většího spritu
s&nbsp;rozlišením 8&times;256 pixelů. Sprity široké 8 pixelů se
v&nbsp;literatuře nazývají hráči (<i>players</i>), úzké dvoupixelové sprity
střely (<i>missiles</i>). Sprity byly jednobarevné, více barev bylo možno
dosáhnout logickými operacemi nad překrývajícími se sprity (počítače Commodore
C64 naproti tomu nabízely i sprity v&nbsp;režimu <i>multicolor</i>). Každý
sprite mohl pomocí jedné instrukce měnit svoji horizontální velikost i
horizontální pozici, přičemž polohy spritů byly navzájem nezávislé
(horizontální pozice se interně zjišťovala pomocí čítače a komparátoru, což
bylo řešení odlišné od technologie použité v&nbsp;čipu <i>TIA</i>, kde byl
namísto čítače využíván <i>linear feedback shift register</i>). Vertikální
pozice spritů se měnila blokovým přesunem bitmapy spritu v&nbsp;operační
paměti. Bylo také možné definovat priority vykreslování spritů vůči sobě
navzájem i vůči pozadí, tj.&nbsp;zda se má sprite vykreslovat nad herním polem
(popř.&nbsp;jiným spritem) či se naopak pod některými barvami skrývat.</p>

<a href="http://i.iinfo.cz/images/194/7614.png"><img src="http://i.iinfo.cz/images/194/7614-prev.png" width="370" height="264" alt="&#160;" /></a>
<p><i>Obrázek 14: Hra Adventure 2 pro počítače Atari 5200. Jedná se o hry
z&nbsp;21. století vytvořenou v&nbsp;domácích podmínkách, která se snaží
zachovat prvky z&nbsp;původní hry Adventure pro Atari 2600 (viz tvar hráče -
čtverečku).</i></p>

<p>Kromě toho, že se dala měnit priorita jednotlivých spritů, bylo také možné
detekovat kolizi spritu s&nbsp;jiným spritem popř.&nbsp;s&nbsp;nějakou barvou
hracího pole. To stejné samozřejmě platí i pro střely, u nichž byla možná
detekce kolize s&nbsp;hráčem či kolize s&nbsp;hracím polem. Při kolizi (do
úvahy se samozřejmě braly pouze viditelné pixely spritu, tj.&nbsp;pixely
nastavené na logickou jedničku) se nastavil příslušný bit ve stavových
registrech, odkud bylo možné kdykoli poté zjistit, zda ke kolizi došlo či
nikoli. Díky této funkcionalitě bylo možné velmi snadno otestovat například
náraz hráče do stěny, zásah hráče střelou atd. Vzhledem k&nbsp;tomu, že sprity
byly pouze jednobarevné, museli se vícebarevní hráči sestavovat z&nbsp;několika
spritů. Omezení počtu spritů naproti tomu nebylo kritické, neboť jeden sprite
mohl být ve skutečnosti použitý pro zobrazení většího množství objektů ve scéně
&ndash; jediným omezením bylo to, že tyto objekty nesměly ležet na stejném
obrazovém řádku.</p>

<a href="http://i.iinfo.cz/images/572/7615.png"><img src="http://i.iinfo.cz/images/572/7615-prev.png" width="370" height="264" alt="&#160;" /></a>
<p><i>Obrázek 15: Screenshot ze hry Adventure 2.</i></p>

<p>Pro porovnání shodných vlastností a rozdílů mezi čipy <i>TIA</i> a
<i>GTIA</i> se podívejme na následující dvojici tabulek. V&nbsp;první tabulce
jsou vypsány grafické objekty, s&nbsp;nimiž dokázal pracovat čip <i>TIA</i>
použitý v&nbsp;herní konzoli <i>Atari 2600</i>:</p>

<table>
<tr><th>#</th><th>Typ objektu</th><th>Orig.název</th><th>Objem paměti</th><th>Šířka reprezentovaná jedním bitem</th></tr>
<tr><td>1</td><td>Pozadí</td><td>Background</td><td> 0 bitů</td><td>&times;</td></tr>
<tr><td>2</td><td>Hrací plocha</td><td>Playground</td><td>20 bitů</td><td>4&times; základní šířka pixelu</td></tr>
<tr><td>3</td><td>Míč</td><td>Ball</td><td> 1 bit </td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
<tr><td>4</td><td>Hráč 0</td><td>Player 0</td><td> 8 bitů</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td>5</td><td>Střela 0</td><td>Missile 0</td><td> 1 bit </td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
<tr><td>6</td><td>Hráč 1</td><td>Player 1</td><td> 8 bitů</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td>7</td><td>Střela 1</td><td>Missile 1</td><td> 1 bit </td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
</table>

<a href="http://i.iinfo.cz/images/262/7616.png"><img src="http://i.iinfo.cz/images/262/7616-prev.png" width="370" height="264" alt="&#160;" /></a>
<p><i>Obrázek 16: Další screenshot ze hry Adventure 2.</i></p>

<p>Ve druhé tabulce jsou vypsány grafické objekty, s&nbsp;nimiž dokázal
pracovat čip <i>GTIA</i> použitý v&nbsp;herní konzoli <i>Atari 5200</i> i
v&nbsp;prakticky všech osmibitových domácích počítačích <i>Atari</i> (pokud
tedy nepočítáme prvních zhruba 100 000 počítačů Atari 400 a Atari 800
s&nbsp;čipy <i>CTIA</i>:</p>

<table>
<tr><th>#</th><th>Typ objektu</th><th>Orig.název</th><th>Objem paměti</th><th>Šířka reprezentovaná jedním bitem</th></tr>
<tr><td> 1</td><td>Pozadí</td><td>Background</td><td> 0 bitů</td><td>barva v COLBK, přes celou šířku řádku</td></tr>
<tr><td> 2</td><td>Hrací plocha</td><td>Playground</td><td> x bitů</td><td>generováno v&nbsp;ANTIC</td></tr>
<tr><td> 3</td><td>Hráč 0</td><td>Player 0</td><td> 8 bitů&times;128/256</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td> 4</td><td>Střela 0</td><td>Missile 0</td><td> 2 bity&times;128/256</td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
<tr><td> 5</td><td>Hráč 1</td><td>Player 1</td><td> 8 bitů&times;128/256</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td> 6</td><td>Střela 1</td><td>Missile 1</td><td> 2 bity&times;128/256</td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
<tr><td> 7</td><td>Hráč 2</td><td>Player 2</td><td> 8 bitů&times;128/256</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td> 8</td><td>Střela 2</td><td>Missile 2</td><td> 2 bity&times;128/256</td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
<tr><td> 9</td><td>Hráč 3</td><td>Player 3</td><td> 8 bitů&times;128/256</td><td>1&times;, 2&times;, 4&times; šířka pixelu</td></tr>
<tr><td>10</td><td>Střela 3</td><td>Missile 3</td><td> 2 bity&times;128/256</td><td>1&times;, 2&times;, 4&times;, 8&times; šířka pixelu</td></tr>
</table>

<img src="http://i.iinfo.cz/images/569/pc6907.png" width="336" height="240" alt="pc6907" />
<p><i>Obrázek 17: Kombinace grafických režimů ve hře International
Karate.</i></p>



<p><a name="k04"></a></p>
<h2 id="k04">4. Počítač Commodore C64</h2>

<p></p>



<p><a name="k05"></a></p>
<h2 id="k05">5. Herní konzole NES</h2>

<p></p>



<p><a name="k06"></a></p>
<h2 id="k06">6. </h2>

<p></p>



<p><a name="k07"></a></p>
<h2 id="k07">7. </h2>

<p></p>



<p><a name="k08"></a></p>
<h2 id="k08">8. </h2>

<p></p>



<p><a name="k09"></a></p>
<h2 id="k09">9. </h2>

<p></p>

<pre>
; Jména řídicích registrů použitých v kódu
PPUCTRL         = $2000
PPUMASK         = $2001
PPUSTATUS       = $2002
PPUADDR         = $2006
PPUDATA         = $2007
DMC_FREQ        = $4010
OAM_DMA         = $4014

; Další důležité adresy
PALETTE         = $3f00



; ---------------------------------------------------------------------
; Definice maker
; ---------------------------------------------------------------------

.macro setup_cpu
        ; nastavení stavu CPU
        sei                     ; zákaz přerušení
        cld                     ; vypnutí dekadického režimu (není podporován)

        ldx #$ff
        txs                     ; vrchol zásobníku nastaven na 0xff (první stránka)
.endmacro

.macro wait_for_frame
:       bit PPUSTATUS            ; test obsahu registru PPUSTATUS 
        bpl :-                   ; skok, pokud je příznak N nulový
.endmacro

.macro clear_ram
        lda #$00                ; vynulování registru A
:       sta $000, x             ; vynulování X-tého bajtu v nulté stránce
        sta $100, x
        sta $200, x
        sta $300, x
        sta $400, x
        sta $500, x
        sta $600, x
        sta $700, x             ; vynulování X-tého bajtu v sedmé stránce
        inx                     ; přechod na další bajt
        bne :-                  ; po přetečení 0xff -> 0x00 konec smyčky
.endmacro

.macro ppu_data_palette_address
        lda PPUSTATUS   ; reset záchytného registru
        lda #>PALETTE   ; nastavení adresy pro barvovou paletu $3f00
        sta PPUADDR
        lda #<PALETTE   ; nižší bajt adresy
        sta PPUADDR
.endmacro


; ---------------------------------------------------------------------
; Definice hlavičky obrazu ROM
; ---------------------------------------------------------------------

; Size of PRG in units of 16 KiB.
prg_npage = 2

; Size of CHR in units of 8 KiB.
chr_npage = 1

; INES mapper number.
mapper = 0

; Mirroring (0 = horizontal, 1 = vertical)
mirroring = 1

.segment "HEADER"
        .byte $4e, $45, $53, $1a
        .byte prg_npage
        .byte chr_npage
        .byte ((mapper & $0f) << 4) | (mirroring & 1)
        .byte mapper & $f0

.segment "ZEROPAGE"
.segment "STARTUP"
.segment "CODE"



; ---------------------------------------------------------------------
; Blok paměti s definicí dlaždic 8x8 pixelů
; ---------------------------------------------------------------------

.segment "CHR0a"
.segment "CHR0b"


.code

; ---------------------------------------------------------------------
; Programový kód rutin pro NMI, RESET a IRQ volaných automaticky CPU
;
; viz též https://www.pagetable.com/?p=410
; ---------------------------------------------------------------------

; Obslužná rutina pro NMI (nemaskovatelné přerušení, vertical blank)

.proc nmi
        lda #$02          ; horní bajt adresy pro přenos + zahájení přenosu
        sta OAM_DMA
        rti                     ; návrat z přerušení
.endproc



; Obslužná rutina pro IRQ (maskovatelné přerušení)

.proc irq
        rti                     ; návrat z přerušení
.endproc



; Obslužná rutina pro RESET

.proc reset
        ; nastavení stavu CPU
        setup_cpu

        ; nastavení řídicích registrů
        ldx #$00
        stx PPUCTRL             ; nastavení PPUCTRL = 0 (NMI)
        stx PPUMASK             ; nastavení PPUMASK = 0
        stx DMC_FREQ            ; zákaz DMC IRQ

        ldx #$40
        stx $4017               ; interrupt inhibit bit

        ; čekání na vnitřní inicializaci PPU (dva snímky)
        wait_for_frame
        wait_for_frame

        ; vymazání obsahu RAM
        clear_ram

        ; čekání na další snímek
        wait_for_frame

        ; nastavení barvové palety
        jsr load_palette  ; zavolání subrutiny

        ; nastavení spritů
        jsr load_sprites  ; zavolání subrutiny

        ; vlastní herní smyčka je prozatím prázdná
game_loop:
        jmp game_loop           ; nekonečná smyčka (později rozšíříme)
.endproc



; vynulování barvové palety
.proc clear_palette
        ppu_data_palette_address

        ldx #$20        ; počitadlo barev v paletě: 16+16
        lda #$00        ; vynulování každé barvy

:
        sta PPUDATA     ; zápis barvy
        dex             ; snížení hodnoty počitadla
        bne :-

        rts             ; návrat ze subrutiny
.endproc



; nastavení barvové palety
.proc load_palette
        ppu_data_palette_address

        ; $3f00-$3f0f - paleta pozadí
        ; $3f10-$3f1f - paleta spritů

        ldx #$00        ; vynulovat počitadlo a offset

:
        lda palette, x  ; načíst bajt s offsetem
        sta PPUDATA     ; zápis barvy do PPU
        inx             ; zvýšit počitadlo/offset
        cpx #32         ; limit počtu barev
        bne :-          ; opakovat smyčku 32x

        rts             ; návrat ze subrutiny
.endproc



; načtení spritů
.proc load_sprites
:
        lda spritedata,X  ; budeme přesouvat data z této oblasti
        sta $0200,X       ; uložení do paměti spritů
        inx               ; zvýšení hodnoty počitadla
        cpx #32           ; každý sprite má 4 bajty: y-coord, tile, attributy, y-coord * 8 spritů = 32
        bne :-

        cli               ; vynulování bitu I - povolení přerušení
        lda #%10000000      
        sta PPUCTRL       ; při každém VBLANK se vyvolá NMI (důležité!)

        lda #%00010000    ; povolení zobrazení spritů
        sta PPUMASK

        rts               ; návrat ze subrutiny
.endproc



; samotná barvová paleta
palette:
    .byte $22, $29, $1a, $0F, $22, $36, $17, $0F, $22, $30, $21, $0F, $22, $27, $17, $0F  ; barvy pozadí
    .byte $22, $16, $27, $18, $22, $1A, $30, $27, $22, $16, $30, $27, $22, $0F, $36, $17  ; barvy spritů

; data pro jeden sprite
spritedata:
    .byte $10, $00, $00, $08   ; y-coord, tile number, attributes, x-coord
    .byte $10, $01, $00, $10
    .byte $18, $02, $00, $08
    .byte $18, $03, $00, $10
    .byte $20, $04, $00, $08
    .byte $20, $05, $00, $10
    .byte $28, $06, $00, $08
    .byte $28, $07, $00, $10



; ---------------------------------------------------------------------
; Tabulka vektorů CPU
; ---------------------------------------------------------------------

.segment "VECTORS"
.addr nmi
.addr reset
.addr irq



.segment "CHARS"
    .incbin "mario.chr"



; ---------------------------------------------------------------------
; Finito
; ---------------------------------------------------------------------
</pre>



<p><a name="k10"></a></p>
<h2 id="k10">10. </h2>

<p></p>



<p><a name="k11"></a></p>
<h2 id="k11">11. </h2>

<p></p>



<p><a name="k12"></a></p>
<h2 id="k12">12. </h2>

<p></p>



<p><a name="k13"></a></p>
<h2 id="k13">13. </h2>

<p></p>



<p><a name="k14"></a></p>
<h2 id="k14">14. </h2>

<p></p>



<p><a name="k15"></a></p>
<h2 id="k15">15. </h2>

<p></p>



<p><a name="k16"></a></p>
<h2 id="k16">16. </h2>

<p></p>



<p><a name="k17"></a></p>
<h2 id="k17">17. </h2>

<p></p>



<p><a name="k18"></a></p>
<h2 id="k18">18. </h2>

<p></p>



<p><a name="k19"></a></p>
<h2 id="k19">19. Repositář s&nbsp;demonstračními příklady</h2>

<p>Demonstrační příklady napsané v&nbsp;assembleru, které jsou určené pro
překlad pomocí assembleru <strong>ca65</strong> (jenž je součástí
<strong>cc65</strong>), byly uložen do Git repositáře, který je dostupný na
adrese <a
href="https://github.com/tisnik/8bit-fame">https://github.com/tisnik/8bit-fame</a>.
Příklady si můžete v&nbsp;případě potřeby stáhnout i jednotlivě bez nutnosti
klonovat celý (dnes již poměrně rozsáhlý) repositář:</p>

<table>
<tr><th> #</th><th>Příklad</th><th>Stručný popis</th><th>Adresa</th></tr>
<tr><td> 1</td><td>example01.asm</td><td>zdrojový kód příkladu tvořeného kostrou aplikace pro NES</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example01.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example01.asm</a></td></tr>
<tr><td> 2</td><td>example02.asm</td><td>použití standardní konfigurace linkeru pro konzoli NES</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example02.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example02.asm</a></td></tr>
<tr><td> 3</td><td>example03.asm</td><td>symbolická jména řídicích registrů PPU</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example03.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example03.asm</a></td></tr>
<tr><td> 4</td><td>example04.asm</td><td>zjednodušený zápis lokálních smyček v&nbsp;assembleru</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example04.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example04.asm</a></td></tr>
<tr><td> 5</td><td>example05.asm</td><td>zvukový výstup s&nbsp;využitím prvního &bdquo;square&ldquo; kanálu</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example05.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example05.asm</a></td></tr>
<tr><td> 6</td><td>example06.asm</td><td>použití maker bez parametrů</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example06.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example06.asm</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td> 7</td><td>example07.asm</td><td>nastavení barvové palety, zvýšení intenzity zvolené barvové složky</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example07.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example07.asm</a></td></tr>
<tr><td> 8</td><td>example08.asm</td><td>využití operátorů &lt; a &gt;</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example08.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example08.asm</a></td></tr>
<tr><td> 9</td><td>example09.asm</td><td>vymazání barvové palety realizované makrem</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example09.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example09.asm</a></td></tr>
<tr><td>10</td><td>example10.asm</td><td>vymazání barvové palety realizované podprogramem</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example10.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example10.asm</a></td></tr>
<tr><td>11</td><td>example11.asm</td><td>nastavení barvové palety pozadí i spritů</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example11.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example11.asm</a></td></tr>
<tr><td>12</td><td>example12.asm</td><td>refaktoring předchozího příkladu makrem</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example12.asm">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/example12.asm</a></td></tr>
<tr><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td></tr>
<tr><td>13</td><td>link.cfg</td><td>konfigurace segmentů pro linker <strong>ld65</strong></td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/link.cfg">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/link.cfg</a></td></tr>
<tr><td>14</td><td>Makefile</td><td>Makefile pro překlad a slinkování všech příkladů</td><td><a href="https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/Makefile">https://github.com/tisnik/8bit-fame/blob/master/NES-ca65/Makefile</a></td></tr>
</table>



<p><a name="k20"></a></p>
<h2 id="k20">20. Odkazy na Internetu</h2>

<ol>

<li>NesDev.org<br />
<a href="https://www.nesdev.org/">https://www.nesdev.org/</a>
</li>

<li>How to Program an NES game in C<br />
<a href="https://nesdoug.com/">https://nesdoug.com/</a>
</li>

<li>Getting Started Programming in C: Coding a Retro Game with C Part 2<br />
<a href="https://retrogamecoders.com/getting-started-with-c-cc65/">https://retrogamecoders.com/getting-started-with-c-cc65/</a>
</li>

<li>NES game development in 6502 assembly - Part 1<br />
<a href="https://kibrit.tech/en/blog/nes-game-development-part-1">https://kibrit.tech/en/blog/nes-game-development-part-1</a>
</li>

<li>"Game Development in Eight Bits" by Kevin Zurawel<br />
<a href="https://www.youtube.com/watch?v=TPbroUDHG0s&amp;list=PLcGKfGEEONaBjSfQaSiU9yQsjPxxDQyV8&amp;index=4">https://www.youtube.com/watch?v=TPbroUDHG0s&amp;list=PLcGKfGEEONaBjSfQaSiU9yQsjPxxDQyV8&amp;index=4</a>
</li>

<li>Game Development for the 8-bit NES: A class by Bob Rost<br />
<a href="http://bobrost.com/nes/">http://bobrost.com/nes/</a>
</li>

<li>Game Development for the 8-bit NES: Lecture Notes<br />
<a href="http://bobrost.com/nes/lectures.php">http://bobrost.com/nes/lectures.php</a>
</li>

<li>NES Graphics Explained<br />
<a href="https://www.youtube.com/watch?v=7Co_8dC2zb8">https://www.youtube.com/watch?v=7Co_8dC2zb8</a>
</li>

<li>NES GAME PROGRAMMING PART 1<br />
<a href="https://rpgmaker.net/tutorials/227/?post=240020">https://rpgmaker.net/tutorials/227/?post=240020</a>
</li>

<li>NES 6502 Programming Tutorial - Part 1: Getting Started<br />
<a href="https://dev.xenforo.relay.cool/index.php?threads/nes-6502-programming-tutorial-part-1-getting-started.858389/">https://dev.xenforo.relay.cool/index.php?threads/nes-6502-programming-tutorial-part-1-getting-started.858389/</a>
</li>

<li>Minimal NES example using ca65<br />
<a href="https://github.com/bbbradsmith/NES-ca65-example">https://github.com/bbbradsmith/NES-ca65-example</a>
</li>

<li>List of 6502-based Computers and Consoles<br />
<a href="https://www.retrocompute.co.uk/list-of-6502-based-computers-and-consoles/">https://www.retrocompute.co.uk/list-of-6502-based-computers-and-consoles/</a>
</li>

<li>History of video game consoles (second generation): Wikipedia<br />
<a href="http://en.wikipedia.org/wiki/History_of_video_game_consoles_(second_generation)">http://en.wikipedia.org/wiki/History_of_video_game_consoles_(second_generation)</a>
</li>

<li>6502 - the first RISC &micro;P<br />
<a href="http://ericclever.com/6500/">http://ericclever.com/6500/</a>
</li>

<li>3 Generations of Game Machine Architecture<br />
<a href="http://www.atariarchives.org/dev/CGEXPO99.html">http://www.atariarchives.org/dev/CGEXPO99.html</a>
</li>

<li>bee - The Multi-Console Emulator<br />
<a href="http://www.thebeehive.ws/">http://www.thebeehive.ws/</a>
</li>

<li>Nerdy Nights Mirror<br />
<a href="https://nerdy-nights.nes.science/">https://nerdy-nights.nes.science/</a>
</li>

<li>The Nerdy Nights ca65 Remix<br />
<a href="https://github.com/ddribin/nerdy-nights">https://github.com/ddribin/nerdy-nights</a>
</li>

<li>NES Development Day 1: Creating a ROM<br />
<a href="https://www.moria.us/blog/2018/03/nes-development">https://www.moria.us/blog/2018/03/nes-development</a>
</li>

<li>How to Start Making NES Games<br />
<a href="https://www.matthughson.com/2021/11/17/how-to-start-making-nes-games/">https://www.matthughson.com/2021/11/17/how-to-start-making-nes-games/</a>
</li>

<li>ca65 Users Guide<br />
<a href="https://cc65.github.io/doc/ca65.html">https://cc65.github.io/doc/ca65.html</a>
</li>

<li>cc65 Users Guide<br />
<a href="https://cc65.github.io/doc/cc65.html">https://cc65.github.io/doc/cc65.html</a>
</li>

<li>ld65 Users Guide<br />
<a href="https://cc65.github.io/doc/ld65.html">https://cc65.github.io/doc/ld65.html</a>
</li>

<li>da65 Users Guide<br />
<a href="https://cc65.github.io/doc/da65.html">https://cc65.github.io/doc/da65.html</a>
</li>

<li>Nocash NES Specs<br />
<a href="http://nocash.emubase.de/everynes.htm">http://nocash.emubase.de/everynes.htm</a>
</li>

<li>Nintendo Entertainment System<br />
<a href="http://cs.wikipedia.org/wiki/NES">http://cs.wikipedia.org/wiki/NES</a>
</li>

<li>Nintendo Entertainment System Architecture<br />
<a href="http://nesdev.icequake.net/nes.txt">http://nesdev.icequake.net/nes.txt</a>
</li>

<li>NesDev<br />
<a href="http://nesdev.parodius.com/">http://nesdev.parodius.com/</a>
</li>

<li>2A03 technical reference<br />
<a href="http://nesdev.parodius.com/2A03%20technical%20reference.txt">http://nesdev.parodius.com/2A03%20technical%20reference.txt</a>
</li>

<li>NES Dev wiki: 2A03<br />
<a href="http://wiki.nesdev.com/w/index.php/2A03">http://wiki.nesdev.com/w/index.php/2A03</a>
</li>

<li>Ricoh 2A03<br />
<a href="http://en.wikipedia.org/wiki/Ricoh_2A03">http://en.wikipedia.org/wiki/Ricoh_2A03</a>
</li>

<li>2A03 pinouts<br />
<a href="http://nesdev.parodius.com/2A03_pinout.txt">http://nesdev.parodius.com/2A03_pinout.txt</a>
</li>

<li>27c3: Reverse Engineering the MOS 6502 CPU (en)<br />
<a href="https://www.youtube.com/watch?v=fWqBmmPQP40">https://www.youtube.com/watch?v=fWqBmmPQP40</a>
</li>

<li>“Hello, world” from scratch on a 6502 — Part 1<br />
<a href="https://www.youtube.com/watch?v=LnzuMJLZRdU">https://www.youtube.com/watch?v=LnzuMJLZRdU</a>
</li>

<li>A Tour of 6502 Cross-Assemblers<br />
<a href="https://bumbershootsoft.wordpress.com/2016/01/31/a-tour-of-6502-cross-assemblers/">https://bumbershootsoft.wordpress.com/2016/01/31/a-tour-of-6502-cross-assemblers/</a>
</li>

<li>Nintendo Entertainment System (NES)<br />
<a href="https://8bitworkshop.com/docs/platforms/nes/">https://8bitworkshop.com/docs/platforms/nes/</a>
</li>

<li>Question about NES vectors and PPU<br />
<a href="https://archive.nes.science/nesdev-forums/f10/t4154.xhtml">https://archive.nes.science/nesdev-forums/f10/t4154.xhtml</a>
</li>

<li>How do mapper chips actually work?<br />
<a href="https://archive.nes.science/nesdev-forums/f9/t13125.xhtml">https://archive.nes.science/nesdev-forums/f9/t13125.xhtml</a>
</li>

<li>INES<br />
<a href="https://www.nesdev.org/wiki/INES">https://www.nesdev.org/wiki/INES</a>
</li>

<li>NES Basics and Our First Game<br />
<a href="http://thevirtualmountain.com/nes/2017/03/08/nes-basics-and-our-first-game.html">http://thevirtualmountain.com/nes/2017/03/08/nes-basics-and-our-first-game.html</a>
</li>

<li>Where is the reset vector in a .nes file?<br />
<a href="https://archive.nes.science/nesdev-forums/f10/t17413.xhtml">https://archive.nes.science/nesdev-forums/f10/t17413.xhtml</a>
</li>

<li>CPU memory map<br />
<a href="https://www.nesdev.org/wiki/CPU_memory_map">https://www.nesdev.org/wiki/CPU_memory_map</a>
</li>

<li>How to make NES music<br />
<a href="http://blog.snugsound.com/2008/08/how-to-make-nes-music.html">http://blog.snugsound.com/2008/08/how-to-make-nes-music.html</a>
</li>

<li>Nintendo Entertainment System Architecture<br />
<a href="http://nesdev.icequake.net/nes.txt">http://nesdev.icequake.net/nes.txt</a>
</li>

<li>MIDINES<br />
<a href="http://www.wayfar.net/0xf00000_overview.php">http://www.wayfar.net/0xf00000_overview.php</a>
</li>

<li>FamiTracker<br />
<a href="http://famitracker.com/">http://famitracker.com/</a>
</li>

<li>nerdTracker II<br />
<a href="http://nesdev.parodius.com/nt2/">http://nesdev.parodius.com/nt2/</a>
</li>

<li>How NES Graphics work<br />
<a href="http://nesdev.parodius.com/nesgfx.txt">http://nesdev.parodius.com/nesgfx.txt</a>
</li>

<li>NES Technical/Emulation/Development FAQ<br />
<a href="http://nesdev.parodius.com/NESTechFAQ.htm">http://nesdev.parodius.com/NESTechFAQ.htm</a>
</li>

<li>Adventures with ca65<br />
<a href="https://atariage.com/forums/topic/312451-adventures-with-ca65/">https://atariage.com/forums/topic/312451-adventures-with-ca65/</a>
</li>

<li>example ca65 startup code<br />
<a href="https://atariage.com/forums/topic/209776-example-ca65-startup-code/">https://atariage.com/forums/topic/209776-example-ca65-startup-code/</a>
</li>

<li>6502 PRIMER: Building your own 6502 computer<br />
<a href="http://wilsonminesco.com/6502primer/">http://wilsonminesco.com/6502primer/</a>
</li>

<li>6502 Instruction Set<br />
<a href="https://www.masswerk.at/6502/6502_instruction_set.html">https://www.masswerk.at/6502/6502_instruction_set.html</a>
</li>

<li>Chip Hall of Fame: MOS Technology 6502 Microprocessor<br />
<a href="https://spectrum.ieee.org/tech-history/silicon-revolution/chip-hall-of-fame-mos-technology-6502-microprocessor">https://spectrum.ieee.org/tech-history/silicon-revolution/chip-hall-of-fame-mos-technology-6502-microprocessor</a>
</li>

<li>Single-board computer<br />
<a href="https://en.wikipedia.org/wiki/Single-board_computer">https://en.wikipedia.org/wiki/Single-board_computer</a>
</li>

<li>www.6502.org<br />
<a href="http://www.6502­.org/">http://www.6502­.org/</a>
</li>

<li>6502 PRIMER: Building your own 6502 computer &ndash; clock generator<br />
<a href="http://wilsonminesco.com/6502primer/ClkGen.html">http://wilsonminesco.com/6502primer/ClkGen.html</a>
</li>

<li>Great Microprocessors of the Past and Present (V 13.4.0)<br />
<a href="http://www.cpushack.com/CPU/cpu.html">http://www.cpushack.com/CPU/cpu.html</a>
</li>

<li>Jak se zrodil procesor?<br />
<a href="https://www.root.cz/clanky/jak-se-zrodil-procesor/">https://www.root.cz/clanky/jak-se-zrodil-procesor/</a>
</li>

<li>Osmibitové mikroprocesory a mikrořadiče firmy Motorola (1)<br />
<a href="https://www.root.cz/clanky/osmibitove-mikroprocesory-a-mikroradice-firmy-motorola-1/">https://www.root.cz/clanky/osmibitove-mikroprocesory-a-mikroradice-firmy-motorola-1/</a>
</li>

<li>Mikrořadiče a jejich použití v jednoduchých mikropočítačích<br />
<a href="https://www.root.cz/clanky/mikroradice-a-jejich-pouziti-v-jednoduchych-mikropocitacich/">https://www.root.cz/clanky/mikroradice-a-jejich-pouziti-v-jednoduchych-mikropocitacich/</a>
</li>

<li>Mikrořadiče a jejich aplikace v jednoduchých mikropočítačích (2)<br />
<a href="https://www.root.cz/clanky/mikroradice-a-jejich-aplikace-v-jednoduchych-mikropocitacich-2/">https://www.root.cz/clanky/mikroradice-a-jejich-aplikace-v-jednoduchych-mikropocitacich-2/</a>
</li>

<li>25 Microchips That Shook the World<br />
<a href="https://spectrum.ieee.org/tech-history/silicon-revolution/25-microchips-that-shook-the-world">https://spectrum.ieee.org/tech-history/silicon-revolution/25-microchips-that-shook-the-world</a>
</li>

<li>Comparison of instruction set architectures<br />
<a href="https://en.wikipedia.org/wiki/Comparison_of_instruction_set_architectures">https://en.wikipedia.org/wiki/Comparison_of_instruction_set_architectures</a>
</li>

<li>Day 1 - Beginning NES Assembly<br />
<a href="https://www.patater.com/nes-asm-tutorials/day-1/">https://www.patater.com/nes-asm-tutorials/day-1/</a>
</li>

<li>Day 2 - A Source Code File's Structure<br />
<a href="https://www.patater.com/nes-asm-tutorials/day-2/">https://www.patater.com/nes-asm-tutorials/day-2/</a>
</li>

<li>Assembly Language Misconceptions<br />
<a href="https://www.youtube.com/watch?v=8_0tbkbSGRE">https://www.youtube.com/watch?v=8_0tbkbSGRE</a>
</li>

<li>How Machine Language Works<br />
<a href="https://www.youtube.com/watch?v=HWpi9n2H3kE">https://www.youtube.com/watch?v=HWpi9n2H3kE</a>
</li>

</ol>



<p></p><p></p>
<p><small>Autor: <a href="http://www.fit.vutbr.cz/~tisnovpa">Pavel Tišnovský</a> &nbsp; 2022</small></p>
</body>
</html>

